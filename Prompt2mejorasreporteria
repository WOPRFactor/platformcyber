# PROMPT PARA CURSOR - MEJORAS M√ìDULO DE REPORTER√çA

---

## üìã CONTEXTO

Tengo un m√≥dulo de reporter√≠a V2 funcional que:
- ‚úÖ Genera reportes en PDF con ReportLab
- ‚úÖ Parsea 5 herramientas (Nmap, Nuclei, Nikto, Subfinder, Amass)
- ‚úÖ Usa Celery para procesamiento as√≠ncrono
- ‚úÖ Tiene frontend React funcional

**Problemas actuales**:
- ‚ùå Los reportes NO se guardan en la base de datos
- ‚ùå PDFs tienen dise√±o b√°sico (solo texto)
- ‚ùå No hay gr√°ficos ni visualizaciones

---

## üéØ OBJETIVO

Implementar 3 mejoras siguiendo la documentaci√≥n t√©cnica completa en:
**`GUIA_IMPLEMENTACION_MEJORAS_REPORTERIA.md`**

---

## üìù INSTRUCCIONES PARA CURSOR

### **IMPORTANTE: LEER PRIMERO LA GU√çA**

Antes de generar c√≥digo, lee el documento completo:
`GUIA_IMPLEMENTACION_MEJORAS_REPORTERIA.md`

Este documento contiene:
- Especificaciones t√©cnicas detalladas
- C√≥digo completo de ejemplo
- Estructura de archivos
- Tests a implementar
- Validaciones necesarias

---

## üöÄ IMPLEMENTACI√ìN EN 3 FASES

### **FASE 1: GUARDAR REPORTES EN BASE DE DATOS** 
**Prioridad: CR√çTICA**  
**Tiempo estimado: 30-60 minutos**

**Tareas**:
1. ‚úÖ Extender modelo `Report` (ver secci√≥n 1.1 de la gu√≠a)
   - Agregar campos: `version`, `is_latest`, `file_hash`, `files_processed`, `tools_used`, `generation_time_seconds`
   - Agregar m√©todos: `calculate_file_hash()`, `verify_integrity()`, `to_dict()`

2. ‚úÖ Crear `ReportRepository` (ver secci√≥n 1.2)
   - Ubicaci√≥n: `repositories/report_repository.py`
   - M√©todos: `create()`, `find_by_id()`, `find_by_workspace()`, `update_status()`, `delete()`

3. ‚úÖ Modificar tarea Celery (ver secci√≥n 1.3)
   - Archivo: `services/reporting/reporting_tasks.py`
   - Importar `ReportRepository`
   - Agregar par√°metro `user_id` a la funci√≥n
   - Despu√©s de generar PDF, llamar a `report_repo.create(...)` con todos los datos
   - Retornar `report_id` en el resultado (adem√°s de `report_path`)

4. ‚úÖ Actualizar endpoint de generaci√≥n (ver secci√≥n 1.4)
   - Obtener `user_id` del JWT: `user_id = get_jwt_identity()`
   - Pasar `user_id` a la tarea Celery

5. ‚úÖ Crear endpoint `/list/<workspace_id>` (ver secci√≥n 1.5)
   - GET para listar reportes de un workspace
   - Retorna lista de reportes con metadata

6. ‚úÖ Actualizar endpoint `/download` (ver secci√≥n 1.6)
   - Soportar descarga por `report_id` (nuevo)
   - Mantener descarga por `report_path` (legacy)

7. ‚úÖ Crear migraci√≥n de BD (ver secci√≥n 1.7)
   - Si uso Flask-Migrate: `flask db migrate -m "Add fields to Report"`
   - Si no: ejecutar SQL manualmente

8. ‚úÖ Actualizar frontend (opcional, ver secci√≥n 1.8)
   - Usar `report_id` en lugar de `report_path` para descargar

**Validaci√≥n (Checklist secci√≥n 1.9)**:
- [ ] Generar reporte ‚Üí Aparece en BD
- [ ] Endpoint `/list/<workspace_id>` retorna reportes
- [ ] Descargar por `report_id` funciona

---

### **FASE 2: MIGRAR A WEASYPRINT PARA PDFs PROFESIONALES**
**Prioridad: ALTA**  
**Tiempo estimado: 2-3 horas**

**Pre-requisito**: Instalar dependencias
```bash
pip install weasyprint==60.2
# Dependencias del sistema (si faltan):
sudo apt-get install -y libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf2.0-0
```

**Tareas**:
1. ‚úÖ Crear `WeasyPrintPDFGenerator` (ver secci√≥n 2.2)
   - Ubicaci√≥n: `services/reporting/generators/pdf_generator_weasy.py`
   - Usar Jinja2 para templates
   - M√©todo principal: `generate_technical_report()`
   - Incluir m√©todo `_get_pdf_stylesheet()` con CSS

2. ‚úÖ Crear template HTML (ver secci√≥n 2.3)
   - Ubicaci√≥n: `services/reporting/templates/technical/report_weasy.html`
   - **COPIAR EXACTAMENTE** el template de la gu√≠a
   - Incluye: portada, resumen ejecutivo, stats, hallazgos detallados

3. ‚úÖ Modificar tarea Celery (ver secci√≥n 2.4)
   - Cambiar de `SimplePDFGenerator` a `WeasyPrintPDFGenerator`
   - Comentar/eliminar imports de ReportLab

4. ‚úÖ Test manual (ver secci√≥n 2.5)
   - Crear `test_weasyprint.py` temporal
   - Generar PDF de prueba con datos mock

**Validaci√≥n (Checklist secci√≥n 2.6)**:
- [ ] PDF se genera sin errores
- [ ] Dise√±o se ve profesional (colores, estilos)
- [ ] Portada incluida
- [ ] Severidades con colores correctos
- [ ] No hay elementos cortados entre p√°ginas

---

### **FASE 3: AGREGAR GR√ÅFICOS CON PLOTLY**
**Prioridad: MEDIA**  
**Tiempo estimado: 1-2 horas**

**Pre-requisito**: Instalar dependencias
```bash
pip install plotly==5.18.0 kaleido==0.2.1
```

**Tareas**:
1. ‚úÖ Crear `ChartBuilder` (ver secci√≥n 3.2)
   - Ubicaci√≥n: `services/reporting/utils/chart_builder.py`
   - M√©todos:
     - `create_severity_pie_chart()` - Pie chart de severidades
     - `create_category_bar_chart()` - Bar chart de categor√≠as
     - `create_risk_gauge()` - Gauge del risk score
     - `generate_all_charts()` - Genera todos y los guarda como PNG

2. ‚úÖ Integrar en el generador (ver secci√≥n 3.3)
   - Modificar `WeasyPrintPDFGenerator`
   - Instanciar `ChartBuilder` en `__init__`
   - Generar gr√°ficos antes de renderizar template
   - Pasar paths de im√°genes al template

3. ‚úÖ Actualizar template HTML
   - Agregar secci√≥n de visualizaciones
   - Incluir im√°genes de gr√°ficos con `<img src="{{ charts.risk_gauge }}">`

**Validaci√≥n (Checklist secci√≥n 3.4)**:
- [ ] Gr√°ficos se generan como PNG
- [ ] PDF incluye los 3 gr√°ficos
- [ ] Im√°genes se ven bien (no pixeladas)
- [ ] Colores correctos por severidad

---

## ‚ö†Ô∏è CONSIDERACIONES IMPORTANTES

### **Manejo de Errores**
- Todos los m√©todos deben tener try/except
- Loguear errores con `logger.error()`
- No dejar que falle la generaci√≥n completa si un gr√°fico falla

### **Rutas de Archivos**
- Usar `Path` de `pathlib` (no strings)
- Validar que archivos existan antes de leer
- Sanitizar nombres de archivos

### **Performance**
- No cargar archivos grandes en memoria completos
- Limitar cantidad de findings en el PDF (ej: top 100)
- Gr√°ficos guardar como PNG (no SVG inline)

### **Seguridad**
- Validar `user_id` del JWT
- Verificar permisos de workspace
- Sanitizar inputs en queries

---

## üß™ TESTING

### **Tests Unitarios a Crear**

**1. Test de Repository** (`tests/unit/test_report_repository.py`):
```python
def test_create_report(db_session):
    """Test crear un reporte."""
    repo = ReportRepository()
    report = repo.create(
        title="Test Report",
        report_type="technical",
        format="pdf",
        workspace_id=1,
        created_by=1,
        file_path="/tmp/test.pdf",
        total_findings=10
    )
    assert report.id is not None
    assert report.status == "completed"
```

**2. Test de WeasyPrint** (`tests/unit/test_weasyprint_generator.py`):
```python
def test_generate_pdf():
    """Test generar PDF."""
    generator = WeasyPrintPDFGenerator()
    # ... (ver gu√≠a secci√≥n Testing)
```

**3. Test de Gr√°ficos** (`tests/unit/test_chart_builder.py`):
```python
def test_create_pie_chart():
    """Test crear pie chart."""
    builder = ChartBuilder()
    # ... (ver gu√≠a secci√≥n Testing)
```

### **Validaci√≥n Manual**

Despu√©s de cada fase, hacer test end-to-end:
1. Ir al frontend
2. Seleccionar workspace
3. Generar reporte
4. Descargar PDF
5. Abrir y verificar contenido

---

## üì¶ ESTRUCTURA DE ARCHIVOS ESPERADA

```
services/reporting/
‚îú‚îÄ‚îÄ generators/
‚îÇ   ‚îú‚îÄ‚îÄ pdf_generator_simple.py      # Existente (ReportLab) - mantener por ahora
‚îÇ   ‚îî‚îÄ‚îÄ pdf_generator_weasy.py       # NUEVO (WeasyPrint)
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îî‚îÄ‚îÄ technical/
‚îÇ       ‚îú‚îÄ‚îÄ report.html              # Existente - mantener
‚îÇ       ‚îî‚îÄ‚îÄ report_weasy.html        # NUEVO
‚îú‚îÄ‚îÄ utils/                            # NUEVO directorio
‚îÇ   ‚îî‚îÄ‚îÄ chart_builder.py             # NUEVO
‚îú‚îÄ‚îÄ reporting_tasks.py                # MODIFICAR
‚îî‚îÄ‚îÄ routes.py                         # MODIFICAR

repositories/
‚îî‚îÄ‚îÄ report_repository.py              # NUEVO (o modificar si existe)

models/
‚îî‚îÄ‚îÄ report.py                         # MODIFICAR (agregar campos)

tests/
‚îî‚îÄ‚îÄ unit/
    ‚îú‚îÄ‚îÄ test_report_repository.py    # NUEVO
    ‚îú‚îÄ‚îÄ test_weasyprint_generator.py # NUEVO
    ‚îî‚îÄ‚îÄ test_chart_builder.py        # NUEVO
```

---

## üéØ ORDEN DE IMPLEMENTACI√ìN RECOMENDADO

**D√≠a 1 - Funcionalidad cr√≠tica**:
1. ‚úÖ FASE 1 completa (BD)
2. ‚úÖ Tests de FASE 1
3. ‚úÖ Validaci√≥n manual

**D√≠a 2 - Mejora visual**:
1. ‚úÖ FASE 2 completa (WeasyPrint)
2. ‚úÖ Tests de FASE 2
3. ‚úÖ Validaci√≥n manual

**D√≠a 3 - Gr√°ficos**:
1. ‚úÖ FASE 3 completa (Plotly)
2. ‚úÖ Tests de FASE 3
3. ‚úÖ Validaci√≥n final completa

---

## üö® PROBLEMAS COMUNES Y SOLUCIONES

### **Problema 1: WeasyPrint no instala**
```bash
# Soluci√≥n: Instalar dependencias del sistema primero
sudo apt-get update
sudo apt-get install -y build-essential python3-dev libpango-1.0-0 libpangocairo-1.0-0
pip install weasyprint
```

### **Problema 2: Kaleido falla al generar PNGs**
```bash
# Soluci√≥n: Instalar versi√≥n espec√≠fica
pip uninstall kaleido
pip install kaleido==0.2.1
```

### **Problema 3: CSS no se aplica en PDF**
- Usar CSS inline en el template HTML
- WeasyPrint no soporta todos los CSS modernos
- Verificar que estilos est√©n en `<style>` tags dentro del HTML

### **Problema 4: Im√°genes no aparecen en PDF**
- Usar rutas absolutas para im√°genes
- Verificar que archivos PNG existan antes de renderizar
- Usar `file://` o rutas relativas correctas

---

## ‚úÖ CHECKLIST FINAL DE VALIDACI√ìN

### **Funcionalidad**
- [ ] Reportes se guardan en BD con todos los campos
- [ ] Endpoint `/list/<workspace_id>` retorna reportes
- [ ] Descarga por `report_id` funciona
- [ ] PDFs se generan con WeasyPrint
- [ ] Dise√±o del PDF es profesional
- [ ] Gr√°ficos aparecen en el PDF

### **Tests**
- [ ] Tests unitarios de repository passing
- [ ] Tests unitarios de WeasyPrint passing
- [ ] Tests unitarios de ChartBuilder passing
- [ ] Test end-to-end funcional

### **Performance**
- [ ] Generaci√≥n de reporte < 5 segundos (workspace peque√±o)
- [ ] PDF tama√±o razonable (< 5MB para 100 findings)
- [ ] No memory leaks en generaci√≥n

### **Seguridad**
- [ ] `user_id` validado del JWT
- [ ] Paths sanitizados (no path traversal)
- [ ] Permisos de workspace verificados

---

## üìö REFERENCIAS

- **Gu√≠a completa**: `GUIA_IMPLEMENTACION_MEJORAS_REPORTERIA.md`
- **WeasyPrint docs**: https://doc.courtbouillon.org/weasyprint/
- **Plotly docs**: https://plotly.com/python/
- **Flask-SQLAlchemy**: https://flask-sqlalchemy.palletsprojects.com/

---

## üÜò SI ALGO FALLA

1. **Revisar logs**: `logs/celery.log` y `logs/flask.log`
2. **Verificar dependencias**: `pip list | grep -E "weasyprint|plotly"`
3. **Rollback**: Ver secci√≥n "Rollback Plan" en la gu√≠a
4. **Pedir ayuda**: Incluir error completo y stack trace

---

## üí° TIPS PARA CURSOR

- **Lee la gu√≠a completa primero**: No empieces a codear sin leerla
- **Copia el c√≥digo de ejemplo**: Est√° probado y funciona
- **No inventes**: Sigue las especificaciones exactamente
- **Valida cada fase**: No avances sin validar la anterior
- **Usa los tests**: Est√°n dise√±ados para verificar todo

---

## üéØ RESULTADO ESPERADO

Al finalizar las 3 fases, el sistema debe:

‚úÖ **Guardar reportes en BD** con historial completo  
‚úÖ **Generar PDFs profesionales** con dise√±o bonito  
‚úÖ **Incluir gr√°ficos visuales** (pie chart, bar chart, gauge)  
‚úÖ **Pasar todos los tests** (unitarios e integraci√≥n)  
‚úÖ **Funcionar end-to-end** desde el frontend  

---

## üöÄ ¬°LISTO PARA EMPEZAR!

**Instrucci√≥n final para Cursor**:

```
Lee completo el archivo GUIA_IMPLEMENTACION_MEJORAS_REPORTERIA.md 
y luego implementa la FASE 1 (Guardar Reportes en BD) siguiendo 
todas las especificaciones y c√≥digo de ejemplo. 

Despu√©s de implementar cada archivo, av√≠same para validar antes 
de continuar con el siguiente.

Empieza por extender el modelo Report.
```

---

**Versi√≥n**: 1.0  
**Fecha**: 10 Diciembre 2025  
**Autor**: Claude AI