"""
Tests Unitarios - Vulnerability Parsers
=======================================

Tests para parsers de vulnerabilidades.
"""

import pytest
from pathlib import Path
from services.reporting.parsers.vulnerability.sqlmap_parser import SQLMapParser
from services.reporting.parsers.vulnerability.owasp_zap_parser import OWASPZAPParser
from services.reporting.parsers.vulnerability.wpscan_parser import WPScanParser
from services.reporting.parsers.enumeration.ssl.testssl_parser import TestSSLParser

FIXTURES_DIR = Path(__file__).parent.parent / 'fixtures' / 'vulnerability'


class TestVulnerabilityParsers:
    """Tests para parsers de vulnerabilidades."""
    
    def test_sqlmap_parser(self):
        """Test SQLMapParser."""
        parser = SQLMapParser()
        fixture_file = FIXTURES_DIR / 'sqlmap_sample.csv'
        
        if not fixture_file.exists():
            pytest.skip(f"Fixture not found: {fixture_file}")
        
        findings = parser.parse(fixture_file)
        
        assert len(findings) > 0
        assert all(f.severity == 'critical' for f in findings)
        assert all(f.raw_data.get('tool') == 'sqlmap' for f in findings)
        assert all(f.category == 'sql_injection' for f in findings)
    
    def test_owasp_zap_parser(self):
        """Test OWASPZAPParser."""
        parser = OWASPZAPParser()
        fixture_file = FIXTURES_DIR / 'zap_sample.json'
        
        if not fixture_file.exists():
            pytest.skip(f"Fixture not found: {fixture_file}")
        
        findings = parser.parse(fixture_file)
        
        assert len(findings) > 0
        assert all(f.raw_data.get('tool') == 'owasp_zap' for f in findings)
        assert all(f.category == 'web_vulnerability' for f in findings)
    
    def test_wpscan_parser(self):
        """Test WPScanParser."""
        parser = WPScanParser()
        fixture_file = FIXTURES_DIR / 'wpscan_sample.json'
        
        if not fixture_file.exists():
            pytest.skip(f"Fixture not found: {fixture_file}")
        
        findings = parser.parse(fixture_file)
        
        assert len(findings) > 0
        assert all(f.raw_data.get('tool') == 'wpscan' for f in findings)
        assert all(f.category == 'cms_vulnerability' for f in findings)
    
    def test_testssl_parser(self):
        """Test TestSSLParser."""
        parser = TestSSLParser()
        fixture_file = FIXTURES_DIR / 'testssl_sample.json'
        
        if not fixture_file.exists():
            pytest.skip(f"Fixture not found: {fixture_file}")
        
        findings = parser.parse(fixture_file)
        
        assert len(findings) >= 0
        assert all(f.raw_data.get('tool') == 'testssl' for f in findings) if findings else True
        assert all(f.category == 'ssl_vulnerability' for f in findings) if findings else True
    
    def test_sqlmap_can_parse(self):
        """Test SQLMapParser.can_parse()."""
        parser = SQLMapParser()
        
        assert parser.can_parse(Path('sqlmap_123.csv'))
        assert parser.can_parse(Path('SQLMAP_sample.csv'))
        assert not parser.can_parse(Path('sqlmap_123.json'))
        assert not parser.can_parse(Path('nmap_123.xml'))
    
    def test_owasp_zap_can_parse(self):
        """Test OWASPZAPParser.can_parse()."""
        parser = OWASPZAPParser()
        
        assert parser.can_parse(Path('zap_123.json'))
        assert parser.can_parse(Path('OWASP_ZAP_sample.json'))
        assert not parser.can_parse(Path('zap_123.txt'))
        assert not parser.can_parse(Path('nmap_123.xml'))
    
    def test_wpscan_can_parse(self):
        """Test WPScanParser.can_parse()."""
        parser = WPScanParser()
        
        assert parser.can_parse(Path('wpscan_123.json'))
        assert parser.can_parse(Path('WPSCAN_sample.json'))
        assert not parser.can_parse(Path('wpscan_123.txt'))
        assert not parser.can_parse(Path('nmap_123.xml'))
    
    def test_testssl_can_parse(self):
        """Test TestSSLParser.can_parse()."""
        parser = TestSSLParser()
        
        assert parser.can_parse(Path('testssl_123.json'))
        assert parser.can_parse(Path('TESTSSL_sample.json'))
        assert not parser.can_parse(Path('testssl_123.txt'))
        assert not parser.can_parse(Path('nmap_123.xml'))


