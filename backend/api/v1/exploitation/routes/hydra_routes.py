"""
Hydra Routes
============

Rutas para ataques de fuerza bruta con Hydra.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de Hydra en el blueprint."""
    
    @bp.route('/hydra/preview', methods=['POST'])
    @jwt_required()
    def preview_hydra():
        """Preview del comando Hydra."""
        data = request.get_json()
        target = data.get('target')
        service = data.get('service')
        workspace_id = data.get('workspace_id')
        username = data.get('username')
        userfile = data.get('userfile')
        password = data.get('password')
        passfile = data.get('passfile')
        port = data.get('port')
        threads = data.get('threads', 16)
        
        if not all([target, service, workspace_id]):
            return jsonify({'error': 'target, service, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_hydra_attack(
                target=target,
                service=service,
                workspace_id=workspace_id,
                username=username,
                userfile=userfile,
                password=password,
                passfile=passfile,
                port=port,
                threads=threads
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_hydra: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/hydra', methods=['POST'])
    @jwt_required()
    def hydra_attack():
        """Ataque de fuerza bruta con Hydra."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        target = data.get('target')
        service = data.get('service')
        workspace_id = data.get('workspace_id')
        
        if not all([target, service, workspace_id]):
            return jsonify({'error': 'target, service, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.start_hydra_attack(
                target=target,
                service=service,
                workspace_id=workspace_id,
                user_id=current_user_id,
                username=data.get('username'),
                userfile=data.get('userfile'),
                password=data.get('password'),
                passfile=data.get('passfile'),
                port=data.get('port'),
                threads=data.get('threads', 16)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in hydra_attack: {e}")
            return jsonify({'error': 'Internal server error'}), 500


