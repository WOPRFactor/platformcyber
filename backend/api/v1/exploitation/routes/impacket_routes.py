"""
Impacket Routes
===============

Rutas para herramientas de Impacket Suite.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de Impacket en el blueprint."""
    
    @bp.route('/impacket/psexec', methods=['POST'])
    @jwt_required()
    def impacket_psexec():
        """Ejecuta comando remoto con psexec."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'command', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_psexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                command=data['command'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_psexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/secretsdump', methods=['POST'])
    @jwt_required()
    def impacket_secretsdump():
        """Extrae secrets con secretsdump."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_secretsdump(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_secretsdump: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/getuserspns', methods=['POST'])
    @jwt_required()
    def impacket_getuserspns():
        """Obtiene SPNs con GetUserSPNs."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_getuserspns(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_getuserspns: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/wmiexec', methods=['POST'])
    @jwt_required()
    def impacket_wmiexec():
        """Ejecuta comando remoto con wmiexec."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'command', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_wmiexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                command=data['command'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_wmiexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/smbexec', methods=['POST'])
    @jwt_required()
    def impacket_smbexec():
        """Ejecuta comando remoto con smbexec."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'command', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_smbexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                command=data['command'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_smbexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/getnpusers', methods=['POST'])
    @jwt_required()
    def impacket_getnpusers():
        """Obtiene usuarios sin pre-autenticaci√≥n con GetNPUsers."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_impacket_getnpusers(
                target=data['target'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                users_file=data.get('users_file'),
                no_pass=data.get('no_pass', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in impacket_getnpusers: {e}")
            return jsonify({'error': 'Internal server error'}), 500


