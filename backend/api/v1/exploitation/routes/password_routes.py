"""
Password Attack Routes
======================

Rutas para ataques de cracking de contrase√±as.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de password attacks en el blueprint."""
    
    @bp.route('/john', methods=['POST'])
    @jwt_required()
    def john_crack():
        """Cracking de hashes con John the Ripper."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['hash_file', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_john(
                hash_file=data['hash_file'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                wordlist=data.get('wordlist'),
                format=data.get('format'),
                rules=data.get('rules', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in john_crack: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/hashcat', methods=['POST'])
    @jwt_required()
    def hashcat_crack():
        """Cracking de hashes con Hashcat."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['hash_file', 'workspace_id', 'hash_type']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_hashcat(
                hash_file=data['hash_file'],
                hash_type=data['hash_type'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                wordlist=data.get('wordlist'),
                rules_file=data.get('rules_file')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in hashcat_crack: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/kerbrute', methods=['POST'])
    @jwt_required()
    def kerbrute_attack():
        """Ataque Kerbrute contra Active Directory."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_kerbrute(
                target=data['target'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                userlist=data.get('userlist'),
                password=data.get('password'),
                passwordlist=data.get('passwordlist'),
                domain=data.get('domain')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in kerbrute_attack: {e}")
            return jsonify({'error': 'Internal server error'}), 500


