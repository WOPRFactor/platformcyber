"""
Metasploit Routes
=================

Rutas para Metasploit Framework.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de Metasploit en el blueprint."""
    
    @bp.route('/metasploit/payload', methods=['POST'])
    @jwt_required()
    def metasploit_payload():
        """Genera payload con msfvenom."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['payload_type', 'lhost', 'lport', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_metasploit_payload(
                payload_type=data['payload_type'],
                lhost=data['lhost'],
                lport=data['lport'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                format=data.get('format', 'exe'),
                encoder=data.get('encoder'),
                iterations=data.get('iterations', 0),
                output_file=data.get('output_file')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in metasploit_payload: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/metasploit/handler', methods=['POST'])
    @jwt_required()
    def metasploit_handler():
        """Inicia Metasploit Handler para recibir conexiones reversas."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['payload', 'lhost', 'lport', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields: payload, lhost, lport, workspace_id'}), 400
        
        try:
            result = exploit_service.start_metasploit_handler(
                payload=data['payload'],
                lhost=data['lhost'],
                lport=data['lport'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                exit_on_session=data.get('exit_on_session', False)
            )
            return jsonify(result), 201
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in metasploit_handler: {e}")
            return jsonify({'error': 'Internal server error'}), 500


