"""
Preview Routes
==============

Rutas para preview de comandos de explotaci√≥n.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de preview en el blueprint."""
    
    @bp.route('/john/preview', methods=['POST'])
    @jwt_required()
    def preview_john():
        """Preview del comando John the Ripper."""
        data = request.get_json()
        
        required = ['hash_file', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.preview_john(
                hash_file=data['hash_file'],
                workspace_id=data['workspace_id'],
                wordlist=data.get('wordlist'),
                format=data.get('format'),
                rules=data.get('rules', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_john: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/hashcat/preview', methods=['POST'])
    @jwt_required()
    def preview_hashcat():
        """Preview del comando Hashcat."""
        data = request.get_json()
        
        required = ['hash_file', 'hash_type', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.preview_hashcat(
                hash_file=data['hash_file'],
                hash_type=data['hash_type'],
                workspace_id=data['workspace_id'],
                wordlist=data.get('wordlist'),
                rules_file=data.get('rules_file')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_hashcat: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/kerbrute/preview', methods=['POST'])
    @jwt_required()
    def preview_kerbrute():
        """Preview del comando Kerbrute."""
        data = request.get_json()
        
        required = ['target', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.preview_kerbrute(
                target=data['target'],
                workspace_id=data['workspace_id'],
                userlist=data.get('userlist'),
                password=data.get('password'),
                passwordlist=data.get('passwordlist'),
                domain=data.get('domain')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_kerbrute: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/crackmapexec/preview', methods=['POST'])
    @jwt_required()
    def preview_crackmapexec():
        """Preview del comando CrackMapExec."""
        data = request.get_json()
        
        if not all([data.get('targets'), data.get('protocol'), data.get('workspace_id')]):
            return jsonify({'error': 'targets, protocol, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_crackmapexec_scan(
                targets=data['targets'],
                protocol=data['protocol'],
                workspace_id=data['workspace_id'],
                username=data.get('username'),
                password=data.get('password'),
                hash=data.get('hash'),
                domain=data.get('domain'),
                command=data.get('command'),
                shares=data.get('shares', False),
                pass_pol=data.get('pass_pol', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_crackmapexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/responder/preview', methods=['POST'])
    @jwt_required()
    def preview_responder():
        """Preview del comando Responder."""
        data = request.get_json()
        
        if not all([data.get('interface'), data.get('workspace_id')]):
            return jsonify({'error': 'interface and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_responder(
                interface=data['interface'],
                workspace_id=data['workspace_id'],
                lm=data.get('lm', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_responder: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/psexec/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_psexec():
        """Preview del comando psexec.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id')]):
            return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_psexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                domain=data.get('domain'),
                hash=data.get('hash'),
                command=data.get('command')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_psexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/wmiexec/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_wmiexec():
        """Preview del comando wmiexec.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id')]):
            return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_wmiexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                domain=data.get('domain'),
                hash=data.get('hash'),
                command=data.get('command')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_wmiexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/smbexec/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_smbexec():
        """Preview del comando smbexec.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id')]):
            return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_smbexec(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                domain=data.get('domain'),
                hash=data.get('hash'),
                command=data.get('command')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_smbexec: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/secretsdump/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_secretsdump():
        """Preview del comando secretsdump.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id')]):
            return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_secretsdump(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                domain=data.get('domain'),
                hash=data.get('hash'),
                just_dc=data.get('just_dc', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_secretsdump: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/getuserspns/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_getuserspns():
        """Preview del comando GetUserSPNs.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id'), data.get('domain')]):
            return jsonify({'error': 'target, username, password, workspace_id, and domain are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_getuserspns(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                domain=data['domain'],
                hash=data.get('hash'),
                request=data.get('request', True)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_getuserspns: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/impacket/getnpusers/preview', methods=['POST'])
    @jwt_required()
    def preview_impacket_getnpusers():
        """Preview del comando GetNPUsers.py."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('workspace_id'), data.get('domain')]):
            return jsonify({'error': 'target, workspace_id, and domain are required'}), 400
        
        try:
            result = exploit_service.preview_impacket_getnpusers(
                target=data['target'],
                workspace_id=data['workspace_id'],
                domain=data['domain'],
                users_file=data.get('users_file'),
                no_pass=data.get('no_pass', True)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_impacket_getnpusers: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/evilwinrm/preview', methods=['POST'])
    @jwt_required()
    def preview_evilwinrm():
        """Preview del comando Evil-WinRM."""
        data = request.get_json()
        
        if not all([data.get('target'), data.get('username'), data.get('password'), data.get('workspace_id')]):
            return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_evilwinrm(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                hash=data.get('hash'),
                ssl=data.get('ssl', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_evilwinrm: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/msfvenom/preview', methods=['POST'])
    @jwt_required()
    def preview_msfvenom():
        """Preview del comando msfvenom."""
        data = request.get_json()
        
        if not all([data.get('payload_type'), data.get('lhost'), data.get('lport'), data.get('workspace_id')]):
            return jsonify({'error': 'payload_type, lhost, lport, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_msfvenom_payload(
                payload_type=data['payload_type'],
                lhost=data['lhost'],
                lport=data['lport'],
                workspace_id=data['workspace_id'],
                format=data.get('format', 'exe'),
                encoder=data.get('encoder'),
                iterations=data.get('iterations', 0)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_msfvenom: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/metasploit-handler/preview', methods=['POST'])
    @jwt_required()
    def preview_metasploit_handler():
        """Preview del comando Metasploit Handler."""
        data = request.get_json()
        
        if not all([data.get('payload'), data.get('lhost'), data.get('lport'), data.get('workspace_id')]):
            return jsonify({'error': 'payload, lhost, lport, and workspace_id are required'}), 400
        
        try:
            result = exploit_service.preview_metasploit_handler(
                payload=data['payload'],
                lhost=data['lhost'],
                lport=data['lport'],
                workspace_id=data['workspace_id'],
                exit_on_session=data.get('exit_on_session', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_metasploit_handler: {e}")
            return jsonify({'error': 'Internal server error'}), 500

