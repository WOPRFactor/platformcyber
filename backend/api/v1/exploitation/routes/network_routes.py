"""
Network Exploitation Routes
===========================

Rutas para explotación de red.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploit_service = ExploitationService()


def register_routes(bp: Blueprint):
    """Registra las rutas de network exploitation en el blueprint."""
    
    @bp.route('/crackmapexec', methods=['POST'])
    @jwt_required()
    def crackmapexec_scan():
        """Escaneo con CrackMapExec."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_crackmapexec(
                target=data['target'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                username=data.get('username'),
                password=data.get('password'),
                hash=data.get('hash'),
                module=data.get('module')
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in crackmapexec_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/evilwinrm', methods=['POST'])
    @jwt_required()
    def evilwinrm_connect():
        """Conexión con Evil-WinRM."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['target', 'username', 'password', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_evilwinrm(
                target=data['target'],
                username=data['username'],
                password=data['password'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                hash=data.get('hash'),
                port=data.get('port', 5985),
                ssl=data.get('ssl', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in evilwinrm_connect: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/responder', methods=['POST'])
    @jwt_required()
    def responder_start():
        """LLMNR/NBT-NS Poisoning con Responder."""
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        required = ['interface', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            result = exploit_service.start_responder(
                interface=data['interface'],
                workspace_id=data['workspace_id'],
                user_id=current_user_id,
                lm=data.get('lm', False)
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in responder_start: {e}")
            return jsonify({'error': 'Internal server error'}), 500


