"""
Exploitation API
================

Endpoints para explotación de vulnerabilidades.

Herramientas:
- Hydra (brute force)
- CrackMapExec
- Impacket Suite (psexec, secretsdump, GetUserSPNs)
- Evil-WinRM
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ExploitationService

logger = logging.getLogger(__name__)

exploitation_bp = Blueprint('exploitation', __name__)

# Inicializar servicio
exploit_service = ExploitationService()


@exploitation_bp.route('/hydra/preview', methods=['POST'])
@jwt_required()
def preview_hydra():
    """Preview del comando Hydra."""
    data = request.get_json()
    target = data.get('target')
    service = data.get('service')
    workspace_id = data.get('workspace_id')
    username = data.get('username')
    userfile = data.get('userfile')
    password = data.get('password')
    passfile = data.get('passfile')
    port = data.get('port')
    threads = data.get('threads', 16)
    
    if not all([target, service, workspace_id]):
        return jsonify({'error': 'target, service, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_hydra_attack(
            target=target,
            service=service,
            workspace_id=workspace_id,
            username=username,
            userfile=userfile,
            password=password,
            passfile=passfile,
            port=port,
            threads=threads
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_hydra: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/hydra', methods=['POST'])
@jwt_required()
def hydra_attack():
    """
    Ataque de fuerza bruta con Hydra.
    
    Body:
        {
            "target": "192.168.1.10",
            "service": "ssh|smb|ftp|http-post-form",
            "workspace_id": 1,
            "username": "admin" (optional),
            "userfile": "/path/to/users.txt" (optional),
            "password": "password123" (optional),
            "passfile": "/path/to/passwords.txt" (optional),
            "port": 22 (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    service = data.get('service')
    workspace_id = data.get('workspace_id')
    
    if not all([target, service, workspace_id]):
        return jsonify({'error': 'target, service, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.start_hydra_attack(
            target=target,
            service=service,
            workspace_id=workspace_id,
            user_id=current_user_id,
            username=data.get('username'),
            userfile=data.get('userfile'),
            password=data.get('password'),
            passfile=data.get('passfile'),
            port=data.get('port')
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in hydra_attack: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/crackmapexec', methods=['POST'])
@jwt_required()
def crackmapexec_scan():
    """
    Escaneo/explotación con CrackMapExec.
    
    Body:
        {
            "targets": "192.168.1.0/24",
            "protocol": "smb|winrm|ssh|ldap|mssql",
            "workspace_id": 1,
            "username": "admin" (optional),
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "domain": "DOMAIN" (optional),
            "command": "whoami" (optional),
            "shares": false (optional),
            "pass_pol": false (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    targets = data.get('targets')
    protocol = data.get('protocol', 'smb')
    workspace_id = data.get('workspace_id')
    
    if not all([targets, workspace_id]):
        return jsonify({'error': 'targets and workspace_id are required'}), 400
    
    try:
        result = exploit_service.start_crackmapexec_scan(
            targets=targets,
            protocol=protocol,
            workspace_id=workspace_id,
            user_id=current_user_id,
            username=data.get('username'),
            password=data.get('password'),
            hash=data.get('hash'),
            domain=data.get('domain'),
            command=data.get('command'),
            shares=data.get('shares', False),
            pass_pol=data.get('pass_pol', False)
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in crackmapexec_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/psexec', methods=['POST'])
@jwt_required()
def impacket_psexec():
    """
    Ejecución remota con Impacket psexec.
    
    Body:
        {
            "target": "192.168.1.10",
            "workspace_id": 1,
            "domain": "DOMAIN",
            "username": "admin",
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "command": "whoami"
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'domain', 'username', 'command']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    if not data.get('password') and not data.get('hash'):
        return jsonify({'error': 'Either password or hash is required'}), 400
    
    try:
        result = exploit_service.start_impacket_psexec(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            domain=data['domain'],
            username=data['username'],
            password=data.get('password'),
            hash=data.get('hash'),
            command=data['command']
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_psexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/secretsdump', methods=['POST'])
@jwt_required()
def impacket_secretsdump():
    """
    Dump de credenciales con Impacket secretsdump.
    
    Body:
        {
            "target": "192.168.1.10",
            "workspace_id": 1,
            "username": "admin",
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "domain": "DOMAIN" (optional),
            "just_dc": false (optional, solo NTDS.dit)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'username']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    if not data.get('password') and not data.get('hash'):
        return jsonify({'error': 'Either password or hash is required'}), 400
    
    try:
        result = exploit_service.start_impacket_secretsdump(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            username=data['username'],
            password=data.get('password'),
            domain=data.get('domain'),
            hash=data.get('hash'),
            just_dc=data.get('just_dc', False)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_secretsdump: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/getuserspns', methods=['POST'])
@jwt_required()
def impacket_getuserspns():
    """
    Kerberoasting con Impacket GetUserSPNs.
    
    Body:
        {
            "target": "domain.local",
            "workspace_id": 1,
            "domain": "DOMAIN",
            "username": "admin",
            "password": "password",
            "dc_ip": "192.168.1.10" (optional),
            "request": true (optional, solicitar TGS tickets)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'domain', 'username', 'password']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_impacket_getuserspns(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            domain=data['domain'],
            username=data['username'],
            password=data['password'],
            dc_ip=data.get('dc_ip'),
            request=data.get('request', True)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_getuserspns: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/evilwinrm', methods=['POST'])
@jwt_required()
def evilwinrm_connect():
    """
    Conexión con Evil-WinRM.
    
    Body:
        {
            "target": "192.168.1.10",
            "workspace_id": 1,
            "username": "admin",
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "ssl": false (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'username']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    if not data.get('password') and not data.get('hash'):
        return jsonify({'error': 'Either password or hash is required'}), 400
    
    try:
        result = exploit_service.start_evilwinrm(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            username=data['username'],
            password=data.get('password'),
            hash=data.get('hash'),
            ssl=data.get('ssl', False)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in evilwinrm_connect: {e}")
        return jsonify({'error': 'Internal server error'}), 500


# ============================================
# PASSWORD ATTACKS - Endpoints adicionales
# ============================================

@exploitation_bp.route('/john', methods=['POST'])
@jwt_required()
def john_crack():
    """
    Cracking de hashes con John the Ripper.
    
    Body:
        {
            "hash_file": "/path/to/hashes.txt",
            "workspace_id": 1,
            "wordlist": "/path/to/wordlist.txt" (optional),
            "format": "NT|Raw-MD5|sha512crypt" (optional),
            "rules": false (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['hash_file', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_john(
            hash_file=data['hash_file'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            wordlist=data.get('wordlist'),
            format=data.get('format'),
            rules=data.get('rules', False)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in john_crack: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/hashcat', methods=['POST'])
@jwt_required()
def hashcat_crack():
    """
    Cracking GPU acelerado con Hashcat.
    
    Body:
        {
            "hash_file": "/path/to/hashes.txt",
            "workspace_id": 1,
            "mode": 1000 (NTLM) | 0 (MD5) | 5600 (NetNTLMv2) | 1800 (SHA-512),
            "wordlist": "/path/to/wordlist.txt",
            "rules_file": "/path/to/rules.rule" (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['hash_file', 'workspace_id', 'mode', 'wordlist']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_hashcat(
            hash_file=data['hash_file'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            mode=data['mode'],
            wordlist=data['wordlist'],
            rules_file=data.get('rules_file')
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in hashcat_crack: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/kerbrute', methods=['POST'])
@jwt_required()
def kerbrute_attack():
    """
    Enumeración y bruteforce Kerberos con Kerbrute.
    
    Body:
        {
            "domain": "domain.local",
            "workspace_id": 1,
            "mode": "userenum|passwordspray|bruteuser",
            "users_file": "/path/to/users.txt" (required for userenum/passwordspray),
            "passwords_file": "/path/to/passwords.txt" (required for bruteuser),
            "password": "Password123" (required for passwordspray),
            "dc_ip": "192.168.1.10" (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['domain', 'workspace_id', 'mode']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_kerbrute(
            domain=data['domain'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            mode=data['mode'],
            users_file=data.get('users_file'),
            passwords_file=data.get('passwords_file'),
            password=data.get('password'),
            dc_ip=data.get('dc_ip')
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in kerbrute_attack: {e}")
        return jsonify({'error': 'Internal server error'}), 500


# ============================================
# NETWORK EXPLOITATION - Endpoints adicionales
# ============================================

@exploitation_bp.route('/responder', methods=['POST'])
@jwt_required()
def responder_start():
    """
    LLMNR/NBT-NS Poisoning con Responder.
    
    Body:
        {
            "interface": "eth0",
            "workspace_id": 1,
            "lm": false (optional, capturar LM hashes)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['interface', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_responder(
            interface=data['interface'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            lm=data.get('lm', False)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in responder_start: {e}")
        return jsonify({'error': 'Internal server error'}), 500


# ============================================
# IMPACKET SUITE - Endpoints adicionales
# ============================================

@exploitation_bp.route('/impacket/wmiexec', methods=['POST'])
@jwt_required()
def impacket_wmiexec():
    """
    Ejecución remota con Impacket wmiexec.
    
    Body:
        {
            "target": "192.168.1.10",
            "workspace_id": 1,
            "username": "admin",
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "domain": "DOMAIN" (optional),
            "command": "whoami"
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'username', 'command']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    if not data.get('password') and not data.get('hash'):
        return jsonify({'error': 'Either password or hash is required'}), 400
    
    try:
        result = exploit_service.start_impacket_wmiexec(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            username=data['username'],
            password=data.get('password'),
            domain=data.get('domain'),
            hash=data.get('hash'),
            command=data['command']
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_wmiexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/smbexec', methods=['POST'])
@jwt_required()
def impacket_smbexec():
    """
    Ejecución remota con Impacket smbexec.
    
    Body:
        {
            "target": "192.168.1.10",
            "workspace_id": 1,
            "username": "admin",
            "password": "password" (optional),
            "hash": "NTLM_HASH" (optional),
            "domain": "DOMAIN" (optional),
            "command": "whoami"
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['target', 'workspace_id', 'username', 'command']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    if not data.get('password') and not data.get('hash'):
        return jsonify({'error': 'Either password or hash is required'}), 400
    
    try:
        result = exploit_service.start_impacket_smbexec(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            username=data['username'],
            password=data.get('password'),
            domain=data.get('domain'),
            hash=data.get('hash'),
            command=data['command']
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_smbexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/getnpusers', methods=['POST'])
@jwt_required()
def impacket_getnpusers():
    """
    AS-REP Roasting con Impacket GetNPUsers.
    
    Body:
        {
            "domain": "domain.local",
            "workspace_id": 1,
            "users_file": "/path/to/users.txt" (optional),
            "username": "user" (optional),
            "dc_ip": "192.168.1.10" (optional),
            "no_pass": true (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['domain', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_impacket_getnpusers(
            domain=data['domain'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            users_file=data.get('users_file'),
            username=data.get('username'),
            dc_ip=data.get('dc_ip'),
            no_pass=data.get('no_pass', True)
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in impacket_getnpusers: {e}")
        return jsonify({'error': 'Internal server error'}), 500


# ============================================
# PAYLOADS - Endpoints
# ============================================

@exploitation_bp.route('/metasploit/payload', methods=['POST'])
@jwt_required()
def metasploit_payload():
    """
    Genera payload con msfvenom.
    
    Body:
        {
            "payload_type": "windows/x64/meterpreter/reverse_tcp",
            "lhost": "192.168.1.100",
            "lport": 4444,
            "workspace_id": 1,
            "format": "exe|elf|raw|asp|aspx|php|jsp" (optional, default: exe),
            "encoder": "x64/xor_dynamic" (optional),
            "iterations": 5 (optional),
            "output_file": "/path/to/output" (optional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['payload_type', 'lhost', 'lport', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        result = exploit_service.start_metasploit_payload(
            payload_type=data['payload_type'],
            lhost=data['lhost'],
            lport=data['lport'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            format=data.get('format', 'exe'),
            encoder=data.get('encoder'),
            iterations=data.get('iterations', 0),
            output_file=data.get('output_file')
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in metasploit_payload: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/metasploit/handler', methods=['POST'])
@jwt_required()
def metasploit_handler():
    """
    Inicia Metasploit Handler para recibir conexiones reversas.
    
    Body:
        {
            "payload": "windows/x64/meterpreter/reverse_tcp",
            "lhost": "192.168.1.100",
            "lport": 4444,
            "workspace_id": 1,
            "exit_on_session": false (optional, default: false)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    required = ['payload', 'lhost', 'lport', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields: payload, lhost, lport, workspace_id'}), 400
    
    try:
        result = exploit_service.start_metasploit_handler(
            payload=data['payload'],
            lhost=data['lhost'],
            lport=data['lport'],
            workspace_id=data['workspace_id'],
            user_id=current_user_id,
            exit_on_session=data.get('exit_on_session', False)
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in metasploit_handler: {e}")
        return jsonify({'error': 'Internal server error'}), 500




# ============================================
# PREVIEW ENDPOINTS
# ============================================

@exploitation_bp.route('/john/preview', methods=['POST'])
@jwt_required()
def preview_john():
    """Preview del comando John the Ripper."""
    data = request.get_json()
    hash_file = data.get('hash_file')
    workspace_id = data.get('workspace_id')
    wordlist = data.get('wordlist')
    format = data.get('format')
    rules = data.get('rules', False)
    
    if not hash_file or not workspace_id:
        return jsonify({'error': 'hash_file and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_john(
            hash_file=hash_file,
            workspace_id=workspace_id,
            wordlist=wordlist,
            format=format,
            rules=rules
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_john: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/hashcat/preview', methods=['POST'])
@jwt_required()
def preview_hashcat():
    """Preview del comando Hashcat."""
    data = request.get_json()
    hash_file = data.get('hash_file')
    workspace_id = data.get('workspace_id')
    mode = data.get('mode')
    wordlist = data.get('wordlist')
    rules_file = data.get('rules_file')
    
    if not all([hash_file, workspace_id, mode, wordlist]):
        return jsonify({'error': 'hash_file, workspace_id, mode, and wordlist are required'}), 400
    
    try:
        result = exploit_service.preview_hashcat(
            hash_file=hash_file,
            workspace_id=workspace_id,
            mode=mode,
            wordlist=wordlist,
            rules_file=rules_file
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_hashcat: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/kerbrute/preview', methods=['POST'])
@jwt_required()
def preview_kerbrute():
    """Preview del comando Kerbrute."""
    data = request.get_json()
    domain = data.get('domain')
    workspace_id = data.get('workspace_id')
    mode = data.get('mode')
    users_file = data.get('users_file')
    passwords_file = data.get('passwords_file')
    password = data.get('password')
    dc_ip = data.get('dc_ip')
    
    if not all([domain, workspace_id, mode]):
        return jsonify({'error': 'domain, workspace_id, and mode are required'}), 400
    
    try:
        result = exploit_service.preview_kerbrute(
            domain=domain,
            workspace_id=workspace_id,
            mode=mode,
            users_file=users_file,
            passwords_file=passwords_file,
            password=password,
            dc_ip=dc_ip
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_kerbrute: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/crackmapexec/preview', methods=['POST'])
@jwt_required()
def preview_crackmapexec():
    """Preview del comando CrackMapExec."""
    data = request.get_json()
    targets = data.get('targets')
    protocol = data.get('protocol')
    workspace_id = data.get('workspace_id')
    username = data.get('username')
    password = data.get('password')
    hash = data.get('hash')
    domain = data.get('domain')
    command = data.get('command')
    shares = data.get('shares', False)
    pass_pol = data.get('pass_pol', False)
    
    if not all([targets, protocol, workspace_id]):
        return jsonify({'error': 'targets, protocol, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_crackmapexec_scan(
            targets=targets,
            protocol=protocol,
            workspace_id=workspace_id,
            username=username,
            password=password,
            hash=hash,
            domain=domain,
            command=command,
            shares=shares,
            pass_pol=pass_pol
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_crackmapexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/responder/preview', methods=['POST'])
@jwt_required()
def preview_responder():
    """Preview del comando Responder."""
    data = request.get_json()
    interface = data.get('interface')
    workspace_id = data.get('workspace_id')
    lm = data.get('lm', False)
    
    if not interface or not workspace_id:
        return jsonify({'error': 'interface and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_responder(
            interface=interface,
            workspace_id=workspace_id,
            lm=lm
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_responder: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/psexec/preview', methods=['POST'])
@jwt_required()
def preview_impacket_psexec():
    """Preview del comando psexec.py."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    hash = data.get('hash')
    command = data.get('command')
    
    if not all([target, username, password, workspace_id]):
        return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_psexec(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            domain=domain,
            hash=hash,
            command=command
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_psexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/wmiexec/preview', methods=['POST'])
@jwt_required()
def preview_impacket_wmiexec():
    """Preview del comando wmiexec.py."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    hash = data.get('hash')
    command = data.get('command')
    
    if not all([target, username, password, workspace_id]):
        return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_wmiexec(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            domain=domain,
            hash=hash,
            command=command
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_wmiexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/smbexec/preview', methods=['POST'])
@jwt_required()
def preview_impacket_smbexec():
    """Preview del comando smbexec.py."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    hash = data.get('hash')
    command = data.get('command')
    
    if not all([target, username, password, workspace_id]):
        return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_smbexec(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            domain=domain,
            hash=hash,
            command=command
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_smbexec: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/secretsdump/preview', methods=['POST'])
@jwt_required()
def preview_impacket_secretsdump():
    """Preview del comando secretsdump.py."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    hash = data.get('hash')
    just_dc = data.get('just_dc', False)
    
    if not all([target, username, password, workspace_id]):
        return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_secretsdump(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            domain=domain,
            hash=hash,
            just_dc=just_dc
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_secretsdump: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/getuserspns/preview', methods=['POST'])
@jwt_required()
def preview_impacket_getuserspns():
    """Preview del comando GetUserSPNs.py."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    hash = data.get('hash')
    request = data.get('request', True)
    
    if not all([target, username, password, workspace_id, domain]):
        return jsonify({'error': 'target, username, password, workspace_id, and domain are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_getuserspns(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            domain=domain,
            hash=hash,
            request=request
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_getuserspns: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/impacket/getnpusers/preview', methods=['POST'])
@jwt_required()
def preview_impacket_getnpusers():
    """Preview del comando GetNPUsers.py."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    users_file = data.get('users_file')
    no_pass = data.get('no_pass', True)
    
    if not all([target, workspace_id, domain]):
        return jsonify({'error': 'target, workspace_id, and domain are required'}), 400
    
    try:
        result = exploit_service.preview_impacket_getnpusers(
            target=target,
            workspace_id=workspace_id,
            domain=domain,
            users_file=users_file,
            no_pass=no_pass
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_impacket_getnpusers: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/evilwinrm/preview', methods=['POST'])
@jwt_required()
def preview_evilwinrm():
    """Preview del comando Evil-WinRM."""
    data = request.get_json()
    target = data.get('target')
    username = data.get('username')
    password = data.get('password')
    workspace_id = data.get('workspace_id')
    hash = data.get('hash')
    ssl = data.get('ssl', False)
    
    if not all([target, username, password, workspace_id]):
        return jsonify({'error': 'target, username, password, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_evilwinrm(
            target=target,
            username=username,
            password=password,
            workspace_id=workspace_id,
            hash=hash,
            ssl=ssl
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_evilwinrm: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/msfvenom/preview', methods=['POST'])
@jwt_required()
def preview_msfvenom():
    """Preview del comando msfvenom."""
    data = request.get_json()
    payload_type = data.get('payload_type')
    lhost = data.get('lhost')
    lport = data.get('lport')
    workspace_id = data.get('workspace_id')
    format = data.get('format', 'exe')
    encoder = data.get('encoder')
    iterations = data.get('iterations', 0)
    
    if not all([payload_type, lhost, lport, workspace_id]):
        return jsonify({'error': 'payload_type, lhost, lport, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_msfvenom_payload(
            payload_type=payload_type,
            lhost=lhost,
            lport=lport,
            workspace_id=workspace_id,
            format=format,
            encoder=encoder,
            iterations=iterations
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_msfvenom: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@exploitation_bp.route('/metasploit-handler/preview', methods=['POST'])
@jwt_required()
def preview_metasploit_handler():
    """Preview del comando Metasploit Handler."""
    data = request.get_json()
    payload = data.get('payload')
    lhost = data.get('lhost')
    lport = data.get('lport')
    workspace_id = data.get('workspace_id')
    exit_on_session = data.get('exit_on_session', False)
    
    if not all([payload, lhost, lport, workspace_id]):
        return jsonify({'error': 'payload, lhost, lport, and workspace_id are required'}), 400
    
    try:
        result = exploit_service.preview_metasploit_handler(
            payload=payload,
            lhost=lhost,
            lport=lport,
            workspace_id=workspace_id,
            exit_on_session=exit_on_session
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_metasploit_handler: {e}")
        return jsonify({'error': 'Internal server error'}), 500
