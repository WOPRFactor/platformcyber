"""
Comprehensive Scan Routes
========================

Rutas para evaluaci贸n completa de vulnerabilidades.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de Comprehensive Scan."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/comprehensive/preview', methods=['POST'])
    def preview_comprehensive():
        """Preview del comando Comprehensive Vulnerability Assessment."""
        from flask_jwt_extended import verify_jwt_in_request
        try:
            verify_jwt_in_request()
        except Exception:
            return jsonify({'error': 'Authentication required'}), 401
        
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        include_nikto = data.get('include_nikto', True)
        include_nmap = data.get('include_nmap', True)
        include_nuclei = data.get('include_nuclei', True)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_comprehensive_scan(
                target=target,
                workspace_id=workspace_id,
                include_nikto=include_nikto,
                include_nmap=include_nmap,
                include_nuclei=include_nuclei
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_comprehensive: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/comprehensive/<target>', methods=['POST', 'OPTIONS'])
    def comprehensive_scan(target):
        """
        Inicia evaluaci贸n completa de vulnerabilidades (Nikto + Nmap + Nuclei).
        
        Args:
            target: URL o host objetivo (en la URL)
        
        Body (opcional):
            {
                "workspace_id": 1,
                "options": {
                    "include_nikto": true,
                    "include_nmap": true,
                    "include_nuclei": true
                }
            }
        """
        # Manejar preflight OPTIONS antes de requerir autenticaci贸n
        if request.method == 'OPTIONS':
            return '', 204
        
        # Para POST, requerir autenticaci贸n
        from flask_jwt_extended import verify_jwt_in_request
        try:
            verify_jwt_in_request()
            current_user_id = get_jwt_identity()
        except Exception as e:
            logger.error(f"JWT verification failed: {e}")
            return jsonify({'error': 'Authentication required'}), 401
        
        # Obtener datos del body (igual que otros endpoints)
        data = request.get_json() or {}
        
        # Obtener workspace_id del body o query params
        workspace_id = data.get('workspace_id') or request.args.get('workspace_id', type=int)
        
        if not workspace_id:
            logger.error(f"Missing workspace_id in comprehensive scan. Data: {data}, Args: {request.args}")
            return jsonify({'error': 'workspace_id is required'}), 400
        
        # Opciones de escaneo
        options = data.get('options', {})
        include_nikto = options.get('include_nikto', True)
        include_nmap = options.get('include_nmap', True)
        include_nuclei = options.get('include_nuclei', True)
        
        try:
            result = vuln_service.start_comprehensive_scan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                include_nikto=include_nikto,
                include_nmap=include_nmap,
                include_nuclei=include_nuclei
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in comprehensive_scan: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500


