"""
SQLMap Routes
=============

Rutas para escaneo con SQLMap.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de SQLMap."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/sqlmap/preview', methods=['POST'])
    @jwt_required()
    def preview_sqlmap():
        """Preview del comando SQLMap."""
        data = request.get_json()
        url = data.get('url')
        workspace_id = data.get('workspace_id')
        method = data.get('method', 'GET')
        data_param = data.get('data')
        level = data.get('level', 1)
        risk = data.get('risk', 1)
        techniques = data.get('techniques')
        
        if not url or not workspace_id:
            return jsonify({'error': 'URL and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_sqlmap_scan(
                url=url,
                workspace_id=workspace_id,
                method=method,
                data=data_param,
                level=level,
                risk=risk,
                techniques=techniques
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_sqlmap: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/sqlmap', methods=['POST'])
    @jwt_required()
    def sqlmap_scan():
        """
        Inicia escaneo con SQLMap (MODO SEGURO - sin --dump-all).
        
        Body:
            {
                "url": "https://example.com/page?id=1",
                "workspace_id": 1,
                "database": "dbname",
                "table": "users",
                "cookies": "session=abc123"
            }
        """
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        url = data.get('url')
        workspace_id = data.get('workspace_id')
        database = data.get('database')
        table = data.get('table')
        cookies = data.get('cookies')
        
        if not url or not workspace_id:
            return jsonify({'error': 'URL and workspace_id are required'}), 400
        
        try:
            result = vuln_service.start_sqlmap_scan(
                url=url,
                workspace_id=workspace_id,
                user_id=current_user_id,
                cookies=cookies,
                database=database,
                table=table
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in sqlmap_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

