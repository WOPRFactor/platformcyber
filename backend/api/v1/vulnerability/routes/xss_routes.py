"""
XSS Multi-Tool Scanner Routes
==============================

Rutas para escaneo XSS con múltiples herramientas.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import XSSScannerService
from repositories import ScanRepository
from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de XSS Scanner."""
    xss_scanner_service = XSSScannerService()
    vuln_service = VulnerabilityService()
    
    @bp.route('/xss/available-tools', methods=['GET'])
    @jwt_required()
    def xss_available_tools():
        """
        Verifica qué herramientas XSS están disponibles.
        
        Returns:
            {
                "xsstrike": true,
                "xsser": true,
                "zap": false,
                "nuclei": true
            }
        """
        try:
            availability = xss_scanner_service.check_tool_availability()
            return jsonify(availability), 200
        except Exception as e:
            logger.error(f"Error checking XSS tools availability: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/xss/preview', methods=['POST'])
    @jwt_required()
    def preview_xss():
        """
        Preview del comando XSS que se ejecutará.
        
        Body:
            {
                "url": "https://example.com/page?param=value",
                "workspace_id": 1,
                "engine": "auto|xsstrike|xsser|zap|nuclei",
                "scan_mode": "single|all|compare",
                "engines": ["xsstrike", "xsser"],
                "options": {...}
            }
        """
        data = request.get_json()
        url = data.get('url')
        workspace_id = data.get('workspace_id')
        engine = data.get('engine', 'auto')
        scan_mode = data.get('scan_mode', 'single')
        engines = data.get('engines')
        options = data.get('options', {})
        
        if not url or not workspace_id:
            return jsonify({'error': 'URL and workspace_id are required'}), 400
        
        try:
            result = xss_scanner_service.preview_xss_command(
                url=url,
                workspace_id=workspace_id,
                engine=engine,
                scan_mode=scan_mode,
                engines=engines,
                options=options
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_xss: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/xss', methods=['POST'])
    @jwt_required()
    def xss_scan():
        """
        Escanea XSS con múltiples herramientas.
        
        Body:
            {
                "url": "https://example.com/page?param=value",
                "workspace_id": 1,
                "engine": "auto|xsstrike|xsser|zap|nuclei",
                "scan_mode": "single|all|compare",
                "engines": ["xsstrike", "xsser"],
                "options": {...}
            }
        """
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        url = data.get('url')
        workspace_id = data.get('workspace_id')
        engine = data.get('engine', 'auto')
        scan_mode = data.get('scan_mode', 'single')
        engines = data.get('engines')
        options = data.get('options', {})
        
        if not url or not workspace_id:
            return jsonify({'error': 'URL and workspace_id are required'}), 400
        
        try:
            result = xss_scanner_service.start_xss_scan(
                url=url,
                workspace_id=workspace_id,
                user_id=current_user_id,
                engine=engine,
                scan_mode=scan_mode,
                engines=engines,
                options=options
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in xss_scan: {e}")
            return jsonify({'error': str(e)}), 500
    
    @bp.route('/xss/<int:scan_id>/comparison', methods=['GET'])
    @jwt_required()
    def xss_scan_comparison(scan_id: int):
        """
        Obtiene resultados comparativos de un scan en modo COMPARE.
        
        Returns:
            {
                "scan_id": 123,
                "mode": "compare",
                "engines": ["xsstrike", "xsser"],
                "results_by_tool": {...},
                "consolidated": [...],
                "statistics": {...}
            }
        """
        try:
            scan_repo = ScanRepository()
            scan = scan_repo.find_by_id(scan_id)
            
            if not scan:
                return jsonify({'error': 'Scan not found'}), 404
            
            results = vuln_service.get_scan_results(scan_id)
            
            scan_mode = scan.options.get('scan_mode') if scan.options else 'single'
            engines = scan.options.get('engines', []) if scan.options else []
            
            if scan_mode in ['compare', 'all']:
                return jsonify({
                    'scan_id': scan_id,
                    'mode': scan_mode,
                    'engines': engines,
                    'results': results,
                    'status': scan.status
                }), 200
            else:
                return jsonify({
                    'scan_id': scan_id,
                    'mode': scan_mode,
                    'results': results,
                    'status': scan.status
                }), 200
                
        except Exception as e:
            logger.error(f"Error in xss_scan_comparison: {e}")
            return jsonify({'error': 'Internal server error'}), 500

