<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte Técnico - {{ workspace_name }}</title>
    <style>
        /* =================================================================
           ESTILOS PARA WEASYPRINT - REPORTE TÉCNICO PROFESIONAL
           ================================================================= */
        
        /* --- PORTADA --- */
        .cover-page {
            text-align: center;
            padding-top: 200pt;
        }
        
        .cover-title {
            font-size: 36pt;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 20pt;
        }
        
        .cover-subtitle {
            font-size: 20pt;
            color: #7f8c8d;
            margin-bottom: 40pt;
        }
        
        .cover-info {
            font-size: 14pt;
            color: #555;
            line-height: 2;
        }
        
        /* --- RISK SCORE BOX --- */
        .risk-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20pt;
            border-radius: 10pt;
            text-align: center;
            margin: 20pt 0;
            page-break-inside: avoid;
        }
        
        .risk-score {
            font-size: 48pt;
            font-weight: bold;
            margin: 10pt 0;
        }
        
        .risk-level {
            font-size: 18pt;
            text-transform: uppercase;
            letter-spacing: 2pt;
        }
        
        /* --- STATS GRID --- */
        .stats-grid {
            display: table;
            width: 100%;
            margin: 20pt 0;
        }
        
        .stat-row {
            display: table-row;
        }
        
        .stat-cell {
            display: table-cell;
            width: 25%;
            padding: 15pt;
            text-align: center;
            border: 1pt solid #e0e0e0;
        }
        
        .stat-number {
            font-size: 36pt;
            font-weight: bold;
            margin: 10pt 0;
        }
        
        .stat-number.critical { color: #e74c3c; }
        .stat-number.high { color: #e67e22; }
        .stat-number.medium { color: #f39c12; }
        .stat-number.info { color: #3498db; }
        
        .stat-label {
            font-size: 10pt;
            color: #666;
            text-transform: uppercase;
        }
        
        /* --- FINDING CARD --- */
        .finding-card {
            border-left: 5pt solid #e74c3c;
            background: #f8f9fa;
            padding: 15pt;
            margin: 15pt 0;
            border-radius: 5pt;
            page-break-inside: avoid;
        }
        
        .finding-card.high { border-left-color: #e67e22; }
        .finding-card.medium { border-left-color: #f39c12; }
        .finding-card.low { border-left-color: #3498db; }
        .finding-card.info { border-left-color: #95a5a6; }
        
        .finding-header {
            margin-bottom: 10pt;
        }
        
        .finding-title {
            font-size: 14pt;
            font-weight: bold;
            color: #2c3e50;
            display: inline;
        }
        
        .finding-severity {
            float: right;
        }
        
        .finding-description {
            color: #555;
            margin: 8pt 0;
            line-height: 1.6;
        }
        
        .finding-target {
            background: #fff;
            padding: 8pt;
            border-radius: 4pt;
            font-family: 'Courier New', monospace;
            font-size: 10pt;
            color: #333;
            margin: 8pt 0;
        }
        
        .finding-evidence {
            background: #fffbf0;
            border-left: 3pt solid #f39c12;
            padding: 10pt;
            margin: 10pt 0;
            font-size: 10pt;
        }
        
        .finding-remediation {
            background: #f0fff4;
            border-left: 3pt solid #28a745;
            padding: 10pt;
            margin: 10pt 0;
        }
        
        .finding-metadata {
            margin-top: 8pt;
            font-size: 10pt;
            color: #666;
        }
        
        /* --- SECTION BOX --- */
        .section-box {
            background: #f8f9fa;
            border: 1pt solid #e0e0e0;
            padding: 15pt;
            margin: 15pt 0;
            border-radius: 5pt;
            page-break-inside: avoid;
        }
        
        /* --- ALERT BOX --- */
        .alert-critical {
            background: #f8d7da;
            border-left: 4pt solid #e74c3c;
            padding: 12pt;
            margin: 15pt 0;
            border-radius: 4pt;
        }
    </style>
</head>
<body>
    <!-- =================================================================
         PORTADA
         ================================================================= -->
    <div class="cover-page">
        <div class="cover-title">Reporte Técnico de Seguridad</div>
        <div class="cover-subtitle">Evaluación de Vulnerabilidades</div>
        <div class="cover-info">
            <strong>Workspace:</strong> {{ workspace_name }}<br>
            <strong>Fecha:</strong> {{ report_date }}<br>
            <strong>Hora:</strong> {{ report_time }}
        </div>
    </div>
    
    <!-- Nueva página -->
    <div style="page-break-before: always;"></div>
    
    <!-- =================================================================
         RESUMEN EJECUTIVO
         ================================================================= -->
    <h1>Resumen Ejecutivo</h1>
    
    <div class="risk-box">
        <div>Puntuación de Riesgo Global</div>
        <div class="risk-score">{{ "%.1f"|format(risk_score) }}/10</div>
        <div class="risk-level">{{ risk_level.upper() }}</div>
    </div>
    
    <div class="section-box">
        <p>
            Se realizó una evaluación de seguridad integral de <strong>{{ workspace_name }}</strong>. 
            El análisis identificó <strong>{{ total_findings }} hallazgos</strong> de severidad variable.
        </p>
        {% if severity_distribution.get('critical', 0) > 0 %}
        <p style="margin-top: 10pt; color: #e74c3c;">
            ⚠️ Se encontraron <strong>{{ severity_distribution.get('critical', 0) }} vulnerabilidades críticas</strong> 
            que requieren atención inmediata.
        </p>
        {% endif %}
    </div>
    
    <h2>Estadísticas del Escaneo</h2>
    
    <!-- Gráficos de visualización -->
    {% if charts %}
    <h3>Visualizaciones</h3>
    
    <div style="text-align: center; margin: 20pt 0;">
        {% if charts.risk_gauge %}
        <img src="file://{{ charts.risk_gauge }}" alt="Risk Gauge" style="max-width: 500px; margin-bottom: 20pt;">
        {% endif %}
    </div>
    
    <div style="display: table; width: 100%; margin: 20pt 0;">
        {% if charts.severity_pie %}
        <div style="display: table-cell; width: 50%; padding: 10pt; text-align: center;">
            <img src="file://{{ charts.severity_pie }}" alt="Severity Distribution" style="width: 95%;">
        </div>
        {% endif %}
        
        {% if charts.category_bar %}
        <div style="display: table-cell; width: 50%; padding: 10pt; text-align: center;">
            <img src="file://{{ charts.category_bar }}" alt="Category Distribution" style="width: 95%;">
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="stats-grid">
        <div class="stat-row">
            <div class="stat-cell">
                <div class="stat-label">Críticas</div>
                <div class="stat-number critical">{{ severity_distribution.get('critical', 0) or 0 }}</div>
            </div>
            <div class="stat-cell">
                <div class="stat-label">Altas</div>
                <div class="stat-number high">{{ severity_distribution.get('high', 0) or 0 }}</div>
            </div>
            <div class="stat-cell">
                <div class="stat-label">Medias</div>
                <div class="stat-number medium">{{ severity_distribution.get('medium', 0) or 0 }}</div>
            </div>
            <div class="stat-cell">
                <div class="stat-label">Bajas/Info</div>
                <div class="stat-number info">{{ (severity_distribution.get('low', 0) or 0) + (severity_distribution.get('info', 0) or 0) }}</div>
            </div>
        </div>
    </div>
    
    <table>
        <tr>
            <th>Métrica</th>
            <th>Valor</th>
        </tr>
        <tr>
            <td>Total de Hallazgos</td>
            <td><strong>{{ total_findings }}</strong></td>
        </tr>
        <tr>
            <td>Archivos Procesados</td>
            <td>{{ total_files }}</td>
        </tr>
        <tr>
            <td>Targets Únicos</td>
            <td>{{ unique_targets }}</td>
        </tr>
        <tr>
            <td>Herramientas Utilizadas</td>
            <td>{{ tools_used|join(', ') if tools_used else 'N/A' }}</td>
        </tr>
        <tr>
            <td>Tiempo de Generación</td>
            <td>{{ "%.2f"|format(generation_time) }} segundos</td>
        </tr>
    </table>
    
    <!-- Nueva página -->
    <div style="page-break-before: always;"></div>
    
    <!-- =================================================================
         HALLAZGOS CRÍTICOS Y ALTOS
         ================================================================= -->
    {% if critical_findings %}
    <h1>Hallazgos Críticos y Altos</h1>
    
    {% if severity_distribution.get('critical', 0) > 0 %}
    <div class="alert-critical">
        <strong>⚠️ ATENCIÓN:</strong> Se identificaron vulnerabilidades de severidad crítica que requieren 
        remediación inmediata. Estas vulnerabilidades representan un riesgo significativo para la seguridad 
        del sistema.
    </div>
    {% endif %}
    
    {% for finding in critical_findings %}
    <div class="finding-card {{ finding.severity }}">
        <div class="finding-header">
            <div class="finding-title">{{ finding.title }}</div>
            <span class="finding-severity">
                <span class="severity-{{ finding.severity }}">{{ finding.severity.upper() }}</span>
            </span>
        </div>
        
        <div class="finding-target">
            <strong>Target:</strong> {{ finding.affected_target }}
        </div>
        
        {% if finding.description %}
        <div class="finding-description">
            {{ finding.description }}
        </div>
        {% endif %}
        
        {% if finding.evidence %}
        <div class="finding-evidence">
            <strong>Evidencia:</strong><br>
            {{ finding.evidence[:200] }}{% if finding.evidence|length > 200 %}...{% endif %}
        </div>
        {% endif %}
        
        {% if finding.remediation %}
        <div class="finding-remediation">
            <strong>Remediación:</strong><br>
            {{ finding.remediation }}
        </div>
        {% endif %}
        
        <div class="finding-metadata">
            {% if finding.cve_id %}
            <strong>CVE:</strong> {{ finding.cve_id }}<br>
            {% endif %}
            {% if finding.references %}
            <strong>Referencias:</strong>
            {% for ref in finding.references[:2] %}
                {{ ref }}{% if not loop.last %}, {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
    {% endif %}
    
    <!-- Nueva página -->
    <div style="page-break-before: always;"></div>
    
    <!-- =================================================================
         HALLAZGOS DETALLADOS POR CATEGORÍA
         ================================================================= -->
    <h1>Hallazgos Detallados por Categoría</h1>
    
    {% for category, category_findings in findings_by_category.items() %}
    <h2>{{ category|replace('_', ' ')|title }}</h2>
    
    <p>Total de hallazgos en esta categoría: <strong>{{ category_findings|length }}</strong></p>
    
    {% for finding in category_findings %}
    <div class="finding-card {{ finding.severity }}">
        <div class="finding-header">
            <div class="finding-title">{{ finding.title }}</div>
            <span class="finding-severity">
                <span class="severity-{{ finding.severity }}">{{ finding.severity.upper() }}</span>
            </span>
        </div>
        
        <div class="finding-target">
            <strong>Target:</strong> {{ finding.affected_target }}
        </div>
        
        {% if finding.description %}
        <div class="finding-description">
            {{ finding.description }}
        </div>
        {% endif %}
        
        {% if finding.evidence %}
        <div class="finding-evidence">
            <strong>Evidencia:</strong><br>
            {{ finding.evidence[:500] }}{% if finding.evidence|length > 500 %}...{% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    
    {% endfor %}
    
    <!-- =================================================================
         CONCLUSIÓN
         ================================================================= -->
    <div style="page-break-before: always;"></div>
    
    <h1>Conclusión</h1>
    
    <div class="section-box">
        <p>
            Este reporte técnico documenta los hallazgos de seguridad identificados durante 
            la evaluación de <strong>{{ workspace_name }}</strong>.
        </p>
        
        {% if severity_distribution.get('critical', 0) > 0 or severity_distribution.get('high', 0) > 0 %}
        <p style="margin-top: 10pt; color: #e74c3c;">
            Se recomienda priorizar la remediación de las vulnerabilidades críticas y altas 
            documentadas en este reporte.
        </p>
        {% endif %}
        
        <p style="margin-top: 10pt;">
            Para más información o asistencia en la remediación, por favor contacte al equipo 
            de seguridad.
        </p>
    </div>
    
    <div style="margin-top: 30pt; padding: 15pt; background: #e8f4f8; border-radius: 5pt;">
        <p style="font-size: 10pt; color: #666; text-align: center;">
            Reporte generado automáticamente el {{ report_date }} a las {{ report_time }}<br>
            Workspace: {{ workspace_name }} | Total de hallazgos: {{ total_findings }}
        </p>
    </div>
</body>
</html>

