"""
Parser para WPScan - WordPress security scanner.
Formato: JSON con versión, plugins y vulnerabilidades.
"""

from pathlib import Path
from typing import List
from ..base_parser import BaseParser, ParsedFinding


class WPScanParser(BaseParser):
    """Parser para archivos JSON de WPScan."""
    
    def can_parse(self, file_path: Path) -> bool:
        """Verifica si el archivo puede ser parseado."""
        filename = file_path.name.lower()
        return 'wpscan' in filename and file_path.suffix == '.json'
    
    def parse(self, file_path: Path) -> List[ParsedFinding]:
        """
        Parsea archivo JSON de WPScan.
        """
        findings = []
        
        try:
            data = self._safe_parse_json(file_path)
            if not data:
                return findings
            
            url = data.get('url', 'unknown')
            
            # Parsear versión de WordPress
            version_info = data.get('version', {})
            wp_version = version_info.get('number', 'unknown')
            version_vulns = version_info.get('vulnerabilities', [])
            
            for vuln in version_vulns:
                title = vuln.get('title', 'WordPress Core Vulnerability')
                fixed_in = vuln.get('fixed_in')
                
                finding = ParsedFinding(
                    title=f"WordPress: {title}",
                    severity='high',
                    description=f"Vulnerability in WordPress {wp_version}: {title}",
                    category='cms_vulnerability',
                    affected_target=url,
                    evidence=f"Current version: {wp_version}, Fixed in: {fixed_in or 'N/A'}",
                    remediation=f"Update WordPress to version {fixed_in}" if fixed_in else "Update WordPress to latest version",
                    references=[vuln.get('references', {}).get('url', [])] if vuln.get('references') else None,
                    raw_data={
                        'tool': 'wpscan',
                        'type': 'core_vulnerability',
                        'version': wp_version,
                        'fixed_in': fixed_in
                    }
                )
                findings.append(finding)
            
            # Parsear plugins
            plugins = data.get('plugins', {})
            for plugin_name, plugin_data in plugins.items():
                plugin_version = plugin_data.get('version', {}).get('number', 'unknown')
                plugin_vulns = plugin_data.get('vulnerabilities', [])
                
                for vuln in plugin_vulns:
                    title = vuln.get('title', 'Plugin Vulnerability')
                    fixed_in = vuln.get('fixed_in')
                    
                    finding = ParsedFinding(
                        title=f"WordPress Plugin: {plugin_name} - {title}",
                        severity='medium',
                        description=f"Vulnerability in plugin {plugin_name} v{plugin_version}",
                        category='cms_vulnerability',
                        affected_target=url,
                        evidence=f"Plugin: {plugin_name}, Version: {plugin_version}, Fixed in: {fixed_in or 'N/A'}",
                        remediation=f"Update {plugin_name} to version {fixed_in}" if fixed_in else f"Update or remove {plugin_name}",
                        raw_data={
                            'tool': 'wpscan',
                            'type': 'plugin_vulnerability',
                            'plugin': plugin_name,
                            'version': plugin_version,
                            'fixed_in': fixed_in
                        }
                    )
                    findings.append(finding)
            
            self.logger.info(f"WPScan: Parsed {len(findings)} WordPress vulnerabilities")
            return findings
            
        except Exception as e:
            self.logger.error(f"Error parsing WPScan file {file_path}: {e}")
            return findings

