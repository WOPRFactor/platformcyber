"""
Parser para SQLMap - SQL injection scanner.
Formato: CSV dentro de directorio results-*.csv.
"""

from pathlib import Path
from typing import List
import csv
from ..base_parser import BaseParser, ParsedFinding


class SQLMapParser(BaseParser):
    """Parser para archivos CSV de SQLMap."""
    
    def can_parse(self, file_path: Path) -> bool:
        """Verifica si el archivo puede ser parseado."""
        if file_path.is_dir() and 'sqlmap' in file_path.name.lower():
            return True
        filename = file_path.name.lower()
        return 'sqlmap' in filename and file_path.suffix == '.csv'
    
    def parse(self, file_path: Path) -> List[ParsedFinding]:
        """
        Parsea archivos CSV de SQLMap.
        
        Formato CSV:
        id,title,payload,where,vector,parameter
        1,"SQL injection","1' OR '1'='1","GET","boolean-based blind","id"
        """
        findings = []
        
        try:
            # Si es directorio, buscar CSV dentro
            csv_files = []
            if file_path.is_dir():
                csv_files = list(file_path.glob('results-*.csv'))
            else:
                csv_files = [file_path]
            
            for csv_file in csv_files:
                try:
                    with open(csv_file, 'r', encoding='utf-8') as f:
                        reader = csv.DictReader(f)
                        
                        for row in reader:
                            title = row.get('title', 'SQL Injection')
                            payload = row.get('payload', '')
                            parameter = row.get('parameter', 'unknown')
                            vector = row.get('vector', 'unknown')
                            where = row.get('where', 'unknown')
                            
                            finding = ParsedFinding(
                                title=f"SQL Injection: {parameter}",
                                severity='critical',
                                description=f"SQL injection vulnerability found in parameter '{parameter}' ({vector})",
                                category='sql_injection',
                                affected_target=parameter,
                                evidence=f"Payload: {payload[:100]}{'...' if len(payload) > 100 else ''}, Vector: {vector}",
                                remediation="Use parameterized queries (prepared statements) and input validation",
                                cve_id="CWE-89",
                                raw_data={
                                    'tool': 'sqlmap',
                                    'title': title,
                                    'parameter': parameter,
                                    'payload': payload,
                                    'vector': vector,
                                    'where': where
                                }
                            )
                            findings.append(finding)
                
                except Exception as e:
                    self.logger.error(f"Error parsing SQLMap CSV file {csv_file}: {e}")
                    continue
            
            self.logger.info(f"SQLMap: Parsed {len(findings)} SQL injection findings")
            return findings
            
        except Exception as e:
            self.logger.error(f"Error parsing SQLMap file {file_path}: {e}")
            return findings

