"""
MITRE ATT&CK Service
====================

Servicio para simulaciÃ³n y tracking de tÃ©cnicas MITRE ATT&CK.
Framework: Enterprise v14
"""

import logging
from typing import Dict, List, Any, Optional
from datetime import datetime
from uuid import uuid4

logger = logging.getLogger(__name__)


class MitreAttackService:
    """Servicio para MITRE ATT&CK Framework."""
    
    def __init__(self):
        """Inicializa el servicio MITRE ATT&CK."""
        self.tactics = self._initialize_tactics()
        self.techniques = self._initialize_techniques()
        self.campaigns = {}  # En memoria
        self.kill_chains = self._initialize_kill_chains()
        logger.info("âœ… MITRE ATT&CK Service inicializado")
    
    def _initialize_tactics(self) -> Dict[str, Dict[str, Any]]:
        """Inicializa las 14 tÃ¡cticas de MITRE ATT&CK Enterprise."""
        return {
            'TA0043': {
                'id': 'TA0043',
                'name': 'Reconnaissance',
                'description': 'RecopilaciÃ³n de informaciÃ³n para planear operaciones futuras',
                'techniques_count': 10
            },
            'TA0042': {
                'id': 'TA0042',
                'name': 'Resource Development',
                'description': 'Establecer recursos para apoyar operaciones',
                'techniques_count': 7
            },
            'TA0001': {
                'id': 'TA0001',
                'name': 'Initial Access',
                'description': 'Obtener punto de entrada en la red',
                'techniques_count': 9
            },
            'TA0002': {
                'id': 'TA0002',
                'name': 'Execution',
                'description': 'Ejecutar cÃ³digo malicioso',
                'techniques_count': 12
            },
            'TA0003': {
                'id': 'TA0003',
                'name': 'Persistence',
                'description': 'Mantener acceso al sistema',
                'techniques_count': 19
            },
            'TA0004': {
                'id': 'TA0004',
                'name': 'Privilege Escalation',
                'description': 'Obtener permisos de nivel superior',
                'techniques_count': 13
            },
            'TA0005': {
                'id': 'TA0005',
                'name': 'Defense Evasion',
                'description': 'Evitar ser detectado',
                'techniques_count': 42
            },
            'TA0006': {
                'id': 'TA0006',
                'name': 'Credential Access',
                'description': 'Robar credenciales',
                'techniques_count': 17
            },
            'TA0007': {
                'id': 'TA0007',
                'name': 'Discovery',
                'description': 'Conocer el entorno',
                'techniques_count': 30
            },
            'TA0008': {
                'id': 'TA0008',
                'name': 'Lateral Movement',
                'description': 'Moverse a travÃ©s de la red',
                'techniques_count': 9
            },
            'TA0009': {
                'id': 'TA0009',
                'name': 'Collection',
                'description': 'Recopilar datos de interÃ©s',
                'techniques_count': 17
            },
            'TA0011': {
                'id': 'TA0011',
                'name': 'Command and Control',
                'description': 'ComunicaciÃ³n con sistemas comprometidos',
                'techniques_count': 16
            },
            'TA0010': {
                'id': 'TA0010',
                'name': 'Exfiltration',
                'description': 'Robar datos',
                'techniques_count': 9
            },
            'TA0040': {
                'id': 'TA0040',
                'name': 'Impact',
                'description': 'Manipular, interrumpir o destruir sistemas',
                'techniques_count': 13
            }
        }
    
    def _initialize_techniques(self) -> Dict[str, Dict[str, Any]]:
        """Inicializa tÃ©cnicas MITRE ATT&CK (subset importante)."""
        return {
            # === RECONNAISSANCE ===
            'T1595': {
                'id': 'T1595',
                'name': 'Active Scanning',
                'tactic': 'TA0043',
                'description': 'Escaneo activo de infraestructura objetivo',
                'detection': 'Monitoreo de logs de firewall, IDS/IPS',
                'platforms': ['Linux', 'Windows', 'Network'],
                'data_sources': ['Network Traffic', 'Network Traffic Content']
            },
            'T1592': {
                'id': 'T1592',
                'name': 'Gather Victim Host Information',
                'tactic': 'TA0043',
                'description': 'Recopilar informaciÃ³n sobre hosts de la vÃ­ctima',
                'detection': 'Monitoreo de consultas DNS anÃ³malas',
                'platforms': ['PRE'],
                'data_sources': ['Internet Scan']
            },
            
            # === INITIAL ACCESS ===
            'T1566': {
                'id': 'T1566',
                'name': 'Phishing',
                'tactic': 'TA0001',
                'description': 'EnvÃ­o de correos de phishing',
                'detection': 'Email gateway, anÃ¡lisis de attachments',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Application Log', 'File', 'Network Traffic']
            },
            'T1190': {
                'id': 'T1190',
                'name': 'Exploit Public-Facing Application',
                'tactic': 'TA0001',
                'description': 'Explotar aplicaciones expuestas',
                'detection': 'WAF logs, anÃ¡lisis de anomalÃ­as',
                'platforms': ['Linux', 'Windows', 'Network'],
                'data_sources': ['Application Log', 'Network Traffic']
            },
            'T1133': {
                'id': 'T1133',
                'name': 'External Remote Services',
                'tactic': 'TA0001',
                'description': 'Acceso mediante servicios remotos (VPN, RDP)',
                'detection': 'Logs de autenticaciÃ³n, geolocalizaciÃ³n',
                'platforms': ['Windows', 'Linux'],
                'data_sources': ['Logon Session', 'Network Traffic']
            },
            
            # === EXECUTION ===
            'T1059': {
                'id': 'T1059',
                'name': 'Command and Scripting Interpreter',
                'tactic': 'TA0002',
                'description': 'EjecuciÃ³n vÃ­a intÃ©rpretes (PowerShell, bash, etc)',
                'detection': 'Process monitoring, command line logging',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Command', 'Process', 'Script']
            },
            'T1203': {
                'id': 'T1203',
                'name': 'Exploitation for Client Execution',
                'tactic': 'TA0002',
                'description': 'Explotar vulnerabilidades de software cliente',
                'detection': 'Endpoint detection, behavior analysis',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Application Log', 'Process']
            },
            'T1569': {
                'id': 'T1569',
                'name': 'System Services',
                'tactic': 'TA0002',
                'description': 'Abuso de servicios del sistema',
                'detection': 'Service creation/modification monitoring',
                'platforms': ['Windows', 'Linux'],
                'data_sources': ['Service', 'Process', 'Command']
            },
            
            # === PERSISTENCE ===
            'T1053': {
                'id': 'T1053',
                'name': 'Scheduled Task/Job',
                'tactic': 'TA0003',
                'description': 'Tareas programadas para persistencia',
                'detection': 'Scheduled task logs, cron monitoring',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Scheduled Job', 'Command', 'Process']
            },
            'T1136': {
                'id': 'T1136',
                'name': 'Create Account',
                'tactic': 'TA0003',
                'description': 'Crear cuentas de usuario',
                'detection': 'Account creation logs',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['User Account', 'Process', 'Command']
            },
            'T1543': {
                'id': 'T1543',
                'name': 'Create or Modify System Process',
                'tactic': 'TA0003',
                'description': 'Crear/modificar servicios del sistema',
                'detection': 'Service monitoring, registry changes',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Service', 'Windows Registry', 'Process']
            },
            
            # === PRIVILEGE ESCALATION ===
            'T1068': {
                'id': 'T1068',
                'name': 'Exploitation for Privilege Escalation',
                'tactic': 'TA0004',
                'description': 'Explotar vulnerabilidades para escalar privilegios',
                'detection': 'Behavior analysis, exploit detection',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Process', 'Application Log']
            },
            'T1078': {
                'id': 'T1078',
                'name': 'Valid Accounts',
                'tactic': 'TA0004',
                'description': 'Uso de cuentas vÃ¡lidas para escalar',
                'detection': 'Login anomalies, privilege usage',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Logon Session', 'User Account']
            },
            
            # === DEFENSE EVASION ===
            'T1027': {
                'id': 'T1027',
                'name': 'Obfuscated Files or Information',
                'tactic': 'TA0005',
                'description': 'Ofuscar archivos o informaciÃ³n',
                'detection': 'File analysis, entropy detection',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['File', 'Script', 'Command']
            },
            'T1070': {
                'id': 'T1070',
                'name': 'Indicator Removal',
                'tactic': 'TA0005',
                'description': 'Eliminar indicadores de compromiso',
                'detection': 'Log monitoring, file integrity',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['File', 'Process', 'Command']
            },
            'T1055': {
                'id': 'T1055',
                'name': 'Process Injection',
                'tactic': 'TA0005',
                'description': 'Inyectar cÃ³digo en procesos legÃ­timos',
                'detection': 'Process behavior analysis, memory monitoring',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Process', 'Module']
            },
            'T1562': {
                'id': 'T1562',
                'name': 'Impair Defenses',
                'tactic': 'TA0005',
                'description': 'Deshabilitar controles de seguridad',
                'detection': 'Security tool monitoring, service status',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Service', 'Process', 'Command', 'Windows Registry']
            },
            
            # === CREDENTIAL ACCESS ===
            'T1110': {
                'id': 'T1110',
                'name': 'Brute Force',
                'tactic': 'TA0006',
                'description': 'Fuerza bruta de credenciales',
                'detection': 'Failed login attempts, rate limiting',
                'platforms': ['Windows', 'Linux', 'macOS', 'Network'],
                'data_sources': ['Logon Session', 'User Account']
            },
            'T1003': {
                'id': 'T1003',
                'name': 'OS Credential Dumping',
                'tactic': 'TA0006',
                'description': 'Dump de credenciales del SO',
                'detection': 'LSASS monitoring, SAM access',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Process', 'Command', 'File']
            },
            'T1056': {
                'id': 'T1056',
                'name': 'Input Capture',
                'tactic': 'TA0006',
                'description': 'Captura de input del usuario (keylogging)',
                'detection': 'Behavior analysis, API monitoring',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Process', 'Driver', 'Windows Registry']
            },
            
            # === DISCOVERY ===
            'T1083': {
                'id': 'T1083',
                'name': 'File and Directory Discovery',
                'tactic': 'TA0007',
                'description': 'EnumeraciÃ³n de archivos y directorios',
                'detection': 'File access monitoring',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Process', 'Command', 'File']
            },
            'T1087': {
                'id': 'T1087',
                'name': 'Account Discovery',
                'tactic': 'TA0007',
                'description': 'Descubrir cuentas del sistema',
                'detection': 'Command monitoring, API calls',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Command', 'Process', 'Group']
            },
            'T1018': {
                'id': 'T1018',
                'name': 'Remote System Discovery',
                'tactic': 'TA0007',
                'description': 'Identificar sistemas remotos',
                'detection': 'Network monitoring, command analysis',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Network Traffic', 'Command', 'Process']
            },
            'T1046': {
                'id': 'T1046',
                'name': 'Network Service Discovery',
                'tactic': 'TA0007',
                'description': 'Escaneo de servicios de red',
                'detection': 'Network traffic analysis',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Network Traffic', 'Command']
            },
            
            # === LATERAL MOVEMENT ===
            'T1021': {
                'id': 'T1021',
                'name': 'Remote Services',
                'tactic': 'TA0008',
                'description': 'Uso de servicios remotos (RDP, SSH, WinRM)',
                'detection': 'Authentication logs, network monitoring',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Logon Session', 'Network Traffic', 'Process']
            },
            'T1080': {
                'id': 'T1080',
                'name': 'Taint Shared Content',
                'tactic': 'TA0008',
                'description': 'Contaminar contenido compartido',
                'detection': 'File integrity monitoring',
                'platforms': ['Windows', 'Linux'],
                'data_sources': ['File', 'Network Traffic']
            },
            
            # === COLLECTION ===
            'T1005': {
                'id': 'T1005',
                'name': 'Data from Local System',
                'tactic': 'TA0009',
                'description': 'Recolectar datos del sistema local',
                'detection': 'File access monitoring, DLP',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['File', 'Command', 'Process']
            },
            'T1560': {
                'id': 'T1560',
                'name': 'Archive Collected Data',
                'tactic': 'TA0009',
                'description': 'Archivar datos recolectados',
                'detection': 'File creation, compression tools',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['File', 'Command', 'Process']
            },
            'T1113': {
                'id': 'T1113',
                'name': 'Screen Capture',
                'tactic': 'TA0009',
                'description': 'Captura de pantalla',
                'detection': 'API monitoring, behavior analysis',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Command', 'Process']
            },
            
            # === COMMAND AND CONTROL ===
            'T1071': {
                'id': 'T1071',
                'name': 'Application Layer Protocol',
                'tactic': 'TA0011',
                'description': 'C2 sobre protocolos de aplicaciÃ³n (HTTP, DNS)',
                'detection': 'Network traffic analysis, behavioral anomalies',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Network Traffic', 'Network Traffic Content']
            },
            'T1573': {
                'id': 'T1573',
                'name': 'Encrypted Channel',
                'tactic': 'TA0011',
                'description': 'Cifrar canal C2',
                'detection': 'Certificate analysis, traffic inspection',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Network Traffic']
            },
            'T1219': {
                'id': 'T1219',
                'name': 'Remote Access Software',
                'tactic': 'TA0011',
                'description': 'Uso de software de acceso remoto',
                'detection': 'Software installation monitoring',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Process', 'Network Traffic']
            },
            
            # === EXFILTRATION ===
            'T1041': {
                'id': 'T1041',
                'name': 'Exfiltration Over C2 Channel',
                'tactic': 'TA0010',
                'description': 'ExfiltraciÃ³n sobre canal C2',
                'detection': 'Network traffic volume analysis',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Network Traffic', 'Network Traffic Content']
            },
            'T1048': {
                'id': 'T1048',
                'name': 'Exfiltration Over Alternative Protocol',
                'tactic': 'TA0010',
                'description': 'ExfiltraciÃ³n por protocolo alternativo',
                'detection': 'Network monitoring, DLP',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Network Traffic', 'Network Traffic Content']
            },
            
            # === IMPACT ===
            'T1486': {
                'id': 'T1486',
                'name': 'Data Encrypted for Impact',
                'tactic': 'TA0040',
                'description': 'Cifrar datos (ransomware)',
                'detection': 'File modification monitoring, behavior analysis',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['File', 'Process', 'Command']
            },
            'T1490': {
                'id': 'T1490',
                'name': 'Inhibit System Recovery',
                'tactic': 'TA0040',
                'description': 'Impedir recuperaciÃ³n del sistema',
                'detection': 'Backup deletion monitoring',
                'platforms': ['Windows', 'Linux', 'macOS'],
                'data_sources': ['Command', 'Process', 'File']
            },
            'T1498': {
                'id': 'T1498',
                'name': 'Network Denial of Service',
                'tactic': 'TA0040',
                'description': 'DoS de red',
                'detection': 'Network traffic analysis, IDS',
                'platforms': ['Linux', 'Windows', 'macOS', 'Network'],
                'data_sources': ['Network Traffic', 'Sensor Health']
            },
            'T1529': {
                'id': 'T1529',
                'name': 'System Shutdown/Reboot',
                'tactic': 'TA0040',
                'description': 'Apagar/reiniciar sistemas',
                'detection': 'System event logs',
                'platforms': ['Linux', 'Windows', 'macOS'],
                'data_sources': ['Command', 'Process']
            }
        }
    
    def _initialize_kill_chains(self) -> Dict[str, Dict[str, Any]]:
        """Inicializa kill chains predefinidos de APTs conocidos."""
        return {
            'apt29_cozy_bear': {
                'name': 'APT29 (Cozy Bear)',
                'description': 'Grupo ruso de espionaje, sofisticado y sigiloso',
                'techniques': ['T1566', 'T1059', 'T1055', 'T1003', 'T1021', 'T1041'],
                'severity': 'critical',
                'target': 'Government, Think Tanks'
            },
            'apt28_fancy_bear': {
                'name': 'APT28 (Fancy Bear)',
                'description': 'Grupo ruso, operaciones de inteligencia',
                'techniques': ['T1566', 'T1203', 'T1055', 'T1003', 'T1078', 'T1041'],
                'severity': 'critical',
                'target': 'Military, Government, Media'
            },
            'apt3_gothic_panda': {
                'name': 'APT3 (Gothic Panda)',
                'description': 'Grupo chino enfocado en espionaje',
                'techniques': ['T1190', 'T1059', 'T1136', 'T1087', 'T1021', 'T1048'],
                'severity': 'high',
                'target': 'Aerospace, Technology'
            },
            'ransomware_generic': {
                'name': 'Ransomware Generic Kill Chain',
                'description': 'Cadena tÃ­pica de ransomware moderno',
                'techniques': ['T1566', 'T1059', 'T1562', 'T1003', 'T1083', 'T1486', 'T1490'],
                'severity': 'critical',
                'target': 'All sectors'
            },
            'credential_theft': {
                'name': 'Credential Theft Campaign',
                'description': 'Enfocado en robo de credenciales',
                'techniques': ['T1133', 'T1110', 'T1003', 'T1056', 'T1078', 'T1041'],
                'severity': 'high',
                'target': 'Corporate networks'
            }
        }
    
    def get_all_tactics(self) -> Dict[str, Dict[str, Any]]:
        """Obtiene todas las tÃ¡cticas."""
        logger.info("Obteniendo todas las tÃ¡cticas MITRE")
        return self.tactics
    
    def get_tactic(self, tactic_id: str) -> Optional[Dict[str, Any]]:
        """Obtiene una tÃ¡ctica especÃ­fica."""
        logger.info(f"Obteniendo tÃ¡ctica: {tactic_id}")
        return self.tactics.get(tactic_id)
    
    def get_all_techniques(
        self,
        tactic_filter: Optional[str] = None
    ) -> Dict[str, Dict[str, Any]]:
        """Obtiene todas las tÃ©cnicas, opcionalmente filtradas por tÃ¡ctica."""
        techniques = self.techniques
        
        if tactic_filter:
            techniques = {
                tid: tech for tid, tech in techniques.items()
                if tech['tactic'] == tactic_filter
            }
            logger.info(f"TÃ©cnicas filtradas por {tactic_filter}: {len(techniques)}")
        else:
            logger.info(f"Obteniendo todas las tÃ©cnicas: {len(techniques)}")
        
        return techniques
    
    def get_technique(self, technique_id: str) -> Optional[Dict[str, Any]]:
        """Obtiene una tÃ©cnica especÃ­fica."""
        logger.info(f"Obteniendo tÃ©cnica: {technique_id}")
        return self.techniques.get(technique_id)
    
    def create_campaign(
        self,
        name: str,
        workspace_id: int,
        techniques: List[str],
        description: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Crea una campaÃ±a de simulaciÃ³n.
        
        Args:
            name: Nombre de la campaÃ±a
            workspace_id: ID del workspace
            techniques: Lista de IDs de tÃ©cnicas
            description: DescripciÃ³n opcional
            
        Returns:
            Dict con detalles de la campaÃ±a
        """
        campaign_id = str(uuid4())
        
        campaign = {
            'id': campaign_id,
            'name': name,
            'workspace_id': workspace_id,
            'description': description or '',
            'techniques': techniques,
            'status': 'pending',
            'executions': [],
            'created_at': datetime.now().isoformat(),
            'created_by': 'admin'
        }
        
        self.campaigns[campaign_id] = campaign
        logger.info(f"ğŸ“‹ CampaÃ±a MITRE creada: {campaign_id} - {name}")
        
        return {
            'success': True,
            'campaign': campaign
        }
    
    def get_campaign(self, campaign_id: str) -> Optional[Dict[str, Any]]:
        """Obtiene detalles de una campaÃ±a."""
        logger.info(f"ğŸ“Š Obteniendo campaÃ±a: {campaign_id}")
        return self.campaigns.get(campaign_id)
    
    def list_campaigns(self, workspace_id: Optional[int] = None) -> List[Dict[str, Any]]:
        """Lista todas las campaÃ±as."""
        campaigns = list(self.campaigns.values())
        
        if workspace_id:
            campaigns = [c for c in campaigns if c['workspace_id'] == workspace_id]
        
        logger.info(f"ğŸ“‹ Listando campaÃ±as: {len(campaigns)} encontradas")
        return campaigns
    
    def execute_technique(
        self,
        campaign_id: str,
        technique_id: str,
        target: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Simula ejecuciÃ³n de una tÃ©cnica (modo seguro).
        
        Args:
            campaign_id: ID de la campaÃ±a
            technique_id: ID de la tÃ©cnica MITRE
            target: Target opcional
            
        Returns:
            Dict con resultado de la ejecuciÃ³n
        """
        campaign = self.campaigns.get(campaign_id)
        if not campaign:
            return {'success': False, 'error': 'Campaign not found'}
        
        technique = self.techniques.get(technique_id)
        if not technique:
            return {'success': False, 'error': 'Technique not found'}
        
        execution_id = str(uuid4())
        execution = {
            'id': execution_id,
            'technique_id': technique_id,
            'technique_name': technique['name'],
            'target': target or 'simulated',
            'status': 'completed',
            'detected': False,  # Simulado
            'logs': [
                f"Simulated execution of {technique['name']}",
                f"Platform: {', '.join(technique['platforms'])}",
                f"Detection method: {technique['detection']}"
            ],
            'timestamp': datetime.now().isoformat()
        }
        
        campaign['executions'].append(execution)
        campaign['status'] = 'running'
        
        logger.info(f"âš¡ TÃ©cnica ejecutada: {technique_id} en campaÃ±a {campaign_id}")
        
        return {
            'success': True,
            'execution': execution
        }
    
    def get_coverage_matrix(self) -> Dict[str, Any]:
        """
        Calcula matriz de cobertura de detecciÃ³n.
        
        Returns:
            Dict con estadÃ­sticas de cobertura
        """
        total_techniques = len(self.techniques)
        
        # Simular cobertura (en producciÃ³n esto vendrÃ­a de configuraciÃ³n real)
        covered_techniques = int(total_techniques * 0.65)  # 65% cobertura ejemplo
        
        coverage_by_tactic = {}
        for tactic_id, tactic in self.tactics.items():
            tactic_techniques = [
                t for t in self.techniques.values()
                if t['tactic'] == tactic_id
            ]
            covered = int(len(tactic_techniques) * 0.65)
            coverage_by_tactic[tactic_id] = {
                'name': tactic['name'],
                'total': len(tactic_techniques),
                'covered': covered,
                'coverage_percent': round((covered / len(tactic_techniques) * 100) if tactic_techniques else 0, 1)
            }
        
        logger.info("ğŸ“Š Calculando matriz de cobertura")
        
        return {
            'total_techniques': total_techniques,
            'covered_techniques': covered_techniques,
            'coverage_percent': round((covered_techniques / total_techniques * 100), 1),
            'by_tactic': coverage_by_tactic,
            'gaps': [
                {
                    'technique_id': 'T1068',
                    'name': 'Exploitation for Privilege Escalation',
                    'severity': 'high'
                },
                {
                    'technique_id': 'T1055',
                    'name': 'Process Injection',
                    'severity': 'high'
                }
            ]
        }
    
    def get_kill_chains(self) -> Dict[str, Dict[str, Any]]:
        """Obtiene kill chains predefinidos."""
        logger.info("âš”ï¸  Obteniendo kill chains")
        return self.kill_chains
    
    def get_kill_chain(self, chain_id: str) -> Optional[Dict[str, Any]]:
        """Obtiene un kill chain especÃ­fico."""
        logger.info(f"âš”ï¸  Obteniendo kill chain: {chain_id}")
        return self.kill_chains.get(chain_id)


# Singleton
mitre_service = MitreAttackService()




