"""
Impacket Dumping Service
=========================

Servicios para dumping de credenciales con Impacket:
- secretsdump (Dump de credenciales)
- GetUserSPNs (Kerberoasting)
- GetNPUsers (AS-REP Roasting)
"""

import logging
from typing import Dict, Any, Optional

from utils.validators import CommandSanitizer, IPValidator
from .base import BaseExploitationService

logger = logging.getLogger(__name__)


class ImpacketDumpingService(BaseExploitationService):
    """Servicio para dumping de credenciales con Impacket."""
    
    def start_secretsdump(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        just_dc: bool = False
    ) -> Dict[str, Any]:
        """
        Dump secrets con secretsdump.py.
        
        Args:
            target: IP objetivo (DC para NTDS)
            username: Usuario
            password: Password
            workspace_id: ID del workspace
            user_id: ID del usuario
            domain: Dominio
            hash: NTLM hash
            just_dc: Solo NTDS.dit (DC)
        """
        IPValidator.validate(target)
        
        scan = self._create_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='secretsdump',
            options={
                'just_dc': just_dc
            }
        )
        
        try:
            output_file = str(self.output_dir / f'secretsdump_{scan.id}.txt')
            
            # Credencial
            if domain:
                cred = f'{domain}/{username}'
            else:
                cred = username
            
            command_list = [
                'secretsdump.py',
                f'{cred}:{password}@{target}' if password else f'{cred}@{target}',
                '-outputfile', output_file
            ]
            
            if hash:
                command_list.extend(['-hashes', hash])
            
            if just_dc:
                command_list.append('-just-dc')
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command_list[0], command_list[1:])
            
            logger.info(f"Starting secretsdump {scan.id}")
            
            self._start_scan_thread(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='secretsdump'
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'secretsdump',
                'target': target
            }
            
        except Exception as e:
            logger.error(f"Error starting secretsdump: {e}")
            self.scan_repo.update_status(scan, 'failed', str(e))
            raise
    
    def start_getuserspns(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: str,
        dc_ip: Optional[str] = None,
        request: bool = True
    ) -> Dict[str, Any]:
        """
        Kerberoasting con GetUserSPNs.py.
        
        Args:
            target: Dominio
            username: Usuario
            password: Password
            workspace_id: ID del workspace
            user_id: ID del usuario
            domain: Dominio AD
            dc_ip: IP del DC
            request: Solicitar TGS tickets
        """
        scan = self._create_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='getuserspns',
            options={
                'domain': domain
            }
        )
        
        try:
            output_file = str(self.output_dir / f'getuserspns_{scan.id}.txt')
            
            command_list = [
                'GetUserSPNs.py',
                f'{domain}/{username}:{password}',
                '-outputfile', output_file
            ]
            
            if dc_ip:
                command_list.extend(['-dc-ip', dc_ip])
            
            if request:
                command_list.append('-request')
            
            command_list.extend(['>', output_file, '2>&1'])
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command_list[0], command_list[1:])
            
            logger.info(f"Starting GetUserSPNs {scan.id}")
            
            self._start_scan_thread(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='getuserspns'
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'getuserspns',
                'domain': domain
            }
            
        except Exception as e:
            logger.error(f"Error starting GetUserSPNs: {e}")
            self.scan_repo.update_status(scan, 'failed', str(e))
            raise
    
    def start_getnpusers(
        self,
        domain: str,
        workspace_id: int,
        user_id: int,
        users_file: Optional[str] = None,
        username: Optional[str] = None,
        dc_ip: Optional[str] = None,
        no_pass: bool = True
    ) -> Dict[str, Any]:
        """
        AS-REP Roasting con GetNPUsers.py.
        
        Args:
            domain: Dominio AD
            workspace_id: ID del workspace
            user_id: ID del usuario
            users_file: Path a archivo de usuarios
            username: Usuario específico
            dc_ip: IP del DC
            no_pass: No requiere password (AS-REP Roasting)
        """
        scan = self._create_scan(
            target=domain,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='getnpusers',
            options={
                'domain': domain,
                'no_pass': no_pass
            }
        )
        
        try:
            output_file = str(self.output_dir / f'getnpusers_{scan.id}.txt')
            
            command_list = [
                'GetNPUsers.py',
                f'{domain}/'
            ]
            
            if users_file:
                command_list.extend(['-usersfile', users_file])
            elif username:
                command_list.extend(['-users', username])
            
            if dc_ip:
                command_list.extend(['-dc-ip', dc_ip])
            
            if no_pass:
                command_list.append('-no-pass')
            
            command_list.extend(['-outputfile', output_file])
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command_list[0], command_list[1:])
            
            logger.info(f"Starting GetNPUsers {scan.id}")
            
            self._start_scan_thread(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='getnpusers'
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'getnpusers',
                'domain': domain
            }
            
        except Exception as e:
            logger.error(f"Error starting GetNPUsers: {e}")
            self.scan_repo.update_status(scan, 'failed', str(e))
            raise


    def preview_secretsdump(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        just_dc: bool = False
    ) -> Dict[str, Any]:
        """Preview del comando secretsdump.py."""
        output_file = f'/workspaces/workspace_{workspace_id}/exploitation/secretsdump_{{scan_id}}.txt'
        
        if domain:
            cred = f'{domain}/{username}'
        else:
            cred = username
        
        command_list = [
            'secretsdump.py',
            f'{cred}:***@{target}' if password else f'{cred}@{target}',
            '-outputfile', output_file
        ]
        
        if hash:
            command_list.extend(['-hashes', hash])
        
        if just_dc:
            command_list.append('-just-dc')
        
        command_str = ' '.join([str(c) for c in command_list])
        
        warnings = []
        warnings.append('secretsdump puede generar mucho tráfico de red y ser detectado')
        
        return {
            'command': command_list,
            'command_string': command_str,
            'parameters': {
                'tool': 'secretsdump',
                'target': target,
                'username': username,
                'password': '***',
                'domain': domain,
                'hash': hash,
                'just_dc': just_dc
            },
            'estimated_timeout': 3600,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': []
        }
    
    def preview_getuserspns(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: str,
        hash: Optional[str] = None,
        request: bool = True
    ) -> Dict[str, Any]:
        """Preview del comando GetUserSPNs.py."""
        output_file = f'/workspaces/workspace_{workspace_id}/exploitation/getuserspns_{{scan_id}}.txt'
        
        command_list = [
            'GetUserSPNs.py',
            f'{domain}/{username}:***@{target}' if password else f'{domain}/{username}@{target}',
            '-outputfile', output_file
        ]
        
        if hash:
            command_list.extend(['-hashes', hash])
        
        if not request:
            command_list.append('-no-pass')
        
        command_str = ' '.join([str(c) for c in command_list])
        
        warnings = []
        warnings.append('GetUserSPNs puede ser detectado por sistemas de monitoreo AD')
        
        return {
            'command': command_list,
            'command_string': command_str,
            'parameters': {
                'tool': 'getuserspns',
                'target': target,
                'username': username,
                'password': '***',
                'domain': domain,
                'hash': hash,
                'request': request
            },
            'estimated_timeout': 1800,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': []
        }
    
    def preview_getnpusers(
        self,
        target: str,
        workspace_id: int,
        domain: str,
        users_file: Optional[str] = None,
        no_pass: bool = True
    ) -> Dict[str, Any]:
        """Preview del comando GetNPUsers.py."""
        output_file = f'/workspaces/workspace_{workspace_id}/exploitation/getnpusers_{{scan_id}}.txt'
        
        command_list = [
            'GetNPUsers.py',
            f'{domain}/',
            '-dc-ip', target,
            '-outputfile', output_file
        ]
        
        if users_file:
            command_list.extend(['-usersfile', users_file])
        
        if no_pass:
            command_list.append('-no-pass')
        
        command_str = ' '.join([str(c) for c in command_list])
        
        warnings = []
        warnings.append('GetNPUsers puede ser detectado por sistemas de monitoreo AD')
        
        return {
            'command': command_list,
            'command_string': command_str,
            'parameters': {
                'tool': 'getnpusers',
                'target': target,
                'domain': domain,
                'users_file': users_file,
                'no_pass': no_pass
            },
            'estimated_timeout': 1800,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': []
        }
