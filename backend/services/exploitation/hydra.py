"""
Hydra Service
=============

Servicio para ataques de fuerza bruta con Hydra.
"""

import logging
from typing import Dict, Any, Optional

from utils.validators import CommandSanitizer
from utils.commands import SafeHydra
from utils.workspace_logger import log_to_workspace
from .base import BaseExploitationService

logger = logging.getLogger(__name__)


class HydraService(BaseExploitationService):
    """Servicio para ataques de fuerza bruta con Hydra."""
    
    def start_hydra_attack(
        self,
        target: str,
        service: str,
        workspace_id: int,
        user_id: int,
        username: Optional[str] = None,
        userfile: Optional[str] = None,
        password: Optional[str] = None,
        passfile: Optional[str] = None,
        port: Optional[int] = None,
        threads: int = 16
    ) -> Dict[str, Any]:
        """
        Ataque de fuerza bruta con Hydra.
        
        Args:
            target: IP o hostname
            service: ssh, ftp, smb, rdp, http-post-form, mysql, etc.
            workspace_id: ID del workspace
            user_id: ID del usuario
            username: Usuario específico
            userfile: Path a archivo de usuarios
            password: Password específica
            passfile: Path a archivo de passwords
            port: Puerto custom
            threads: Threads paralelos (max 64)
        """
        CommandSanitizer.validate_target(target)
        SafeHydra.validate_service(service)
        
        # Limitar threads
        threads = min(threads, 64)
        
        scan = self._create_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='hydra',
            options={
                'service': service,
                'threads': threads
            }
        )
        
        try:
            output_file = str(self.output_dir / f'hydra_{scan.id}.txt')
            
            # Construir comando según servicio
            if service == 'ssh':
                command = SafeHydra.build_ssh_attack(
                    target, username, userfile, password, passfile,
                    port or 22, output_file
                )
            elif service == 'smb':
                command = SafeHydra.build_smb_attack(
                    target, username, userfile, password, passfile,
                    output_file
                )
            elif service == 'rdp':
                command = SafeHydra.build_rdp_attack(
                    target, username, userfile, password, passfile,
                    output_file
                )
            elif service == 'ftp':
                command = [
                    'hydra',
                    '-t', str(threads),
                    '-o', output_file,
                    '-f'
                ]
                if username:
                    command.extend(['-l', username])
                elif userfile:
                    command.extend(['-L', userfile])
                if password:
                    command.extend(['-p', password])
                elif passfile:
                    command.extend(['-P', passfile])
                
                command.extend([f'{service}://{target}'])
                
                if port:
                    command.extend(['-s', str(port)])
            elif service.startswith('http'):
                raise ValueError("HTTP form brute force requires specific format. Use custom endpoint.")
            else:
                # Servicio genérico
                command = [
                    'hydra',
                    '-t', str(threads),
                    '-o', output_file,
                    '-f'
                ]
                if username:
                    command.extend(['-l', username])
                elif userfile:
                    command.extend(['-L', userfile])
                if password:
                    command.extend(['-p', password])
                elif passfile:
                    command.extend(['-P', passfile])
                
                command.append(f'{service}://{target}')
                
                if port:
                    command.extend(['-s', str(port)])
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command[0], command[1:])
            
            # Log inicial del ataque
            command_str = ' '.join([str(c) for c in sanitized_cmd if c not in ['>', '2>&1']])
            log_to_workspace(
                workspace_id=workspace_id,
                source='HYDRA',
                level='INFO',
                message=f"Iniciando ataque Hydra {service} contra {target}",
                metadata={
                    'scan_id': scan.id,
                    'service': service,
                    'target': target,
                    'port': port,
                    'threads': threads,
                    'command': command_str
                }
            )
            
            logger.info(f"Starting Hydra {service} attack {scan.id}")
            
            self._start_scan_thread(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='hydra'
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'hydra',
                'service': service,
                'target': target
            }
            
        except Exception as e:
            error_msg = str(e)
            logger.error(f"Error starting Hydra attack: {error_msg}")
            
            # Log de error
            log_to_workspace(
                workspace_id=workspace_id,
                source='HYDRA',
                level='ERROR',
                message=f"Error iniciando ataque Hydra {service}: {error_msg}",
                metadata={
                    'scan_id': scan.id if 'scan' in locals() else None,
                    'service': service,
                    'target': target,
                    'error': error_msg
                }
            )
            
            self.scan_repo.update_status(scan, 'failed', error_msg)
            raise


    def preview_hydra_attack(
        self,
        target: str,
        service: str,
        workspace_id: int,
        username: Optional[str] = None,
        userfile: Optional[str] = None,
        password: Optional[str] = None,
        passfile: Optional[str] = None,
        port: Optional[int] = None,
        threads: int = 16
    ) -> Dict[str, Any]:
        """Preview del comando Hydra."""
        CommandSanitizer.validate_target(target)
        SafeHydra.validate_service(service)
        
        threads = min(threads, 64)
        output_file = f'/workspaces/workspace_{workspace_id}/exploitation/hydra_{{scan_id}}.txt'
        
        if service == 'ssh':
            command = SafeHydra.build_ssh_attack(
                target, username, userfile, password, passfile,
                port or 22, output_file
            )
        elif service == 'smb':
            command = SafeHydra.build_smb_attack(
                target, username, userfile, password, passfile,
                output_file
            )
        elif service == 'rdp':
            command = SafeHydra.build_rdp_attack(
                target, username, userfile, password, passfile,
                output_file
            )
        else:
            command = ['hydra', '-t', str(threads), '-o', output_file, '-f']
            if username:
                command.extend(['-l', username])
            elif userfile:
                command.extend(['-L', userfile])
            if password:
                command.extend(['-p', password])
            elif passfile:
                command.extend(['-P', passfile])
            command.extend([f'{service}://{target}'])
            if port:
                command.extend(['-s', str(port)])
        
        command_str = ' '.join([str(c) for c in command])
        
        warnings = []
        if threads > 32:
            warnings.append('Threads altos pueden causar bloqueos de cuenta')
        
        return {
            'command': command,
            'command_string': command_str,
            'parameters': {
                'tool': 'hydra',
                'target': target,
                'service': service,
                'username': username,
                'userfile': userfile,
                'password': '***' if password else None,
                'passfile': passfile,
                'port': port,
                'threads': threads
            },
            'estimated_timeout': 3600,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': []
        }
