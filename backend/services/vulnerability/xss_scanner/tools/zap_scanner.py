"""
OWASP ZAP Scanner
=================

Módulo para escaneo XSS con OWASP ZAP.
"""

import subprocess
import logging
import shutil
import requests
from typing import Dict, Any, Tuple
from pathlib import Path

from utils.workspace_logger import log_to_workspace
from services.vulnerability.xss_scanner.base import BaseXSSScanner

logger = logging.getLogger(__name__)


class ZAPScanner(BaseXSSScanner):
    """Scanner XSS usando OWASP ZAP."""
    
    DEFAULT_TIMEOUT = 600  # 10 minutos
    
    def check_zap_daemon(self) -> Tuple[bool, str]:
        """
        Verifica si el daemon de ZAP está corriendo.
        
        Returns:
            Tuple (is_running, error_message)
        """
        try:
            response = requests.get('http://localhost:8080', timeout=2)
            if response.status_code in [200, 401, 403]:
                return True, None
            else:
                return False, f"ZAP daemon responded with status {response.status_code}"
        except requests.exceptions.ConnectionError:
            return False, "ZAP daemon not running. Please start ZAP first: 'zaproxy -daemon -port 8080'"
        except Exception as e:
            return False, f"Error checking ZAP daemon: {str(e)}"
    
    def execute_scan(
        self,
        url: str,
        scan_id: int,
        workspace_id: int,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Ejecuta escaneo con OWASP ZAP.
        
        Args:
            url: URL objetivo
            scan_id: ID del scan
            workspace_id: ID del workspace
            options: Opciones de configuración
            
        Returns:
            Dict con resultados
        """
        # Verificar daemon
        is_running, error_msg = self.check_zap_daemon()
        if not is_running:
            raise ValueError(error_msg or "ZAP daemon not running")
        
        if not shutil.which('zap-cli'):
            raise ValueError("zap-cli not found. Install with: pip3 install zapcli")
        
        workspace_output_dir = self._get_workspace_output_dir(scan_id)
        output_file = workspace_output_dir / f'zap_{scan_id}.json'
        
        # Construir comando
        command = ['zap-cli', 'quick-scan', '--self-contained', '--start-options', '-config api.disablekey=true', url]
        
        timeout = options.get('timeout', self.DEFAULT_TIMEOUT)
        
        log_to_workspace(
            workspace_id=workspace_id,
            source='ZAP',
            level='INFO',
            message=f"Starting ZAP scan {scan_id}",
            metadata={'scan_id': scan_id, 'target': url}
        )
        
        try:
            # Ejecutar comando
            process = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            
            # Generar reporte JSON
            report_cmd = ['zap-cli', 'report', '-o', str(output_file), '-f', 'json']
            subprocess.run(report_cmd, capture_output=True, timeout=30)
            
            # Parsear resultados
            from services.vulnerability.xss_scanner.parsers import ZAPParser
            parser = ZAPParser()
            results = parser.parse_output(str(output_file))
            
            log_to_workspace(
                workspace_id=workspace_id,
                source='ZAP',
                level='INFO',
                message=f"ZAP scan {scan_id} completed",
                metadata={'scan_id': scan_id, 'vulnerabilities_found': len(results.get('vulnerabilities', []))}
            )
            
            return {
                'success': True,
                'tool': 'zap',
                'vulnerabilities': results.get('vulnerabilities', []),
                'raw_output': process.stdout,
                'output_file': str(output_file)
            }
            
        except subprocess.TimeoutExpired:
            error_msg = f"ZAP scan {scan_id} timed out after {timeout} seconds"
            log_to_workspace(
                workspace_id=workspace_id,
                source='ZAP',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id}
            )
            raise TimeoutError(error_msg)
        except Exception as e:
            error_msg = f"ZAP scan {scan_id} failed: {str(e)}"
            log_to_workspace(
                workspace_id=workspace_id,
                source='ZAP',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id, 'error': str(e)}
            )
            raise
    
    def preview_command(
        self,
        url: str,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Genera preview del comando ZAP."""
        is_running, error_msg = self.check_zap_daemon()
        if not is_running:
            return {
                'tool': 'zap',
                'command': None,
                'warning': error_msg or 'ZAP daemon not running'
            }
        
        if not shutil.which('zap-cli'):
            return {
                'tool': 'zap',
                'command': None,
                'warning': 'zap-cli not found'
            }
        
        command = ['zap-cli', 'quick-scan', '--self-contained', url]
        
        return {
            'tool': 'zap',
            'command': ' '.join(command),
            'description': 'Professional XSS scanner with comprehensive coverage'
        }


