"""
XSSer Scanner
=============

Módulo para escaneo XSS con XSSer.
"""

import subprocess
import logging
import shutil
from typing import Dict, Any
from pathlib import Path

from utils.workspace_logger import log_to_workspace
from services.vulnerability.xss_scanner.base import BaseXSSScanner

logger = logging.getLogger(__name__)


class XSSerScanner(BaseXSSScanner):
    """Scanner XSS usando XSSer."""
    
    DEFAULT_TIMEOUT = 180  # 3 minutos
    
    def execute_scan(
        self,
        url: str,
        scan_id: int,
        workspace_id: int,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Ejecuta escaneo con XSSer.
        
        Args:
            url: URL objetivo
            scan_id: ID del scan
            workspace_id: ID del workspace
            options: Opciones de configuración
            
        Returns:
            Dict con resultados
        """
        if not shutil.which('xsser'):
            raise ValueError("XSSer not found. Install with: apt install xsser")
        
        workspace_output_dir = self._get_workspace_output_dir(scan_id)
        output_file = workspace_output_dir / f'xsser_{scan_id}.txt'
        
        # Construir comando
        command = ['xsser']
        
        # Modo automático (recomendado)
        if options.get('auto_mode', True):
            command.extend(['--auto', '-u', url])
        else:
            command.extend(['-u', url])
        
        # Opciones configurables
        if options.get('custom_cookies'):
            command.extend(['--Coo', options['custom_cookies']])
        
        if options.get('custom_payload'):
            command.extend(['--payload', options['custom_payload']])
        
        if options.get('threads'):
            command.extend(['--threads', str(options['threads'])])
        
        if options.get('timeout'):
            command.extend(['--timeout', str(options['timeout'])])
        
        if options.get('verbose', False):
            command.append('--verbose')
        
        timeout = options.get('timeout', self.DEFAULT_TIMEOUT)
        
        log_to_workspace(
            workspace_id=workspace_id,
            source='XSSER',
            level='INFO',
            message=f"Starting XSSer scan {scan_id}",
            metadata={'scan_id': scan_id, 'target': url, 'command': ' '.join(command)}
        )
        
        try:
            # Ejecutar comando
            process = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            
            # Guardar output en archivo
            with open(output_file, 'w') as f:
                f.write(process.stdout)
                if process.stderr:
                    f.write(f"\n--- STDERR ---\n{process.stderr}")
            
            # Parsear resultados
            from services.vulnerability.xss_scanner.parsers import XSSerParser
            parser = XSSerParser()
            results = parser.parse_output(process.stdout)
            
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSER',
                level='INFO',
                message=f"XSSer scan {scan_id} completed",
                metadata={'scan_id': scan_id, 'vulnerabilities_found': len(results.get('vulnerabilities', []))}
            )
            
            return {
                'success': True,
                'tool': 'xsser',
                'vulnerabilities': results.get('vulnerabilities', []),
                'raw_output': process.stdout,
                'output_file': str(output_file)
            }
            
        except subprocess.TimeoutExpired:
            error_msg = f"XSSer scan {scan_id} timed out after {timeout} seconds"
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSER',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id}
            )
            raise TimeoutError(error_msg)
        except Exception as e:
            error_msg = f"XSSer scan {scan_id} failed: {str(e)}"
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSER',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id, 'error': str(e)}
            )
            raise
    
    def preview_command(
        self,
        url: str,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Genera preview del comando XSSer."""
        if not shutil.which('xsser'):
            return {
                'tool': 'xsser',
                'command': None,
                'warning': 'XSSer not found'
            }
        
        command = ['xsser', '--auto', '-u', url]
        
        if options.get('custom_cookies'):
            command.extend(['--Coo', options['custom_cookies']])
        if options.get('custom_payload'):
            command.extend(['--payload', options['custom_payload']])
        
        return {
            'tool': 'xsser',
            'command': ' '.join(command),
            'description': 'Fast XSS scanner with automatic payload generation'
        }


