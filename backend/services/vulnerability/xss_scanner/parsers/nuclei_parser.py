"""
Nuclei Output Parser
====================

Parser para resultados de Nuclei.
"""

import json
import logging
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class NucleiParser:
    """Parser para salida JSONL de Nuclei."""
    
    def parse_output(self, stdout: str) -> Dict[str, Any]:
        """Parsea salida JSONL de Nuclei."""
        vulnerabilities = []
        
        for line in stdout.strip().split('\n'):
            if not line.strip():
                continue
            try:
                finding = json.loads(line)
                # Filtrar solo XSS
                if 'xss' in finding.get('template-id', '').lower() or 'xss' in finding.get('info', {}).get('tags', []):
                    vuln = self._normalize_vulnerability(finding)
                    if vuln:
                        vulnerabilities.append(vuln)
            except json.JSONDecodeError:
                continue
        
        return {'vulnerabilities': vulnerabilities}
    
    def _normalize_vulnerability(self, finding: Dict) -> Optional[Dict[str, Any]]:
        """Normaliza vulnerabilidad de Nuclei a formato com√∫n."""
        try:
            info = finding.get('info', {})
            return {
                'type': 'XSS',
                'subtype': 'reflected',
                'payload': finding.get('matched-at', ''),
                'parameter': '',
                'context': 'html',
                'severity': info.get('severity', 'medium').lower(),
                'confidence': 'high',
                'detected_by': 'nuclei',
                'url': finding.get('host', ''),
                'method': 'GET',
                'evidence': finding.get('matched-at', ''),
                'remediation': info.get('reference', '') or 'Sanitize user input and use Content Security Policy (CSP)'
            }
        except Exception:
            return None


