"""
XSSer Output Parser
===================

Parser para resultados de XSSer.
"""

import logging
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class XSSerParser:
    """Parser para salida de XSSer."""
    
    def parse_output(self, stdout: str) -> Dict[str, Any]:
        """
        Parsea salida de texto de XSSer.
        Busca líneas con "XSS", "FOUND", "VULNERABLE".
        """
        vulnerabilities = []
        
        lines = stdout.split('\n')
        for i, line in enumerate(lines):
            line_lower = line.lower()
            if any(keyword in line_lower for keyword in ['xss', 'found', 'vulnerable', 'payload']):
                # Intentar extraer información de la línea
                vuln = self._extract_vulnerability(line, lines, i)
                if vuln:
                    vulnerabilities.append(vuln)
        
        return {'vulnerabilities': vulnerabilities}
    
    def _extract_vulnerability(self, line: str, all_lines: List[str], line_index: int) -> Optional[Dict[str, Any]]:
        """Extrae información de vulnerabilidad de salida de XSSer."""
        try:
            # Buscar payload en la línea o líneas siguientes
            payload = ''
            url = ''
            
            # Buscar URL y payload en líneas cercanas
            for i in range(max(0, line_index - 2), min(len(all_lines), line_index + 3)):
                current_line = all_lines[i]
                if 'http' in current_line.lower():
                    url = current_line.strip()
                if '<script' in current_line.lower() or 'alert' in current_line.lower():
                    payload = current_line.strip()
            
            if not payload and not url:
                return None
            
            return {
                'type': 'XSS',
                'subtype': 'reflected',
                'payload': payload,
                'parameter': '',
                'context': 'html',
                'severity': 'high',
                'confidence': 'medium',
                'detected_by': 'xsser',
                'url': url,
                'method': 'GET',
                'evidence': line,
                'remediation': 'Sanitize user input and use Content Security Policy (CSP)'
            }
        except Exception:
            return None


