"""
Comprehensive Scanner
====================

Scanner completo que ejecuta múltiples herramientas.
"""

import logging
from typing import Dict, Any

from utils.validators import CommandSanitizer
from ..base import BaseVulnerabilityScanner
from .nuclei_scanner import NucleiScanner
from .nikto_scanner import NiktoScanner

logger = logging.getLogger(__name__)


class ComprehensiveScanner(BaseVulnerabilityScanner):
    """Scanner completo que ejecuta múltiples herramientas."""
    
    def __init__(self, scan_repository=None, vuln_repository=None):
        """Inicializa el scanner completo."""
        super().__init__(scan_repository, vuln_repository)
        self.nuclei_scanner = NucleiScanner(scan_repository, vuln_repository)
        self.nikto_scanner = NiktoScanner(scan_repository, vuln_repository)
    
    def start_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        include_nikto: bool = True,
        include_nmap: bool = True,
        include_nuclei: bool = True
    ) -> Dict[str, Any]:
        """
        Inicia scan completo con múltiples herramientas.
        
        Args:
            target: Target objetivo
            workspace_id: ID del workspace
            user_id: ID del usuario
            include_nikto: Incluir scan de Nikto
            include_nmap: Incluir scan de Nmap
            include_nuclei: Incluir scan de Nuclei
        
        Returns:
            Dict con información de los scans iniciados
        """
        CommandSanitizer.validate_target(target)
        
        scans_started = []
        
        try:
            # 1. Nikto scan
            if include_nikto:
                has_protocol = target.startswith('http://') or target.startswith('https://')
                is_https = target.startswith('https://')
                port = 443 if is_https else 80
                
                nikto_result = self.nikto_scanner.start_scan(
                    target=target,
                    workspace_id=workspace_id,
                    user_id=user_id,
                    port=port,
                    ssl=is_https
                )
                scans_started.append({
                    'tool': 'nikto',
                    'scan_id': nikto_result['scan_id'],
                    'status': nikto_result['status']
                })
            
            # 2. Nmap vuln scan
            if include_nmap:
                from services import ScanningService
                scanning_service = ScanningService()
                
                nmap_result = scanning_service.start_nmap_scan(
                    target=target,
                    scan_type='vuln',
                    workspace_id=workspace_id,
                    user_id=user_id
                )
                scans_started.append({
                    'tool': 'nmap',
                    'scan_id': nmap_result['scan_id'],
                    'status': nmap_result['status']
                })
            
            # 3. Nuclei scan
            if include_nuclei:
                nuclei_result = self.nuclei_scanner.start_scan(
                    target=target,
                    workspace_id=workspace_id,
                    user_id=user_id,
                    severity=['critical', 'high', 'medium']
                )
                scans_started.append({
                    'tool': 'nuclei',
                    'scan_id': nuclei_result['scan_id'],
                    'status': nuclei_result['status']
                })
            
            return {
                'message': 'Comprehensive scan iniciado',
                'scans': scans_started,
                'total_scans': len(scans_started)
            }
            
        except Exception as e:
            logger.error(f"Error starting comprehensive scan: {e}")
            raise
    
    def preview_scan(
        self,
        target: str,
        workspace_id: int,
        include_nikto: bool = True,
        include_nmap: bool = True,
        include_nuclei: bool = True
    ) -> Dict[str, Any]:
        """
        Preview del comando Comprehensive Scan.
        
        Args:
            target: Target objetivo
            workspace_id: ID del workspace
            include_nikto: Incluir scan de Nikto
            include_nmap: Incluir scan de Nmap
            include_nuclei: Incluir scan de Nuclei
        
        Returns:
            Dict con información de los comandos que se ejecutarán
        """
        CommandSanitizer.validate_target(target)
        
        commands = []
        warnings = []
        suggestions = []
        
        # 1. Nikto preview
        if include_nikto:
            has_protocol = target.startswith('http://') or target.startswith('https://')
            is_https = target.startswith('https://')
            port = 443 if is_https else 80
            
            nikto_preview = self.nikto_scanner.preview_scan(
                target=target,
                workspace_id=workspace_id,
                port=port,
                ssl=is_https
            )
            commands.append({
                'tool': 'nikto',
                'command': nikto_preview.get('command_string', ''),
                'description': 'Web server scanner'
            })
        
        # 2. Nmap vuln preview
        if include_nmap:
            commands.append({
                'tool': 'nmap',
                'command': f'nmap --script vuln {target}',
                'description': 'Vulnerability detection with NSE scripts'
            })
        
        # 3. Nuclei preview
        if include_nuclei:
            nuclei_preview = self.nuclei_scanner.preview_scan(
                target=target,
                workspace_id=workspace_id,
                severity=['critical', 'high', 'medium']
            )
            commands.append({
                'tool': 'nuclei',
                'command': nuclei_preview.get('command_string', ''),
                'description': 'Template-based vulnerability scanner'
            })
        
        command_string = ' && '.join([cmd['command'] for cmd in commands if cmd.get('command')])
        
        return {
            'command': [cmd['command'] for cmd in commands if cmd.get('command')],
            'command_string': command_string,
            'parameters': {
                'tool': 'comprehensive',
                'target': target,
                'include_nikto': include_nikto,
                'include_nmap': include_nmap,
                'include_nuclei': include_nuclei
            },
            'estimated_timeout': 7200,  # 2 horas para scan completo
            'output_file': f'/workspaces/workspace_{workspace_id}/vuln_scans/comprehensive_{{scan_id}}',
            'warnings': warnings,
            'suggestions': suggestions,
            'tools': [cmd['tool'] for cmd in commands]
        }

