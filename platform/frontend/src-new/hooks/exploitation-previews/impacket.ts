/**
 * Impacket Suite Previews
 * =======================
 * 
 * Handlers de preview para herramientas de Impacket.
 */

import { toast } from 'sonner'
import { commandPreviewAPI } from '../../lib/api/command-preview'
import { PreviewState, PreviewHandlers, ExecuteCallback } from './types'

export const createImpacketPreviewHandlers = (
  state: PreviewState,
  handlers: PreviewHandlers,
  workspaceId: number
) => {
  const handleImpacketPsexecWithPreview = async (params: {
    target: string
    username: string
    password: string
    domain?: string
    hash?: string
    command?: string
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketPsexec({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket psexec')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket psexec:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleImpacketWmiexecWithPreview = async (params: {
    target: string
    username: string
    password: string
    domain?: string
    hash?: string
    command?: string
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketWmiexec({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket wmiexec')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket wmiexec:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleImpacketSmbexecWithPreview = async (params: {
    target: string
    username: string
    password: string
    domain?: string
    hash?: string
    command?: string
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketSmbexec({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket smbexec')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        command: params.command
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket smbexec:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleImpacketSecretsdumpWithPreview = async (params: {
    target: string
    username: string
    password: string
    domain?: string
    hash?: string
    justDc: boolean
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketSecretsdump({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        just_dc: params.justDc
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket secretsdump')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        just_dc: params.justDc
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket secretsdump:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleImpacketGetUserSPNsWithPreview = async (params: {
    target: string
    username: string
    password: string
    domain: string
    hash?: string
    request: boolean
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketGetUserSPNs({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        request: params.request
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket GetUserSPNs')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        domain: params.domain,
        hash: params.hash,
        request: params.request
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket GetUserSPNs:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleImpacketGetNPUsersWithPreview = async (params: {
    target: string
    domain: string
    usersFile?: string
    noPass: boolean
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewImpacketGetNPUsers({
        workspace_id: workspaceId,
        target: params.target,
        domain: params.domain,
        users_file: params.usersFile,
        no_pass: params.noPass
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Impacket GetNPUsers')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        domain: params.domain,
        users_file: params.usersFile,
        no_pass: params.noPass
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Impacket GetNPUsers:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  return {
    handleImpacketPsexecWithPreview,
    handleImpacketWmiexecWithPreview,
    handleImpacketSmbexecWithPreview,
    handleImpacketSecretsdumpWithPreview,
    handleImpacketGetUserSPNsWithPreview,
    handleImpacketGetNPUsersWithPreview
  }
}


