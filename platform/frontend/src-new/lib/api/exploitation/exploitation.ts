/**
 * Módulo de Explotación (Exploitation)
 * Maneja operaciones relacionadas con explotación de vulnerabilidades profesionales
 */

import { api } from '../shared/client'

/**
 * Interfaces para las herramientas de explotación
 */
export interface ExploitSession {
  id: number
  session_id: string
  target: string
  scan_type: string
  created_at: string
  status: string
}

export interface ExploitResponse {
  scan_id: number
  status: string
  tool: string
  target?: string
  service?: string
  domain?: string
  message?: string
}

// ============================================
// HYDRA - Brute Force
// ============================================

export interface HydraRequest {
  target: string
  service: 'ssh' | 'smb' | 'ftp' | 'rdp' | 'http-post-form' | 'mysql' | string
  workspace_id: number
  username?: string
  userfile?: string
  password?: string
  passfile?: string
  port?: number
  threads?: number
}

export const startHydraAttack = async (request: HydraRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/hydra', request)
  return response.data
}

// ============================================
// HASH CRACKING
// ============================================

export interface JohnRequest {
  hash_file: string
  workspace_id: number
  wordlist?: string
  format?: string
  rules?: boolean
}

export const startJohn = async (request: JohnRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/john', request)
  return response.data
}

export interface HashcatRequest {
  hash_file: string
  workspace_id: number
  mode: number
  wordlist: string
  rules_file?: string
}

export const startHashcat = async (request: HashcatRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/hashcat', request)
  return response.data
}

export interface KerbruteRequest {
  domain: string
  workspace_id: number
  mode: 'userenum' | 'passwordspray' | 'bruteuser'
  users_file?: string
  passwords_file?: string
  password?: string
  dc_ip?: string
}

export const startKerbrute = async (request: KerbruteRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/kerbrute', request)
  return response.data
}

// ============================================
// CRACKMAPEXEC - AD Exploitation
// ============================================

export interface CrackMapExecRequest {
  targets: string
  protocol: 'smb' | 'winrm' | 'ssh' | 'ldap' | 'mssql'
  workspace_id: number
  username?: string
  password?: string
  hash?: string
  domain?: string
  command?: string
  shares?: boolean
  pass_pol?: boolean
}

export const startCrackMapExec = async (request: CrackMapExecRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/crackmapexec', request)
  return response.data
}

// ============================================
// RESPONDER
// ============================================

export interface ResponderRequest {
  interface: string
  workspace_id: number
  lm?: boolean
}

export const startResponder = async (request: ResponderRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/responder', request)
  return response.data
}

// ============================================
// IMPACKET SUITE - Execution
// ============================================

export interface ImpacketPsexecRequest {
  target: string
  workspace_id: number
  domain: string
  username: string
  password?: string
  hash?: string
  command: string
}

export const startImpacketPsexec = async (request: ImpacketPsexecRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/psexec', request)
  return response.data
}

export interface ImpacketWmiexecRequest {
  target: string
  workspace_id: number
  username: string
  password?: string
  hash?: string
  domain?: string
  command: string
}

export const startImpacketWmiexec = async (request: ImpacketWmiexecRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/wmiexec', request)
  return response.data
}

export interface ImpacketSmbexecRequest {
  target: string
  workspace_id: number
  username: string
  password?: string
  hash?: string
  domain?: string
  command: string
}

export const startImpacketSmbexec = async (request: ImpacketSmbexecRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/smbexec', request)
  return response.data
}

// ============================================
// IMPACKET SUITE - Dumping
// ============================================

export interface ImpacketSecretsdumpRequest {
  target: string
  workspace_id: number
  username: string
  password?: string
  hash?: string
  domain?: string
  just_dc?: boolean
}

export const startImpacketSecretsdump = async (request: ImpacketSecretsdumpRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/secretsdump', request)
  return response.data
}

export interface ImpacketGetUserSPNsRequest {
  target: string
  workspace_id: number
  domain: string
  username: string
  password: string
  dc_ip?: string
  request?: boolean
}

export const startImpacketGetUserSPNs = async (request: ImpacketGetUserSPNsRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/getuserspns', request)
  return response.data
}

export interface ImpacketGetNPUsersRequest {
  domain: string
  workspace_id: number
  users_file?: string
  username?: string
  dc_ip?: string
  no_pass?: boolean
}

export const startImpacketGetNPUsers = async (request: ImpacketGetNPUsersRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/impacket/getnpusers', request)
  return response.data
}

// ============================================
// EVIL-WINRM - WinRM Shell
// ============================================

export interface EvilWinRMRequest {
  target: string
  workspace_id: number
  username: string
  password?: string
  hash?: string
  ssl?: boolean
}

export const startEvilWinRM = async (request: EvilWinRMRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/evilwinrm', request)
  return response.data
}

// ============================================
// METASPLOIT/MSFVENOM - Payload Generation
// ============================================

export interface MetasploitPayloadRequest {
  payload_type: string
  lhost: string
  lport: number
  workspace_id: number
  format?: string
  encoder?: string
  iterations?: number
  output_file?: string
}

export const startMetasploitPayload = async (request: MetasploitPayloadRequest): Promise<ExploitResponse> => {
  const response = await api.post<ExploitResponse>('exploitation/metasploit/payload', request)
  return response.data
}

// ============================================
// SESSIONS
// ============================================

export const getExploitSessions = async (): Promise<ExploitSession[]> => {
  const response = await api.get<{ sessions: ExploitSession[] }>('exploitation/sessions')
  return response.data.sessions || []
}

/**
 * Objeto API de explotación - agrupa todas las funciones
 */
export const exploitationAPI = {
  // Password Attacks
  startHydraAttack,
  startJohn,
  startHashcat,
  startKerbrute,
  // Network Exploitation
  startCrackMapExec,
  startResponder,
  // Impacket Execution
  startImpacketPsexec,
  startImpacketWmiexec,
  startImpacketSmbexec,
  // Impacket Dumping
  startImpacketSecretsdump,
  startImpacketGetUserSPNs,
  startImpacketGetNPUsers,
  // Remote Access
  startEvilWinRM,
  // Payloads
  startMetasploitPayload,
  // Sessions
  getExploitSessions
}
