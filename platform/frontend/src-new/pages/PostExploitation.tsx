import React, { useState } from 'react'
import { Shield, AlertTriangle, Eye, Zap, Route, Network } from 'lucide-react'
import { useQuery, useQueryClient } from '@tanstack/react-query'
import { postExploitAPI } from '../lib/api/postExploit'
import LoadingSpinner from '../components/LoadingSpinner'
import { toast } from 'sonner'
import { useAuth } from '../contexts/AuthContext'
import { useConsole } from '../contexts/ConsoleContext'
import {
  LinPEASSection,
  WinPEASSection,
  MimikatzSection,
  SeatbeltSection,
  SSHPivotSection,
  ChiselSection,
  LigoloSection
} from '../components/postExploitation'

const PostExploitation: React.FC = () => {
  const { isAuthenticated } = useAuth()
  const [activeTab, setActiveTab] = useState('linpeas')
  const [activeScanSession, setActiveScanSession] = useState<number | null>(null)
  const queryClient = useQueryClient()
  const { tasks } = useConsole()

  // Query para obtener resultados del scan activo
  const { data: scanResults, isLoading: scanResultsLoading } = useQuery({
    queryKey: ['post-exploit-scan-results', activeScanSession],
    queryFn: () => activeScanSession ? postExploitAPI.getScanResults(activeScanSession) : null,
    enabled: !!activeScanSession,
    staleTime: 0,
    cacheTime: 0,
  })

  // Función para renderizar el contenido de cada tab
  const renderTabContent = () => {
    const commonProps = { setActiveScanSession }

    switch (activeTab) {
      case 'linpeas':
        return <LinPEASSection {...commonProps} />
      case 'winpeas':
        return <WinPEASSection {...commonProps} />
      case 'mimikatz':
        return <MimikatzSection {...commonProps} />
      case 'seatbelt':
        return <SeatbeltSection {...commonProps} />
      case 'ssh-pivot':
        return <SSHPivotSection {...commonProps} />
      case 'chisel':
        return <ChiselSection {...commonProps} />
      case 'ligolo':
        return <LigoloSection {...commonProps} />
      default:
        return <LinPEASSection {...commonProps} />
    }
  }

  // Función para renderizar los resultados del scan activo
  const renderScanResults = () => {
    if (!activeScanSession || scanResultsLoading) {
      return null
    }

    if (!scanResults) {
      return (
        <div className="bg-white border border-yellow-500 rounded-xl p-6 mt-4">
          <p className="text-yellow-600">No hay resultados disponibles para este scan.</p>
        </div>
      )
    }

    return (
      <div className="bg-white border border-gray-200 rounded-xl p-6 mt-4">
        <h3 className="text-lg font-bold text-gray-900 mb-4">Resultados del Scan</h3>
        <pre className="bg-gray-50 p-4 rounded text-gray-900 text-sm overflow-x-auto">
          {JSON.stringify(scanResults, null, 2)}
        </pre>
    </div>
  )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Post-Exploitation</h1>
          <p className="text-gray-500 mt-1">Privilege escalation and pivoting tools</p>
        </div>
        <div className="flex items-center gap-2 px-3 py-1.5 bg-red-50 text-red-600 rounded-lg text-sm font-medium">
          <Shield className="w-4 h-4" />
          High Risk Tools
        </div>
      </div>

      {/* Advertencia de seguridad crítica */}
      <div className="border border-red-200 bg-red-50 p-6 rounded-xl">
        <div className="flex items-center gap-2 mb-4">
          <AlertTriangle className="w-6 h-6 text-red-600" />
          <h2 className="text-lg font-semibold text-red-800">CRITICAL SECURITY WARNING</h2>
        </div>
        <div className="text-red-700 space-y-2 text-sm">
          <p>• <strong>These operations can cause permanent damage to the target system.</strong></p>
          <p>• <strong>Running these tools requires explicit authorization.</strong></p>
          <p>• <strong>Credential extraction may violate privacy laws.</strong></p>
          <p>• <strong>Only use in controlled test environments with express authorization.</strong></p>
        </div>
      </div>

      {/* Herramientas de post-explotación */}
      <div className="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
        <div className="mb-4">
          <h2 className="text-lg font-semibold text-gray-900">Post-Exploitation Tools</h2>
          <p className="text-gray-500 text-sm">
            Select the specific tool you want to run
          </p>
        </div>

        <div className="w-full">
          <div className="flex border-b border-gray-200 mb-4 overflow-x-auto">
            <button
              onClick={() => setActiveTab('linpeas')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap transition-colors ${
                activeTab === 'linpeas'
                  ? 'border-red-500 text-red-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <Eye className="w-4 h-4" />
              LinPEAS
            </button>
            <button
              onClick={() => setActiveTab('winpeas')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap transition-colors ${
                activeTab === 'winpeas'
                  ? 'border-red-500 text-red-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <Eye className="w-4 h-4" />
              WinPEAS
            </button>
            <button
              onClick={() => setActiveTab('mimikatz')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap transition-colors ${
                activeTab === 'mimikatz'
                  ? 'border-red-500 text-red-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <Shield className="w-4 h-4" />
              Mimikatz
            </button>
            <button
              onClick={() => setActiveTab('seatbelt')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap transition-colors ${
                activeTab === 'seatbelt'
                  ? 'border-red-500 text-red-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              <Shield className="w-4 h-4" />
              Seatbelt
            </button>
            <button
              onClick={() => setActiveTab('ssh-pivot')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'ssh-pivot'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-500 hover:text-red-400'
              }`}
            >
              <Route className="w-4 h-4" />
              SSH Pivot
            </button>
            <button
              onClick={() => setActiveTab('chisel')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'chisel'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-500 hover:text-red-400'
              }`}
            >
              <Zap className="w-4 h-4" />
              Chisel
            </button>
            <button
              onClick={() => setActiveTab('ligolo')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'ligolo'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-500 hover:text-red-400'
              }`}
            >
              <Network className="w-4 h-4" />
              Ligolo
            </button>
          </div>

            <div className="mt-4">
            {renderTabContent()}
            </div>
        </div>
      </div>

      {/* Resultados del scan activo */}
      {renderScanResults()}

      {/* Información del scan activo */}
      {activeScanSession && (
        <div className="bg-white border border-blue-500 rounded-xl p-6">
          <h3 className="text-lg font-bold text-blue-400 mb-2">Scan Activo</h3>
          <p className="text-blue-600">
            ID del scan: <span className="font-mono">{activeScanSession}</span>
          </p>
          <p className="text-sm text-gray-500 mt-2">
            Los resultados se mostrarán arriba automáticamente cuando estén disponibles.
          </p>
        </div>
      )}
    </div>
  )
}

export default PostExploitation

