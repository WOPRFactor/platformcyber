/**
 * Metasploit Previews
 * ===================
 * 
 * Handlers de preview para Metasploit Framework.
 */

import { toast } from 'sonner'
import { commandPreviewAPI } from '../../lib/api/command-preview'
import { PreviewState, PreviewHandlers, ExecuteCallback } from './types'

export const createMetasploitPreviewHandlers = (
  state: PreviewState,
  handlers: PreviewHandlers,
  workspaceId: number
) => {
  const handleMsfvenomWithPreview = async (params: {
    payloadType: string
    lhost: string
    lport: number
    format: string
    encoder?: string
    iterations: number
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewMsfvenom({
        workspace_id: workspaceId,
        payload_type: params.payloadType,
        lhost: params.lhost,
        lport: params.lport,
        format: params.format,
        encoder: params.encoder,
        iterations: params.iterations
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('MSFvenom')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        payload_type: params.payloadType,
        lhost: params.lhost,
        lport: params.lport,
        format: params.format,
        encoder: params.encoder,
        iterations: params.iterations
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de MSFvenom:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleMetasploitHandlerWithPreview = async (params: {
    payload: string
    lhost: string
    lport: number
    exitOnSession: boolean
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewMetasploitHandler({
        workspace_id: workspaceId,
        payload: params.payload,
        lhost: params.lhost,
        lport: params.lport,
        exit_on_session: params.exitOnSession
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Metasploit Handler')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        payload: params.payload,
        lhost: params.lhost,
        lport: params.lport,
        exit_on_session: params.exitOnSession
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Metasploit Handler:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  return {
    handleMsfvenomWithPreview,
    handleMetasploitHandlerWithPreview
  }
}


