/**
 * Pentest Selector API Client
 */
import { api } from '../shared/client'
import type {
  PentestMethodology,
  MethodologyWorkflow,
  CreateProjectData,
  PentestProject,
  ProjectSummary,
  PentestFinding,
  PentestDashboard,
  ApiResponse
} from './types'

const BASE_URL = '/pentest'

export const pentestSelectorAPI = {
  /**
   * Get all available methodologies
   */
  getMethodologies: async (): Promise<Record<string, PentestMethodology>> => {
    const response = await api.get<Record<string, PentestMethodology>>(
      `${BASE_URL}/methodologies`
    )
    return response.data
  },

  /**
   * Get specific methodology
   */
  getMethodology: async (methodologyId: string): Promise<PentestMethodology> => {
    const response = await api.get<{ methodology: PentestMethodology }>(
      `${BASE_URL}/methodologies/${methodologyId}`
    )
    return response.data.methodology
  },

  /**
   * Get methodology workflow
   */
  getMethodologyWorkflow: async (
    methodologyId: string
  ): Promise<MethodologyWorkflow> => {
    const response = await api.get<MethodologyWorkflow>(
      `${BASE_URL}/methodologies/${methodologyId}/workflow`
    )
    return response.data
  },

  /**
   * Preview project creation (without creating)
   */
  previewProject: async (projectData: CreateProjectData): Promise<any> => {
    const response = await api.post<any>(
      `${BASE_URL}/projects/preview`,
      projectData
    )
    return response.data
  },

  /**
   * Create new pentest project
   */
  createProject: async (projectData: CreateProjectData): Promise<ApiResponse> => {
    const response = await api.post<ApiResponse>(
      `${BASE_URL}/projects`,
      projectData
    )
    return response.data
  },

  /**
   * List all projects
   */
  listProjects: async (filters?: {
    status?: string
    methodology?: string
  }): Promise<ProjectSummary[]> => {
    const params = new URLSearchParams()
    if (filters?.status) params.append('status', filters.status)
    if (filters?.methodology) params.append('methodology', filters.methodology)

    const url = params.toString()
      ? `${BASE_URL}/projects?${params.toString()}`
      : `${BASE_URL}/projects`

    const response = await api.get<ProjectSummary[]>(url)
    return response.data
  },

  /**
   * Get specific project
   */
  getProject: async (projectId: string): Promise<PentestProject> => {
    const response = await api.get<PentestProject>(
      `${BASE_URL}/projects/${projectId}`
    )
    return response.data
  },

  /**
   * Update project status
   */
  updateProjectStatus: async (
    projectId: string,
    status: string,
    phaseCompleted?: string
  ): Promise<ApiResponse> => {
    const response = await api.put<ApiResponse>(
      `${BASE_URL}/projects/${projectId}/status`,
      {
        status,
        phase_completed: phaseCompleted
      }
    )
    return response.data
  },

  /**
   * Add finding to project
   */
  addProjectFinding: async (
    projectId: string,
    finding: Omit<PentestFinding, 'id' | 'created_at' | 'created_by'> & { workspace_id?: number }
  ): Promise<ApiResponse> => {
    const response = await api.post<ApiResponse>(
      `${BASE_URL}/projects/${projectId}/findings`,
      finding
    )
    return response.data
  },

  /**
   * Get dashboard statistics
   */
  getPentestDashboard: async (): Promise<PentestDashboard> => {
    const response = await api.get<PentestDashboard>(`${BASE_URL}/dashboard`)
    return response.data
  },

  /**
   * Health check
   */
  healthCheck: async (): Promise<{ status: string; service: string; version: string }> => {
    const response = await api.get(`${BASE_URL}/health`)
    return response.data
  }
}


