import React from 'react'
import { useNavigate } from 'react-router-dom'
import { Plus, CheckCircle } from 'lucide-react'
import type { MethodologyWorkflow, WorkflowPhase } from '../../../lib/api/pentestSelector/types'

// Mapeo de herramientas a rutas
const toolRouteMap: Record<string, string> = {
  // === BLACK BOX ===
  // Reconnaissance
  'theHarvester': '/reconnaissance',
  'Sublist3r': '/reconnaissance',
  'Amass': '/reconnaissance',
  'Shodan': '/reconnaissance',
  'Censys': '/reconnaissance',
  'Findomain': '/reconnaissance',
  'Subfinder': '/reconnaissance',
  'DNSenum': '/reconnaissance',
  'Whois': '/reconnaissance',
  
  // Scanning
  'Nmap': '/scanning',
  'Masscan': '/scanning',
  'Rustscan': '/scanning',
  'Naabu': '/scanning',
  
  // Enumeration
  'enum4linux': '/scanning',
  'smbclient': '/scanning',
  'ldapsearch': '/active-directory',
  'snmpwalk': '/scanning',
  
  // Vulnerability
  'Nuclei': '/vulnerability',
  'Nikto': '/vulnerability',
  'WPScan': '/vulnerability',
  'testssl.sh': '/vulnerability',
  'SQLMap': '/integrations',
  'XSStrike': '/vulnerability',
  'OWASP ZAP': '/vulnerability',
  'Gobuster': '/integrations',
  'FFuF': '/vulnerability',
  'Dirb': '/vulnerability',
  
  // Exploitation
  'Metasploit': '/integrations',
  'Burp Suite': '/integrations',
  
  // Post-Exploitation
  'LinPEAS': '/post-exploitation',
  'WinPEAS': '/post-exploitation',
  'Mimikatz': '/active-directory',
  'BloodHound': '/active-directory',
  
  // === GRAY BOX ===
  'PowerView': '/active-directory',
  'ldapdomaindump': '/active-directory',
  'Nmap (authenticated)': '/scanning',
  'CrackMapExec': '/active-directory',
  'Nessus': '/vulnerability',
  'Autorize': '/vulnerability',
  'BeRoot': '/post-exploitation',
  'PEASS-ng': '/post-exploitation',
  'Evil-WinRM': '/post-exploitation',
  'Impacket': '/post-exploitation',
  'Proxychains': '/post-exploitation',
  
  // === WHITE BOX ===
  'Semgrep': '/whitebox',
  'Bandit': '/whitebox',
  'SonarQube': '/whitebox',
  'CodeQL': '/whitebox',
  'OWASP Dependency-Check': '/whitebox',
  'pip-audit': '/whitebox',
  'npm audit': '/whitebox',
  'Snyk': '/whitebox',
  'TruffleHog': '/whitebox',
  'GitLeaks': '/whitebox',
  'detect-secrets': '/whitebox',
  'Checkov': '/container',
  'Trivy': '/container',
  'kube-bench': '/container',
  'docker-bench-security': '/container',
  'ESLint': '/whitebox',
  'Pylint': '/whitebox',
  'RuboCop': '/whitebox',
  'Retire.js': '/whitebox',
  'Safety': '/whitebox',
  'Bundle Audit': '/whitebox',
  
  // === RED TEAM ===
  'OSINT Framework': '/reconnaissance',
  'Maltego': '/reconnaissance',
  'msfvenom': '/exploitation',
  'Donut': '/exploitation',
  'Veil': '/exploitation',
  'Shellter': '/exploitation',
  'GoPhish': '/reconnaissance',
  'SET': '/reconnaissance',
  'King Phisher': '/reconnaissance',
  'Evilginx2': '/reconnaissance',
  'Cobalt Strike': '/exploitation',
  'Empire': '/exploitation',
  'Covenant': '/exploitation',
  'PowerShell Empire': '/exploitation',
  'Sliver': '/exploitation',
  'Mythic': '/exploitation',
  'SharpHound': '/active-directory',
  'Rubeus': '/active-directory',
  'Responder': '/active-directory',
  
  // === HERRAMIENTAS SIN PÁGINA ESPECÍFICA (navegan a dashboard) ===
  'Draw.io': '/dashboard',
  'PlantUML': '/dashboard',
  'Threat Dragon': '/dashboard',
  'VS Code': '/dashboard',
  'Sublime Text': '/dashboard',
  'grep': '/dashboard',
  'ripgrep': '/dashboard',
  'OWASP Threat Dragon': '/dashboard',
  'Microsoft Threat Modeling Tool': '/dashboard',
  'Markdown': '/reporting',
  'LaTeX': '/reporting',
  'Jupyter Notebooks': '/reporting',
  'curl': '/dashboard',
  'scp': '/dashboard',
  'PowerShell': '/dashboard',
  'DNS tunneling': '/dashboard',
}

interface WorkflowSectionProps {
  workflow: MethodologyWorkflow | null
  isLoading: boolean
  error: Error | null
  selectedMethodology: string | null
  onBack: () => void
  onCreateProject: () => void
}

export const WorkflowSection: React.FC<WorkflowSectionProps> = ({
  workflow,
  isLoading,
  error,
  selectedMethodology,
  onBack,
  onCreateProject
}) => {
  const navigate = useNavigate()

  const handleToolClick = (tool: string) => {
    const route = toolRouteMap[tool] || '/dashboard'
    navigate(route)
  }
  if (error) {
    return (
      <div className="text-center py-8">
        <div className="text-red-400 mb-2">❌ Error cargando workflow</div>
        <div className="text-gray-500 text-sm">{error.message}</div>
      </div>
    )
  }

  if (!workflow || isLoading) {
    return (
      <div className="text-center py-8">
        <div className="text-blue-400 mb-2">⏳ Cargando workflow...</div>
        <div className="text-gray-500 text-sm">
          Metodología: {selectedMethodology || 'Ninguna'}
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-white">{workflow.name}</h2>
          <p className="text-gray-500">{workflow.description}</p>
        </div>
        <div className="flex gap-2">
          <button
            onClick={onBack}
            className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl"
          >
            ← Volver
          </button>
          <button
            onClick={onCreateProject}
            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl flex items-center gap-2"
          >
            <Plus className="w-4 h-4" />
            Crear Proyecto
          </button>
        </div>
      </div>

      <div className="space-y-4">
        {workflow.workflow_phases.map((phase: WorkflowPhase, index: number) => (
          <div key={phase.phase} className="bg-gray-100 border border-gray-300 rounded-xl p-6">
            <div className="flex items-center gap-4 mb-4">
              <div className="flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-full font-bold text-lg">
                {index + 1}
              </div>
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-gray-900">{phase.name}</h3>
                <p className="text-gray-500">{phase.description}</p>
              </div>
              <div className="text-right">
                <span className="text-sm text-gray-500">{phase.estimated_time}</span>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 className="font-medium text-gray-600 mb-2">Herramientas Recomendadas:</h4>
                <div className="flex flex-wrap gap-2">
                  {phase.tools.map((tool: string) => {
                    const hasRoute = toolRouteMap[tool]
                    return (
                      <button
                        key={tool}
                        onClick={() => handleToolClick(tool)}
                        disabled={!hasRoute}
                        className={`px-3 py-1.5 text-xs rounded transition-colors border ${
                          hasRoute
                            ? 'bg-gray-700 hover:bg-gray-600 text-white border-gray-200 hover:border-gray-500 cursor-pointer'
                            : 'bg-white text-gray-500 border-gray-200 cursor-not-allowed opacity-60'
                        }`}
                        title={hasRoute ? `Ir a ${tool}` : 'Herramienta no disponible'}
                      >
                        {tool}
                      </button>
                    )
                  })}
                </div>
              </div>
              <div>
                <h4 className="font-medium text-gray-600 mb-2">Entregables:</h4>
                <ul className="text-sm text-gray-500 space-y-1">
                  {phase.deliverables.map((deliverable: string) => (
                    <li key={deliverable} className="flex items-center gap-2">
                      <CheckCircle className="w-4 h-4 text-gray-800" />
                      {deliverable}
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}


