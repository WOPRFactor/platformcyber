import React, { useState } from 'react'
import { Target } from 'lucide-react'
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { pentestSelectorAPI } from '../lib/api/pentestSelector'
import type {
  PentestProject,
  ProjectSummary,
  CreateProjectData,
  PentestFinding
} from '../lib/api/pentestSelector/types'
import { toast } from 'sonner'
import { useAuth } from '../contexts/AuthContext'
import { useWorkspace } from '../contexts/WorkspaceContext'
import { useCommandPreview } from './VulnerabilityAssessment/hooks/useCommandPreview'
import CommandPreviewModal from '../components/CommandPreviewModal'
import { PentestTabs } from './PentestSelector/components/PentestTabs'
import { DashboardSection } from './PentestSelector/components/DashboardSection'
import { MethodologiesSection } from './PentestSelector/components/MethodologiesSection'
import { WorkflowSection } from './PentestSelector/components/WorkflowSection'
import { ProjectsSection } from './PentestSelector/components/ProjectsSection'
import { ProjectDetails } from './PentestSelector/components/ProjectDetails'
import { CreateProjectModal } from './PentestSelector/components/CreateProjectModal'
import { AddFindingModal } from './PentestSelector/components/AddFindingModal'

const PentestSelector: React.FC = () => {
  const { isAuthenticated } = useAuth()
  const { currentWorkspace } = useWorkspace()
  const commandPreview = useCommandPreview()
  const { showPreview, previewData, previewToolName, closePreview, executePreview, openPreview } = commandPreview
  const [activeTab, setActiveTab] = useState('methodologies')
  const [selectedMethodology, setSelectedMethodology] = useState<string | null>(null)
  const [selectedProject, setSelectedProject] = useState<PentestProject | null>(null)
  const [showCreateProject, setShowCreateProject] = useState(false)
  const [showAddFinding, setShowAddFinding] = useState(false)

  const [projectForm, setProjectForm] = useState<CreateProjectData>({
    name: '',
    methodology: 'black_box',
    target: '',
    scope: [],
    client: '',
    start_date: new Date().toISOString().split('T')[0],
    objectives: [],
    team_members: []
  })

  const [findingForm, setFindingForm] = useState({
    title: '',
    description: '',
    severity: 'medium' as const,
    category: '',
    phase: '',
    remediation: '',
    tags: [] as string[]
  })

  const queryClient = useQueryClient()

  // Queries
  const { data: methodologies, isLoading: methodologiesLoading } = useQuery({
    queryKey: ['pentest_methodologies'],
    queryFn: pentestSelectorAPI.getMethodologies,
    enabled: isAuthenticated,
    retry: 2
  })

  const { data: methodologyWorkflow, isLoading: workflowLoading, error: workflowError } = useQuery({
    queryKey: ['methodology_workflow', selectedMethodology],
    queryFn: () => pentestSelectorAPI.getMethodologyWorkflow(selectedMethodology!),
    enabled: isAuthenticated && !!selectedMethodology,
  })

  const { data: projects, isLoading: projectsLoading } = useQuery({
    queryKey: ['pentest_projects'],
    queryFn: () => pentestSelectorAPI.listProjects(),
    enabled: isAuthenticated,
    refetchInterval: 10000,
  })

  const { data: selectedProjectDetails, isLoading: projectDetailsLoading } = useQuery({
    queryKey: ['project_details', selectedProject?.id],
    queryFn: () => selectedProject ? pentestSelectorAPI.getProject(selectedProject.id) : null,
    enabled: isAuthenticated && !!selectedProject,
  })

  const { data: dashboard, isLoading: dashboardLoading } = useQuery({
    queryKey: ['pentest_dashboard'],
    queryFn: pentestSelectorAPI.getPentestDashboard,
    enabled: isAuthenticated,
    refetchInterval: 30000,
  })

  // Mutations
  const createProjectMutation = useMutation({
    mutationFn: pentestSelectorAPI.createProject,
    onSuccess: (data) => {
      if (data.success) {
        toast.success('Proyecto creado exitosamente')
        setShowCreateProject(false)
        setProjectForm({
          name: '',
          methodology: 'black_box',
          target: '',
          scope: [],
          client: '',
          start_date: new Date().toISOString().split('T')[0],
          objectives: [],
          team_members: []
        })
        queryClient.invalidateQueries({ queryKey: ['pentest_projects'] })
      } else {
        toast.error('Error creando proyecto')
      }
    },
    onError: (error: any) => {
      toast.error(`Error: ${error.message}`)
    }
  })

  const updateProjectStatusMutation = useMutation({
    mutationFn: ({ projectId, status, phaseCompleted }: { projectId: string; status: string; phaseCompleted?: string }) =>
      pentestSelectorAPI.updateProjectStatus(projectId, status, phaseCompleted),
    onSuccess: (data) => {
      if (data.success) {
        toast.success('Estado del proyecto actualizado')
        queryClient.invalidateQueries({ queryKey: ['pentest_projects'] })
        if (selectedProject) {
          queryClient.invalidateQueries({ queryKey: ['project_details', selectedProject.id] })
        }
      } else {
        toast.error('Error actualizando proyecto')
      }
    },
    onError: (error: any) => {
      toast.error(`Error: ${error.message}`)
    }
  })

  const addFindingMutation = useMutation({
    mutationFn: ({ projectId, finding }: { projectId: string; finding: Omit<PentestFinding, 'id' | 'created_at' | 'created_by'> & { workspace_id?: number } }) =>
      pentestSelectorAPI.addProjectFinding(projectId, finding),
    onSuccess: (data) => {
      if (data.success) {
        toast.success('Hallazgo agregado exitosamente')
        setShowAddFinding(false)
        setFindingForm({
          title: '',
          description: '',
          severity: 'medium',
          category: '',
          phase: '',
          remediation: '',
          tags: []
        })
        if (selectedProject) {
          queryClient.invalidateQueries({ queryKey: ['project_details', selectedProject.id] })
        }
      } else {
        toast.error('Error agregando hallazgo')
      }
    },
    onError: (error: any) => {
      toast.error(`Error: ${error.message}`)
    }
  })

  const handlePreviewProject = async () => {
    if (!projectForm.target.trim() || !projectForm.methodology) {
      toast.error('Target y metodología son requeridos')
      return
    }
    if (!currentWorkspace?.id) {
      toast.error('Selecciona un workspace primero')
      return
    }

    try {
      const preview = await pentestSelectorAPI.previewProject({
        ...projectForm,
        workspace_id: currentWorkspace.id
      })
      openPreview(preview, 'Pentest Selector', async () => {
        await createProjectMutation.mutateAsync({
          ...projectForm,
          workspace_id: currentWorkspace.id
        })
      })
    } catch (error: any) {
      toast.error(`Error obteniendo preview: ${error.message}`)
    }
  }

  const handleCreateProject = () => {
    if (!projectForm.target.trim() || !projectForm.methodology) {
      toast.error('Target y metodología son requeridos')
      return
    }
    if (!currentWorkspace?.id) {
      toast.error('Selecciona un workspace primero')
      return
    }
    createProjectMutation.mutate({
      ...projectForm,
      workspace_id: currentWorkspace.id
    })
  }

  const handleAddFinding = () => {
    if (!selectedProject || !findingForm.title.trim() || !findingForm.description.trim()) {
      toast.error('Proyecto seleccionado y título/descripción son requeridos')
      return
    }
    if (!currentWorkspace?.id) {
      toast.error('Selecciona un workspace primero')
      return
    }
    addFindingMutation.mutate({
      projectId: selectedProject.id,
      finding: {
        ...findingForm,
        workspace_id: currentWorkspace.id
      }
    })
  }

  const handleViewWorkflow = (key: string) => {
    setSelectedMethodology(key)
    setActiveTab('workflow')
  }

  const handleCreateProjectFromWorkflow = () => {
    setProjectForm(prev => ({ ...prev, methodology: selectedMethodology! }))
    setShowCreateProject(true)
  }

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold text-gray-900">Selector de Pentest</h1>
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <Target className="w-4 h-4" />
          Metodologías de caja negra, gris y blanca
        </div>
      </div>

      <div className="bg-gray-100 border border-gray-300 rounded-xl p-6">
        <PentestTabs activeTab={activeTab} setActiveTab={setActiveTab} />

        {activeTab === 'dashboard' && (
          <DashboardSection dashboard={dashboard} isLoading={dashboardLoading} />
        )}

        {activeTab === 'methodologies' && (
          <MethodologiesSection
            methodologies={methodologies}
            isLoading={methodologiesLoading}
            selectedMethodology={selectedMethodology}
            onSelectMethodology={setSelectedMethodology}
            onViewWorkflow={handleViewWorkflow}
          />
        )}

        {activeTab === 'workflow' && (
          <WorkflowSection
            workflow={methodologyWorkflow}
            isLoading={workflowLoading}
            error={workflowError}
            selectedMethodology={selectedMethodology}
            onBack={() => setActiveTab('methodologies')}
            onCreateProject={handleCreateProjectFromWorkflow}
          />
        )}

        {activeTab === 'projects' && (
          <ProjectsSection
            projects={projects}
            isLoading={projectsLoading}
            onCreateProject={() => setShowCreateProject(true)}
            onSelectProject={(project) => setSelectedProject(project as any)}
          />
        )}
      </div>

      {selectedProject && selectedProjectDetails && (
        <ProjectDetails
          project={selectedProjectDetails}
          onAddFinding={() => setShowAddFinding(true)}
          onUpdateStatus={(status) => updateProjectStatusMutation.mutate({
            projectId: selectedProject.id,
            status
          })}
        />
      )}

      <CreateProjectModal
        isOpen={showCreateProject}
        form={projectForm}
        isLoading={createProjectMutation.isPending}
        onClose={() => setShowCreateProject(false)}
        onSubmit={handleCreateProject}
        onPreview={handlePreviewProject}
        onFormChange={setProjectForm}
      />

      <AddFindingModal
        isOpen={showAddFinding}
        form={findingForm}
        isLoading={addFindingMutation.isPending}
        onClose={() => setShowAddFinding(false)}
        onSubmit={handleAddFinding}
        onFormChange={setFindingForm}
      />

      <CommandPreviewModal
        isOpen={showPreview}
        onClose={closePreview}
        previewData={previewData}
        category="Pentest Selector"
        toolName={previewToolName}
        onExecute={async () => {
          await executePreview()
        }}
      />
    </div>
  )
}

export default PentestSelector
