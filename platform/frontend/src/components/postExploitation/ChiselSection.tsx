/**
 * ChiselSection Component
 * =======================
 *
 * Componente para configurar tunneling con Chisel.
 */

import React, { useState, useRef } from 'react'
import { Zap, Loader2, Terminal } from 'lucide-react'
import { useMutation } from '@tanstack/react-query'
import { postExploitAPI } from '../../lib/api/postExploit'
import { commandPreviewAPI } from '../../lib/api/command-preview'
import { useWorkspace } from '../../contexts/WorkspaceContext'
import { useConsole } from '../../contexts/ConsoleContext'
import { toast } from 'sonner'
import { useQueryClient } from '@tanstack/react-query'
import CommandPreviewModal from '../CommandPreviewModal'
import type { CommandPreview } from '../CommandPreviewModal'

interface ChiselSectionProps {
  setActiveScanSession: (session: number | null) => void
}

const ChiselSection: React.FC<ChiselSectionProps> = ({
  setActiveScanSession
}) => {
  const { currentWorkspace } = useWorkspace()
  const { startTask, addLog, updateTaskProgress } = useConsole()
  const queryClient = useQueryClient()

  const [attackerHost, setAttackerHost] = useState('')
  const [attackerPort, setAttackerPort] = useState(8080)
  const [remoteHost, setRemoteHost] = useState('')
  const [remotePort, setRemotePort] = useState(3389)
  const [bindPort, setBindPort] = useState(3389)
  
  // Estado para preview
  const [showPreview, setShowPreview] = useState(false)
  const [previewData, setPreviewData] = useState<CommandPreview | null>(null)
  const previewExecuteFnRef = useRef<(() => Promise<void>) | null>(null)

  const chiselMutation = useMutation({
    mutationFn: (data: { attackerHost: string; attackerPort: number; remoteHost: string; remotePort: number; bindPort: number }) => {
      if (!data.attackerHost?.trim() || !data.remoteHost?.trim() || !currentWorkspace?.id) {
        throw new Error('Attacker host, remote host y workspace son requeridos')
      }

      const taskId = startTask('Post Exploitation', `Chisel tunneling ${data.attackerHost} ↔ ${data.remoteHost}`)
      addLog('info', 'postexploitation', `Configurando Chisel tunneling ${data.attackerHost}:${data.attackerPort} ↔ ${data.remoteHost}:${data.remotePort}`, taskId, `chisel ${data.attackerHost}:${data.attackerPort}`)
      updateTaskProgress(taskId, 10, 'Configurando Chisel tunneling...')

      return postExploitAPI.runChisel({
        workspace_id: currentWorkspace.id,
        attacker_host: data.attackerHost,
        attacker_port: data.attackerPort,
        remote_host: data.remoteHost,
        remote_port: data.remotePort,
        bind_port: data.bindPort
      }).then(result => {
        if (result.scan_id) {
          setActiveScanSession(result.scan_id)
        }
        return result
      })
    },
    onSuccess: (data, variables) => {
      toast.success('Chisel tunneling configurado exitosamente')
      queryClient.invalidateQueries({ queryKey: ['post-exploit-sessions'] })
    },
    onError: (error: any, variables) => {
      toast.error(`Error configurando Chisel: ${error.message}`)
    }
  })

  const handleChiselWithPreview = async () => {
    if (!currentWorkspace?.id || !attackerHost.trim() || !remoteHost.trim()) {
      toast.error('Workspace, attacker host y remote host son requeridos')
      return
    }

    try {
      const preview = await commandPreviewAPI.previewChisel({
        workspace_id: currentWorkspace.id,
        attacker_host: attackerHost.trim(),
        attacker_port: attackerPort,
        remote_host: remoteHost.trim(),
        remote_port: remotePort,
        bind_port: bindPort
      })

      setPreviewData(preview)
      previewExecuteFnRef.current = async () => {
        await chiselMutation.mutateAsync({
          attackerHost: attackerHost.trim(),
          attackerPort,
          remoteHost: remoteHost.trim(),
          remotePort,
          bindPort
        })
      };
      setShowPreview(true)
    } catch (error: any) {
      toast.error(`Error obteniendo preview: ${error.message}`)
      // NO ejecutar el comando automáticamente - el usuario debe confirmar desde el preview
    }
  }

  return (
    <div className="bg-gray-100 border border-gray-300 rounded-xl p-6">
      <div className="mb-4">
        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
          <Zap className="w-5 h-5" />
          Chisel Tunneling
        </h3>
        <p className="text-gray-500">
          Crea túneles TCP/UDP seguros a través de HTTP usando Chisel
        </p>
      </div>

      <div className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Attacker Host *
            </label>
            <input
              type="text"
              value={attackerHost}
              onChange={(e) => setAttackerHost(e.target.value)}
              placeholder="tu-ip-publica.com"
              className="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Attacker Port
            </label>
            <input
              type="number"
              value={attackerPort}
              onChange={(e) => setAttackerPort(Number(e.target.value))}
              placeholder="8080"
              className="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500"
            />
          </div>
        </div>

        <div className="grid grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Remote Host *
            </label>
            <input
              type="text"
              value={remoteHost}
              onChange={(e) => setRemoteHost(e.target.value)}
              placeholder="10.0.0.100"
              className="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Remote Port
            </label>
            <input
              type="number"
              value={remotePort}
              onChange={(e) => setRemotePort(Number(e.target.value))}
              placeholder="3389"
              className="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-900 mb-2">
              Bind Port
            </label>
            <input
              type="number"
              value={bindPort}
              onChange={(e) => setBindPort(Number(e.target.value))}
              placeholder="3389"
              className="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500"
            />
          </div>
        </div>

        <div className="border border-blue-500 bg-blue-50 p-4 rounded-xl">
          <p className="text-blue-800 text-sm">
            <strong>Configuración del túnel:</strong><br />
            Attacker: {attackerHost}:{attackerPort} ↔ Remote: {remoteHost}:{remotePort} (bound to localhost:{bindPort})
          </p>
        </div>

        <button
          onClick={handleChiselWithPreview}
          disabled={chiselMutation.isPending}
          className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {chiselMutation.isPending ? (
            <Loader2 className="w-4 h-4 animate-spin mr-2" />
          ) : (
            <Terminal className="w-4 h-4 mr-2" />
          )}
          Configurar Chisel Tunnel
        </button>
      </div>

      <CommandPreviewModal
        isOpen={showPreview}
        onClose={() => setShowPreview(false)}
        onExecute={async () => {
          if (previewExecuteFnRef.current) {
            setShowPreview(false)
            await previewExecuteFnRef.current()
          }
        }}
        previewData={previewData}
        toolName="Chisel"
        category="post-exploitation"
      />
    </div>
  )
}

export default ChiselSection




