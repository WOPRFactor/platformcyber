/**
 * NetworkExploitationSection Component
 * 
 * Componente para herramientas de explotación de red:
 * - CrackMapExec
 * - Responder
 */

import React, { useState } from 'react'
import { Network, Wifi, Loader2, Play } from 'lucide-react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { exploitationAPI, type CrackMapExecRequest, type ResponderRequest } from '../../lib/api/exploitation'
import { useWorkspace } from '../../contexts/WorkspaceContext'
import { useConsole } from '../../contexts/ConsoleContext'
import { toast } from 'sonner'
import { useExploitationPreviews } from '../../hooks/exploitation-previews'

interface NetworkExploitationSectionProps {
  activeSubTab: string
  setActiveSubTab: (tab: string) => void
}

const NetworkExploitationSection: React.FC<NetworkExploitationSectionProps> = ({ activeSubTab, setActiveSubTab }) => {
  const { currentWorkspace } = useWorkspace()
  const { startTask, addLog, updateTaskProgress, failTask } = useConsole()
  const queryClient = useQueryClient()
  const previewHooks = useExploitationPreviews()

  // Estados para formularios
  const [cmeTargets, setCmeTargets] = useState('')
  const [cmeProtocol, setCmeProtocol] = useState('smb')
  const [cmeUsername, setCmeUsername] = useState('')
  const [cmePassword, setCmePassword] = useState('')
  const [cmeHash, setCmeHash] = useState('')
  const [cmeDomain, setCmeDomain] = useState('')
  const [cmeCommand, setCmeCommand] = useState('')
  const [cmeShares, setCmeShares] = useState(false)
  const [cmePassPol, setCmePassPol] = useState(false)
  
  const [responderInterface, setResponderInterface] = useState('eth0')
  const [responderLm, setResponderLm] = useState(false)

  // Auto-completar targets desde workspace
  React.useEffect(() => {
    if (currentWorkspace?.target_domain) {
      setCmeTargets(currentWorkspace.target_domain)
    } else if (currentWorkspace && !currentWorkspace.target_domain) {
      setCmeTargets('')
    }
  }, [currentWorkspace?.id, currentWorkspace?.target_domain])

  // Mutaciones
  const crackmapexecMutation = useMutation({
    mutationFn: (data: CrackMapExecRequest) => exploitationAPI.startCrackMapExec(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `CrackMapExec ${variables.protocol} en ${variables.targets}`)
      addLog('info', 'exploitation', `Iniciando CrackMapExec ${variables.protocol}`, taskId, `crackmapexec ${variables.protocol} ${variables.targets}`)
      updateTaskProgress(taskId, 10, 'Iniciando CrackMapExec...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`CrackMapExec iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'CrackMapExec enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en CrackMapExec: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  const responderMutation = useMutation({
    mutationFn: (data: ResponderRequest) => exploitationAPI.startResponder(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `Responder en ${variables.interface}`)
      addLog('info', 'exploitation', `Iniciando Responder LLMNR/NBT-NS Poisoning`, taskId, `responder -I ${variables.interface}`)
      updateTaskProgress(taskId, 10, 'Iniciando Responder...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`Responder iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'Responder enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en Responder: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  // Handlers con preview
  const handleCrackMapExecWithPreview = () => {
    previewHooks.handleCrackMapExecWithPreview({
      targets: cmeTargets,
      protocol: cmeProtocol,
      username: cmeUsername || undefined,
      password: cmePassword || undefined,
      hash: cmeHash || undefined,
      domain: cmeDomain || undefined,
      command: cmeCommand || undefined,
      shares: cmeShares,
      passPol: cmePassPol,
      originalPassword: cmePassword,
      onExecute: async (params: any) => {
        await crackmapexecMutation.mutateAsync(params)
      }
    })
  }

  const handleResponderWithPreview = () => {
    previewHooks.handleResponderWithPreview({
      interface: responderInterface,
      lm: responderLm,
      onExecute: async (params: any) => {
        await responderMutation.mutateAsync(params)
      }
    })
  }

  return (
    <div className="space-y-4">
      {/* Sub-tabs */}
      <div className="flex border-b border-gray-700 mb-4">
        <button
          onClick={() => setActiveSubTab('crackmapexec')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'crackmapexec' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          CrackMapExec
        </button>
        <button
          onClick={() => setActiveSubTab('responder')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'responder' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          Responder
        </button>
      </div>

      {/* Formulario CrackMapExec */}
      {activeSubTab === 'crackmapexec' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <Network className="w-5 h-5" />
            CrackMapExec - AD/Windows Exploitation
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-300 mb-1">Targets *</label>
              <input
                type="text"
                value={cmeTargets}
                onChange={(e) => setCmeTargets(e.target.value)}
                placeholder="192.168.1.0/24 o 192.168.1.1,192.168.1.2"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Protocolo *</label>
              <select
                value={cmeProtocol}
                onChange={(e) => setCmeProtocol(e.target.value)}
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              >
                <option value="smb">SMB</option>
                <option value="winrm">WinRM</option>
                <option value="ssh">SSH</option>
                <option value="ldap">LDAP</option>
                <option value="mssql">MSSQL</option>
              </select>
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Usuario (opcional)</label>
              <input
                type="text"
                value={cmeUsername}
                onChange={(e) => setCmeUsername(e.target.value)}
                placeholder="admin"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Password (opcional)</label>
              <input
                type="password"
                value={cmePassword}
                onChange={(e) => setCmePassword(e.target.value)}
                placeholder="password123"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Hash NTLM (opcional)</label>
              <input
                type="text"
                value={cmeHash}
                onChange={(e) => setCmeHash(e.target.value)}
                placeholder="aad3b435b51404eeaad3b435b51404ee:..."
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Dominio (opcional)</label>
              <input
                type="text"
                value={cmeDomain}
                onChange={(e) => setCmeDomain(e.target.value)}
                placeholder="DOMAIN"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div className="col-span-2">
              <label className="block text-sm text-gray-300 mb-1">Comando a ejecutar (opcional)</label>
              <input
                type="text"
                value={cmeCommand}
                onChange={(e) => setCmeCommand(e.target.value)}
                placeholder="whoami"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div className="col-span-2 flex gap-4">
              <label className="flex items-center gap-2 text-sm text-gray-300">
                <input
                  type="checkbox"
                  checked={cmeShares}
                  onChange={(e) => setCmeShares(e.target.checked)}
                  className="rounded"
                />
                Enumerar shares
              </label>
              <label className="flex items-center gap-2 text-sm text-gray-300">
                <input
                  type="checkbox"
                  checked={cmePassPol}
                  onChange={(e) => setCmePassPol(e.target.checked)}
                  className="rounded"
                />
                Dump password policy
              </label>
            </div>
          </div>
          <button
            onClick={handleCrackMapExecWithPreview}
            disabled={crackmapexecMutation.isPending}
            className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {crackmapexecMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {crackmapexecMutation.isPending ? 'Iniciando...' : 'Iniciar CrackMapExec'}
          </button>
        </div>
      )}

      {/* Formulario Responder */}
      {activeSubTab === 'responder' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <Wifi className="w-5 h-5" />
            Responder - LLMNR/NBT-NS Poisoning
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-300 mb-1">Interfaz de red *</label>
              <input
                type="text"
                value={responderInterface}
                onChange={(e) => setResponderInterface(e.target.value)}
                placeholder="eth0"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div className="flex items-center">
              <label className="flex items-center gap-2 text-sm text-gray-300">
                <input
                  type="checkbox"
                  checked={responderLm}
                  onChange={(e) => setResponderLm(e.target.checked)}
                  className="rounded"
                />
                Capturar LM hashes (menos seguro)
              </label>
            </div>
          </div>
          <button
            onClick={handleResponderWithPreview}
            disabled={responderMutation.isPending}
            className="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {responderMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {responderMutation.isPending ? 'Iniciando...' : 'Iniciar Responder'}
          </button>
        </div>
      )}
    </div>
  )
}

export default NetworkExploitationSection
