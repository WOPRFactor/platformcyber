/**
 * Vulnerability Alerts Component
 * ===============================
 * 
 * Componente para mostrar alertas de vulnerabilidades detectadas en tiempo real.
 */

import React, { useState, useEffect } from 'react';
import { useVulnerabilityAlerts, VulnerabilityEvent } from '../contexts/WebSocketContext';
import { useWorkspace } from '../contexts/WorkspaceContext';

interface VulnerabilityCardProps {
  vulnerability: VulnerabilityEvent;
  isNew: boolean;
}

const VulnerabilityCard: React.FC<VulnerabilityCardProps> = ({ vulnerability, isNew }) => {
  const getSeverityColor = () => {
    const severity = vulnerability.vulnerability.severity?.toLowerCase();
    switch (severity) {
      case 'critical':
        return 'border-purple-500 bg-purple-50 dark:bg-purple-900/20';
      case 'high':
        return 'border-red-500 bg-red-50 dark:bg-red-900/20';
      case 'medium':
        return 'border-orange-500 bg-orange-50 dark:bg-orange-900/20';
      case 'low':
        return 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20';
      default:
        return 'border-gray-500 bg-gray-50 dark:bg-gray-900/20';
    }
  };

  const getSeverityIcon = () => {
    const severity = vulnerability.vulnerability.severity?.toLowerCase();
    switch (severity) {
      case 'critical':
        return 'ğŸ”¥';
      case 'high':
        return 'ğŸš¨';
      case 'medium':
        return 'âš ï¸';
      case 'low':
        return 'âš¡';
      default:
        return 'ğŸ”';
    }
  };

  return (
    <div
      className={`
        border-l-4 rounded-lg p-4 mb-3 transition-all duration-300
        ${getSeverityColor()}
        ${isNew ? 'animate-pulse-once shadow-lg' : 'shadow'}
      `}
    >
      <div className="flex items-start justify-between">
        <div className="flex items-start space-x-3 flex-1">
          <span className="text-2xl">{getSeverityIcon()}</span>
          <div className="flex-1">
            <div className="flex items-center space-x-2">
              <h4 className="font-semibold text-gray-900 dark:text-gray-100">
                {vulnerability.vulnerability.name}
              </h4>
              <span
                className={`
                  text-xs px-2 py-1 rounded-full font-medium uppercase
                  ${vulnerability.vulnerability.severity?.toLowerCase() === 'critical' ? 'bg-purple-500 text-white' : ''}
                  ${vulnerability.vulnerability.severity?.toLowerCase() === 'high' ? 'bg-red-500 text-white' : ''}
                  ${vulnerability.vulnerability.severity?.toLowerCase() === 'medium' ? 'bg-orange-500 text-white' : ''}
                  ${vulnerability.vulnerability.severity?.toLowerCase() === 'low' ? 'bg-yellow-500 text-black' : ''}
                `}
              >
                {vulnerability.vulnerability.severity || 'Unknown'}
              </span>
            </div>
            
            {vulnerability.vulnerability.description && (
              <p className="text-sm text-gray-700 dark:text-gray-300 mt-2">
                {vulnerability.vulnerability.description}
              </p>
            )}
            
            {vulnerability.scan_id && (
              <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                Scan ID: {vulnerability.scan_id}
              </p>
            )}
            
            <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">
              {new Date(vulnerability.timestamp * 1000).toLocaleString()}
            </p>
          </div>
        </div>
        
        {isNew && (
          <span className="bg-blue-500 text-white text-xs px-2 py-1 rounded-full animate-bounce">
            NEW
          </span>
        )}
      </div>
    </div>
  );
};

interface VulnerabilityAlertsProps {
  maxDisplay?: number;
  autoScroll?: boolean;
}

/**
 * Vulnerability Alerts Component
 */
export const VulnerabilityAlerts: React.FC<VulnerabilityAlertsProps> = ({ 
  maxDisplay = 10,
  autoScroll = true
}) => {
  const { currentWorkspace } = useWorkspace();
  const workspaceId = currentWorkspace?.id || null;
  
  const [newVulnIds, setNewVulnIds] = useState<Set<number>>(new Set());
  
  const vulnerabilities = useVulnerabilityAlerts(workspaceId, (vuln) => {
    console.log('ğŸš¨ New vulnerability detected:', vuln);
    
    // Marcar como nuevo durante 5 segundos
    const vulnId = vuln.timestamp;
    setNewVulnIds(prev => new Set(prev).add(vulnId));
    
    setTimeout(() => {
      setNewVulnIds(prev => {
        const updated = new Set(prev);
        updated.delete(vulnId);
        return updated;
      });
    }, 5000);
    
    // Opcional: reproducir sonido de alerta
    // playAlertSound();
  });

  // Limitar cantidad mostrada
  const displayedVulns = vulnerabilities.slice(-maxDisplay);

  // Auto-scroll al final cuando hay nuevas vulnerabilidades
  useEffect(() => {
    if (autoScroll && displayedVulns.length > 0) {
      const element = document.getElementById('vulnerability-alerts-container');
      if (element) {
        element.scrollTop = element.scrollHeight;
      }
    }
  }, [displayedVulns.length, autoScroll]);

  if (displayedVulns.length === 0) {
    return (
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 text-center">
        <div className="text-6xl mb-4">âœ…</div>
        <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">
          No Vulnerabilities Detected
        </h3>
        <p className="text-sm text-gray-500 dark:text-gray-400">
          All scans completed without finding vulnerabilities in this workspace.
        </p>
      </div>
    );
  }

  return (
    <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-gray-800 dark:text-gray-200">
          ğŸš¨ Vulnerability Alerts
        </h3>
        <span className="bg-red-500 text-white text-sm px-3 py-1 rounded-full font-semibold">
          {vulnerabilities.length}
        </span>
      </div>
      
      <div
        id="vulnerability-alerts-container"
        className="max-h-[600px] overflow-y-auto space-y-2 pr-2"
        style={{
          scrollBehavior: 'smooth'
        }}
      >
        {displayedVulns.map((vuln, index) => (
          <VulnerabilityCard
            key={`${vuln.timestamp}-${index}`}
            vulnerability={vuln}
            isNew={newVulnIds.has(vuln.timestamp)}
          />
        ))}
      </div>
      
      {vulnerabilities.length > maxDisplay && (
        <div className="mt-3 text-center text-sm text-gray-500 dark:text-gray-400">
          Showing last {maxDisplay} of {vulnerabilities.length} vulnerabilities
        </div>
      )}
    </div>
  );
};

export default VulnerabilityAlerts;

