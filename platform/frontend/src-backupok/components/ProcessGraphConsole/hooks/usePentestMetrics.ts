/**
 * usePentestMetrics Hook
 * =======================
 * 
 * Hook para calcular métricas de pentesting basadas en tareas y logs.
 */

import { useState, useEffect, useCallback } from 'react'
import { Task, Log } from '../../../contexts/ConsoleContext'

interface PentestMetrics {
  openPorts: number
  vulnerabilities: {
    critical: number
    high: number
    medium: number
    low: number
  }
  scannedHosts: number
  discoveredServices: number
  foundUrls: number
  sensitiveFiles: number
  scanProgress: number
}

export const usePentestMetrics = (tasks: Task[], logs: Log[]) => {
  const calculateRealMetrics = useCallback((): PentestMetrics => {
    let openPorts = 0
    let scannedHosts = 0
    let discoveredServices = 0
    let foundUrls = 0
    let sensitiveFiles = 0
    let vulnerabilities = { critical: 0, high: 0, medium: 0, low: 0 }
    let scanProgress = 0

    // Procesar logs para extraer métricas reales
    logs.forEach(log => {
      const message = log.message.toLowerCase()
      const module = log.module.toLowerCase()

      // Contar puertos abiertos
      if ((message.includes('puerto') || message.includes('port')) &&
          (message.includes('abierto') || message.includes('open') || message.includes('listening'))) {
        openPorts++
      }

      // Contar hosts escaneados
      if (module === 'scanning' || module === 'reconnaissance') {
        if (message.includes('escaneando') || message.includes('scanning') ||
            message.includes('host') || message.includes('ip:')) {
          scannedHosts++
        }
      }

      // Contar servicios descubiertos
      if ((message.includes('servicio') || message.includes('service')) &&
          (message.includes('encontrado') || message.includes('detectado') ||
           message.includes('running') || message.includes('identified'))) {
        discoveredServices++
      }

      // Contar URLs encontradas
      if (message.includes('url') || message.includes('endpoint') || message.includes('ruta') ||
          message.includes('path') || message.includes('http') || message.includes('directory')) {
        if (message.includes('encontrado') || message.includes('descubierto') ||
            message.includes('found') || message.includes('discovered') ||
            message.includes('accesible') || message.includes('accessible')) {
          foundUrls++
        }
      }

      // Contar archivos sensibles
      if ((message.includes('archivo') || message.includes('file')) &&
          (message.includes('sensible') || message.includes('confidencial') ||
           message.includes('sensitive') || message.includes('secret') ||
           message.includes('password') || message.includes('config'))) {
        sensitiveFiles++
      }

      // Contar vulnerabilidades por severidad
      if (message.includes('vulnerabilidad') || message.includes('vulnerability') ||
          message.includes('exploit') || message.includes('cve') ||
          message.includes('weak') || message.includes('insecure')) {

        if (message.includes('crítica') || message.includes('critical') || message.includes('cve-')) {
          vulnerabilities.critical++
        } else if (message.includes('alta') || message.includes('high') ||
                   message.includes('severe') || message.includes('dangerous')) {
          vulnerabilities.high++
        } else if (message.includes('media') || message.includes('medium') ||
                   message.includes('moderate') || message.includes('warning')) {
          vulnerabilities.medium++
        } else if (message.includes('baja') || message.includes('low') ||
                   message.includes('info') || message.includes('informational')) {
          vulnerabilities.low++
        } else {
          vulnerabilities.medium++
        }
      }
    })

    // Calcular progreso basado en tareas activas
    const activeTasks = tasks.filter(task => task.status === 'running')
    if (activeTasks.length > 0) {
      scanProgress = Math.round(activeTasks.reduce((acc, task) => acc + task.progress, 0) / activeTasks.length)
    }

    // Si no hay tareas activas, usar el progreso de las tareas completadas más recientes
    if (scanProgress === 0 && tasks.length > 0) {
      const completedTasks = tasks.filter(task => task.status === 'completed')
      if (completedTasks.length > 0) {
        scanProgress = 100
      }
    }

    return {
      openPorts: Math.max(openPorts, 0),
      vulnerabilities,
      scannedHosts: Math.max(scannedHosts, tasks.length),
      discoveredServices: Math.max(discoveredServices, 0),
      foundUrls: Math.max(foundUrls, 0),
      sensitiveFiles: Math.max(sensitiveFiles, 0),
      scanProgress: Math.min(Math.max(scanProgress, 0), 100)
    }
  }, [tasks, logs])

  const [pentestMetrics, setPentestMetrics] = useState<PentestMetrics>(calculateRealMetrics())

  useEffect(() => {
    const newMetrics = calculateRealMetrics()
    setPentestMetrics(newMetrics)
  }, [calculateRealMetrics])

  return pentestMetrics
}


