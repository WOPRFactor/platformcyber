/**
 * Network Exploitation Previews
 * =============================
 * 
 * Handlers de preview para explotaciÃ³n de red.
 */

import { toast } from 'sonner'
import { commandPreviewAPI } from '../../lib/api/command-preview'
import { PreviewState, PreviewHandlers, ExecuteCallback } from './types'

export const createNetworkPreviewHandlers = (
  state: PreviewState,
  handlers: PreviewHandlers,
  workspaceId: number
) => {
  const handleCrackMapExecWithPreview = async (params: {
    targets: string
    protocol: string
    username?: string
    password?: string
    hash?: string
    domain?: string
    command?: string
    shares: boolean
    passPol: boolean
    originalPassword?: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewCrackMapExec({
        workspace_id: workspaceId,
        targets: params.targets,
        protocol: params.protocol,
        username: params.username,
        password: params.password || params.originalPassword,
        hash: params.hash,
        domain: params.domain,
        command: params.command,
        shares: params.shares,
        pass_pol: params.passPol
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('CrackMapExec')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        targets: params.targets,
        protocol: params.protocol,
        username: params.username,
        password: params.password || params.originalPassword,
        hash: params.hash,
        domain: params.domain,
        command: params.command,
        shares: params.shares,
        pass_pol: params.passPol
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de CrackMapExec:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleResponderWithPreview = async (params: {
    interface: string
    lm: boolean
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewResponder({
        workspace_id: workspaceId,
        interface: params.interface,
        lm: params.lm
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Responder')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        interface: params.interface,
        lm: params.lm
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Responder:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleEvilWinRMWithPreview = async (params: {
    target: string
    username: string
    password: string
    hash?: string
    ssl: boolean
    originalPassword: string
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewEvilWinRM({
        workspace_id: workspaceId,
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        hash: params.hash,
        ssl: params.ssl
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Evil-WinRM')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        username: params.username,
        password: params.password || params.originalPassword,
        hash: params.hash,
        ssl: params.ssl
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Evil-WinRM:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  const handleHydraWithPreview = async (params: {
    target: string
    service: string
    username?: string
    userfile?: string
    password?: string
    passfile?: string
    port?: number
    threads: number
    onExecute: ExecuteCallback
  }) => {
    try {
      const preview = await commandPreviewAPI.previewHydra({
        workspace_id: workspaceId,
        target: params.target,
        service: params.service,
        username: params.username,
        userfile: params.userfile,
        password: params.password,
        passfile: params.passfile,
        port: params.port,
        threads: params.threads
      })
      handlers.setPreviewData(preview)
      handlers.setPreviewToolName('Hydra')
      handlers.setPreviewExecuteFn(() => params.onExecute({
        target: params.target,
        service: params.service,
        username: params.username,
        userfile: params.userfile,
        password: params.password,
        passfile: params.passfile,
        port: params.port,
        threads: params.threads
      }))
      handlers.setShowPreview(true)
    } catch (error: any) {
      console.error('Error obteniendo preview de Hydra:', error)
      toast.error('Error al obtener preview del comando')
    }
  }

  return {
    handleCrackMapExecWithPreview,
    handleResponderWithPreview,
    handleEvilWinRMWithPreview,
    handleHydraWithPreview
  }
}


