/**
 * Exploitation Previews Hook
 * ===========================
 * 
 * Hook unificado para manejar previews de comandos de Exploitation.
 * 
 * Refactorizado: 2025-12-04
 * Dividido en módulos por categoría para mejor mantenibilidad.
 */

import { useState, useRef } from 'react'
import { CommandPreview } from '../../components/CommandPreviewModal'
import { useWorkspace } from '../../contexts/WorkspaceContext'
import { createPasswordPreviewHandlers } from './password'
import { createImpacketPreviewHandlers } from './impacket'
import { createMetasploitPreviewHandlers } from './metasploit'
import { createNetworkPreviewHandlers } from './network'

interface UseExploitationPreviewsReturn {
  showPreview: boolean
  previewData: CommandPreview | null
  previewToolName: string
  previewExecuteFn: (() => Promise<void>) | null
  setShowPreview: (show: boolean) => void
  setPreviewData: (data: CommandPreview | null) => void
  setPreviewToolName: (name: string) => void
  setPreviewExecuteFn: (fn: (() => Promise<void>) | null) => void
  // Password attacks
  handleJohnWithPreview: (params: any) => Promise<void>
  handleHashcatWithPreview: (params: any) => Promise<void>
  handleKerbruteWithPreview: (params: any) => Promise<void>
  // Impacket
  handleImpacketPsexecWithPreview: (params: any) => Promise<void>
  handleImpacketWmiexecWithPreview: (params: any) => Promise<void>
  handleImpacketSmbexecWithPreview: (params: any) => Promise<void>
  handleImpacketSecretsdumpWithPreview: (params: any) => Promise<void>
  handleImpacketGetUserSPNsWithPreview: (params: any) => Promise<void>
  handleImpacketGetNPUsersWithPreview: (params: any) => Promise<void>
  // Metasploit
  handleMsfvenomWithPreview: (params: any) => Promise<void>
  handleMetasploitHandlerWithPreview: (params: any) => Promise<void>
  // Network
  handleCrackMapExecWithPreview: (params: any) => Promise<void>
  handleResponderWithPreview: (params: any) => Promise<void>
  handleEvilWinRMWithPreview: (params: any) => Promise<void>
  handleHydraWithPreview: (params: any) => Promise<void>
}

export const useExploitationPreviews = (): UseExploitationPreviewsReturn => {
  const { currentWorkspace } = useWorkspace()
  const [showPreview, setShowPreview] = useState(false)
  const [previewData, setPreviewData] = useState<CommandPreview | null>(null)
  const [previewToolName, setPreviewToolName] = useState('')
  const previewExecuteFnRef = useRef<(() => Promise<void>) | null>(null)
  
  const previewExecuteFn = previewExecuteFnRef.current
  const setPreviewExecuteFn = (fn: (() => Promise<void>) | null) => {
    previewExecuteFnRef.current = fn
  }

  const state = { showPreview, previewData, previewToolName }
  const handlers = { setShowPreview, setPreviewData, setPreviewToolName }
  const workspaceId = currentWorkspace?.id || 0

  // Crear handlers por categoría
  const passwordHandlers = createPasswordPreviewHandlers(state, handlers, workspaceId)
  const impacketHandlers = createImpacketPreviewHandlers(state, handlers, workspaceId)
  const metasploitHandlers = createMetasploitPreviewHandlers(state, handlers, workspaceId)
  const networkHandlers = createNetworkPreviewHandlers(state, handlers, workspaceId)

  return {
    showPreview,
    previewData,
    previewToolName,
    previewExecuteFn,
    setShowPreview,
    setPreviewData,
    setPreviewToolName,
    setPreviewExecuteFn,
    ...passwordHandlers,
    ...impacketHandlers,
    ...metasploitHandlers,
    ...networkHandlers
  }
}


