import React, { useState } from 'react'
import { FileText, Download, BarChart3, Shield, AlertTriangle, CheckCircle, XCircle, Loader, Calendar, Target, TrendingUp } from 'lucide-react'
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { reportingAPI } from '../lib/api/reporting'
import LoadingSpinner from '../components/LoadingSpinner'
import { toast } from 'sonner'
import { useAuth } from '../contexts/AuthContext'
import { useConsole } from '../contexts/ConsoleContext'

const Reporting: React.FC = () => {
  const { isAuthenticated } = useAuth()
  const [target, setTarget] = useState('')
  const [startDate, setStartDate] = useState('')
  const [endDate, setEndDate] = useState('')
  const [complianceStandard, setComplianceStandard] = useState('general')
  const [exportFormat, setExportFormat] = useState<'json' | 'html' | 'pdf'>('html')
  const [activeTab, setActiveTab] = useState('executive')
  const [generatedReport, setGeneratedReport] = useState<any>(null)
  const queryClient = useQueryClient()
  const { startTask, addLog, updateTaskProgress, completeTask, failTask, killTask, tasks } = useConsole()

  // Query para listar reportes
  const { data: reports, isLoading: reportsLoading, refetch: refetchReports } = useQuery({
    queryKey: ['reports'],
    queryFn: reportingAPI.listReports,
    enabled: false, // Manual refresh only
    staleTime: 0,
    cacheTime: 0,
  })

  // Mutations para generar reportes
  const executiveMutation = useMutation({
    mutationFn: (data: { target: string; startDate?: string; endDate?: string }) =>
      reportingAPI.generateExecutiveSummary(data.target, data.startDate, data.endDate),
    onMutate: (data) => {
      // Iniciar tarea en consola
      const taskId = startTask('Reporting', `Resumen ejecutivo para ${data.target}`)

      // Log inicial
      addLog('info', 'reporting', `Generando resumen ejecutivo para ${data.target}`, taskId, `Executive Summary - target: ${data.target}`)
      updateTaskProgress(taskId, 10, 'Iniciando generaci√≥n de resumen ejecutivo...')

      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      if (data.success) {
        setGeneratedReport(data)
        toast.success('Resumen ejecutivo generado exitosamente')
        queryClient.invalidateQueries({ queryKey: ['reports'] })

        // Actualizar consola
        if (context?.taskId) {
          updateTaskProgress(context.taskId, 100, 'Resumen ejecutivo generado exitosamente')
          addLog('success', 'reporting', 'Resumen ejecutivo generado exitosamente', context.taskId)
          completeTask(context.taskId, `Resumen ejecutivo generado para ${variables.target}`)
        }
      } else {
        toast.error('Error generando resumen ejecutivo')
        if (context?.taskId) {
          failTask(context.taskId, 'Error generando resumen ejecutivo')
        }
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error: ${error.message}`)

      // Marcar error en consola
      if (context?.taskId) {
        failTask(context.taskId, error.message)
      }
    }
  })

  const technicalMutation = useMutation({
    mutationFn: (data: { target: string; startDate?: string; endDate?: string }) =>
      reportingAPI.generateTechnicalReport(data.target, data.startDate, data.endDate),
    onMutate: (data) => {
      // Iniciar tarea en consola
      const taskId = startTask('Reporting', `Reporte t√©cnico para ${data.target}`)

      // Log inicial
      addLog('info', 'reporting', `Generando reporte t√©cnico para ${data.target}`, taskId, `Technical Report - target: ${data.target}`)
      updateTaskProgress(taskId, 10, 'Iniciando generaci√≥n de reporte t√©cnico...')

      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      if (data.success) {
        setGeneratedReport(data)
        toast.success('Reporte t√©cnico generado exitosamente')
        queryClient.invalidateQueries({ queryKey: ['reports'] })

        // Actualizar consola
        if (context?.taskId) {
          updateTaskProgress(context.taskId, 100, 'Reporte t√©cnico generado exitosamente')
          addLog('success', 'reporting', 'Reporte t√©cnico generado exitosamente', context.taskId)
          completeTask(context.taskId, `Reporte t√©cnico generado para ${variables.target}`)
        }
      } else {
        toast.error('Error generando reporte t√©cnico')
        if (context?.taskId) {
          failTask(context.taskId, 'Error generando reporte t√©cnico')
        }
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error: ${error.message}`)

      // Marcar error en consola
      if (context?.taskId) {
        failTask(context.taskId, error.message)
      }
    }
  })

  const complianceMutation = useMutation({
    mutationFn: (data: { target: string; standard: string; startDate?: string; endDate?: string }) =>
      reportingAPI.generateComplianceReport(data.target, data.standard, data.startDate, data.endDate),
    onMutate: (data) => {
      // Iniciar tarea en consola
      const taskId = startTask('Reporting', `Reporte de cumplimiento ${data.standard} para ${data.target}`)

      // Log inicial
      addLog('info', 'reporting', `Generando reporte de cumplimiento ${data.standard} para ${data.target}`, taskId, `Compliance Report - ${data.standard}`)
      updateTaskProgress(taskId, 10, 'Iniciando generaci√≥n de reporte de cumplimiento...')

      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      if (data.success) {
        setGeneratedReport(data)
        toast.success(`Reporte de cumplimiento ${data.data?.standard} generado exitosamente`)
        queryClient.invalidateQueries({ queryKey: ['reports'] })

        // Actualizar consola
        if (context?.taskId) {
          updateTaskProgress(context.taskId, 100, 'Reporte de cumplimiento generado exitosamente')
          addLog('success', 'reporting', `Reporte de cumplimiento ${data.data?.standard} generado exitosamente`, context.taskId)
          completeTask(context.taskId, `Reporte de cumplimiento generado para ${variables.target}`)
        }
      } else {
        toast.error('Error generando reporte de cumplimiento')
        if (context?.taskId) {
          failTask(context.taskId, 'Error generando reporte de cumplimiento')
        }
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error: ${error.message}`)

      // Marcar error en consola
      if (context?.taskId) {
        failTask(context.taskId, error.message)
      }
    }
  })

  const exportMutation = useMutation({
    mutationFn: (data: { reportData: any; format: 'json' | 'html' | 'pdf' }) =>
      reportingAPI.exportReport({ report_data: data.reportData, format: data.format }),
    onMutate: (data) => {
      // Iniciar tarea en consola
      const taskId = startTask('Reporting', `Exportando reporte en formato ${data.format.toUpperCase()}`)

      // Log inicial
      addLog('info', 'reporting', `Exportando reporte en formato ${data.format.toUpperCase()}`, taskId, `Report Export - format: ${data.format}`)
      updateTaskProgress(taskId, 10, 'Iniciando exportaci√≥n...')

      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      if (data.success) {
        // Descargar el archivo
        const link = document.createElement('a')
        link.href = `data:application/octet-stream;base64,${data.content}`
        link.download = data.filename
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        toast.success(`Reporte exportado como ${data.format.toUpperCase()}`)
        refetchReports()

        // Actualizar consola
        if (context?.taskId) {
          updateTaskProgress(context.taskId, 100, 'Reporte exportado exitosamente')
          addLog('success', 'reporting', `Reporte exportado como ${data.format.toUpperCase()}`, context.taskId)
          completeTask(context.taskId, `Reporte exportado en formato ${variables.format.toUpperCase()}`)
        }
      } else {
        toast.error('Error exportando reporte')
        if (context?.taskId) {
          failTask(context.taskId, 'Error exportando reporte')
        }
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en exportaci√≥n: ${error.message}`)

      // Marcar error en consola
      if (context?.taskId) {
        failTask(context.taskId, error.message)
      }
    }
  })

  const handleGenerateReport = (reportType: string) => {
    if (!target.trim()) {
      toast.error('Por favor ingrese un target v√°lido')
      return
    }

    const params = {
      target,
      startDate: startDate || undefined,
      endDate: endDate || undefined
    }

    switch (reportType) {
      case 'executive':
        executiveMutation.mutate(params)
        break
      case 'technical':
        technicalMutation.mutate(params)
        break
      case 'compliance':
        complianceMutation.mutate({ ...params, standard: complianceStandard })
        break
    }
  }

  const handleExportReport = () => {
    if (!generatedReport) {
      toast.error('Primero genere un reporte')
      return
    }

    exportMutation.mutate({
      reportData: generatedReport,
      format: exportFormat
    })
  }

  const handleDownloadReport = async (filename: string) => {
    try {
      const blob = await reportingAPI.downloadReport(filename)
      const url = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = filename
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(url)
      toast.success('Reporte descargado exitosamente')
    } catch (error: any) {
      toast.error(`Error descargando reporte: ${error.message}`)
    }
  }

  const renderExecutiveSummary = (data: ExecutiveSummaryData) => (
    <div className="space-y-6">
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <h3 className="text-xl font-bold text-green-400 mb-4">üìä Resumen Ejecutivo</h3>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div className="text-center">
            <div className="text-3xl font-bold text-blue-600">{data.executive_summary.total_sessions}</div>
            <div className="text-sm text-gray-600">Sesiones Totales</div>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-green-600">{data.executive_summary.completed_sessions}</div>
            <div className="text-sm text-gray-600">Completadas</div>
          </div>
          <div className="text-center">
            <div className="text-3xl font-bold text-red-600">{data.executive_summary.critical_findings}</div>
            <div className="text-sm text-gray-600">Hallazgos Cr√≠ticos</div>
          </div>
          <div className={`text-center p-2 rounded ${
            data.executive_summary.risk_level === 'CRITICAL' ? 'bg-red-100 text-red-800' :
            data.executive_summary.risk_level === 'HIGH' ? 'bg-orange-100 text-orange-800' :
            data.executive_summary.risk_level === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' :
            'bg-green-100 text-green-800'
          }`}>
            <div className="text-2xl font-bold">{data.executive_summary.risk_score}</div>
            <div className="text-sm">{data.executive_summary.risk_level}</div>
          </div>
        </div>

        <div className="mb-4">
          <h4 className="font-semibold mb-2">Tipos de Escaneo Realizados:</h4>
          <div className="flex flex-wrap gap-2">
            {data.executive_summary.scan_types_performed.map((type, idx) => (
              <span key={idx} className="px-3 py-1 bg-blue-100 text-blue-800 rounded text-sm">
                {type.replace('_', ' ')}
              </span>
            ))}
          </div>
        </div>
      </div>

      {data.key_findings.length > 0 && (
        <div className="bg-gray-800 border border-red-500 rounded-lg p-6">
          <h3 className="text-xl font-bold text-red-400 mb-4">üî¥ Hallazgos Cr√≠ticos</h3>
          <div className="space-y-2">
            {data.key_findings.map((finding, idx) => (
              <div key={idx} className="border border-red-300 rounded p-3 bg-red-50">
                <div className="flex justify-between items-start">
                  <div>
                    <div className="font-medium text-red-800">{finding.finding}</div>
                    <div className="text-sm text-red-600">
                      {finding.scan_type} - {finding.target}
                    </div>
                  </div>
                  <div className="text-sm text-red-500">
                    {finding.timestamp ? new Date(finding.timestamp).toLocaleDateString() : 'N/A'}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      <div className="bg-gray-800 border border-blue-500 rounded-lg p-6">
        <h3 className="text-xl font-bold text-blue-400 mb-4">üìù Recomendaciones</h3>
        <ul className="space-y-2">
          {data.recommendations.map((rec, idx) => (
            <li key={idx} className="flex items-start gap-2">
              <CheckCircle className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" />
              <span className="text-blue-700">{rec}</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  )

  const renderTechnicalReport = (data: TechnicalReportData) => (
    <div className="space-y-6">
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <h3 className="text-xl font-bold text-green-400 mb-4">üîß Resumen de Vulnerabilidades</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="text-center p-4 bg-red-100 rounded">
            <div className="text-2xl font-bold text-red-600">{data.vulnerability_summary.high}</div>
            <div className="text-sm text-red-800">Alta Severidad</div>
          </div>
          <div className="text-center p-4 bg-orange-100 rounded">
            <div className="text-2xl font-bold text-orange-600">{data.vulnerability_summary.medium}</div>
            <div className="text-sm text-orange-800">Media Severidad</div>
          </div>
          <div className="text-center p-4 bg-yellow-100 rounded">
            <div className="text-2xl font-bold text-yellow-600">{data.vulnerability_summary.low}</div>
            <div className="text-sm text-yellow-800">Baja Severidad</div>
          </div>
          <div className="text-center p-4 bg-gray-100 rounded">
            <div className="text-2xl font-bold text-gray-600">{data.vulnerability_summary.info}</div>
            <div className="text-sm text-gray-800">Informativas</div>
          </div>
        </div>
      </div>

      <div className="bg-gray-800 border border-blue-500 rounded-lg p-6">
        <h3 className="text-xl font-bold text-blue-400 mb-4">üìã Metodolog√≠a de Escaneo</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div>
            <h4 className="font-semibold mb-2 text-blue-300">Reconocimiento</h4>
            <div className="text-sm text-blue-200">{data.scan_methodology.reconnaissance.length} sesiones</div>
          </div>
          <div>
            <h4 className="font-semibold mb-2 text-blue-300">Escaneo</h4>
            <div className="text-sm text-blue-200">{data.scan_methodology.scanning.length} sesiones</div>
          </div>
          <div>
            <h4 className="font-semibold mb-2 text-blue-300">Evaluaci√≥n de Vuln.</h4>
            <div className="text-sm text-blue-200">{data.scan_methodology.vulnerability_assessment.length} sesiones</div>
          </div>
          <div>
            <h4 className="font-semibold mb-2 text-blue-300">Explotaci√≥n</h4>
            <div className="text-sm text-blue-200">{data.scan_methodology.exploitation.length} sesiones</div>
          </div>
          <div>
            <h4 className="font-semibold mb-2 text-blue-300">Post-Explotaci√≥n</h4>
            <div className="text-sm text-blue-200">{data.scan_methodology.post_exploitation.length} sesiones</div>
          </div>
        </div>
      </div>
    </div>
  )

  const renderComplianceReport = (data: ComplianceReportData) => (
    <div className="space-y-6">
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <h3 className="text-xl font-bold text-green-400 mb-4">üìã Reporte de Cumplimiento - {data.standard}</h3>

        <div className="text-center mb-6">
          <div className={`inline-block p-6 rounded-full ${
            data.compliance_score >= 80 ? 'bg-green-100' :
            data.compliance_score >= 60 ? 'bg-yellow-100' : 'bg-red-100'
          }`}>
            <div className={`text-4xl font-bold ${
              data.compliance_score >= 80 ? 'text-green-600' :
              data.compliance_score >= 60 ? 'text-yellow-600' : 'text-red-600'
            }`}>
              {data.compliance_score}%
            </div>
            <div className="text-sm text-gray-600">Puntuaci√≥n de Cumplimiento</div>
          </div>
        </div>

        <div className="mb-6">
          <h4 className="font-semibold mb-3">Requisitos Evaluados:</h4>
          <div className="space-y-2">
            {data.requirements.map((req, idx) => (
              <div key={idx} className="flex items-center justify-between p-3 border rounded">
                <div>
                  <div className="font-medium">{req.id}: {req.description}</div>
                </div>
                <span className={`px-3 py-1 rounded text-sm ${
                  req.status === 'PASS' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  {req.status}
                </span>
              </div>
            ))}
          </div>
        </div>

        {data.violations.length > 0 && (
          <div className="mb-6">
            <h4 className="font-semibold mb-3 text-red-400">Violaciones Identificadas:</h4>
            <ul className="space-y-1">
              {data.violations.map((violation, idx) => (
                <li key={idx} className="flex items-start gap-2 text-red-700">
                  <XCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                  <span>{violation}</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        <div>
          <h4 className="font-semibold mb-3 text-blue-400">Recomendaciones:</h4>
          <ul className="space-y-1">
            {data.recommendations.map((rec, idx) => (
              <li key={idx} className="flex items-start gap-2 text-blue-700">
                <CheckCircle className="w-4 h-4 mt-0.5 flex-shrink-0" />
                <span>{rec}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  )

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">Reporting</h1>
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <FileText className="w-4 h-4" />
          Sistema de reportes profesionales de pentesting
        </div>
      </div>

      {/* Configuraci√≥n del reporte */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4">
          <h2 className="text-xl font-bold text-green-400">Configuraci√≥n del Reporte</h2>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">Target</label>
            <input
              type="text"
              value={target}
              onChange={(e) => setTarget(e.target.value)}
              placeholder="192.168.1.1 o dominio.com"
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">Fecha Inicio</label>
            <input
              type="date"
              value={startDate}
              onChange={(e) => setStartDate(e.target.value)}
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">Fecha Fin</label>
            <input
              type="date"
              value={endDate}
              onChange={(e) => setEndDate(e.target.value)}
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">Est√°ndar Cumplimiento</label>
            <select
              value={complianceStandard}
              onChange={(e) => setComplianceStandard(e.target.value)}
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500"
            >
              <option value="general">General</option>
              <option value="pci-dss">PCI-DSS</option>
              <option value="hipaa">HIPAA</option>
            </select>
          </div>
        </div>
      </div>

      {/* Tipos de reporte */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4">
          <h2 className="text-xl font-bold text-green-400">Generar Reporte</h2>
          <p className="text-green-600">
            Seleccione el tipo de reporte a generar
          </p>
        </div>

        <div className="w-full">
          <div className="flex border-b border-green-500 mb-4 overflow-x-auto">
            <button
              onClick={() => setActiveTab('executive')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'executive'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-400 hover:text-red-400'
              }`}
            >
              <BarChart3 className="w-4 h-4" />
              Ejecutivo
            </button>
            <button
              onClick={() => setActiveTab('technical')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'technical'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-400 hover:text-red-400'
              }`}
            >
              <Target className="w-4 h-4" />
              T√©cnico
            </button>
            <button
              onClick={() => setActiveTab('compliance')}
              className={`flex items-center gap-2 px-4 py-2 border-b-2 whitespace-nowrap ${
                activeTab === 'compliance'
                  ? 'border-red-400 text-red-400'
                  : 'border-transparent text-gray-400 hover:text-red-400'
              }`}
            >
              <Shield className="w-4 h-4" />
              Cumplimiento
            </button>
          </div>

          {activeTab === 'executive' && (
            <div className="mt-4">
              <div className="bg-gray-900 border border-red-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="text-lg font-bold text-red-400 flex items-center gap-2">
                    <BarChart3 className="w-5 h-5" />
                    Resumen Ejecutivo
                  </h3>
                  <p className="text-red-600">
                    Reporte de alto nivel para stakeholders y directivos
                  </p>
                </div>
                <button
                  onClick={() => handleGenerateReport('executive')}
                  disabled={executiveMutation.isPending}
                  className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {executiveMutation.isPending ? (
                    <Loader className="w-4 h-4 animate-spin mr-2" />
                  ) : (
                    <BarChart3 className="w-4 h-4 mr-2" />
                  )}
                  Generar Resumen Ejecutivo
                </button>
              </div>
            </div>
          )}

          {activeTab === 'technical' && (
            <div className="mt-4">
              <div className="bg-gray-900 border border-red-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="text-lg font-bold text-red-400 flex items-center gap-2">
                    <Target className="w-5 h-5" />
                    Reporte T√©cnico Detallado
                  </h3>
                  <p className="text-red-600">
                    Reporte t√©cnico completo con todos los hallazgos y metodolog√≠a
                  </p>
                </div>
                <button
                  onClick={() => handleGenerateReport('technical')}
                  disabled={technicalMutation.isPending}
                  className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {technicalMutation.isPending ? (
                    <Loader className="w-4 h-4 animate-spin mr-2" />
                  ) : (
                    <Target className="w-4 h-4 mr-2" />
                  )}
                  Generar Reporte T√©cnico
                </button>
              </div>
            </div>
          )}

          {activeTab === 'compliance' && (
            <div className="mt-4">
              <div className="bg-gray-900 border border-red-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="text-lg font-bold text-red-400 flex items-center gap-2">
                    <Shield className="w-5 h-5" />
                    Reporte de Cumplimiento - {complianceStandard.toUpperCase()}
                  </h3>
                  <p className="text-red-600">
                    Evaluaci√≥n de cumplimiento con est√°ndares de seguridad espec√≠ficos
                  </p>
                </div>
                <button
                  onClick={() => handleGenerateReport('compliance')}
                  disabled={complianceMutation.isPending}
                  className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {complianceMutation.isPending ? (
                    <Loader className="w-4 h-4 animate-spin mr-2" />
                  ) : (
                    <Shield className="w-4 h-4 mr-2" />
                  )}
                  Generar Reporte de Cumplimiento
                </button>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* Reporte generado */}
      {generatedReport && (
        <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-bold text-green-400">Reporte Generado</h2>
            <div className="flex gap-2">
              <select
                value={exportFormat}
                onChange={(e) => setExportFormat(e.target.value as 'json' | 'html' | 'pdf')}
                className="bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500"
              >
                <option value="html">HTML</option>
                <option value="pdf">PDF</option>
                <option value="json">JSON</option>
              </select>
              <button
                onClick={handleExportReport}
                disabled={exportMutation.isPending}
                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {exportMutation.isPending ? (
                  <Loader className="w-4 h-4 animate-spin" />
                ) : (
                  <Download className="w-4 h-4" />
                )}
                Exportar
              </button>
            </div>
          </div>

          {generatedReport.report_type === 'executive_summary' && renderExecutiveSummary(generatedReport.data)}
          {generatedReport.report_type === 'technical_report' && renderTechnicalReport(generatedReport.data)}
          {generatedReport.report_type === 'compliance_report' && renderComplianceReport(generatedReport.data)}
        </div>
      )}

      {/* Historial de reportes */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4 flex items-center justify-between">
          <div>
            <h2 className="text-xl font-bold text-green-400">Historial de Reportes</h2>
            <p className="text-green-600">
              Reportes generados y disponibles para descarga
            </p>
          </div>
          <button
            onClick={() => refetchReports()}
            className="btn-secondary px-4 py-2"
            title="Actualizar lista de reportes"
          >
            üîÑ Refresh
          </button>
        </div>
        {reportsLoading ? (
          <div className="flex items-center justify-center py-8">
            <LoadingSpinner />
          </div>
        ) : reports && reports.length > 0 ? (
          <div className="space-y-2">
            {reports.map((report: ReportListItem, idx: number) => (
              <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded">
                <div>
                  <div className="font-medium">{report.filename}</div>
                  <div className="text-sm text-gray-600">
                    {new Date(report.created).toLocaleString()} - {(report.size / 1024).toFixed(1)} KB
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                    {report.format.toUpperCase()}
                  </span>
                  <button
                    onClick={() => handleDownloadReport(report.filename)}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex items-center gap-1"
                  >
                    <Download className="w-3 h-3" />
                    Descargar
                  </button>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p className="text-gray-500 text-center py-4">
            No hay reportes generados
          </p>
        )}
      </div>
    </div>
  )
}

export default Reporting