"""
API Endpoints para Pentest Selector
Gestión de metodologías y proyectos de pentesting
"""
from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from functools import wraps
import logging

from services.pentest_methodology import get_pentest_methodology_service
from utils.workspace_logger import log_to_workspace

logger = logging.getLogger(__name__)

pentest_selector_bp = Blueprint('pentest_selector', __name__, url_prefix='/api/v1/pentest')


def handle_errors(f):
    """Decorator para manejo de errores"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        try:
            return f(*args, **kwargs)
        except ValueError as e:
            logger.error(f"ValueError en {f.__name__}: {str(e)}")
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error en {f.__name__}: {str(e)}")
            return jsonify({'error': 'Internal server error'}), 500
    return decorated_function


@pentest_selector_bp.route('/methodologies', methods=['GET'])
@jwt_required()
@handle_errors
def get_methodologies():
    """
    Obtener todas las metodologías disponibles
    
    Returns:
        200: Dict con todas las metodologías
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    methodologies = service.get_all_methodologies()
    
    return jsonify(methodologies), 200


@pentest_selector_bp.route('/methodologies/<methodology_id>', methods=['GET'])
@jwt_required()
@handle_errors
def get_methodology(methodology_id: str):
    """
    Obtener una metodología específica
    
    Args:
        methodology_id: ID de la metodología
        
    Returns:
        200: Detalles de la metodología
        404: Metodología no encontrada
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    methodology = service.get_methodology(methodology_id)
    
    if not methodology:
        return jsonify({'error': 'Metodología no encontrada'}), 404
    
    return jsonify({'methodology': methodology}), 200


@pentest_selector_bp.route('/methodologies/<methodology_id>/workflow', methods=['GET'])
@jwt_required()
@handle_errors
def get_methodology_workflow(methodology_id: str):
    """
    Obtener workflow detallado de una metodología
    
    Args:
        methodology_id: ID de la metodología
        
    Returns:
        200: Workflow de la metodología
        404: Metodología no encontrada
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    workflow = service.get_methodology_workflow(methodology_id)
    
    if not workflow:
        return jsonify({'error': 'Workflow no encontrado para esta metodología'}), 404
    
    return jsonify(workflow), 200


@pentest_selector_bp.route('/projects/preview', methods=['POST'])
@jwt_required()
@handle_errors
def preview_project():
    """
    Preview de creación de proyecto (sin crear)
    
    Request Body:
        {
            "name": str,
            "methodology": str (black_box, gray_box, white_box, red_team),
            "target": str (required),
            "scope": list[str],
            "client": str,
            ...
        }
        
    Returns:
        200: Preview del comando
        400: Datos inválidos
        500: Error del servidor
    """
    data = request.get_json()
    
    if not data:
        return jsonify({'error': 'No se proporcionaron datos'}), 400
    
    if not data.get('target'):
        return jsonify({'error': 'El campo "target" es requerido'}), 400
    
    service = get_pentest_methodology_service()
    result = service.preview_project(data)
    
    return jsonify(result), 200


@pentest_selector_bp.route('/projects', methods=['POST'])
@jwt_required()
@handle_errors
def create_project():
    """
    Crear nuevo proyecto de pentest
    
    Request Body:
        {
            "name": str,
            "methodology": str (black_box, gray_box, white_box, red_team),
            "target": str (required),
            "workspace_id": int (required),
            "scope": list[str],
            "client": str,
            "start_date": str (ISO date),
            "objectives": list[str],
            "team_members": list[str]
        }
        
    Returns:
        201: Proyecto creado exitosamente
        400: Datos inválidos
        500: Error del servidor
    """
    data = request.get_json()
    current_user = get_jwt_identity()
    
    if not data:
        return jsonify({'error': 'No se proporcionaron datos'}), 400
    
    if not data.get('target'):
        return jsonify({'error': 'El campo "target" es requerido'}), 400
    
    if not data.get('workspace_id'):
        return jsonify({'error': 'El campo "workspace_id" es requerido'}), 400
    
    # Agregar usuario actual
    data['created_by'] = current_user or 'system'
    workspace_id = data.get('workspace_id')
    
    service = get_pentest_methodology_service()
    result = service.create_project(data)
    
    if result['success']:
        # Log al workspace
        log_to_workspace(
            workspace_id=workspace_id,
            source='Pentest Selector',
            level='INFO',
            message=f"Proyecto de pentest creado: {result['project']['name']} ({result['project']['methodology']})",
            metadata={
                'project_id': result['project']['id'],
                'methodology': result['project']['methodology'],
                'target': result['project']['target']
            }
        )
        return jsonify(result), 201
    else:
        return jsonify(result), 400


@pentest_selector_bp.route('/projects', methods=['GET'])
@jwt_required()
@handle_errors
def list_projects():
    """
    Listar todos los proyectos
    
    Query Params:
        status: Filtrar por estado (planning, active, completed, cancelled)
        methodology: Filtrar por metodología
        
    Returns:
        200: Lista de proyectos
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    projects = service.list_projects()
    
    # Filtros opcionales
    status_filter = request.args.get('status')
    methodology_filter = request.args.get('methodology')
    
    if status_filter:
        projects = [p for p in projects if p['status'] == status_filter]
    
    if methodology_filter:
        projects = [p for p in projects if p['methodology'] == methodology_filter]
    
    # Retornar solo resumen para lista
    project_summaries = [
        {
            "id": p["id"],
            "name": p["name"],
            "methodology": p["methodology"],
            "target": p["target"],
            "status": p["status"],
            "phases_completed": len(p["phases_completed"]),
            "findings_count": len(p["findings"]),
            "start_date": p["start_date"],
            "created_by": p["created_by"],
            "created_at": p["created_at"]
        }
        for p in projects
    ]
    
    return jsonify(project_summaries), 200


@pentest_selector_bp.route('/projects/<project_id>', methods=['GET'])
@jwt_required()
@handle_errors
def get_project(project_id: str):
    """
    Obtener proyecto específico
    
    Args:
        project_id: ID del proyecto
        
    Returns:
        200: Detalles completos del proyecto
        404: Proyecto no encontrado
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    project = service.get_project(project_id)
    
    if not project:
        return jsonify({'error': 'Proyecto no encontrado'}), 404
    
    return jsonify(project), 200


@pentest_selector_bp.route('/projects/<project_id>/status', methods=['PUT'])
@jwt_required()
@handle_errors
def update_project_status(project_id: str):
    """
    Actualizar estado del proyecto
    
    Args:
        project_id: ID del proyecto
        
    Request Body:
        {
            "status": str (planning, active, completed, cancelled),
            "phase_completed": str (opcional)
        }
        
    Returns:
        200: Proyecto actualizado
        400: Datos inválidos
        404: Proyecto no encontrado
        500: Error del servidor
    """
    data = request.get_json()
    
    if not data or 'status' not in data:
        return jsonify({'error': 'El campo "status" es requerido'}), 400
    
    service = get_pentest_methodology_service()
    result = service.update_project_status(
        project_id,
        data['status'],
        data.get('phase_completed')
    )
    
    if result['success']:
        return jsonify(result), 200
    else:
        return jsonify(result), 404 if 'no encontrado' in result['message'] else 400


@pentest_selector_bp.route('/projects/<project_id>/findings', methods=['POST'])
@jwt_required()
@handle_errors
def add_finding(project_id: str):
    """
    Agregar hallazgo a proyecto
    
    Args:
        project_id: ID del proyecto
        
    Request Body:
        {
            "title": str (required),
            "description": str (required),
            "severity": str (info, low, medium, high, critical),
            "category": str,
            "phase": str,
            "remediation": str,
            "tags": list[str],
            "workspace_id": int (required)
        }
        
    Returns:
        201: Hallazgo agregado
        400: Datos inválidos
        404: Proyecto no encontrado
        500: Error del servidor
    """
    data = request.get_json()
    current_user = get_jwt_identity()
    
    if not data:
        return jsonify({'error': 'No se proporcionaron datos'}), 400
    
    required_fields = ['title', 'description', 'workspace_id']
    missing_fields = [field for field in required_fields if not data.get(field)]
    
    if missing_fields:
        return jsonify({
            'error': f'Campos requeridos faltantes: {", ".join(missing_fields)}'
        }), 400
    
    # Agregar usuario actual
    data['created_by'] = current_user or 'system'
    workspace_id = data.get('workspace_id')
    
    service = get_pentest_methodology_service()
    result = service.add_finding(project_id, data)
    
    if result['success']:
        # Log al workspace
        log_to_workspace(
            workspace_id=workspace_id,
            source='Pentest Selector',
            level='INFO',
            message=f"Hallazgo agregado al proyecto {project_id}: {result['finding']['title']}",
            metadata={
                'project_id': project_id,
                'finding_id': result['finding']['id'],
                'severity': result['finding']['severity']
            }
        )
        return jsonify(result), 201
    else:
        return jsonify(result), 404 if 'no encontrado' in result['message'] else 400


@pentest_selector_bp.route('/dashboard', methods=['GET'])
@jwt_required()
@handle_errors
def get_dashboard():
    """
    Obtener estadísticas del dashboard
    
    Returns:
        200: Estadísticas agregadas
        500: Error del servidor
    """
    service = get_pentest_methodology_service()
    stats = service.get_dashboard_stats()
    
    return jsonify(stats), 200


@pentest_selector_bp.route('/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    return jsonify({
        'status': 'healthy',
        'service': 'pentest_selector',
        'version': '1.0.0'
    }), 200


# Documentación de la API
@pentest_selector_bp.route('/docs', methods=['GET'])
def api_docs():
    """Documentación de endpoints disponibles"""
    endpoints = {
        'GET /api/v1/pentest/methodologies': 'Obtener todas las metodologías',
        'GET /api/v1/pentest/methodologies/<id>': 'Obtener metodología específica',
        'GET /api/v1/pentest/methodologies/<id>/workflow': 'Obtener workflow de metodología',
        'POST /api/v1/pentest/projects': 'Crear nuevo proyecto',
        'GET /api/v1/pentest/projects': 'Listar proyectos',
        'GET /api/v1/pentest/projects/<id>': 'Obtener proyecto específico',
        'PUT /api/v1/pentest/projects/<id>/status': 'Actualizar estado de proyecto',
        'POST /api/v1/pentest/projects/<id>/findings': 'Agregar hallazgo a proyecto',
        'GET /api/v1/pentest/dashboard': 'Obtener estadísticas del dashboard'
    }
    
    return jsonify({
        'service': 'Pentest Selector API',
        'version': '1.0.0',
        'endpoints': endpoints
    }), 200





