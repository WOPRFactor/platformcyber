"""
Vulnerability API
=================

Endpoints para detección y gestión de vulnerabilidades.

Herramientas:
- Nuclei (5000+ templates)
- Nikto (web server scanner)
- SQLMap (SQL injection, modo seguro)
- ZAP (OWASP ZAP)
- TestSSL (SSL/TLS testing)
- WhatWeb (technology detection)
- Dalfox (XSS scanner)

Endpoints:
- POST /api/v1/vulnerability/nuclei - Escaneo Nuclei
- POST /api/v1/vulnerability/nikto - Escaneo Nikto
- POST /api/v1/vulnerability/sqlmap - Escaneo SQLMap (seguro)
- POST /api/v1/vulnerability/zap - Escaneo OWASP ZAP
- POST /api/v1/vulnerability/testssl - Análisis SSL/TLS
- POST /api/v1/vulnerability/whatweb - Detección de tecnologías
- POST /api/v1/vulnerability/dalfox - Escaneo XSS
- POST /api/v1/vulnerability/comprehensive/<target> - Evaluación completa
- GET /api/v1/vulnerability/list - Listar vulnerabilidades
- GET /api/v1/vulnerability/stats - Estadísticas
- POST /api/v1/vulnerability/create - Crear vulnerabilidad manual
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging
import sys

from services import VulnerabilityService, XSSScannerService

logger = logging.getLogger(__name__)

# Asegurar que el logger tenga un handler si no lo tiene
if not logger.handlers:
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.INFO)
    formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    handler.setFormatter(formatter)
    logger.addHandler(handler)
    logger.setLevel(logging.INFO)

vulnerability_bp = Blueprint('vulnerability', __name__)

# Inicializar servicios
vuln_service = VulnerabilityService()
xss_scanner_service = XSSScannerService()


@vulnerability_bp.route('/nuclei/preview', methods=['POST'])
@jwt_required()
def preview_nuclei():
    """Preview del comando Nuclei."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    severity = data.get('severity')
    tags = data.get('tags')
    templates = data.get('templates')
    rate_limit = data.get('rate_limit', 150)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_nuclei_scan(
            target=target,
            workspace_id=workspace_id,
            severity=severity,
            tags=tags,
            templates=templates,
            rate_limit=rate_limit
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_nuclei: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/nikto/preview', methods=['POST'])
@jwt_required()
def preview_nikto():
    """Preview del comando Nikto."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    port = data.get('port', 80)
    ssl = data.get('ssl', False)
    tuning = data.get('tuning')
    maxtime = data.get('maxtime')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_nikto_scan(
            target=target,
            workspace_id=workspace_id,
            port=port,
            ssl=ssl,
            tuning=tuning,
            maxtime=maxtime
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_nikto: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/nuclei', methods=['POST'])
@jwt_required()
def nuclei_scan():
    """
    Inicia escaneo con Nuclei.
    
    Body:
        {
            "target": "https://example.com",
            "severity": ["critical", "high"],
            "workspace_id": 1,
            "templates": "cves/" (opcional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    severity = data.get('severity', ['critical', 'high', 'medium'])
    templates = data.get('templates')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_nuclei_scan(
            target=target,
            severity=severity,
            workspace_id=workspace_id,
            user_id=current_user_id,
            templates=templates
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in nuclei_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/sqlmap/preview', methods=['POST'])
@jwt_required()
def preview_sqlmap():
    """Preview del comando SQLMap."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    method = data.get('method', 'GET')
    data_param = data.get('data')
    level = data.get('level', 1)
    risk = data.get('risk', 1)
    techniques = data.get('techniques')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_sqlmap_scan(
            target=target,
            workspace_id=workspace_id,
            method=method,
            data=data_param,
            level=level,
            risk=risk,
            techniques=techniques
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_sqlmap: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/zap/preview', methods=['POST'])
@jwt_required()
def preview_zap():
    """Preview del comando ZAP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    scan_type = data.get('scan_type', 'spider')
    context = data.get('context')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_zap_scan(
            target=target,
            workspace_id=workspace_id,
            scan_type=scan_type,
            context=context
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_zap: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/testssl/preview', methods=['POST'])
@jwt_required()
def preview_testssl():
    """Preview del comando testssl.sh."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    severity = data.get('severity', 'LOW')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_testssl(
            target=target,
            workspace_id=workspace_id,
            severity=severity
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_testssl: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/whatweb/preview', methods=['POST'])
@jwt_required()
def preview_whatweb():
    """Preview del comando WhatWeb."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    aggression = data.get('aggression', 1)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_whatweb(
            target=target,
            workspace_id=workspace_id,
            aggression=aggression
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_whatweb: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/dalfox/preview', methods=['POST'])
@jwt_required()
def preview_dalfox():
    """Preview del comando Dalfox."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    blind = data.get('blind', False)
    worker = data.get('worker', 100)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_dalfox(
            target=target,
            workspace_id=workspace_id,
            blind=blind,
            worker=worker
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_dalfox: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/nmap-vuln/preview', methods=['POST'])
@jwt_required()
def preview_nmap_vuln():
    """Preview del comando Nmap Vulnerability Scripts."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    ports = data.get('ports')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_nmap_vuln_scan(
            target=target,
            workspace_id=workspace_id,
            ports=ports
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_nmap_vuln: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/comprehensive/preview', methods=['POST'])
@jwt_required()
def preview_comprehensive():
    """Preview del comando Comprehensive Vulnerability Assessment."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    include_nikto = data.get('include_nikto', True)
    include_nmap = data.get('include_nmap', True)
    include_nuclei = data.get('include_nuclei', True)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_comprehensive_scan(
            target=target,
            workspace_id=workspace_id,
            include_nikto=include_nikto,
            include_nmap=include_nmap,
            include_nuclei=include_nuclei
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_comprehensive: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/wpscan/preview', methods=['POST'])
@jwt_required()
def preview_wpscan():
    """Preview del comando WPScan."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    enumerate = data.get('enumerate')
    plugins_detection = data.get('plugins_detection', 'passive')
    api_token = data.get('api_token')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.preview_wpscan(
            target=target,
            workspace_id=workspace_id,
            enumerate=enumerate,
            plugins_detection=plugins_detection,
            api_token=api_token
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_wpscan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/wpscan', methods=['POST'])
@jwt_required()
def wpscan_scan():
    """
    Inicia escaneo con WPScan (WordPress Security Scanner).
    
    Body:
        {
            "target": "https://example.com",
            "workspace_id": 1,
            "enumerate": "u,p,t" (opcional: u=usuarios, p=plugins, t=themes),
            "plugins_detection": "passive|aggressive|mixed" (opcional, default: passive),
            "api_token": "token" (opcional: API token de WPScan)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    enumerate = data.get('enumerate')
    plugins_detection = data.get('plugins_detection', 'passive')
    api_token = data.get('api_token')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_wpscan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            enumerate=enumerate,
            plugins_detection=plugins_detection,
            api_token=api_token
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in wpscan_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/nikto', methods=['POST'])
@jwt_required()
def nikto_scan():
    """
    Inicia escaneo con Nikto.
    
    Body:
        {
            "target": "https://example.com",
            "workspace_id": 1,
            "port": 80,
            "ssl": true,
            "tuning": "1,2,3",          # Opcional: Categorías de tests (1-9,0,a-e,x)
            "maxtime": "30m",            # Opcional: Tiempo máximo ("1h", "60m", "3600s")
            "maxtests": 1000,            # Opcional: Número máximo de tests
            "timeout": 5                 # Opcional: Timeout por request en segundos
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    port = data.get('port', 80)
    ssl = data.get('ssl', False)
    tuning = data.get('tuning')
    maxtime = data.get('maxtime')
    maxtests = data.get('maxtests')
    timeout = data.get('timeout')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_nikto_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=port,
            ssl=ssl,
            tuning=tuning,
            maxtime=maxtime,
            maxtests=maxtests,
            timeout=timeout
        )
        
        return jsonify(result), 201
        
    except Exception as e:
        logger.error(f"Error in nikto_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/nmap', methods=['POST'])
@jwt_required()
def nmap_vuln_scan():
    """
    Inicia escaneo de vulnerabilidades con Nmap (scripts NSE).
    
    Body:
        {
            "target": "example.com",
            "workspace_id": 1,
            "ports": "1-1000"  # Opcional
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    ports = data.get('ports')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_nmap_vuln_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            ports=ports
        )
        
        return jsonify(result), 201
        
    except Exception as e:
        logger.error(f"Error in nmap_vuln_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/sqlmap', methods=['POST'])
@jwt_required()
def sqlmap_scan():
    """
    Inicia escaneo con SQLMap (MODO SEGURO - sin --dump-all).
    
    Body:
        {
            "url": "https://example.com/page?id=1",
            "workspace_id": 1,
            "database": "dbname" (opcional),
            "table": "users" (opcional),
            "cookies": "session=abc123" (opcional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    url = data.get('url')
    workspace_id = data.get('workspace_id')
    database = data.get('database')
    table = data.get('table')
    cookies = data.get('cookies')
    
    if not url or not workspace_id:
        return jsonify({'error': 'URL and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_sqlmap_scan(
            url=url,
            workspace_id=workspace_id,
            user_id=current_user_id,
            cookies=cookies,
            database=database,
            table=table
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in sqlmap_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/list', methods=['GET'])
@jwt_required()
def list_vulnerabilities():
    """
    Lista vulnerabilidades de un workspace.
    
    Query params:
        workspace_id: ID del workspace (required)
        severity: Filtrar por severidad (optional)
        status: Filtrar por estado (optional)
    """
    workspace_id = request.args.get('workspace_id', type=int)
    severity = request.args.get('severity')
    status = request.args.get('status')
    
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    
    try:
        vulns = vuln_service.get_vulnerabilities(
            workspace_id=workspace_id,
            severity=severity,
            status=status
        )
        
        return jsonify({
            'vulnerabilities': vulns,
            'total': len(vulns)
        }), 200
        
    except Exception as e:
        logger.error(f"Error listing vulnerabilities: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/stats', methods=['GET'])
@jwt_required()
def get_statistics():
    """
    Obtiene estadísticas de vulnerabilidades.
    
    Query params:
        workspace_id: ID del workspace (required)
    """
    workspace_id = request.args.get('workspace_id', type=int)
    
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    
    try:
        stats = vuln_service.get_statistics(workspace_id)
        return jsonify(stats), 200
        
    except Exception as e:
        logger.error(f"Error getting statistics: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/create', methods=['POST'])
@jwt_required()
def create_vulnerability():
    """
    Crea una vulnerabilidad manualmente.
    
    Body:
        {
            "title": "SQL Injection in login",
            "description": "...",
            "severity": "high",
            "target": "https://example.com/login",
            "workspace_id": 1,
            "cve_id": "CVE-2024-1234" (opcional),
            "cvss_score": 8.5 (opcional),
            "port": 443 (opcional),
            "service": "https" (opcional)
        }
    """
    data = request.get_json()
    
    required = ['title', 'description', 'severity', 'target', 'workspace_id']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    
    try:
        vuln = vuln_service.create_vulnerability(
            title=data['title'],
            description=data['description'],
            severity=data['severity'],
            target=data['target'],
            workspace_id=data['workspace_id'],
            cve_id=data.get('cve_id'),
            cvss_score=data.get('cvss_score'),
            port=data.get('port'),
            service=data.get('service')
        )
        
        return jsonify(vuln), 201
        
    except Exception as e:
        logger.error(f"Error creating vulnerability: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/zap', methods=['POST'])
@jwt_required()
def zap_scan():
    """
    Inicia escaneo con OWASP ZAP.
    
    Body:
        {
            "target": "https://example.com",
            "workspace_id": 1,
            "scan_type": "baseline|full|api" (opcional, default: baseline),
            "ajax_spider": false (opcional)
        }
    """
    try:
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        logger.info(f"ZAP scan request - data: {data}, user_id: {current_user_id}")
        
        if not data:
            error_msg = 'Request body is required'
            logger.error(f"ZAP scan error: {error_msg}")
            return jsonify({'error': error_msg}), 400
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        scan_type = data.get('scan_type', 'baseline')
        ajax_spider = data.get('ajax_spider', False)
        
        logger.info(f"ZAP scan - target: {target}, workspace_id: {workspace_id}, scan_type: {scan_type}, ajax_spider: {ajax_spider}")
        
        if not target:
            error_msg = f'Target is required. Received: target={target}'
            logger.error(f"ZAP scan error: {error_msg}")
            return jsonify({'error': error_msg}), 400
        
        if not workspace_id:
            error_msg = f'workspace_id is required. Received: workspace_id={workspace_id}'
            logger.error(f"ZAP scan error: {error_msg}")
            return jsonify({'error': error_msg}), 400
    except Exception as e:
        logger.error(f"ZAP scan error parsing request: {e}")
        return jsonify({'error': f'Error parsing request: {str(e)}'}), 400
    
    try:
        result = vuln_service.start_zap_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            scan_type=scan_type,
            ajax_spider=ajax_spider
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in zap_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/testssl', methods=['POST'])
@jwt_required()
def testssl_scan():
    """
    Inicia análisis SSL/TLS con testssl.sh.
    
    Body:
        {
            "target": "example.com",
            "workspace_id": 1,
            "port": 443 (opcional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    port = data.get('port', 443)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = vuln_service.start_testssl_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=port
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in testssl_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/whatweb', methods=['POST'])
@jwt_required()
def whatweb_scan():
    """
    Detecta tecnologías con WhatWeb.
    
    Body:
        {
            "target": "https://example.com",
            "workspace_id": 1,
            "aggression": 1 (opcional, 1-4, default: 1)
        }
    """
    # Log inicial para verificar que el endpoint se está llamando
    logger.info("=" * 80)
    logger.info("WhatWeb scan endpoint called")
    logger.info(f"Request method: {request.method}")
    logger.info(f"Request path: {request.path}")
    logger.info(f"Request content type: {request.content_type}")
    logger.info(f"Request headers: {dict(request.headers)}")
    
    # Obtener datos del request
    try:
        data = request.get_json(force=True)  # force=True para intentar parsear aunque el content-type no sea correcto
    except Exception as e:
        logger.error(f"WhatWeb scan: Error parsing JSON: {e}")
        logger.error(f"Raw data: {request.get_data(as_text=True)}")
        return jsonify({'error': 'Invalid JSON in request body'}), 400
    
    logger.info(f"WhatWeb scan - Raw request data: {data}")
    
    if not data:
        logger.error("WhatWeb scan: No data received in request body")
        logger.error(f"Request data (raw): {request.get_data(as_text=True)}")
        return jsonify({'error': 'Request body is required'}), 400
    
    try:
        current_user_id = get_jwt_identity()
        logger.info(f"WhatWeb scan - User ID: {current_user_id}")
    except Exception as e:
        logger.error(f"WhatWeb scan: Error getting JWT identity: {e}")
        return jsonify({'error': 'Authentication error'}), 401
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    aggression = data.get('aggression', 1)
    
    logger.info(f"WhatWeb scan request - target: {target}, workspace_id: {workspace_id}, aggression: {aggression}, user_id: {current_user_id}, full_data: {data}")
    
    if not target:
        logger.error(f"WhatWeb scan: Target is missing. Data received: {data}")
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        logger.error(f"WhatWeb scan: workspace_id is missing. Data received: {data}")
        return jsonify({'error': 'workspace_id is required'}), 400
    
    # Convertir aggression a int si viene como string
    try:
        aggression = int(aggression) if aggression else 1
    except (ValueError, TypeError):
        logger.warning(f"WhatWeb scan: Invalid aggression value '{aggression}', using default 1")
        aggression = 1
    
    if aggression < 1 or aggression > 4:
        logger.error(f"WhatWeb scan: Aggression out of range: {aggression}")
        return jsonify({'error': 'Aggression must be between 1 and 4'}), 400
    
    try:
        result = vuln_service.start_whatweb_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            aggression=aggression
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in whatweb_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


# ============================================
# XSS MULTI-TOOL SCANNER
# ============================================

@vulnerability_bp.route('/xss/available-tools', methods=['GET'])
@jwt_required()
def xss_available_tools():
    """
    Verifica qué herramientas XSS están disponibles.
    
    Returns:
        {
            "xsstrike": true,
            "xsser": true,
            "zap": false,
            "nuclei": true
        }
    """
    try:
        availability = xss_scanner_service.check_tool_availability()
        return jsonify(availability), 200
    except Exception as e:
        logger.error(f"Error checking XSS tools availability: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/xss/preview', methods=['POST'])
@jwt_required()
def preview_xss():
    """
    Preview del comando XSS que se ejecutará.
    
    Body:
        {
            "url": "https://example.com/page?param=value",
            "workspace_id": 1,
            "engine": "auto|xsstrike|xsser|zap|nuclei" (default: "auto"),
            "scan_mode": "single|all|compare" (default: "single"),
            "engines": ["xsstrike", "xsser"] (opcional, para modo compare),
            "options": {
                "crawl": boolean,
                "fuzzing": boolean,
                "timeout": integer,
                "timeout_per_tool": integer,
                "global_timeout": integer,
                "custom_headers": object,
                "custom_cookies": string,
                "threads": integer
            }
        }
    """
    data = request.get_json()
    url = data.get('url')
    workspace_id = data.get('workspace_id')
    engine = data.get('engine', 'auto')
    scan_mode = data.get('scan_mode', 'single')
    engines = data.get('engines')
    options = data.get('options', {})
    
    if not url or not workspace_id:
        return jsonify({'error': 'URL and workspace_id are required'}), 400
    
    try:
        result = xss_scanner_service.preview_xss_command(
            url=url,
            workspace_id=workspace_id,
            engine=engine,
            scan_mode=scan_mode,
            engines=engines,
            options=options
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_xss: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/xss', methods=['POST'])
@jwt_required()
def xss_scan():
    """
    Escanea XSS con múltiples herramientas.
    
    Body:
        {
            "url": "https://example.com/page?param=value",
            "workspace_id": 1,
            "engine": "auto|xsstrike|xsser|zap|nuclei" (default: "auto"),
            "scan_mode": "single|all|compare" (default: "single"),
            "engines": ["xsstrike", "xsser"] (opcional, para modo compare),
            "options": {
                "crawl": boolean,
                "fuzzing": boolean,
                "timeout": integer,
                "timeout_per_tool": integer,
                "global_timeout": integer,
                "custom_headers": object,
                "custom_cookies": string,
                "threads": integer,
                "skip_dom": boolean,
                "auto_mode": boolean (para XSSer),
                "severity": ["low", "medium", "high", "critical"] (para Nuclei)
            }
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    url = data.get('url')
    workspace_id = data.get('workspace_id')
    engine = data.get('engine', 'auto')
    scan_mode = data.get('scan_mode', 'single')
    engines = data.get('engines')
    options = data.get('options', {})
    
    if not url or not workspace_id:
        return jsonify({'error': 'URL and workspace_id are required'}), 400
    
    try:
        result = xss_scanner_service.start_xss_scan(
            url=url,
            workspace_id=workspace_id,
            user_id=current_user_id,
            engine=engine,
            scan_mode=scan_mode,
            engines=engines,
            options=options
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in xss_scan: {e}")
        return jsonify({'error': str(e)}), 500


@vulnerability_bp.route('/xss/<int:scan_id>/comparison', methods=['GET'])
@jwt_required()
def xss_scan_comparison(scan_id: int):
    """
    Obtiene resultados comparativos de un scan en modo COMPARE.
    
    Returns:
        {
            "scan_id": 123,
            "mode": "compare",
            "engines": ["xsstrike", "xsser"],
            "results_by_tool": {
                "xsstrike": {...},
                "xsser": {...}
            },
            "consolidated": [...],
            "statistics": {
                "total_unique": 5,
                "by_tool": {
                    "xsstrike": 3,
                    "xsser": 2
                },
                "agreement": 0.4
            }
        }
    """
    try:
        # Obtener scan
        from repositories import ScanRepository
        scan_repo = ScanRepository()
        scan = scan_repo.find_by_id(scan_id)
        
        if not scan:
            return jsonify({'error': 'Scan not found'}), 404
        
        # Obtener resultados del scan
        results = vuln_service.get_scan_results(scan_id)
        
        # Si el scan está en modo compare, estructurar respuesta comparativa
        scan_mode = scan.options.get('scan_mode') if scan.options else 'single'
        engines = scan.options.get('engines', []) if scan.options else []
        
        if scan_mode in ['compare', 'all']:
            # Estructurar resultados por herramienta
            # Esto requeriría parsear el raw_output y agrupar por tool
            # Por ahora, retornar estructura básica
            return jsonify({
                'scan_id': scan_id,
                'mode': scan_mode,
                'engines': engines,
                'results': results,
                'status': scan.status
            }), 200
        else:
            return jsonify({
                'scan_id': scan_id,
                'mode': scan_mode,
                'results': results,
                'status': scan.status
            }), 200
            
    except Exception as e:
        logger.error(f"Error in xss_scan_comparison: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@vulnerability_bp.route('/comprehensive/<target>', methods=['POST', 'OPTIONS'])
def comprehensive_scan(target):
    """
    Inicia evaluación completa de vulnerabilidades (Nikto + Nmap + Nuclei).
    
    Args:
        target: URL o host objetivo (en la URL)
    
    Body (opcional):
        {
            "workspace_id": 1,
            "options": {
                "include_nikto": true,
                "include_nmap": true,
                "include_nuclei": true
            }
        }
    """
    # Manejar preflight OPTIONS antes de requerir autenticación
    if request.method == 'OPTIONS':
        return '', 204
    
    # Para POST, requerir autenticación
    from flask_jwt_extended import verify_jwt_in_request
    try:
        verify_jwt_in_request()
        current_user_id = get_jwt_identity()
    except Exception as e:
        logger.error(f"JWT verification failed: {e}")
        return jsonify({'error': 'Authentication required'}), 401
    
    # Obtener datos del body (igual que otros endpoints)
    data = request.get_json() or {}
    
    # Obtener workspace_id del body o query params
    workspace_id = data.get('workspace_id') or request.args.get('workspace_id', type=int)
    
    if not workspace_id:
        logger.error(f"Missing workspace_id in comprehensive scan. Data: {data}, Args: {request.args}")
        return jsonify({'error': 'workspace_id is required'}), 400
    
    # Opciones de escaneo
    options = data.get('options', {})
    include_nikto = options.get('include_nikto', True)
    include_nmap = options.get('include_nmap', True)
    include_nuclei = options.get('include_nuclei', True)
    
    try:
        result = vuln_service.start_comprehensive_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            include_nikto=include_nikto,
            include_nmap=include_nmap,
            include_nuclei=include_nuclei
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in comprehensive_scan: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500



