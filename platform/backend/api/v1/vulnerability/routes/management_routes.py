"""
Vulnerability Management Routes
===============================

Rutas para gestión de vulnerabilidades (listar, estadísticas, crear).
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de gestión de vulnerabilidades."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/list', methods=['GET'])
    @jwt_required()
    def list_vulnerabilities():
        """
        Lista vulnerabilidades de un workspace.
        
        Query params:
            workspace_id: ID del workspace (required)
            severity: Filtrar por severidad (optional)
            status: Filtrar por estado (optional)
        """
        workspace_id = request.args.get('workspace_id', type=int)
        severity = request.args.get('severity')
        status = request.args.get('status')
        
        if not workspace_id:
            return jsonify({'error': 'workspace_id is required'}), 400
        
        try:
            vulns = vuln_service.get_vulnerabilities(
                workspace_id=workspace_id,
                severity=severity,
                status=status
            )
            
            return jsonify({
                'vulnerabilities': vulns,
                'total': len(vulns)
            }), 200
            
        except Exception as e:
            logger.error(f"Error listing vulnerabilities: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/stats', methods=['GET'])
    @jwt_required()
    def get_statistics():
        """
        Obtiene estadísticas de vulnerabilidades.
        
        Query params:
            workspace_id: ID del workspace (required)
        """
        workspace_id = request.args.get('workspace_id', type=int)
        
        if not workspace_id:
            return jsonify({'error': 'workspace_id is required'}), 400
        
        try:
            stats = vuln_service.get_statistics(workspace_id)
            return jsonify(stats), 200
            
        except Exception as e:
            logger.error(f"Error getting statistics: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/create', methods=['POST'])
    @jwt_required()
    def create_vulnerability():
        """
        Crea una vulnerabilidad manualmente.
        
        Body:
            {
                "title": "SQL Injection in login",
                "description": "...",
                "severity": "high",
                "target": "https://example.com/login",
                "workspace_id": 1,
                "cve_id": "CVE-2024-1234",
                "cvss_score": 8.5,
                "port": 443,
                "service": "https"
            }
        """
        data = request.get_json()
        
        required = ['title', 'description', 'severity', 'target', 'workspace_id']
        if not all(field in data for field in required):
            return jsonify({'error': 'Missing required fields'}), 400
        
        try:
            vuln = vuln_service.create_vulnerability(
                title=data['title'],
                description=data['description'],
                severity=data['severity'],
                target=data['target'],
                workspace_id=data['workspace_id'],
                cve_id=data.get('cve_id'),
                cvss_score=data.get('cvss_score'),
                port=data.get('port'),
                service=data.get('service')
            )
            
            return jsonify(vuln), 201
            
        except Exception as e:
            logger.error(f"Error creating vulnerability: {e}")
            return jsonify({'error': 'Internal server error'}), 500


