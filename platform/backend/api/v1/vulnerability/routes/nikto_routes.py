"""
Nikto Routes
============

Rutas para escaneo con Nikto.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de Nikto."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/nikto/preview', methods=['POST'])
    @jwt_required()
    def preview_nikto():
        """Preview del comando Nikto."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        port = data.get('port', 80)
        ssl = data.get('ssl', False)
        tuning = data.get('tuning')
        maxtime = data.get('maxtime')
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_nikto_scan(
                target=target,
                workspace_id=workspace_id,
                port=port,
                ssl=ssl,
                tuning=tuning,
                maxtime=maxtime
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_nikto: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/nikto', methods=['POST'])
    @jwt_required()
    def nikto_scan():
        """
        Inicia escaneo con Nikto.
        
        Body:
            {
                "target": "https://example.com",
                "workspace_id": 1,
                "port": 80,
                "ssl": true,
                "tuning": "1,2,3",
                "maxtime": "30m",
                "maxtests": 1000,
                "timeout": 5
            }
        """
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        port = data.get('port', 80)
        ssl = data.get('ssl', False)
        tuning = data.get('tuning')
        maxtime = data.get('maxtime')
        maxtests = data.get('maxtests')
        timeout = data.get('timeout')
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.start_nikto_scan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                port=port,
                ssl=ssl,
                tuning=tuning,
                maxtime=maxtime,
                maxtests=maxtests,
                timeout=timeout
            )
            
            return jsonify(result), 201
            
        except Exception as e:
            logger.error(f"Error in nikto_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

