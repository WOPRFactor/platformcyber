"""
OWASP ZAP Routes
================

Rutas para escaneo con OWASP ZAP.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de ZAP."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/zap/preview', methods=['POST'])
    @jwt_required()
    def preview_zap():
        """Preview del comando OWASP ZAP."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        scan_type = data.get('scan_type', 'baseline')
        ajax_spider = data.get('ajax_spider', False)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_zap_scan(
                target=target,
                workspace_id=workspace_id,
                scan_type=scan_type,
                ajax_spider=ajax_spider
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_zap: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/zap', methods=['POST'])
    @jwt_required()
    def zap_scan():
        """
        Inicia escaneo con OWASP ZAP.
        
        Body:
            {
                "target": "https://example.com",
                "workspace_id": 1,
                "scan_type": "baseline|full|api",
                "ajax_spider": false
            }
        """
        try:
            data = request.get_json()
            current_user_id = get_jwt_identity()
            
            logger.info(f"ZAP scan request - data: {data}, user_id: {current_user_id}")
            
            if not data:
                error_msg = 'Request body is required'
                logger.error(f"ZAP scan error: {error_msg}")
                return jsonify({'error': error_msg}), 400
            
            target = data.get('target')
            workspace_id = data.get('workspace_id')
            scan_type = data.get('scan_type', 'baseline')
            ajax_spider = data.get('ajax_spider', False)
            
            logger.info(f"ZAP scan - target: {target}, workspace_id: {workspace_id}, scan_type: {scan_type}, ajax_spider: {ajax_spider}")
            
            if not target:
                error_msg = f'Target is required. Received: target={target}'
                logger.error(f"ZAP scan error: {error_msg}")
                return jsonify({'error': error_msg}), 400
            
            if not workspace_id:
                error_msg = f'workspace_id is required. Received: workspace_id={workspace_id}'
                logger.error(f"ZAP scan error: {error_msg}")
                return jsonify({'error': error_msg}), 400
        except Exception as e:
            logger.error(f"ZAP scan error parsing request: {e}")
            return jsonify({'error': f'Error parsing request: {str(e)}'}), 400
        
        try:
            result = vuln_service.start_zap_scan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                scan_type=scan_type,
                ajax_spider=ajax_spider
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in zap_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

