"""
Dalfox Routes
=============

Rutas para escaneo XSS con Dalfox.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de Dalfox."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/dalfox/preview', methods=['POST'])
    @jwt_required()
    def preview_dalfox():
        """Preview del comando Dalfox."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        blind = data.get('blind', False)
        worker = data.get('worker', 100)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_dalfox(
                target=target,
                workspace_id=workspace_id,
                blind=blind,
                worker=worker
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_dalfox: {e}")
            return jsonify({'error': 'Internal server error'}), 500


