"""
WPScan Routes
=============

Rutas para escaneo WordPress con WPScan.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de WPScan."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/wpscan/preview', methods=['POST'])
    @jwt_required()
    def preview_wpscan():
        """Preview del comando WPScan."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        enumerate = data.get('enumerate')
        plugins_detection = data.get('plugins_detection', 'passive')
        api_token = data.get('api_token')
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_wpscan_scan(
                target=target,
                workspace_id=workspace_id,
                enumerate=enumerate,
                plugins_detection=plugins_detection,
                api_token=api_token
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_wpscan: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/wpscan', methods=['POST'])
    @jwt_required()
    def wpscan_scan():
        """
        Inicia escaneo con WPScan (WordPress Security Scanner).
        
        Body:
            {
                "target": "https://example.com",
                "workspace_id": 1,
                "enumerate": "u,p,t",
                "plugins_detection": "passive|aggressive|mixed",
                "api_token": "token"
            }
        """
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        enumerate = data.get('enumerate')
        plugins_detection = data.get('plugins_detection', 'passive')
        api_token = data.get('api_token')
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.start_wpscan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                enumerate=enumerate,
                plugins_detection=plugins_detection,
                api_token=api_token
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in wpscan_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

