"""
Nuclei Routes
============

Rutas para escaneo con Nuclei.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de Nuclei."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/nuclei/preview', methods=['POST'])
    @jwt_required()
    def preview_nuclei():
        """Preview del comando Nuclei."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        severity = data.get('severity')
        tags = data.get('tags')
        templates = data.get('templates')
        rate_limit = data.get('rate_limit', 150)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_nuclei_scan(
                target=target,
                workspace_id=workspace_id,
                severity=severity,
                tags=tags,
                templates=templates,
                rate_limit=rate_limit
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_nuclei: {e}")
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/nuclei', methods=['POST'])
    @jwt_required()
    def nuclei_scan():
        """
        Inicia escaneo con Nuclei.
        
        Body:
            {
                "target": "https://example.com",
                "workspace_id": 1,
                "severity": ["critical", "high"],
                "tags": ["xss", "sqli"],
                "templates": "path/to/templates",
                "rate_limit": 150
            }
        """
        data = request.get_json()
        current_user_id = get_jwt_identity()
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        severity = data.get('severity')
        tags = data.get('tags')
        templates = data.get('templates')
        rate_limit = data.get('rate_limit', 150)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.start_nuclei_scan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                severity=severity,
                tags=tags,
                templates=templates,
                rate_limit=rate_limit
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in nuclei_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

