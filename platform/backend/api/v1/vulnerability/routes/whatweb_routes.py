"""
WhatWeb Routes
==============

Rutas para detección de tecnologías con WhatWeb.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import VulnerabilityService

logger = logging.getLogger(__name__)


def register_routes(bp: Blueprint):
    """Registra las rutas de WhatWeb."""
    vuln_service = VulnerabilityService()
    
    @bp.route('/whatweb/preview', methods=['POST'])
    @jwt_required()
    def preview_whatweb():
        """Preview del comando WhatWeb."""
        data = request.get_json()
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        aggression = data.get('aggression', 1)
        
        if not target or not workspace_id:
            return jsonify({'error': 'Target and workspace_id are required'}), 400
        
        try:
            result = vuln_service.preview_whatweb_scan(
                target=target,
                workspace_id=workspace_id,
                aggression=aggression
            )
            return jsonify(result), 200
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in preview_whatweb: {e}", exc_info=True)
            return jsonify({'error': 'Internal server error'}), 500
    
    @bp.route('/whatweb', methods=['POST'])
    @jwt_required()
    def whatweb_scan():
        """
        Detecta tecnologías con WhatWeb.
        
        Body:
            {
                "target": "https://example.com",
                "workspace_id": 1,
                "aggression": 1
            }
        """
        logger.info("=" * 80)
        logger.info("WhatWeb scan endpoint called")
        logger.info(f"Request method: {request.method}")
        logger.info(f"Request path: {request.path}")
        logger.info(f"Request content type: {request.content_type}")
        logger.info(f"Request headers: {dict(request.headers)}")
        
        try:
            data = request.get_json(force=True)
        except Exception as e:
            logger.error(f"WhatWeb scan: Error parsing JSON: {e}")
            logger.error(f"Raw data: {request.get_data(as_text=True)}")
            return jsonify({'error': 'Invalid JSON in request body'}), 400
        
        logger.info(f"WhatWeb scan - Raw request data: {data}")
        
        if not data:
            logger.error("WhatWeb scan: No data received in request body")
            logger.error(f"Request data (raw): {request.get_data(as_text=True)}")
            return jsonify({'error': 'Request body is required'}), 400
        
        try:
            current_user_id = get_jwt_identity()
            logger.info(f"WhatWeb scan - User ID: {current_user_id}")
        except Exception as e:
            logger.error(f"WhatWeb scan: Error getting JWT identity: {e}")
            return jsonify({'error': 'Authentication error'}), 401
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        aggression = data.get('aggression', 1)
        
        logger.info(f"WhatWeb scan request - target: {target}, workspace_id: {workspace_id}, aggression: {aggression}, user_id: {current_user_id}, full_data: {data}")
        
        if not target:
            logger.error(f"WhatWeb scan: Target is missing. Data received: {data}")
            return jsonify({'error': 'Target is required'}), 400
        
        if not workspace_id:
            logger.error(f"WhatWeb scan: workspace_id is missing. Data received: {data}")
            return jsonify({'error': 'workspace_id is required'}), 400
        
        try:
            aggression = int(aggression) if aggression else 1
        except (ValueError, TypeError):
            logger.warning(f"WhatWeb scan: Invalid aggression value '{aggression}', using default 1")
            aggression = 1
        
        if aggression < 1 or aggression > 4:
            logger.error(f"WhatWeb scan: Aggression out of range: {aggression}")
            return jsonify({'error': 'Aggression must be between 1 and 4'}), 400
        
        try:
            result = vuln_service.start_whatweb_scan(
                target=target,
                workspace_id=workspace_id,
                user_id=current_user_id,
                aggression=aggression
            )
            
            return jsonify(result), 201
            
        except ValueError as e:
            return jsonify({'error': str(e)}), 400
        except Exception as e:
            logger.error(f"Error in whatweb_scan: {e}")
            return jsonify({'error': 'Internal server error'}), 500

