"""
Post-Exploitation API
=====================

Endpoints para actividades post-explotaciÃ³n.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import get_jwt_identity, jwt_required
import logging

from services import PostExploitationService

logger = logging.getLogger(__name__)

post_exploitation_bp = Blueprint('post_exploitation', __name__)
post_exploit_service = PostExploitationService()


def _json_body() -> dict:
    return request.get_json(silent=True) or {}


def _handle_service_call(fn, success_code=201):
    try:
        return jsonify(fn()), success_code
    except ValueError as exc:
        return jsonify({'error': str(exc)}), 400
    except Exception as exc:  # pylint: disable=broad-except
        logger.error("Post-exploitation endpoint error: %s", exc, exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500


@post_exploitation_bp.route('/linpeas', methods=['POST'])
@jwt_required()
def run_linpeas():
    data = _json_body()
    user_id = get_jwt_identity()
    workspace_id = data.get('workspace_id')
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_linpeas(
            target=data.get('target'),
            workspace_id=workspace_id,
            user_id=user_id,
            local=data.get('local', False),
            ssh_user=data.get('ssh_user'),
            ssh_pass=data.get('ssh_pass'),
        )
    )


@post_exploitation_bp.route('/winpeas', methods=['POST'])
@jwt_required()
def run_winpeas():
    data = _json_body()
    user_id = get_jwt_identity()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    if not all([target, workspace_id]):
        return jsonify({'error': 'target and workspace_id are required'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_winpeas(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            local=data.get('local', False),
            username=data.get('username'),
            password=data.get('password'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/bloodhound', methods=['POST'])
@jwt_required()
def run_bloodhound():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['domain', 'workspace_id', 'username', 'password']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_bloodhound(
            domain=data['domain'],
            workspace_id=data['workspace_id'],
            user_id=user_id,
            username=data['username'],
            password=data['password'],
            collection_method=data.get('collection_method', 'All'),
            dc_ip=data.get('dc_ip'),
        )
    )


@post_exploitation_bp.route('/mimikatz', methods=['POST'])
@jwt_required()
def run_mimikatz():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['target', 'workspace_id', 'username', 'password']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_mimikatz(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=user_id,
            username=data['username'],
            password=data['password'],
            command=data.get('command', 'sekurlsa::logonpasswords'),
        )
    )


@post_exploitation_bp.route('/powerview', methods=['POST'])
@jwt_required()
def run_powerview():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['target', 'workspace_id', 'username', 'password']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_powerview(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=user_id,
            username=data['username'],
            password=data['password'],
            command=data.get('command', 'Get-DomainUser'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/seatbelt', methods=['POST'])
@jwt_required()
def run_seatbelt():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['target', 'workspace_id', 'username', 'password']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_seatbelt(
            target=data['target'],
            workspace_id=data['workspace_id'],
            user_id=user_id,
            username=data['username'],
            password=data['password'],
            group=data.get('group', 'all'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/lazagne', methods=['POST'])
@jwt_required()
def run_lazagne():
    data = _json_body()
    user_id = get_jwt_identity()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    if not all([target, workspace_id]):
        return jsonify({'error': 'target and workspace_id are required'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_lazagne(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            mode=data.get('mode', 'all'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/ssh-pivot', methods=['POST'])
@jwt_required()
def run_ssh_pivot():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['workspace_id', 'jump_host', 'jump_user', 'remote_host', 'remote_port', 'local_port']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_ssh_pivot(
            workspace_id=data['workspace_id'],
            user_id=user_id,
            jump_host=data['jump_host'],
            jump_user=data['jump_user'],
            remote_host=data['remote_host'],
            remote_port=int(data['remote_port']),
            local_port=int(data['local_port']),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/chisel', methods=['POST'])
@jwt_required()
def run_chisel():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['workspace_id', 'attacker_host', 'attacker_port', 'remote_host', 'remote_port', 'bind_port']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_chisel(
            workspace_id=data['workspace_id'],
            user_id=user_id,
            attacker_host=data['attacker_host'],
            attacker_port=int(data['attacker_port']),
            remote_host=data['remote_host'],
            remote_port=int(data['remote_port']),
            bind_port=int(data['bind_port']),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/ligolo', methods=['POST'])
@jwt_required()
def run_ligolo():
    data = _json_body()
    user_id = get_jwt_identity()
    required = ['workspace_id', 'relay_port', 'agent_port', 'target_subnet']
    if not all(field in data for field in required):
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.run_ligolo(
            workspace_id=data['workspace_id'],
            user_id=user_id,
            relay_port=int(data['relay_port']),
            agent_port=int(data['agent_port']),
            target_subnet=data['target_subnet'],
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/scans/<int:scan_id>', methods=['GET'])
@jwt_required()
def get_scan_results(scan_id: int):
    return _handle_service_call(
        lambda: post_exploit_service.get_scan_results(scan_id),
        success_code=200,
    )


# ============================================
# PREVIEW ENDPOINTS
# ============================================

@post_exploitation_bp.route('/linpeas/preview', methods=['POST'])
@jwt_required()
def preview_linpeas():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_linpeas(
            workspace_id=workspace_id,
            local=data.get('local', False),
            target=data.get('target'),
            ssh_user=data.get('ssh_user'),
            ssh_pass=data.get('ssh_pass'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/winpeas/preview', methods=['POST'])
@jwt_required()
def preview_winpeas():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    target = data.get('target')
    if not all([workspace_id, target]):
        return jsonify({'error': 'workspace_id and target are required'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_winpeas(
            workspace_id=workspace_id,
            target=target,
            local=data.get('local', False),
            username=data.get('username'),
            password=data.get('password'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/mimikatz/preview', methods=['POST'])
@jwt_required()
def preview_mimikatz():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    required = ['target', 'username', 'password']
    if not all(field in data for field in required) or not workspace_id:
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_mimikatz(
            workspace_id=workspace_id,
            target=data['target'],
            username=data['username'],
            password=data['password'],
            command=data.get('command', 'sekurlsa::logonpasswords'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/seatbelt/preview', methods=['POST'])
@jwt_required()
def preview_seatbelt():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    required = ['target', 'username', 'password']
    if not all(field in data for field in required) or not workspace_id:
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_seatbelt(
            workspace_id=workspace_id,
            target=data['target'],
            username=data['username'],
            password=data['password'],
            group=data.get('group', 'all'),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/ssh-pivot/preview', methods=['POST'])
@jwt_required()
def preview_ssh_pivot():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    required = ['jump_host', 'jump_user', 'remote_host', 'remote_port', 'local_port']
    if not all(field in data for field in required) or not workspace_id:
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_ssh_pivot(
            workspace_id=workspace_id,
            jump_host=data['jump_host'],
            jump_user=data['jump_user'],
            remote_host=data['remote_host'],
            remote_port=int(data['remote_port']),
            local_port=int(data['local_port']),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/chisel/preview', methods=['POST'])
@jwt_required()
def preview_chisel():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    required = ['attacker_host', 'attacker_port', 'remote_host', 'remote_port', 'bind_port']
    if not all(field in data for field in required) or not workspace_id:
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_chisel(
            workspace_id=workspace_id,
            attacker_host=data['attacker_host'],
            attacker_port=int(data['attacker_port']),
            remote_host=data['remote_host'],
            remote_port=int(data['remote_port']),
            bind_port=int(data['bind_port']),
        ),
        success_code=200,
    )


@post_exploitation_bp.route('/ligolo/preview', methods=['POST'])
@jwt_required()
def preview_ligolo():
    data = _json_body()
    workspace_id = data.get('workspace_id')
    required = ['relay_port', 'agent_port', 'target_subnet']
    if not all(field in data for field in required) or not workspace_id:
        return jsonify({'error': 'Missing required fields'}), 400
    return _handle_service_call(
        lambda: post_exploit_service.preview_ligolo(
            workspace_id=workspace_id,
            relay_port=int(data['relay_port']),
            agent_port=int(data['agent_port']),
            target_subnet=data['target_subnet'],
        ),
        success_code=200,
    )

