"""
Scanning API
============

Endpoints para escaneos de puertos y servicios.

Herramientas:
- Nmap
- RustScan
- Masscan
- Naabu

Endpoints:
- POST /api/v1/scanning/start - Endpoint unificado (recomendado)
- POST /api/v1/scanning/nmap - Escaneo Nmap
- POST /api/v1/scanning/rustscan - Escaneo RustScan (ultra-r√°pido)
- POST /api/v1/scanning/masscan - Escaneo Masscan (masivo)
- POST /api/v1/scanning/naabu - Escaneo Naabu (port discovery)
- GET /api/v1/scanning/scans - Listar escaneos
- GET /api/v1/scanning/scans/<id> - Detalle de escaneo
- GET /api/v1/scanning/scans/<id>/results - Resultados parseados
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from services import ScanningService

logger = logging.getLogger(__name__)
logger.setLevel(logging.INFO)  # Asegurar que el logger est√© en INFO

scanning_bp = Blueprint('scanning', __name__)

# Inicializar servicio
scanning_service = ScanningService()


@scanning_bp.route('/start', methods=['POST'])
@jwt_required()
def start_scan():
    """
    Endpoint unificado para iniciar escaneos.
    
    Body:
        {
            "target": "192.168.1.1",
            "scan_type": "comprehensive|quick|stealth|vuln|discovery|udp|detailed|custom",
            "tool": "nmap|masscan|rustscan",
            "workspace_id": 1,
            "ports": "22,80,443" (opcional)
        }
    """
    data = request.get_json() or {}
    current_user_id = get_jwt_identity()
    
    # Log para debugging
    logger.info(f"üì° POST /scanning/start - User: {current_user_id}, Data: {data}")
    
    # Validar campos requeridos
    target = data.get('target')
    workspace_id = data.get('workspace_id') or request.args.get('workspace_id', type=int)
    
    logger.info(f"üîç Validaci√≥n - target: {target}, workspace_id: {workspace_id}")
    
    if not target:
        logger.warning(f"‚ùå Target is required. Data received: {data}")
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        logger.warning(f"‚ùå workspace_id is required. Data received: {data}, Args: {request.args}")
        return jsonify({'error': 'workspace_id is required'}), 400
    
    # Par√°metros
    scan_type = data.get('scan_type', 'comprehensive')
    tool = data.get('tool', 'nmap')
    ports = data.get('ports')
    
    # Validar herramienta
    valid_tools = ['nmap', 'masscan', 'rustscan']
    if tool not in valid_tools:
        return jsonify({'error': f'Invalid tool. Must be one of: {valid_tools}'}), 400
    
    # Validar tipo de escaneo
    # Mapear tipos del frontend a tipos del backend
    scan_type_map = {
        'vulnerability': 'vuln',  # Frontend usa 'vulnerability', backend usa 'vuln'
        'network': 'discovery'    # Network scan usa discovery
    }
    
    # Si el tipo est√° en el mapa, usar el tipo mapeado
    if scan_type in scan_type_map:
        scan_type = scan_type_map[scan_type]
    
    valid_types = ['comprehensive', 'quick', 'stealth', 'vuln', 'discovery', 'udp', 'detailed', 'custom', 'service', 'os']
    if scan_type not in valid_types:
        return jsonify({'error': f'Invalid scan_type. Must be one of: {valid_types}'}), 400
    
    try:
        # Delegar al servicio correspondiente
        if tool == 'nmap' or tool == 'rustscan':
            result = scanning_service.start_nmap_scan(
                target=target,
                scan_type=scan_type,
                workspace_id=workspace_id,
                user_id=current_user_id,
                ports=ports
            )
        elif tool == 'masscan':
            result = scanning_service.start_masscan_scan(
                target=target,
                ports=ports or '1-65535',
                environment='internal',
                workspace_id=workspace_id,
                user_id=current_user_id
            )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in start_scan endpoint: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error', 'details': str(e)}), 500


@scanning_bp.route('/nmap/preview', methods=['POST'])
@jwt_required()
def preview_nmap_scan():
    """
    Preview del comando Nmap (sin ejecutar).
    
    Body:
        {
            "target": "192.168.1.1",
            "scan_type": "discovery|detailed|vuln|stealth|udp",
            "workspace_id": 1,
            "ports": "22,80,443" (opcional)
        }
    """
    data = request.get_json()
    
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    scan_type = data.get('scan_type', 'discovery')
    ports = data.get('ports')
    scripts = data.get('scripts')
    os_detection = data.get('os_detection', False)
    version_detection = data.get('version_detection', False)
    
    if not target:
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    
    try:
        result = scanning_service.preview_nmap_scan(
            target=target,
            scan_type=scan_type,
            workspace_id=workspace_id,
            ports=ports,
            scripts=scripts,
            os_detection=os_detection,
            version_detection=version_detection
        )
        
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_nmap_scan endpoint: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/nmap', methods=['POST'])
@jwt_required()
def nmap_scan():
    """
    Inicia un escaneo Nmap.
    
    Body:
        {
            "target": "192.168.1.1",
            "scan_type": "discovery|detailed|vuln|stealth|udp",
            "workspace_id": 1,
            "ports": "22,80,443" (opcional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    # Validar campos requeridos
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    
    if not target:
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        return jsonify({'error': 'workspace_id is required'}), 400
    
    # Par√°metros
    scan_type = data.get('scan_type', 'discovery')
    ports = data.get('ports')
    
    try:
        result = scanning_service.start_nmap_scan(
            target=target,
            scan_type=scan_type,
            workspace_id=workspace_id,
            user_id=current_user_id,
            ports=ports
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in nmap_scan endpoint: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/naabu/preview', methods=['POST'])
@jwt_required()
def preview_naabu():
    """Preview del comando Naabu."""
    data = request.get_json() or {}
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    top_ports = data.get('top_ports')
    rate = data.get('rate', 1000)
    verify = data.get('verify', True)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = scanning_service.preview_naabu(
            target=target,
            workspace_id=workspace_id,
            top_ports=top_ports,
            rate=rate,
            verify=verify
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_naabu: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/masscan', methods=['POST'])
@jwt_required()
def masscan_scan():
    """
    Inicia un escaneo Masscan.
    
    Body:
        {
            "target": "192.168.1.0/24",
            "ports": "1-65535",
            "environment": "internal|external|stealth",
            "workspace_id": 1
        }
    """
    logger.info(f"üì° POST /scanning/masscan - Iniciando escaneo")
    
    # Intentar obtener datos del body
    try:
        data = request.get_json() or {}
    except Exception as e:
        logger.error(f"‚ùå Error parseando JSON: {e}")
        data = {}
    
    try:
        current_user_id = get_jwt_identity()
    except Exception as e:
        logger.error(f"‚ùå Error obteniendo JWT identity: {e}")
        return jsonify({'error': 'Invalid or expired token'}), 401
    
    logger.info(f"üì° POST /scanning/masscan - User: {current_user_id}, Data: {data}")
    
    # Validar que haya datos
    if not data:
        logger.warning(f"‚ùå No data received in request body")
        return jsonify({'error': 'Request body is required'}), 400
    
    # Validar campos
    target = data.get('target')
    workspace_id = data.get('workspace_id') or request.args.get('workspace_id', type=int)
    
    logger.info(f"üîç Validaci√≥n Masscan - target: {target}, workspace_id: {workspace_id}, Data completa: {data}")
    
    if not target:
        logger.warning(f"‚ùå Target is required. Data received: {data}")
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        logger.warning(f"‚ùå workspace_id is required. Data received: {data}")
        return jsonify({'error': 'workspace_id is required'}), 400
    
    try:
        workspace_id = int(workspace_id)
    except (ValueError, TypeError):
        logger.warning(f"‚ùå Invalid workspace_id type. Received: {workspace_id}")
        return jsonify({'error': 'workspace_id must be a number'}), 400
    
    # Par√°metros (rate se ignora, se calcula desde environment)
    ports = data.get('ports', '1-65535')
    environment = data.get('environment', 'internal')
    
    # Validar environment
    valid_environments = ['internal', 'external', 'stealth', 'slow']
    if environment not in valid_environments:
        logger.warning(f"‚ùå Invalid environment: {environment}. Valid: {valid_environments}")
        return jsonify({'error': f'Invalid environment. Must be one of: {", ".join(valid_environments)}'}), 400
    
    try:
        logger.info(f"‚úÖ Llamando a start_masscan_scan con: target={target}, ports={ports}, environment={environment}, workspace_id={workspace_id}, user_id={current_user_id}")
        result = scanning_service.start_masscan_scan(
            target=target,
            ports=ports,
            environment=environment,
            workspace_id=workspace_id,
            user_id=current_user_id
        )
        logger.info(f"‚úÖ Masscan iniciado exitosamente: {result}")
        return jsonify(result), 201
        
    except ValueError as e:
        logger.error(f"‚ùå ValueError en masscan_scan: {e}", exc_info=True)
        return jsonify({'error': str(e), 'type': 'ValueError'}), 400
    except Exception as e:
        logger.error(f"‚ùå Exception en masscan_scan: {e}", exc_info=True)
        import traceback
        logger.error(f"Traceback: {traceback.format_exc()}")
        return jsonify({'error': 'Internal server error', 'details': str(e)}), 500


@scanning_bp.route('/scans', methods=['GET'])
@jwt_required()
def list_scans():
    """Lista todos los escaneos del usuario."""
    from models import Scan
    
    current_user_id = get_jwt_identity()
    
    # Filtros
    workspace_id = request.args.get('workspace_id', type=int)
    status = request.args.get('status')
    
    query = Scan.query.filter_by(user_id=current_user_id)
    
    if workspace_id:
        query = query.filter_by(workspace_id=workspace_id)
    
    if status:
        query = query.filter_by(status=status)
    
    scans = query.order_by(Scan.created_at.desc()).all()
    
    return jsonify({
        'scans': [{
            'id': scan.id,
            'scan_type': scan.scan_type,
            'target': scan.target,
            'status': scan.status,
            'progress': scan.progress,
            'started_at': scan.started_at.isoformat() if scan.started_at else None,
            'completed_at': scan.completed_at.isoformat() if scan.completed_at else None,
            'created_at': scan.created_at.isoformat() if scan.created_at else None
        } for scan in scans],
        'total': len(scans)
    }), 200


@scanning_bp.route('/sessions', methods=['GET', 'OPTIONS'])
def get_scan_sessions():
    """Lista sesiones de escaneo activas (alias para /scans)."""
    # Manejar preflight OPTIONS antes de requerir autenticaci√≥n
    if request.method == 'OPTIONS':
        return '', 204
    # Para GET, requerir autenticaci√≥n
    from flask_jwt_extended import verify_jwt_in_request
    verify_jwt_in_request()
    return list_scans()


@scanning_bp.route('/scans/<int:scan_id>', methods=['GET'])
@jwt_required()
def get_scan(scan_id):
    """Obtiene detalles de un escaneo."""
    try:
        result = scanning_service.get_scan_status(scan_id)
        return jsonify(result), 200
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 404
    except Exception as e:
        logger.error(f"Error in get_scan endpoint: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/rustscan/preview', methods=['POST'])
@jwt_required()
def preview_rustscan():
    """Preview del comando RustScan."""
    data = request.get_json() or {}
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    batch_size = data.get('batch_size', 4000)
    timeout = data.get('timeout', 1500)
    ulimit = data.get('ulimit', 5000)
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = scanning_service.preview_rustscan(
            target=target,
            workspace_id=workspace_id,
            batch_size=batch_size,
            timeout=timeout,
            ulimit=ulimit
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_rustscan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/masscan/preview', methods=['POST'])
@jwt_required()
def preview_masscan():
    """Preview del comando Masscan."""
    data = request.get_json() or {}
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    ports = data.get('ports', '1-65535')
    rate = data.get('rate', 1000)
    environment = data.get('environment', 'internal')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    try:
        result = scanning_service.preview_masscan(
            target=target,
            ports=ports,
            workspace_id=workspace_id,
            rate=rate,
            environment=environment
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_masscan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/rustscan', methods=['POST'])
@jwt_required()
def rustscan_scan():
    """
    Inicia un escaneo RustScan (ultra-r√°pido).
    
    Body:
        {
            "target": "192.168.1.1",
            "workspace_id": 1,
            "batch_size": 4000 (opcional),
            "timeout": 1500 (opcional),
            "ulimit": 5000 (opcional)
        }
    """
    data = request.get_json() or {}
    current_user_id = get_jwt_identity()
    
    # Log para debugging
    logger.info(f"üì° POST /scanning/rustscan - User: {current_user_id}, Data: {data}")
    
    # Validar campos requeridos
    target = data.get('target')
    workspace_id = data.get('workspace_id') or request.args.get('workspace_id', type=int)
    
    logger.info(f"üîç Validaci√≥n RustScan - target: {target}, workspace_id: {workspace_id}, Data completa: {data}")
    
    if not target:
        logger.warning(f"‚ùå Target is required. Data received: {data}")
        return jsonify({'error': 'Target is required'}), 400
    
    if not workspace_id:
        logger.warning(f"‚ùå workspace_id is required. Data received: {data}, Args: {request.args}")
        return jsonify({'error': 'workspace_id is required'}), 400
    
    # Asegurar que workspace_id sea un entero
    try:
        workspace_id = int(workspace_id)
    except (ValueError, TypeError):
        logger.warning(f"‚ùå workspace_id debe ser un n√∫mero. Recibido: {workspace_id}")
        return jsonify({'error': 'workspace_id must be a number'}), 400
    
    # Par√°metros opcionales
    batch_size = data.get('batch_size', 4000)
    timeout = data.get('timeout', 1500)
    ulimit = data.get('ulimit', 5000)
    
    try:
        result = scanning_service.start_rustscan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            batch_size=batch_size,
            timeout=timeout,
            ulimit=ulimit
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        logger.error(f"ValueError in rustscan_scan: {e}", exc_info=True)
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in rustscan_scan: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error', 'details': str(e)}), 500


@scanning_bp.route('/naabu', methods=['POST'])
@jwt_required()
def naabu_scan():
    """
    Inicia un escaneo Naabu (port discovery r√°pido).
    
    Body:
        {
            "target": "192.168.1.1",
            "workspace_id": 1,
            "top_ports": 100 (opcional: 100, 1000, etc),
            "rate": 1000 (opcional),
            "verify": true (opcional)
        }
    """
    data = request.get_json()
    current_user_id = get_jwt_identity()
    
    # Validar campos requeridos
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    
    if not target or not workspace_id:
        return jsonify({'error': 'Target and workspace_id are required'}), 400
    
    # Par√°metros opcionales
    top_ports = data.get('top_ports')
    rate = data.get('rate', 1000)
    verify = data.get('verify', True)
    
    try:
        result = scanning_service.start_naabu(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            top_ports=top_ports,
            rate=rate,
            verify=verify
        )
        
        return jsonify(result), 201
        
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in naabu_scan: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/scans/<int:scan_id>/results', methods=['GET'])
@jwt_required()
def get_scan_results(scan_id):
    """Obtiene resultados parseados de un escaneo."""
    try:
        result = scanning_service.parse_nmap_results(scan_id)
        return jsonify(result), 200
        
    except Exception as e:
        logger.error(f"Error parsing results: {e}")
        return jsonify({'error': 'Error parsing results'}), 500


# ============================================
# ENUMERACI√ìN SMB/CIFS
# ============================================

@scanning_bp.route('/enum/smb/enum4linux', methods=['POST'])
@jwt_required()
def enum4linux_scan():
    """Enumeraci√≥n SMB con enum4linux."""
    try:
        data = request.get_json()
        logger.info(f"[enum4linux] Request data: {data}")
        
        target = data.get('target')
        workspace_id = data.get('workspace_id')
        current_user_id = get_jwt_identity()
        
        logger.info(f"[enum4linux] target={target}, workspace_id={workspace_id}, user_id={current_user_id}")
        
        if not target or not workspace_id:
            logger.warning(f"[enum4linux] Missing required fields: target={target}, workspace_id={workspace_id}")
            return jsonify({'error': 'target and workspace_id required'}), 400
        
        result = scanning_service.start_enum4linux(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            use_ng=data.get('use_ng', True),
            all=data.get('all', False)
        )
        logger.info(f"[enum4linux] Success: {result}")
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"[enum4linux] Error: {e}", exc_info=True)
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/smb/smbmap', methods=['POST'])
@jwt_required()
def smbmap_scan():
    """Enumeraci√≥n SMB con smbmap."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_smbmap(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            username=data.get('username'),
            password=data.get('password'),
            share=data.get('share')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in smbmap: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/smb/smbclient', methods=['POST'])
@jwt_required()
def smbclient_scan():
    """Enumeraci√≥n SMB con smbclient."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_smbclient(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            share=data.get('share', 'IPC$'),
            username=data.get('username'),
            password=data.get('password')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in smbclient: {e}")
        return jsonify({'error': str(e)}), 500


# ============================================
# ENUMERACI√ìN SERVICIOS DE RED
# ============================================

@scanning_bp.route('/enum/ssh', methods=['POST'])
@jwt_required()
def ssh_enum():
    """Enumeraci√≥n SSH."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_ssh_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 22),
            tool=data.get('tool', 'nmap')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in SSH enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/ftp', methods=['POST'])
@jwt_required()
def ftp_enum():
    """Enumeraci√≥n FTP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        port = data.get('port', 21)
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.start_ftp_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=port
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in FTP enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/smtp', methods=['POST'])
@jwt_required()
def smtp_enum():
    """Enumeraci√≥n SMTP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_smtp_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 25),
            tool=data.get('tool', 'nmap')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in SMTP enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/dns', methods=['POST'])
@jwt_required()
def dns_enum():
    """Enumeraci√≥n DNS."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        port = data.get('port', 53)
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.start_dns_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            domain=data.get('domain'),
            port=port,
            tool=data.get('tool', 'nmap')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in DNS enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/snmp', methods=['POST'])
@jwt_required()
def snmp_enum():
    """Enumeraci√≥n SNMP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_snmp_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 161),
            community=data.get('community', 'public')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in SNMP enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/ldap', methods=['POST'])
@jwt_required()
def ldap_enum():
    """Enumeraci√≥n LDAP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_ldap_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 389),
            tool=data.get('tool', 'nmap')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in LDAP enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/rdp', methods=['POST'])
@jwt_required()
def rdp_enum():
    """Enumeraci√≥n RDP."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        port = data.get('port', 3389)
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.start_rdp_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=port
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in RDP enum: {e}")
        return jsonify({'error': str(e)}), 500


# ============================================
# ENUMERACI√ìN BASES DE DATOS
# ============================================

@scanning_bp.route('/enum/mysql', methods=['POST'])
@jwt_required()
def mysql_enum():
    """Enumeraci√≥n MySQL."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_mysql_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 3306),
            tool=data.get('tool', 'nmap'),
            username=data.get('username')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in MySQL enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/postgresql', methods=['POST'])
@jwt_required()
def postgresql_enum():
    """Enumeraci√≥n PostgreSQL."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_postgresql_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 5432),
            tool=data.get('tool', 'nmap'),
            username=data.get('username', 'postgres')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in PostgreSQL enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/redis', methods=['POST'])
@jwt_required()
def redis_enum():
    """Enumeraci√≥n Redis."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_redis_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 6379),
            tool=data.get('tool', 'nmap')
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in Redis enum: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/mongodb', methods=['POST'])
@jwt_required()
def mongodb_enum():
    """Enumeraci√≥n MongoDB."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_mongodb_enum(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 27017)
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in MongoDB enum: {e}")
        return jsonify({'error': str(e)}), 500


# ============================================
# AN√ÅLISIS SSL/TLS
# ============================================

@scanning_bp.route('/enum/ssl/sslscan', methods=['POST'])
@jwt_required()
def sslscan_analysis():
    """An√°lisis SSL con sslscan."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_sslscan(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 443),
            show_certificate=data.get('show_certificate', False)
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in sslscan: {e}")
        return jsonify({'error': str(e)}), 500


@scanning_bp.route('/enum/ssl/sslyze', methods=['POST'])
@jwt_required()
def sslyze_analysis():
    """An√°lisis SSL/TLS con sslyze."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    current_user_id = get_jwt_identity()
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.start_sslyze(
            target=target,
            workspace_id=workspace_id,
            user_id=current_user_id,
            port=data.get('port', 443),
            regular=data.get('regular', True)
        )
        return jsonify(result), 201
    except Exception as e:
        logger.error(f"Error in sslyze: {e}")
        return jsonify({'error': str(e)}), 500


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# PREVIEW ENDPOINTS - ENUMERATION

@scanning_bp.route('/enum/smb/enum4linux/preview', methods=['POST'])
@jwt_required()
def preview_enum4linux():
    """Preview del comando enum4linux."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.preview_enum4linux(
            target=target,
            workspace_id=workspace_id,
            use_ng=data.get('use_ng', True),
            all=data.get('all', False)
        )
        return jsonify(result), 200
    except Exception as e:
        logger.error(f"Error in preview_enum4linux: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/enum/smb/smbmap/preview', methods=['POST'])
@jwt_required()
def preview_smbmap():
    """Preview del comando smbmap."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.preview_smbmap(
            target=target,
            workspace_id=workspace_id,
            username=data.get('username'),
            password=data.get('password'),
            hash=data.get('hash'),
            recursive=data.get('recursive', False),
            share=data.get('share')
        )
        return jsonify(result), 200
    except Exception as e:
        logger.error(f"Error in preview_smbmap: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/enum/smb/smbclient/preview', methods=['POST'])
@jwt_required()
def preview_smbclient():
    """Preview del comando smbclient."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    share = data.get('share', 'IPC$')
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        result = scanning_service.preview_smbclient(
            target=target,
            workspace_id=workspace_id,
            share=share,
            username=data.get('username'),
            password=data.get('password'),
            command=data.get('command')
        )
        return jsonify(result), 200
    except Exception as e:
        logger.error(f"Error in preview_smbclient: {e}")
        return jsonify({'error': 'Internal server error'}), 500

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

@scanning_bp.route('/enum/ftp/preview', methods=['POST'])
@jwt_required()
def preview_ftp_enum():
    """Preview del comando FTP enum."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    port = data.get('port', 21)
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.preview_ftp_enum(
            target=target,
            workspace_id=workspace_id,
            port=port
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_ftp_enum: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/enum/dns/preview', methods=['POST'])
@jwt_required()
def preview_dns_enum():
    """Preview del comando DNS enum."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    domain = data.get('domain')
    tool = data.get('tool', 'nmap')
    port = data.get('port', 53)
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.preview_dns_enum(
            target=target,
            workspace_id=workspace_id,
            domain=domain,
            tool=tool,
            port=port
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_dns_enum: {e}")
        return jsonify({'error': 'Internal server error'}), 500


@scanning_bp.route('/enum/rdp/preview', methods=['POST'])
@jwt_required()
def preview_rdp_enum():
    """Preview del comando RDP enum."""
    data = request.get_json()
    target = data.get('target')
    workspace_id = data.get('workspace_id')
    port = data.get('port', 3389)
    
    if not target or not workspace_id:
        return jsonify({'error': 'target and workspace_id required'}), 400
    
    try:
        if isinstance(port, str):
            port = int(port)
        result = scanning_service.preview_rdp_enum(
            target=target,
            workspace_id=workspace_id,
            port=port
        )
        return jsonify(result), 200
    except ValueError as e:
        return jsonify({'error': str(e)}), 400
    except Exception as e:
        logger.error(f"Error in preview_rdp_enum: {e}")
        return jsonify({'error': 'Internal server error'}), 500

