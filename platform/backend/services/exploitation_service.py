"""
Exploitation Service (Main)
============================

Servicio principal de explotación que orquesta los módulos modulares.
Delega a servicios especializados por categoría.
"""

import logging
from typing import Dict, Any, Optional
from pathlib import Path

from repositories import ScanRepository
from services.exploitation import (
    HydraService,
    HashCrackingService,
    NetworkExploitationService,
    ImpacketExecutionService,
    ImpacketDumpingService,
    RemoteAccessService,
    PayloadsService
)

logger = logging.getLogger(__name__)


class ExploitationService:
    """
    Servicio principal de explotación.
    
    Delega a servicios modulares especializados:
    - HydraService: Hydra (brute force)
    - HashCrackingService: John, Hashcat, Kerbrute
    - NetworkExploitationService: CrackMapExec, Responder
    - ImpacketExecutionService: psexec, wmiexec, smbexec
    - ImpacketDumpingService: secretsdump, GetUserSPNs, GetNPUsers
    - RemoteAccessService: Evil-WinRM
    - PayloadsService: Metasploit/msfvenom
    """
    
    def __init__(self, scan_repository: ScanRepository = None):
        """Inicializa el servicio y sus submódulos."""
        self.scan_repo = scan_repository or ScanRepository()
        from utils.workspace_filesystem import PROJECT_TMP_DIR
        output_dir = PROJECT_TMP_DIR / 'exploitation'
        
        # Inicializar servicios modulares
        self.hydra = HydraService(self.scan_repo, output_dir)
        self.hash_cracking = HashCrackingService(self.scan_repo, output_dir)
        self.network_exploitation = NetworkExploitationService(self.scan_repo, output_dir)
        self.impacket_execution = ImpacketExecutionService(self.scan_repo, output_dir)
        self.impacket_dumping = ImpacketDumpingService(self.scan_repo, output_dir)
        self.remote_access = RemoteAccessService(self.scan_repo, output_dir)
        self.payloads = PayloadsService(self.scan_repo, output_dir)
    
    # ============================================
    # HYDRA - Delegación
    # ============================================
    
    def start_hydra_attack(
        self,
        target: str,
        service: str,
        workspace_id: int,
        user_id: int,
        username: Optional[str] = None,
        userfile: Optional[str] = None,
        password: Optional[str] = None,
        passfile: Optional[str] = None,
        port: Optional[int] = None,
        threads: int = 16
    ) -> Dict[str, Any]:
        """Delega a HydraService."""
        return self.hydra.start_hydra_attack(
            target, service, workspace_id, user_id,
            username, userfile, password, passfile, port, threads
        )
    
    # ============================================
    # HASH CRACKING - Delegación
    # ============================================
    
    def start_john(
        self,
        hash_file: str,
        workspace_id: int,
        user_id: int,
        wordlist: Optional[str] = None,
        format: Optional[str] = None,
        rules: bool = False
    ) -> Dict[str, Any]:
        """Delega a HashCrackingService."""
        return self.hash_cracking.start_john(
            hash_file, workspace_id, user_id, wordlist, format, rules
        )
    
    def start_hashcat(
        self,
        hash_file: str,
        workspace_id: int,
        user_id: int,
        mode: int,
        wordlist: str,
        rules_file: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a HashCrackingService."""
        return self.hash_cracking.start_hashcat(
            hash_file, workspace_id, user_id, mode, wordlist, rules_file
        )
    
    def start_kerbrute(
        self,
        domain: str,
        workspace_id: int,
        user_id: int,
        mode: str,
        users_file: Optional[str] = None,
        passwords_file: Optional[str] = None,
        password: Optional[str] = None,
        dc_ip: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a HashCrackingService."""
        return self.hash_cracking.start_kerbrute(
            domain, workspace_id, user_id, mode,
            users_file, passwords_file, password, dc_ip
        )
    
    # ============================================
    # NETWORK EXPLOITATION - Delegación
    # ============================================
    
    def start_crackmapexec_scan(
        self,
        targets: str,
        protocol: str,
        workspace_id: int,
        user_id: int,
        username: Optional[str] = None,
        password: Optional[str] = None,
        hash: Optional[str] = None,
        domain: Optional[str] = None,
        command: Optional[str] = None,
        shares: bool = False,
        pass_pol: bool = False
    ) -> Dict[str, Any]:
        """Delega a NetworkExploitationService."""
        return self.network_exploitation.start_crackmapexec_scan(
            targets, protocol, workspace_id, user_id,
            username, password, hash, domain, command, shares, pass_pol
        )
    
    def start_responder(
        self,
        interface: str,
        workspace_id: int,
        user_id: int,
        lm: bool = False
    ) -> Dict[str, Any]:
        """Delega a NetworkExploitationService."""
        return self.network_exploitation.start_responder(
            interface, workspace_id, user_id, lm
        )
    
    # ============================================
    # IMPACKET SUITE - Delegación
    # ============================================
    
    def start_impacket_psexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a ImpacketExecutionService."""
        return self.impacket_execution.start_psexec(
            target, username, password, workspace_id, user_id,
            domain, hash, command
        )
    
    def start_impacket_wmiexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a ImpacketExecutionService."""
        return self.impacket_execution.start_wmiexec(
            target, username, password, workspace_id, user_id,
            domain, hash, command
        )
    
    def start_impacket_smbexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a ImpacketExecutionService."""
        return self.impacket_execution.start_smbexec(
            target, username, password, workspace_id, user_id,
            domain, hash, command
        )
    
    def start_impacket_secretsdump(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        just_dc: bool = False
    ) -> Dict[str, Any]:
        """Delega a ImpacketDumpingService."""
        return self.impacket_dumping.start_secretsdump(
            target, username, password, workspace_id, user_id,
            domain, hash, just_dc
        )
    
    def start_impacket_getuserspns(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        domain: str,
        dc_ip: Optional[str] = None,
        request: bool = True
    ) -> Dict[str, Any]:
        """Delega a ImpacketDumpingService."""
        return self.impacket_dumping.start_getuserspns(
            target, username, password, workspace_id, user_id,
            domain, dc_ip, request
        )
    
    def start_impacket_getnpusers(
        self,
        domain: str,
        workspace_id: int,
        user_id: int,
        users_file: Optional[str] = None,
        username: Optional[str] = None,
        dc_ip: Optional[str] = None,
        no_pass: bool = True
    ) -> Dict[str, Any]:
        """Delega a ImpacketDumpingService."""
        return self.impacket_dumping.start_getnpusers(
            domain, workspace_id, user_id,
            users_file, username, dc_ip, no_pass
        )
    
    # ============================================
    # REMOTE ACCESS - Delegación
    # ============================================
    
    def start_evilwinrm(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        hash: Optional[str] = None,
        ssl: bool = False
    ) -> Dict[str, Any]:
        """Delega a RemoteAccessService."""
        return self.remote_access.start_evilwinrm(
            target, username, password, workspace_id, user_id,
            hash, ssl
        )
    
    # ============================================
    # PAYLOADS - Delegación
    # ============================================
    
    def start_metasploit_payload(
        self,
        payload_type: str,
        lhost: str,
        lport: int,
        workspace_id: int,
        user_id: int,
        format: str = 'exe',
        encoder: Optional[str] = None,
        iterations: int = 0,
        output_file: Optional[str] = None
    ) -> Dict[str, Any]:
        """Delega a PayloadsService."""
        return self.payloads.generate_msfvenom_payload(
            payload_type, lhost, lport, workspace_id, user_id,
            format, encoder, iterations, output_file
        )
    
    def start_metasploit_handler(
        self,
        payload: str,
        lhost: str,
        lport: int,
        workspace_id: int,
        user_id: int,
        exit_on_session: bool = False
    ) -> Dict[str, Any]:
        """Delega a PayloadsService para iniciar Metasploit Handler."""
        return self.payloads.start_metasploit_handler(
            payload, lhost, lport, workspace_id, user_id, exit_on_session
        )

    def preview_hydra_attack(
        self,
        target: str,
        service: str,
        workspace_id: int,
        username: Optional[str] = None,
        userfile: Optional[str] = None,
        password: Optional[str] = None,
        passfile: Optional[str] = None,
        port: Optional[int] = None,
        threads: int = 16
    ) -> Dict[str, Any]:
        """Preview de Hydra attack."""
        return self.hydra.preview_hydra_attack(
            target, service, workspace_id,
            username, userfile, password, passfile, port, threads
        )

    # ============================================
    # PREVIEW METHODS - Delegación
    # ============================================
    
    def preview_john(
        self,
        hash_file: str,
        workspace_id: int,
        wordlist: Optional[str] = None,
        format: Optional[str] = None,
        rules: bool = False
    ) -> Dict[str, Any]:
        """Preview de John the Ripper."""
        return self.hash_cracking.preview_john(
            hash_file, workspace_id, wordlist, format, rules
        )
    
    def preview_hashcat(
        self,
        hash_file: str,
        workspace_id: int,
        mode: int,
        wordlist: str,
        rules_file: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview de Hashcat."""
        return self.hash_cracking.preview_hashcat(
            hash_file, workspace_id, mode, wordlist, rules_file
        )
    
    def preview_kerbrute(
        self,
        domain: str,
        workspace_id: int,
        mode: str,
        users_file: Optional[str] = None,
        passwords_file: Optional[str] = None,
        password: Optional[str] = None,
        dc_ip: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview de Kerbrute."""
        return self.hash_cracking.preview_kerbrute(
            domain, workspace_id, mode, users_file, passwords_file, password, dc_ip
        )
    
    def preview_crackmapexec_scan(
        self,
        targets: str,
        protocol: str,
        workspace_id: int,
        username: Optional[str] = None,
        password: Optional[str] = None,
        hash: Optional[str] = None,
        domain: Optional[str] = None,
        command: Optional[str] = None,
        shares: bool = False,
        pass_pol: bool = False
    ) -> Dict[str, Any]:
        """Preview de CrackMapExec."""
        return self.network_exploitation.preview_crackmapexec_scan(
            targets, protocol, workspace_id,
            username, password, hash, domain, command, shares, pass_pol
        )
    
    def preview_responder(
        self,
        interface: str,
        workspace_id: int,
        lm: bool = False
    ) -> Dict[str, Any]:
        """Preview de Responder."""
        return self.network_exploitation.preview_responder(
            interface, workspace_id, lm
        )
    
    def preview_impacket_psexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview de psexec."""
        return self.impacket_execution.preview_psexec(
            target, username, password, workspace_id, domain, hash, command
        )
    
    def preview_impacket_wmiexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview de wmiexec."""
        return self.impacket_execution.preview_wmiexec(
            target, username, password, workspace_id, domain, hash, command
        )
    
    def preview_impacket_smbexec(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        command: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview de smbexec."""
        return self.impacket_execution.preview_smbexec(
            target, username, password, workspace_id, domain, hash, command
        )
    
    def preview_impacket_secretsdump(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: Optional[str] = None,
        hash: Optional[str] = None,
        just_dc: bool = False
    ) -> Dict[str, Any]:
        """Preview de secretsdump."""
        return self.impacket_dumping.preview_secretsdump(
            target, username, password, workspace_id, domain, hash, just_dc
        )
    
    def preview_impacket_getuserspns(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        domain: str,
        hash: Optional[str] = None,
        request: bool = True
    ) -> Dict[str, Any]:
        """Preview de GetUserSPNs."""
        return self.impacket_dumping.preview_getuserspns(
            target, username, password, workspace_id, domain, hash, request
        )
    
    def preview_impacket_getnpusers(
        self,
        target: str,
        workspace_id: int,
        domain: str,
        users_file: Optional[str] = None,
        no_pass: bool = True
    ) -> Dict[str, Any]:
        """Preview de GetNPUsers."""
        return self.impacket_dumping.preview_getnpusers(
            target, workspace_id, domain, users_file, no_pass
        )
    
    def preview_evilwinrm(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        hash: Optional[str] = None,
        ssl: bool = False
    ) -> Dict[str, Any]:
        """Preview de Evil-WinRM."""
        return self.remote_access.preview_evilwinrm(
            target, username, password, workspace_id, hash, ssl
        )
    
    def preview_msfvenom_payload(
        self,
        payload_type: str,
        lhost: str,
        lport: int,
        workspace_id: int,
        format: str = 'exe',
        encoder: Optional[str] = None,
        iterations: int = 0
    ) -> Dict[str, Any]:
        """Preview de msfvenom."""
        return self.payloads.preview_msfvenom_payload(
            payload_type, lhost, lport, workspace_id, format, encoder, iterations
        )
    
    def preview_metasploit_handler(
        self,
        payload: str,
        lhost: str,
        lport: int,
        workspace_id: int,
        exit_on_session: bool = False
    ) -> Dict[str, Any]:
        """Preview de Metasploit Handler."""
        return self.payloads.preview_metasploit_handler(
            payload, lhost, lport, workspace_id, exit_on_session
        )
