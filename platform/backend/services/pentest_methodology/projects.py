"""
Projects Management
==================

Gestión de proyectos de pentesting.
"""

import logging
from datetime import datetime
from typing import Dict, List, Optional, Any
from uuid import uuid4

from utils.workspace_filesystem import PROJECT_TMP_DIR

logger = logging.getLogger(__name__)


class ProjectsManager:
    """Gestor de proyectos de pentesting"""
    
    def __init__(self):
        """Inicializar gestor de proyectos"""
        self.projects = {}  # En memoria por ahora, migrar a BD después
    
    def create_project(self, project_data: Dict[str, Any], methodology: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Crear nuevo proyecto de pentest"""
        project_id = str(uuid4())
        
        project = {
            "id": project_id,
            "name": project_data.get("name", f"Project {project_id[:8]}"),
            "methodology": project_data.get("methodology", "black_box"),
            "target": project_data["target"],
            "workspace_id": project_data.get("workspace_id", 1),
            "scope": project_data.get("scope", []),
            "client": project_data.get("client", ""),
            "start_date": project_data.get("start_date", datetime.now().isoformat()),
            "end_date": project_data.get("end_date"),
            "status": "planning",
            "phases_completed": [],
            "findings": [],
            "team_members": project_data.get("team_members", []),
            "objectives": project_data.get("objectives", []),
            "created_at": datetime.now().isoformat(),
            "created_by": project_data.get("created_by", "admin"),
            "updated_at": datetime.now().isoformat()
        }

        if methodology:
            project["methodology_details"] = methodology

        self.projects[project_id] = project
        logger.info(f"Proyecto creado: {project_id} - {project['name']}")
        
        return {
            "success": True,
            "message": "Proyecto creado exitosamente",
            "project": project
        }
    
    def get_project(self, project_id: str, methodology: Optional[Dict[str, Any]] = None) -> Optional[Dict[str, Any]]:
        """Obtener proyecto específico"""
        logger.info(f"Obteniendo proyecto: {project_id}")
        project = self.projects.get(project_id)
        
        if project and "methodology_details" not in project and methodology:
            project["methodology_details"] = methodology
        
        return project
    
    def list_projects(self) -> List[Dict[str, Any]]:
        """Listar todos los proyectos"""
        logger.info(f"Listando proyectos: {len(self.projects)} encontrados")
        return list(self.projects.values())
    
    def update_project_status(
        self, 
        project_id: str, 
        status: str, 
        phase_completed: Optional[str] = None
    ) -> Dict[str, Any]:
        """Actualizar estado del proyecto"""
        project = self.projects.get(project_id)
        if not project:
            return {
                "success": False,
                "message": "Proyecto no encontrado"
            }

        project["status"] = status
        project["updated_at"] = datetime.now().isoformat()

        if phase_completed and phase_completed not in project["phases_completed"]:
            project["phases_completed"].append(phase_completed)

        logger.info(f"Proyecto actualizado: {project_id} - Estado: {status}")
        
        return {
            "success": True,
            "message": "Proyecto actualizado exitosamente",
            "project": project
        }
    
    def add_finding(
        self, 
        project_id: str, 
        finding_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Agregar hallazgo a proyecto"""
        project = self.projects.get(project_id)
        if not project:
            return {
                "success": False,
                "message": "Proyecto no encontrado"
            }

        finding_id = str(uuid4())
        finding = {
            "id": finding_id,
            "title": finding_data["title"],
            "description": finding_data["description"],
            "severity": finding_data.get("severity", "medium"),
            "category": finding_data.get("category", ""),
            "phase": finding_data.get("phase", ""),
            "remediation": finding_data.get("remediation", ""),
            "tags": finding_data.get("tags", []),
            "created_at": datetime.now().isoformat(),
            "created_by": finding_data.get("created_by", "admin")
        }

        project["findings"].append(finding)
        project["updated_at"] = datetime.now().isoformat()

        logger.info(f"Hallazgo agregado al proyecto {project_id}: {finding['title']}")
        
        return {
            "success": True,
            "message": "Hallazgo agregado exitosamente",
            "finding": finding
        }
    
    def get_dashboard_stats(self) -> Dict[str, Any]:
        """Obtener estadísticas del dashboard"""
        total_projects = len(self.projects)
        active_projects = sum(1 for p in self.projects.values() if p["status"] == "active")
        completed_projects = sum(1 for p in self.projects.values() if p["status"] == "completed")
        
        methodology_distribution = {}
        for project in self.projects.values():
            methodology = project["methodology"]
            methodology_distribution[methodology] = methodology_distribution.get(methodology, 0) + 1

        recent_projects = sorted(
            self.projects.values(),
            key=lambda x: x["created_at"],
            reverse=True
        )[:5]

        logger.info("Obteniendo estadísticas del dashboard")
        
        return {
            "total_projects": total_projects,
            "active_projects": active_projects,
            "completed_projects": completed_projects,
            "methodology_distribution": methodology_distribution,
            "recent_projects": recent_projects
        }
    
    def preview_project(self, project_data: Dict[str, Any], methodology: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """Preview de creación de proyecto (sin crear)"""
        methodology_id = project_data.get("methodology", "black_box")
        methodology_name = methodology.get("name", methodology_id) if methodology else methodology_id
        
        command_parts = ['pentest-cli', 'create-project']
        command_parts.extend(['--methodology', methodology_id])
        command_parts.extend(['--target', project_data.get("target", "")])
        
        if project_data.get("name"):
            command_parts.extend(['--name', project_data.get("name")])
        if project_data.get("client"):
            command_parts.extend(['--client', project_data.get("client")])
        if project_data.get("scope"):
            command_parts.extend(['--scope', ','.join(project_data.get("scope", []))])
        
        command_str = ' '.join(command_parts)
        
        return {
            'command': command_parts,
            'command_string': command_str,
            'parameters': {
                'methodology': methodology_id,
                'methodology_name': methodology_name,
                'target': project_data.get("target"),
                'name': project_data.get("name"),
                'client': project_data.get("client"),
                'scope': project_data.get("scope", [])
            },
            'estimated_timeout': 5,
            'output_file': str(PROJECT_TMP_DIR / f'pentest_project_preview_{project_data.get("target", "unknown")}.log'),
            'warnings': [
                'Este es solo un preview, el proyecto no se creará hasta confirmar.',
                'Asegúrate de tener los permisos necesarios para crear proyectos.'
            ],
            'suggestions': [
                'Revisa la metodología seleccionada antes de crear el proyecto.',
                'Verifica que el target sea accesible y esté dentro del alcance autorizado.'
            ]
        }


