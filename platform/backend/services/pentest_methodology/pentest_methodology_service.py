"""
Pentest Methodology Service
============================

Servicio principal para gestión de metodologías de pentesting.
"""

import logging
from typing import Dict, List, Optional, Any

from .methodologies import get_methodologies
from .workflows import get_workflow
from .projects import ProjectsManager

logger = logging.getLogger(__name__)


class PentestMethodologyService:
    """Servicio para gestión de metodologías de pentesting"""

    def __init__(self):
        """Inicializar servicio de metodologías"""
        self.methodologies = get_methodologies()
        self.projects_manager = ProjectsManager()

    def get_all_methodologies(self) -> Dict[str, Dict[str, Any]]:
        """Obtener todas las metodologías disponibles"""
        logger.info("Obteniendo todas las metodologías")
        return self.methodologies

    def get_methodology(self, methodology_id: str) -> Optional[Dict[str, Any]]:
        """Obtener una metodología específica"""
        logger.info(f"Obteniendo metodología: {methodology_id}")
        return self.methodologies.get(methodology_id)

    def get_methodology_workflow(self, methodology_id: str) -> Optional[Dict[str, Any]]:
        """Obtener workflow detallado de una metodología"""
        logger.info(f"Obteniendo workflow para: {methodology_id}")
        
        methodology = self.methodologies.get(methodology_id)
        if not methodology:
            return None

        return get_workflow(methodology_id, methodology)

    def create_project(self, project_data: Dict[str, Any]) -> Dict[str, Any]:
        """Crear nuevo proyecto de pentest"""
        methodology = self.methodologies.get(project_data.get("methodology", "black_box"))
        return self.projects_manager.create_project(project_data, methodology)
    
    def preview_project(self, project_data: Dict[str, Any]) -> Dict[str, Any]:
        """Preview de creación de proyecto (sin crear)"""
        methodology = self.methodologies.get(project_data.get("methodology", "black_box"))
        return self.projects_manager.preview_project(project_data, methodology)

    def get_project(self, project_id: str) -> Optional[Dict[str, Any]]:
        """Obtener proyecto específico"""
        project = self.projects_manager.get_project(project_id)
        if project and "methodology_details" not in project:
            methodology = self.methodologies.get(project["methodology"])
            return self.projects_manager.get_project(project_id, methodology)
        return project

    def list_projects(self) -> List[Dict[str, Any]]:
        """Listar todos los proyectos"""
        return self.projects_manager.list_projects()

    def update_project_status(
        self, 
        project_id: str, 
        status: str, 
        phase_completed: Optional[str] = None
    ) -> Dict[str, Any]:
        """Actualizar estado del proyecto"""
        return self.projects_manager.update_project_status(project_id, status, phase_completed)

    def add_finding(
        self, 
        project_id: str, 
        finding_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Agregar hallazgo a proyecto"""
        return self.projects_manager.add_finding(project_id, finding_data)

    def get_dashboard_stats(self) -> Dict[str, Any]:
        """Obtener estadísticas del dashboard"""
        return self.projects_manager.get_dashboard_stats()


# Instancia singleton
_pentest_service_instance = None


def get_pentest_methodology_service() -> PentestMethodologyService:
    """Obtener instancia del servicio"""
    global _pentest_service_instance
    if _pentest_service_instance is None:
        _pentest_service_instance = PentestMethodologyService()
    return _pentest_service_instance


