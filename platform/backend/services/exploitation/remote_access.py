"""
Remote Access Service
=====================

Servicios para acceso remoto:
- Evil-WinRM (Windows remote management)
"""

import logging
from typing import Dict, Any, Optional

from utils.validators import CommandSanitizer, IPValidator
from .base import BaseExploitationService

logger = logging.getLogger(__name__)


class RemoteAccessService(BaseExploitationService):
    """Servicio para acceso remoto."""
    
    def start_evilwinrm(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        user_id: int,
        hash: Optional[str] = None,
        ssl: bool = False
    ) -> Dict[str, Any]:
        """
        Conecta con Evil-WinRM.
        
        Args:
            target: IP objetivo
            username: Usuario
            password: Password
            workspace_id: ID del workspace
            user_id: ID del usuario
            hash: NTLM hash
            ssl: Usar SSL
        """
        IPValidator.validate(target)
        
        scan = self._create_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='evil-winrm',
            options={
                'username': username,
                'ssl': ssl
            }
        )
        
        try:
            output_file = str(self.output_dir / f'evilwinrm_{scan.id}.txt')
            
            command_list = [
                'evil-winrm',
                '-i', target,
                '-u', username
            ]
            
            if password:
                command_list.extend(['-p', password])
            elif hash:
                command_list.extend(['-H', hash])
            
            if ssl:
                command_list.append('-S')
            
            command_list.extend(['>', output_file, '2>&1'])
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command_list[0], command_list[1:])
            
            logger.info(f"Starting Evil-WinRM {scan.id}")
            
            self._start_scan_thread(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='evilwinrm'
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'evil-winrm',
                'target': target
            }
            
        except Exception as e:
            logger.error(f"Error starting Evil-WinRM: {e}")
            self.scan_repo.update_status(scan, 'failed', str(e))
            raise


    def preview_evilwinrm(
        self,
        target: str,
        username: str,
        password: str,
        workspace_id: int,
        hash: Optional[str] = None,
        ssl: bool = False
    ) -> Dict[str, Any]:
        """Preview del comando Evil-WinRM."""
        output_file = f'/workspaces/workspace_{workspace_id}/exploitation/evilwinrm_{{scan_id}}.txt'
        
        command_list = [
            'evil-winrm',
            '-i', target,
            '-u', username
        ]
        
        if password:
            command_list.extend(['-p', '***'])
        elif hash:
            command_list.extend(['-H', hash])
        
        if ssl:
            command_list.append('-S')
        
        command_list.extend(['>', output_file, '2>&1'])
        command_str = ' '.join([str(c) for c in command_list])
        
        warnings = []
        warnings.append('Evil-WinRM requiere sesi√≥n interactiva, puede requerir comandos manuales')
        
        return {
            'command': command_list,
            'command_string': command_str,
            'parameters': {
                'tool': 'evil-winrm',
                'target': target,
                'username': username,
                'password': '***' if password else None,
                'hash': hash,
                'ssl': ssl
            },
            'estimated_timeout': 3600,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': []
        }
