"""
Nuclei Scanner
==============

Scanner de vulnerabilidades usando Nuclei (5000+ templates).
"""

import logging
from typing import Dict, Any, List, Optional
from pathlib import Path

from utils.validators import CommandSanitizer, DomainValidator
from utils.workspace_logger import log_to_workspace
from ..base import BaseVulnerabilityScanner
from ..executors.scan_executor import ScanExecutor

logger = logging.getLogger(__name__)


class NucleiScanner(BaseVulnerabilityScanner):
    """Scanner de vulnerabilidades con Nuclei."""
    
    def __init__(self, scan_repository=None, vuln_repository=None):
        """Inicializa el scanner de Nuclei."""
        super().__init__(scan_repository, vuln_repository)
        self.executor = ScanExecutor(scan_repository)
    
    def start_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None,
        templates: Optional[str] = None,
        rate_limit: int = 150
    ) -> Dict[str, Any]:
        """
        Inicia scan con Nuclei.
        
        Args:
            target: URL o lista de URLs
            workspace_id: ID del workspace
            user_id: ID del usuario
            severity: Lista de severidades (critical, high, medium, low, info)
            tags: Tags de templates (cve, owasp, tech, etc)
            templates: Path a templates específicos
            rate_limit: Requests por segundo
        
        Returns:
            Dict con información del scan iniciado
        """
        # Validar que sea un dominio o URL válido (Nuclei acepta ambos)
        is_url = DomainValidator.validate_url(target)
        is_domain = DomainValidator.is_valid_domain(target)
        
        if not is_url and not is_domain:
            raise ValueError(f'Invalid URL or domain: {target}')
        
        scan = self._create_scan(
            scan_type='vulnerability',
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            tool='nuclei',
            options={
                'severity': severity,
                'tags': tags,
                'templates': templates,
                'rate_limit': rate_limit
            }
        )
        
        try:
            workspace_output_dir = self._get_workspace_output_dir(scan.id)
            output_file = str(workspace_output_dir / f'nuclei_{scan.id}.jsonl')
            
            command = [
                'nuclei',
                '-u', target,
                '-j',  # JSON output
                '-o', output_file,
                '-rl', str(rate_limit),
                '-stats',  # Show statistics
                '-si', '10'  # Status interval
            ]
            
            # Severidades
            if severity:
                command.extend(['-severity', ','.join(severity)])
            else:
                command.extend(['-severity', 'critical,high,medium,low'])
            
            # Tags
            if tags:
                command.extend(['-tags', ','.join(tags)])
            
            # Templates específicos
            if templates:
                template_path = Path(templates)
                if template_path.exists():
                    command.extend(['-t', str(template_path)])
                else:
                    command.extend(['-t', templates])
            
            sanitized_cmd = CommandSanitizer.sanitize_command(command[0], command[1:])
            
            log_to_workspace(
                workspace_id=workspace_id,
                source='NUCLEI',
                level='INFO',
                message=f"Starting Nuclei scan {scan.id}",
                metadata={'scan_id': scan.id, 'target': target}
            )
            
            self.executor.execute_async(
                scan_id=scan.id,
                command=sanitized_cmd,
                output_file=output_file,
                tool='nuclei',
                workspace_id=workspace_id
            )
            
            self.scan_repo.update_status(scan, 'running')
            
            return {
                'scan_id': scan.id,
                'status': 'running',
                'tool': 'nuclei',
                'target': target
            }
            
        except Exception as e:
            log_to_workspace(
                workspace_id=workspace_id,
                source='NUCLEI',
                level='ERROR',
                message=f"Error starting Nuclei scan: {str(e)}",
                metadata={'scan_id': scan.id, 'target': target}
            )
            self.scan_repo.update_status(scan, 'failed', str(e))
            raise
    
    def preview_scan(
        self,
        target: str,
        workspace_id: int,
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None,
        templates: Optional[str] = None,
        rate_limit: int = 150
    ) -> Dict[str, Any]:
        """Preview del comando Nuclei (sin ejecutar)."""
        is_url = DomainValidator.validate_url(target)
        is_domain = DomainValidator.is_valid_domain(target)
        
        if not is_url and not is_domain:
            raise ValueError(f'Invalid URL or domain: {target}')
        
        output_file = f'/workspaces/workspace_{workspace_id}/vuln_scans/nuclei_{{scan_id}}.jsonl'
        command = [
            'nuclei',
            '-u', target,
            '-j',
            '-o', output_file,
            '-rl', str(rate_limit),
            '-stats',
            '-si', '10'
        ]
        
        if severity:
            command.extend(['-severity', ','.join(severity)])
        else:
            command.extend(['-severity', 'critical,high,medium,low'])
        
        if tags:
            command.extend(['-tags', ','.join(tags)])
        
        if templates:
            template_path = Path(templates)
            if template_path.exists():
                command.extend(['-t', str(template_path)])
            else:
                command.extend(['-t', templates])
        
        command_str = ' '.join([str(c) for c in command])
        
        warnings = []
        suggestions = []
        
        if rate_limit > 200:
            warnings.append('Rate limit alto puede causar que el servidor bloquee las peticiones')
        
        return {
            'command': command,
            'command_string': command_str,
            'parameters': {
                'tool': 'nuclei',
                'target': target,
                'severity': severity,
                'tags': tags,
                'templates': templates,
                'rate_limit': rate_limit
            },
            'estimated_timeout': 1800,
            'output_file': output_file,
            'warnings': warnings,
            'suggestions': suggestions
        }

