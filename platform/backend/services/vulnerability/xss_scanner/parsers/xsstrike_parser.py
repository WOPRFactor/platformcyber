"""
XSStrike Output Parser
======================

Parser para resultados de XSStrike.
"""

import json
import os
import logging
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class XSStrikeParser:
    """Parser para salida de XSStrike."""
    
    def parse_output(self, stdout: str, output_file: str) -> Dict[str, Any]:
        """
        Parsea salida JSON de XSStrike.
        XSStrike puede generar múltiples líneas JSON.
        """
        vulnerabilities = []
        
        # Intentar leer del archivo primero
        if os.path.exists(output_file):
            try:
                with open(output_file, 'r') as f:
                    content = f.read()
                    for line in content.strip().split('\n'):
                        if not line.strip():
                            continue
                        try:
                            finding = json.loads(line)
                            vuln = self._normalize_vulnerability(finding)
                            if vuln:
                                vulnerabilities.append(vuln)
                        except json.JSONDecodeError:
                            continue
            except Exception as e:
                logger.warning(f"Error reading XSStrike output file: {e}")
        
        # Si no hay resultados del archivo, parsear stdout
        if not vulnerabilities:
            for line in stdout.strip().split('\n'):
                if not line.strip():
                    continue
                try:
                    finding = json.loads(line)
                    vuln = self._normalize_vulnerability(finding)
                    if vuln:
                        vulnerabilities.append(vuln)
                except json.JSONDecodeError:
                    continue
        
        return {'vulnerabilities': vulnerabilities}
    
    def _normalize_vulnerability(self, finding: Dict) -> Optional[Dict[str, Any]]:
        """Normaliza vulnerabilidad de XSStrike a formato común."""
        try:
            return {
                'type': 'XSS',
                'subtype': finding.get('type', 'reflected'),
                'payload': finding.get('payload', ''),
                'parameter': finding.get('parameter', ''),
                'context': finding.get('context', 'html'),
                'severity': 'high',
                'confidence': 'high',
                'detected_by': 'xsstrike',
                'url': finding.get('url', ''),
                'method': finding.get('method', 'GET'),
                'evidence': finding.get('evidence', ''),
                'remediation': 'Sanitize user input and use Content Security Policy (CSP)'
            }
        except Exception:
            return None


