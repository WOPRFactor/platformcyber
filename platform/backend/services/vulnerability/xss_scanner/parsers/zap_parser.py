"""
OWASP ZAP Output Parser
=======================

Parser para resultados de OWASP ZAP.
"""

import json
import os
import logging
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


class ZAPParser:
    """Parser para reporte JSON de ZAP."""
    
    def parse_output(self, output_file: str) -> Dict[str, Any]:
        """Parsea reporte JSON de ZAP."""
        vulnerabilities = []
        
        if not os.path.exists(output_file):
            return {'vulnerabilities': []}
        
        try:
            with open(output_file, 'r') as f:
                data = json.load(f)
                
            # ZAP report structure
            sites = data.get('site', [])
            for site in sites:
                alerts = site.get('alerts', [])
                for alert in alerts:
                    if 'xss' in alert.get('name', '').lower() or 'cross-site scripting' in alert.get('name', '').lower():
                        vuln = self._normalize_vulnerability(alert, site)
                        if vuln:
                            vulnerabilities.append(vuln)
        except Exception as e:
            logger.error(f"Error parsing ZAP output: {e}")
        
        return {'vulnerabilities': vulnerabilities}
    
    def _normalize_vulnerability(self, alert: Dict, site: Dict) -> Optional[Dict[str, Any]]:
        """Normaliza vulnerabilidad de ZAP a formato común."""
        try:
            return {
                'type': 'XSS',
                'subtype': 'reflected',
                'payload': alert.get('attack', ''),
                'parameter': alert.get('param', ''),
                'context': alert.get('other', {}).get('context', 'html'),
                'severity': self._map_severity(alert.get('risk', 'Medium')),
                'confidence': self._map_confidence(alert.get('confidence', 'Medium')),
                'detected_by': 'zap',
                'url': alert.get('uri', ''),
                'method': alert.get('method', 'GET'),
                'evidence': alert.get('evidence', ''),
                'remediation': alert.get('solution', 'Sanitize user input and use Content Security Policy (CSP)')
            }
        except Exception:
            return None
    
    def _map_severity(self, risk: str) -> str:
        """Mapea severidad de ZAP a formato común."""
        mapping = {
            'Informational': 'low',
            'Low': 'low',
            'Medium': 'medium',
            'High': 'high',
            'Critical': 'critical'
        }
        return mapping.get(risk, 'medium').lower()
    
    def _map_confidence(self, confidence: str) -> str:
        """Mapea confianza de ZAP a formato común."""
        mapping = {
            'False Positive': 'low',
            'Low': 'low',
            'Medium': 'medium',
            'High': 'high',
            'Confirmed': 'high'
        }
        return mapping.get(confidence, 'medium').lower()


