"""
XSS Scanner Utilities
=====================

Utilidades para el servicio de escaneo XSS.
"""

from typing import List, Dict, Any


def deduplicate_vulnerabilities(all_vulnerabilities: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """
    Deduplica vulnerabilidades basándose en (payload, parameter, url).
    Si múltiples herramientas detectan la misma, consolida.
    
    Args:
        all_vulnerabilities: Lista de todas las vulnerabilidades encontradas
        
    Returns:
        Lista de vulnerabilidades deduplicadas
    """
    seen = {}
    deduplicated = []
    
    for vuln in all_vulnerabilities:
        # Crear clave única
        key = (
            vuln.get('payload', '').strip(),
            vuln.get('parameter', '').strip(),
            vuln.get('url', '').strip()
        )
        
        if key in seen:
            # Consolidar: agregar herramienta a detected_by
            existing = seen[key]
            existing_tools = existing.get('detected_by', [])
            if isinstance(existing_tools, str):
                existing_tools = [existing_tools]
            
            new_tool = vuln.get('detected_by', '')
            if new_tool and new_tool not in existing_tools:
                existing_tools.append(new_tool)
            
            existing['detected_by'] = existing_tools
            
            # Aumentar confidence si múltiples herramientas confirman
            if len(existing_tools) > 1:
                existing['confidence'] = 'high'
        else:
            # Nueva vulnerabilidad
            vuln_copy = vuln.copy()
            detected_by = vuln_copy.get('detected_by', '')
            if isinstance(detected_by, str):
                vuln_copy['detected_by'] = [detected_by]
            seen[key] = vuln_copy
            deduplicated.append(vuln_copy)
    
    return deduplicated


