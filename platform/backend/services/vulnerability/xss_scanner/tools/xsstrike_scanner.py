"""
XSStrike Scanner
================

Módulo para escaneo XSS con XSStrike.
"""

import os
import subprocess
import json
import logging
from typing import Dict, Any, Optional
from pathlib import Path

from utils.workspace_logger import log_to_workspace
from services.vulnerability.xss_scanner.base import BaseXSSScanner

logger = logging.getLogger(__name__)


class XSStrikeScanner(BaseXSSScanner):
    """Scanner XSS usando XSStrike."""
    
    DEFAULT_TIMEOUT = 300  # 5 minutos
    
    def _find_xsstrike(self) -> Optional[str]:
        """Encuentra la ruta de XSStrike."""
        paths = [
            '/usr/share/xsstrike/xsstrike.py',
            '/opt/xsstrike/xsstrike.py',
            os.path.expanduser('~/xsstrike/xsstrike.py')
        ]
        
        import shutil
        for path in paths:
            if os.path.exists(path):
                return path
        
        # Buscar en PATH
        path = shutil.which('xsstrike.py')
        if path:
            return path
        
        return None
    
    def execute_scan(
        self,
        url: str,
        scan_id: int,
        workspace_id: int,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Ejecuta escaneo con XSStrike.
        
        Args:
            url: URL objetivo
            scan_id: ID del scan
            workspace_id: ID del workspace
            options: Opciones de configuración
            
        Returns:
            Dict con resultados
        """
        xsstrike_path = self._find_xsstrike()
        if not xsstrike_path:
            raise ValueError("XSStrike not found. Install with: git clone https://github.com/s0md3v/XSStrike.git /usr/share/xsstrike")
        
        workspace_output_dir = self._get_workspace_output_dir(scan_id)
        output_file = workspace_output_dir / f'xsstrike_{scan_id}.json'
        
        # Construir comando
        command = ['python3', xsstrike_path, '-u', url, '--json']
        
        # Opciones configurables
        if options.get('crawl', False):
            command.append('--crawl')
        
        if options.get('fuzzing', False):
            command.append('--fuzzer')
        
        if options.get('skip_dom', False):
            command.append('--skip')
        
        if options.get('timeout'):
            command.extend(['--timeout', str(options['timeout'])])
        
        if options.get('custom_headers'):
            headers_str = ' '.join([f"{k}: {v}" for k, v in options['custom_headers'].items()])
            command.extend(['--headers', headers_str])
        
        timeout = options.get('timeout', self.DEFAULT_TIMEOUT)
        
        log_to_workspace(
            workspace_id=workspace_id,
            source='XSSTRIKE',
            level='INFO',
            message=f"Starting XSStrike scan {scan_id}",
            metadata={'scan_id': scan_id, 'target': url, 'command': ' '.join(command)}
        )
        
        try:
            # Ejecutar comando
            process = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=timeout,
                cwd=os.path.dirname(xsstrike_path) if os.path.dirname(xsstrike_path) else None
            )
            
            # Guardar output en archivo
            with open(output_file, 'w') as f:
                f.write(process.stdout)
            
            # Parsear resultados
            from services.vulnerability.xss_scanner.parsers import XSStrikeParser
            parser = XSStrikeParser()
            results = parser.parse_output(process.stdout, str(output_file))
            
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSTRIKE',
                level='INFO',
                message=f"XSStrike scan {scan_id} completed",
                metadata={'scan_id': scan_id, 'vulnerabilities_found': len(results.get('vulnerabilities', []))}
            )
            
            return {
                'success': True,
                'tool': 'xsstrike',
                'vulnerabilities': results.get('vulnerabilities', []),
                'raw_output': process.stdout,
                'output_file': str(output_file)
            }
            
        except subprocess.TimeoutExpired:
            error_msg = f"XSStrike scan {scan_id} timed out after {timeout} seconds"
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSTRIKE',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id}
            )
            raise TimeoutError(error_msg)
        except Exception as e:
            error_msg = f"XSStrike scan {scan_id} failed: {str(e)}"
            log_to_workspace(
                workspace_id=workspace_id,
                source='XSSTRIKE',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id, 'error': str(e)}
            )
            raise
    
    def preview_command(
        self,
        url: str,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Genera preview del comando XSStrike."""
        xsstrike_path = self._find_xsstrike()
        if not xsstrike_path:
            return {
                'tool': 'xsstrike',
                'command': None,
                'warning': 'XSStrike not found'
            }
        
        command = ['python3', xsstrike_path, '-u', url, '--json']
        
        if options.get('crawl'):
            command.append('--crawl')
        if options.get('fuzzing'):
            command.append('--fuzzer')
        if options.get('skip_dom'):
            command.append('--skip')
        
        return {
            'tool': 'xsstrike',
            'command': ' '.join(command),
            'description': 'Primary XSS scanner with advanced payload generation'
        }


