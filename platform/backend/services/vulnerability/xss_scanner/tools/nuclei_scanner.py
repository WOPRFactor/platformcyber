"""
Nuclei XSS Scanner
=================

Módulo para escaneo XSS con Nuclei.
"""

import subprocess
import logging
import shutil
from typing import Dict, Any
from pathlib import Path

from utils.workspace_logger import log_to_workspace
from services.vulnerability.xss_scanner.base import BaseXSSScanner

logger = logging.getLogger(__name__)


class NucleiXSSScanner(BaseXSSScanner):
    """Scanner XSS usando Nuclei."""
    
    DEFAULT_TIMEOUT = 180  # 3 minutos
    
    def execute_scan(
        self,
        url: str,
        scan_id: int,
        workspace_id: int,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Ejecuta escaneo XSS con Nuclei usando templates XSS.
        
        Args:
            url: URL objetivo
            scan_id: ID del scan
            workspace_id: ID del workspace
            options: Opciones de configuración
            
        Returns:
            Dict con resultados
        """
        if not shutil.which('nuclei'):
            raise ValueError("Nuclei not found. Install with: apt install nuclei")
        
        workspace_output_dir = self._get_workspace_output_dir(scan_id)
        output_file = workspace_output_dir / f'nuclei_xss_{scan_id}.json'
        
        # Construir comando
        command = ['nuclei', '-u', url, '-tags', 'xss', '-json']
        
        # Opciones configurables
        if options.get('severity'):
            severities = ','.join(options['severity'])
            command.extend(['-severity', severities])
        
        timeout = options.get('timeout', self.DEFAULT_TIMEOUT)
        
        log_to_workspace(
            workspace_id=workspace_id,
            source='NUCLEI',
            level='INFO',
            message=f"Starting Nuclei XSS scan {scan_id}",
            metadata={'scan_id': scan_id, 'target': url}
        )
        
        try:
            # Ejecutar comando
            process = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=timeout
            )
            
            # Guardar output en archivo
            with open(output_file, 'w') as f:
                f.write(process.stdout)
            
            # Parsear resultados
            from services.vulnerability.xss_scanner.parsers import NucleiParser
            parser = NucleiParser()
            results = parser.parse_output(process.stdout)
            
            log_to_workspace(
                workspace_id=workspace_id,
                source='NUCLEI',
                level='INFO',
                message=f"Nuclei XSS scan {scan_id} completed",
                metadata={'scan_id': scan_id, 'vulnerabilities_found': len(results.get('vulnerabilities', []))}
            )
            
            return {
                'success': True,
                'tool': 'nuclei',
                'vulnerabilities': results.get('vulnerabilities', []),
                'raw_output': process.stdout,
                'output_file': str(output_file)
            }
            
        except subprocess.TimeoutExpired:
            error_msg = f"Nuclei XSS scan {scan_id} timed out after {timeout} seconds"
            log_to_workspace(
                workspace_id=workspace_id,
                source='NUCLEI',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id}
            )
            raise TimeoutError(error_msg)
        except Exception as e:
            error_msg = f"Nuclei XSS scan {scan_id} failed: {str(e)}"
            log_to_workspace(
                workspace_id=workspace_id,
                source='NUCLEI',
                level='ERROR',
                message=error_msg,
                metadata={'scan_id': scan_id, 'error': str(e)}
            )
            raise
    
    def preview_command(
        self,
        url: str,
        options: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Genera preview del comando Nuclei."""
        if not shutil.which('nuclei'):
            return {
                'tool': 'nuclei',
                'command': None,
                'warning': 'Nuclei not found'
            }
        
        command = ['nuclei', '-u', url, '-tags', 'xss', '-json']
        
        if options.get('severity'):
            severities = ','.join(options['severity'])
            command.extend(['-severity', severities])
        
        return {
            'tool': 'nuclei',
            'command': ' '.join(command),
            'description': 'Template-based XSS scanner with community templates'
        }


