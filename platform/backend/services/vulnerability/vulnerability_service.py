"""
Vulnerability Assessment Service (Refactorizado)
=================================================

Servicio orquestador para evaluación de vulnerabilidades.
Utiliza scanners modulares para cada herramienta.
"""

import logging
from typing import Dict, Any, List, Optional
from pathlib import Path

from repositories import ScanRepository, VulnerabilityRepository
from utils.workspace_logger import log_to_workspace
from utils.workspace_filesystem import get_workspace_output_dir_from_scan
from .tools import (
    NucleiScanner, NiktoScanner, SQLMapScanner, ZAPScanner,
    TestSSLScanner, WhatWebScanner, WPScanScanner, ComprehensiveScanner
)
from utils.parsers.vuln_parser import (
    NucleiParser, NiktoParser, SQLMapParser,
    TestSSLParser, WhatWebParser, WappalyzerParser, ZAPParser
)

logger = logging.getLogger(__name__)


class VulnerabilityService:
    """Servicio completo de evaluación de vulnerabilidades."""
    
    def __init__(
        self,
        scan_repository: ScanRepository = None,
        vuln_repository: VulnerabilityRepository = None
    ):
        """Inicializa el servicio."""
        self.scan_repo = scan_repository or ScanRepository()
        self.vuln_repo = vuln_repository or VulnerabilityRepository()
        
        # Inicializar scanners modulares
        self.nuclei_scanner = NucleiScanner(scan_repository, vuln_repository)
        self.nikto_scanner = NiktoScanner(scan_repository, vuln_repository)
        self.sqlmap_scanner = SQLMapScanner(scan_repository, vuln_repository)
        self.zap_scanner = ZAPScanner(scan_repository, vuln_repository)
        self.testssl_scanner = TestSSLScanner(scan_repository, vuln_repository)
        self.whatweb_scanner = WhatWebScanner(scan_repository, vuln_repository)
        self.wpscan_scanner = WPScanScanner(scan_repository, vuln_repository)
        self.comprehensive_scanner = ComprehensiveScanner(scan_repository, vuln_repository)
        
        # Parsers para resultados
        self.nuclei_parser = NucleiParser()
        self.nikto_parser = NiktoParser()
        self.sqlmap_parser = SQLMapParser()
        self.testssl_parser = TestSSLParser()
        self.whatweb_parser = WhatWebParser()
        self.wappalyzer_parser = WappalyzerParser()
        self.zap_parser = ZAPParser()
    
    def _get_workspace_output_dir(self, scan_id: int) -> Path:
        """Obtiene directorio de output del workspace para un scan."""
        return get_workspace_output_dir_from_scan(scan_id, 'vuln_scans')
    
    # ============================================
    # NUCLEI
    # ============================================
    
    def start_nuclei_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None,
        templates: Optional[str] = None,
        rate_limit: int = 150
    ) -> Dict[str, Any]:
        """Inicia scan con Nuclei."""
        return self.nuclei_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            severity=severity,
            tags=tags,
            templates=templates,
            rate_limit=rate_limit
        )
    
    def preview_nuclei_scan(
        self,
        target: str,
        workspace_id: int,
        severity: Optional[List[str]] = None,
        tags: Optional[List[str]] = None,
        templates: Optional[str] = None,
        rate_limit: int = 150
    ) -> Dict[str, Any]:
        """Preview del comando Nuclei."""
        return self.nuclei_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            severity=severity,
            tags=tags,
            templates=templates,
            rate_limit=rate_limit
        )
    
    # ============================================
    # NIKTO
    # ============================================
    
    def start_nikto_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        port: int = 80,
        ssl: bool = False,
        tuning: Optional[str] = None,
        maxtime: Optional[str] = None,
        maxtests: Optional[int] = None,
        timeout: Optional[int] = None
    ) -> Dict[str, Any]:
        """Inicia scan con Nikto."""
        return self.nikto_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            port=port,
            ssl=ssl,
            tuning=tuning,
            maxtime=maxtime,
            maxtests=maxtests,
            timeout=timeout
        )
    
    def preview_nikto_scan(
        self,
        target: str,
        workspace_id: int,
        port: int = 80,
        ssl: bool = False,
        tuning: Optional[str] = None,
        maxtime: Optional[str] = None,
        maxtests: Optional[int] = None,
        timeout: Optional[int] = None
    ) -> Dict[str, Any]:
        """Preview del comando Nikto."""
        return self.nikto_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            port=port,
            ssl=ssl,
            tuning=tuning,
            maxtime=maxtime,
            maxtests=maxtests,
            timeout=timeout
        )
    
    # ============================================
    # NMAP VULN SCAN
    # ============================================
    
    def start_nmap_vuln_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        ports: Optional[str] = None
    ) -> Dict[str, Any]:
        """Inicia scan de vulnerabilidades con Nmap."""
        from services import ScanningService
        scanning_service = ScanningService()
        return scanning_service.start_nmap_scan(
            target=target,
            scan_type='vuln',
            workspace_id=workspace_id,
            user_id=user_id,
            ports=ports
        )
    
    def preview_nmap_vuln_scan(
        self,
        target: str,
        workspace_id: int,
        ports: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview del comando Nmap Vulnerability."""
        from services import ScanningService
        scanning_service = ScanningService()
        return scanning_service.preview_nmap_scan(
            target=target,
            scan_type='vuln',
            workspace_id=workspace_id,
            ports=ports
        )
    
    # ============================================
    # SQLMAP
    # ============================================
    
    def start_sqlmap_scan(
        self,
        url: str,
        workspace_id: int,
        user_id: int,
        method: str = 'GET',
        data: Optional[str] = None,
        cookie: Optional[str] = None,
        cookies: Optional[str] = None,
        risk: int = 1,
        level: int = 1,
        dbms: Optional[str] = None,
        database: Optional[str] = None,
        table: Optional[str] = None
    ) -> Dict[str, Any]:
        """Inicia scan con SQLMap."""
        return self.sqlmap_scanner.start_scan(
            url=url,
            workspace_id=workspace_id,
            user_id=user_id,
            method=method,
            data=data,
            cookie=cookie,
            cookies=cookies,
            risk=risk,
            level=level,
            dbms=dbms,
            database=database,
            table=table
        )
    
    def preview_sqlmap_scan(
        self,
        url: str,
        workspace_id: int,
        method: str = 'GET',
        data: Optional[str] = None,
        cookie: Optional[str] = None,
        cookies: Optional[str] = None,
        risk: int = 1,
        level: int = 1,
        dbms: Optional[str] = None,
        database: Optional[str] = None,
        table: Optional[str] = None,
        techniques: Optional[list] = None
    ) -> Dict[str, Any]:
        """Preview del comando SQLMap."""
        return self.sqlmap_scanner.preview_scan(
            url=url,
            workspace_id=workspace_id,
            method=method,
            data=data,
            cookie=cookie,
            cookies=cookies,
            risk=risk,
            level=level,
            dbms=dbms,
            database=database,
            table=table,
            techniques=techniques
        )
    
    # ============================================
    # ZAP
    # ============================================
    
    def start_zap_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        scan_type: str = 'baseline',
        ajax_spider: bool = False
    ) -> Dict[str, Any]:
        """Inicia scan con OWASP ZAP."""
        return self.zap_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            scan_type=scan_type,
            ajax_spider=ajax_spider
        )
    
    def preview_zap_scan(
        self,
        target: str,
        workspace_id: int,
        scan_type: str = 'baseline',
        ajax_spider: bool = False
    ) -> Dict[str, Any]:
        """Preview del comando ZAP."""
        return self.zap_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            scan_type=scan_type,
            ajax_spider=ajax_spider
        )
    
    # ============================================
    # TESTSSL
    # ============================================
    
    def start_testssl_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        port: int = 443
    ) -> Dict[str, Any]:
        """Inicia análisis SSL/TLS con testssl.sh."""
        return self.testssl_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            port=port
        )
    
    def preview_testssl_scan(
        self,
        target: str,
        workspace_id: int,
        port: int = 443
    ) -> Dict[str, Any]:
        """Preview del comando testssl.sh."""
        return self.testssl_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            port=port
        )
    
    # ============================================
    # WHATWEB
    # ============================================
    
    def start_whatweb_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        aggression: int = 1
    ) -> Dict[str, Any]:
        """Detecta tecnologías con WhatWeb."""
        return self.whatweb_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            aggression=aggression
        )
    
    def preview_whatweb_scan(
        self,
        target: str,
        workspace_id: int,
        aggression: int = 1
    ) -> Dict[str, Any]:
        """Preview del comando WhatWeb."""
        return self.whatweb_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            aggression=aggression
        )
    
    # ============================================
    # WPSCAN
    # ============================================
    
    def start_wpscan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        enumerate: Optional[str] = None,
        plugins_detection: str = 'passive',
        api_token: Optional[str] = None
    ) -> Dict[str, Any]:
        """Inicia scan con WPScan."""
        return self.wpscan_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            enumerate=enumerate,
            plugins_detection=plugins_detection,
            api_token=api_token
        )
    
    def preview_wpscan_scan(
        self,
        target: str,
        workspace_id: int,
        enumerate: Optional[str] = None,
        plugins_detection: str = 'passive',
        api_token: Optional[str] = None
    ) -> Dict[str, Any]:
        """Preview del comando WPScan."""
        return self.wpscan_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            enumerate=enumerate,
            plugins_detection=plugins_detection,
            api_token=api_token
        )
    
    # ============================================
    # COMPREHENSIVE SCAN
    # ============================================
    
    def start_comprehensive_scan(
        self,
        target: str,
        workspace_id: int,
        user_id: int,
        include_nikto: bool = True,
        include_nmap: bool = True,
        include_nuclei: bool = True
    ) -> Dict[str, Any]:
        """Inicia scan completo con múltiples herramientas."""
        return self.comprehensive_scanner.start_scan(
            target=target,
            workspace_id=workspace_id,
            user_id=user_id,
            include_nikto=include_nikto,
            include_nmap=include_nmap,
            include_nuclei=include_nuclei
        )
    
    def preview_comprehensive_scan(
        self,
        target: str,
        workspace_id: int,
        include_nikto: bool = True,
        include_nmap: bool = True,
        include_nuclei: bool = True
    ) -> Dict[str, Any]:
        """Preview del comando Comprehensive Scan."""
        return self.comprehensive_scanner.preview_scan(
            target=target,
            workspace_id=workspace_id,
            include_nikto=include_nikto,
            include_nmap=include_nmap,
            include_nuclei=include_nuclei
        )
    
    # ============================================
    # GET RESULTS
    # ============================================
    
    def get_scan_results(self, scan_id: int) -> Dict[str, Any]:
        """
        Obtiene y parsea resultados del scan.
        
        Args:
            scan_id: ID del escaneo
        
        Returns:
            Dict con resultados parseados
        """
        scan = self.scan_repo.find_by_id(scan_id)
        
        if not scan:
            raise ValueError(f'Scan {scan_id} not found')
        
        if scan.status != 'completed':
            return {
                'scan_id': scan_id,
                'status': scan.status,
                'message': 'Scan not completed yet'
            }
        
        tool = scan.options.get('tool')
        
        try:
            workspace_output_dir = self._get_workspace_output_dir(scan_id)
            
            if tool == 'nuclei':
                output_file = workspace_output_dir / f'nuclei_{scan_id}.jsonl'
                if output_file.exists():
                    with open(output_file, 'r') as f:
                        results = self.nuclei_parser.parse_jsonl(f.read())
                else:
                    results = []
            
            elif tool == 'nikto':
                output_file = workspace_output_dir / f'nikto_{scan_id}.json'
                if output_file.exists():
                    with open(output_file, 'r') as f:
                        results = self.nikto_parser.parse_json(f.read())
                else:
                    results = []
            
            elif tool == 'sqlmap':
                output_dir = workspace_output_dir / f'sqlmap_{scan_id}'
                log_file = output_dir / 'log'
                if log_file.exists():
                    with open(log_file, 'r') as f:
                        results = self.sqlmap_parser.parse_output(f.read())
                else:
                    results = []
            
            elif tool == 'zap':
                output_file = workspace_output_dir / f'zap_{scan_id}.json'
                if output_file.exists():
                    results = self.zap_parser.parse_json(str(output_file))
                else:
                    results = []
            
            elif tool == 'testssl':
                output_file = workspace_output_dir / f'testssl_{scan_id}.json'
                if output_file.exists():
                    results = self.testssl_parser.parse_json(str(output_file))
                else:
                    results = []
            
            elif tool == 'whatweb':
                output_file = workspace_output_dir / f'whatweb_{scan_id}.json'
                if output_file.exists():
                    with open(output_file, 'r') as f:
                        results = self.whatweb_parser.parse_json(f.read())
                else:
                    results = []
            
            else:
                results = {'error': f'Unknown tool: {tool}'}
            
            return {
                'scan_id': scan_id,
                'status': 'completed',
                'tool': tool,
                'results': results,
                'scan_info': {
                    'target': scan.target,
                    'started_at': scan.started_at.isoformat() if scan.started_at else None,
                    'completed_at': scan.completed_at.isoformat() if scan.completed_at else None
                }
            }
            
        except Exception as e:
            log_to_workspace(
                workspace_id=scan.workspace_id,
                source='BACKEND',
                level='WARNING',
                message=f"Error parsing vuln scan results {scan_id}: {str(e)}",
                metadata={'scan_id': scan_id}
            )
            return {
                'scan_id': scan_id,
                'error': f'Failed to parse results: {str(e)}'
            }

