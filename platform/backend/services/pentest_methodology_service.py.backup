"""
Pentest Methodology Service
Gestión de metodologías de pentesting (Black Box, Grey Box, White Box, Red Team)
"""
import logging
from datetime import datetime
from typing import Dict, List, Optional, Any
from uuid import uuid4

logger = logging.getLogger(__name__)


class PentestMethodologyService:
    """Servicio para gestión de metodologías de pentesting"""

    def __init__(self):
        """Inicializar servicio de metodologías"""
        self.methodologies = self._initialize_methodologies()
        self.projects = {}  # En memoria por ahora, migrar a BD después

    def _initialize_methodologies(self) -> Dict[str, Dict[str, Any]]:
        """Inicializar metodologías predefinidas"""
        return {
            "black_box": {
                "name": "Caja Negra (Black Box)",
                "description": "Prueba sin conocimiento previo del sistema objetivo. Simula un ataque externo real.",
                "scope": "Sin acceso al código fuente, arquitectura o credenciales. Solo información pública.",
                "access_level": "Ninguno - Solo perspectiva externa",
                "estimated_time": "2-4 semanas",
                "difficulty": "media",
                "phases": [
                    "reconnaissance",
                    "scanning",
                    "enumeration",
                    "vulnerability_assessment",
                    "exploitation",
                    "post_exploitation",
                    "reporting"
                ],
                "tools": [
                    "Nmap", "Masscan", "Rustscan", "Naabu",
                    "theHarvester", "Sublist3r", "Amass",
                    "Nikto", "Nuclei", "WPScan",
                    "SQLMap", "XSStrike", "OWASP ZAP",
                    "Gobuster", "FFuF", "Dirb"
                ],
                "advantages": [
                    "Simula ataque real",
                    "Perspectiva del atacante",
                    "Identifica exposición pública",
                    "No requiere acceso interno"
                ],
                "limitations": [
                    "Cobertura limitada",
                    "No detecta vulnerabilidades internas",
                    "Tiempo de ejecución más largo",
                    "Puede generar falsos negativos"
                ]
            },
            "gray_box": {
                "name": "Caja Gris (Grey Box)",
                "description": "Prueba con conocimiento parcial del sistema. Simula amenaza interna o credenciales comprometidas.",
                "scope": "Acceso limitado con credenciales de usuario estándar. Información parcial del sistema.",
                "access_level": "Usuario estándar - Credenciales limitadas",
                "estimated_time": "1-3 semanas",
                "difficulty": "media",
                "phases": [
                    "reconnaissance",
                    "authenticated_scanning",
                    "authorization_testing",
                    "privilege_escalation",
                    "lateral_movement",
                    "data_exfiltration",
                    "reporting"
                ],
                "tools": [
                    "Nmap (authenticated)", "BloodHound", "PowerView",
                    "LinPEAS", "WinPEAS", "Mimikatz",
                    "CrackMapExec", "Evil-WinRM", "Impacket",
                    "Burp Suite (authenticated)", "OWASP ZAP (sessions)",
                    "Hydra", "Medusa", "John the Ripper"
                ],
                "advantages": [
                    "Mayor cobertura que caja negra",
                    "Identifica vulnerabilidades de autorización",
                    "Pruebas de escalación de privilegios",
                    "Simula amenaza interna realista"
                ],
                "limitations": [
                    "Requiere credenciales iniciales",
                    "No cubre todas las perspectivas externas",
                    "Puede pasar por alto controles de acceso",
                    "Tiempo variable según acceso"
                ]
            },
            "white_box": {
                "name": "Caja Blanca (White Box)",
                "description": "Prueba con conocimiento completo del sistema. Incluye código fuente, arquitectura y documentación.",
                "scope": "Acceso completo al código fuente, documentación técnica, arquitectura y credenciales.",
                "access_level": "Administrador - Acceso completo",
                "estimated_time": "2-6 semanas",
                "difficulty": "alta",
                "phases": [
                    "architecture_review",
                    "code_review",
                    "static_analysis",
                    "dependency_analysis",
                    "configuration_review",
                    "dynamic_testing",
                    "threat_modeling",
                    "reporting"
                ],
                "tools": [
                    "Semgrep", "Bandit", "SonarQube",
                    "OWASP Dependency-Check", "pip-audit", "npm audit",
                    "TruffleHog", "GitLeaks", "detect-secrets",
                    "Checkov", "Trivy", "Snyk",
                    "ESLint", "Pylint", "RuboCop",
                    "Retire.js", "Safety", "Bundle Audit"
                ],
                "advantages": [
                    "Cobertura completa del sistema",
                    "Identifica vulnerabilidades de diseño",
                    "Análisis profundo de código",
                    "Detección de vulnerabilidades ocultas",
                    "Mejora la calidad del código"
                ],
                "limitations": [
                    "Requiere acceso completo",
                    "Mayor tiempo de ejecución",
                    "Requiere expertise técnico avanzado",
                    "No simula ataque real",
                    "Puede generar muchos falsos positivos"
                ]
            },
            "red_team": {
                "name": "Red Team",
                "description": "Simulación de ataque adversario completo. Objetivo: comprometer la organización usando cualquier medio.",
                "scope": "Sin restricciones. Cualquier vector de ataque disponible (técnico, físico, social).",
                "access_level": "Ninguno inicialmente - Adquirido durante la operación",
                "estimated_time": "4-12 semanas",
                "difficulty": "muy_alta",
                "phases": [
                    "reconnaissance",
                    "weaponization",
                    "delivery",
                    "exploitation",
                    "installation",
                    "command_and_control",
                    "actions_on_objectives",
                    "reporting"
                ],
                "tools": [
                    "Metasploit Framework", "Cobalt Strike", "Empire",
                    "Social Engineering Toolkit (SET)", "GoPhish",
                    "BloodHound", "Mimikatz", "Rubeus",
                    "Covenant", "Sliver", "Mythic",
                    "Responder", "Impacket", "CrackMapExec",
                    "Proxychains", "Chisel", "ligolo-ng"
                ],
                "advantages": [
                    "Simula ataque APT realista",
                    "Evalúa capacidad de detección",
                    "Prueba respuesta a incidentes",
                    "Identifica cadenas de ataque completas",
                    "Evalúa defensa en profundidad"
                ],
                "limitations": [
                    "Muy costoso en tiempo/recursos",
                    "Requiere equipo especializado",
                    "Puede ser disruptivo",
                    "Requiere coordinación extensa",
                    "No cubre todas las vulnerabilidades"
                ]
            }
        }

    def get_all_methodologies(self) -> Dict[str, Dict[str, Any]]:
        """Obtener todas las metodologías disponibles"""
        logger.info("Obteniendo todas las metodologías")
        return self.methodologies

    def get_methodology(self, methodology_id: str) -> Optional[Dict[str, Any]]:
        """Obtener una metodología específica"""
        logger.info(f"Obteniendo metodología: {methodology_id}")
        return self.methodologies.get(methodology_id)

    def get_methodology_workflow(self, methodology_id: str) -> Optional[Dict[str, Any]]:
        """Obtener workflow detallado de una metodología"""
        logger.info(f"Obteniendo workflow para: {methodology_id}")
        
        methodology = self.methodologies.get(methodology_id)
        if not methodology:
            return None

        # Definir workflows detallados por fase
        workflows = {
            "black_box": {
                "name": methodology["name"],
                "description": methodology["description"],
                "workflow_phases": [
                    {
                        "phase": "reconnaissance",
                        "name": "Reconocimiento",
                        "description": "Recopilación de información sobre el objetivo",
                        "estimated_time": "2-5 días",
                        "tools": ["theHarvester", "Sublist3r", "Amass", "Shodan", "Censys"],
                        "deliverables": [
                            "Lista de subdominios",
                            "Emails de empleados",
                            "Tecnologías identificadas",
                            "Servicios expuestos públicamente"
                        ]
                    },
                    {
                        "phase": "scanning",
                        "name": "Escaneo",
                        "description": "Identificación de servicios y puertos abiertos",
                        "estimated_time": "1-3 días",
                        "tools": ["Nmap", "Masscan", "Rustscan", "Naabu"],
                        "deliverables": [
                            "Mapa de red",
                            "Puertos abiertos",
                            "Servicios identificados",
                            "Versiones de software"
                        ]
                    },
                    {
                        "phase": "enumeration",
                        "name": "Enumeración",
                        "description": "Recopilación detallada de información de servicios",
                        "estimated_time": "2-4 días",
                        "tools": ["enum4linux", "smbclient", "ldapsearch", "snmpwalk"],
                        "deliverables": [
                            "Usuarios enumerados",
                            "Recursos compartidos",
                            "Configuraciones de servicios",
                            "Información de sistema"
                        ]
                    },
                    {
                        "phase": "vulnerability_assessment",
                        "name": "Análisis de Vulnerabilidades",
                        "description": "Identificación de vulnerabilidades en servicios",
                        "estimated_time": "3-7 días",
                        "tools": ["Nuclei", "Nikto", "WPScan", "testssl.sh"],
                        "deliverables": [
                            "Lista de vulnerabilidades",
                            "Clasificación por severidad",
                            "CVEs identificados",
                            "Vectores de ataque"
                        ]
                    },
                    {
                        "phase": "exploitation",
                        "name": "Explotación",
                        "description": "Aprovechamiento de vulnerabilidades identificadas",
                        "estimated_time": "3-7 días",
                        "tools": ["Metasploit", "SQLMap", "XSStrike", "Burp Suite"],
                        "deliverables": [
                            "Accesos obtenidos",
                            "Datos comprometidos",
                            "Pruebas de concepto",
                            "Evidencias de explotación"
                        ]
                    },
                    {
                        "phase": "post_exploitation",
                        "name": "Post-Explotación",
                        "description": "Acciones después del acceso inicial",
                        "estimated_time": "2-5 días",
                        "tools": ["LinPEAS", "WinPEAS", "Mimikatz", "BloodHound"],
                        "deliverables": [
                            "Credenciales extraídas",
                            "Datos sensibles identificados",
                            "Persistencia establecida",
                            "Movimiento lateral"
                        ]
                    },
                    {
                        "phase": "reporting",
                        "name": "Reporte",
                        "description": "Documentación de hallazgos y recomendaciones",
                        "estimated_time": "3-5 días",
                        "tools": ["Markdown", "LaTeX", "Jupyter Notebooks"],
                        "deliverables": [
                            "Reporte ejecutivo",
                            "Reporte técnico",
                            "Evidencias documentadas",
                            "Recomendaciones de remediación"
                        ]
                    }
                ]
            },
            "gray_box": {
                "name": methodology["name"],
                "description": methodology["description"],
                "workflow_phases": [
                    {
                        "phase": "reconnaissance",
                        "name": "Reconocimiento Autenticado",
                        "description": "Recopilación de información con credenciales",
                        "estimated_time": "1-3 días",
                        "tools": ["BloodHound", "PowerView", "ldapdomaindump"],
                        "deliverables": [
                            "Estructura de Active Directory",
                            "Usuarios y grupos",
                            "Políticas de seguridad",
                            "Relaciones de confianza"
                        ]
                    },
                    {
                        "phase": "authenticated_scanning",
                        "name": "Escaneo Autenticado",
                        "description": "Escaneo de servicios con credenciales",
                        "estimated_time": "1-2 días",
                        "tools": ["Nmap (authenticated)", "CrackMapExec", "Nessus"],
                        "deliverables": [
                            "Servicios internos",
                            "Recursos accesibles",
                            "Configuraciones de seguridad",
                            "Parches faltantes"
                        ]
                    },
                    {
                        "phase": "authorization_testing",
                        "name": "Pruebas de Autorización",
                        "description": "Verificación de controles de acceso",
                        "estimated_time": "2-4 días",
                        "tools": ["Burp Suite", "OWASP ZAP", "Autorize"],
                        "deliverables": [
                            "Fallas de autorización",
                            "Escalación horizontal",
                            "IDOR vulnerabilities",
                            "Bypass de controles"
                        ]
                    },
                    {
                        "phase": "privilege_escalation",
                        "name": "Escalación de Privilegios",
                        "description": "Obtención de privilegios elevados",
                        "estimated_time": "2-5 días",
                        "tools": ["LinPEAS", "WinPEAS", "BeRoot", "PEASS-ng"],
                        "deliverables": [
                            "Vectores de escalación",
                            "Privilegios obtenidos",
                            "Configuraciones inseguras",
                            "Credenciales adicionales"
                        ]
                    },
                    {
                        "phase": "lateral_movement",
                        "name": "Movimiento Lateral",
                        "description": "Propagación a través de la red",
                        "estimated_time": "2-4 días",
                        "tools": ["CrackMapExec", "Evil-WinRM", "Impacket", "Proxychains"],
                        "deliverables": [
                            "Hosts comprometidos",
                            "Rutas de movimiento",
                            "Credenciales reusadas",
                            "Dominios adicionales"
                        ]
                    },
                    {
                        "phase": "data_exfiltration",
                        "name": "Exfiltración de Datos",
                        "description": "Extracción de información sensible",
                        "estimated_time": "1-3 días",
                        "tools": ["curl", "scp", "PowerShell", "DNS tunneling"],
                        "deliverables": [
                            "Datos sensibles identificados",
                            "Métodos de exfiltración",
                            "Detección de DLP",
                            "Evidencias de extracción"
                        ]
                    },
                    {
                        "phase": "reporting",
                        "name": "Reporte",
                        "description": "Documentación completa con evidencias",
                        "estimated_time": "3-5 días",
                        "tools": ["Markdown", "LaTeX", "Jupyter Notebooks"],
                        "deliverables": [
                            "Reporte ejecutivo",
                            "Reporte técnico",
                            "Cadena de ataque documentada",
                            "Remediaciones priorizadas"
                        ]
                    }
                ]
            },
            "white_box": {
                "name": methodology["name"],
                "description": methodology["description"],
                "workflow_phases": [
                    {
                        "phase": "architecture_review",
                        "name": "Revisión de Arquitectura",
                        "description": "Análisis de diseño y arquitectura del sistema",
                        "estimated_time": "2-5 días",
                        "tools": ["Draw.io", "PlantUML", "Threat Dragon"],
                        "deliverables": [
                            "Diagramas de arquitectura",
                            "Flujo de datos",
                            "Modelos de amenazas",
                            "Análisis de superficie de ataque"
                        ]
                    },
                    {
                        "phase": "code_review",
                        "name": "Revisión de Código",
                        "description": "Análisis manual de código fuente",
                        "estimated_time": "5-10 días",
                        "tools": ["VS Code", "Sublime Text", "grep", "ripgrep"],
                        "deliverables": [
                            "Vulnerabilidades identificadas",
                            "Patrones inseguros",
                            "Lógica de negocio comprometida",
                            "Recomendaciones de código"
                        ]
                    },
                    {
                        "phase": "static_analysis",
                        "name": "Análisis Estático (SAST)",
                        "description": "Análisis automatizado de código fuente",
                        "estimated_time": "2-4 días",
                        "tools": ["Semgrep", "Bandit", "SonarQube", "CodeQL"],
                        "deliverables": [
                            "Vulnerabilidades detectadas",
                            "Código inseguro",
                            "Complejidad ciclomática",
                            "Métricas de calidad"
                        ]
                    },
                    {
                        "phase": "dependency_analysis",
                        "name": "Análisis de Dependencias",
                        "description": "Identificación de vulnerabilidades en dependencias",
                        "estimated_time": "1-2 días",
                        "tools": ["OWASP Dependency-Check", "pip-audit", "npm audit", "Snyk"],
                        "deliverables": [
                            "CVEs en dependencias",
                            "Versiones desactualizadas",
                            "Licencias problemáticas",
                            "Recomendaciones de actualización"
                        ]
                    },
                    {
                        "phase": "configuration_review",
                        "name": "Revisión de Configuración",
                        "description": "Análisis de archivos de configuración",
                        "estimated_time": "2-3 días",
                        "tools": ["Checkov", "kube-bench", "docker-bench-security"],
                        "deliverables": [
                            "Configuraciones inseguras",
                            "Secrets hardcodeados",
                            "Permisos incorrectos",
                            "Benchmarks de seguridad"
                        ]
                    },
                    {
                        "phase": "dynamic_testing",
                        "name": "Pruebas Dinámicas (DAST)",
                        "description": "Testing de aplicación en ejecución",
                        "estimated_time": "3-5 días",
                        "tools": ["OWASP ZAP", "Burp Suite", "Nuclei"],
                        "deliverables": [
                            "Vulnerabilidades en runtime",
                            "Pruebas de casos límite",
                            "Validación de inputs",
                            "Comportamiento anómalo"
                        ]
                    },
                    {
                        "phase": "threat_modeling",
                        "name": "Modelado de Amenazas",
                        "description": "Identificación de amenazas potenciales",
                        "estimated_time": "2-4 días",
                        "tools": ["OWASP Threat Dragon", "Microsoft Threat Modeling Tool"],
                        "deliverables": [
                            "Modelo de amenazas STRIDE",
                            "Árboles de ataque",
                            "Contramedidas propuestas",
                            "Matriz de riesgos"
                        ]
                    },
                    {
                        "phase": "reporting",
                        "name": "Reporte Comprehensivo",
                        "description": "Documentación técnica completa",
                        "estimated_time": "5-7 días",
                        "tools": ["Markdown", "LaTeX", "Jupyter Notebooks"],
                        "deliverables": [
                            "Reporte ejecutivo",
                            "Análisis técnico detallado",
                            "Código de ejemplo seguro",
                            "Roadmap de remediación"
                        ]
                    }
                ]
            },
            "red_team": {
                "name": methodology["name"],
                "description": methodology["description"],
                "workflow_phases": [
                    {
                        "phase": "reconnaissance",
                        "name": "Reconocimiento Adversario",
                        "description": "Recopilación de inteligencia como un atacante real",
                        "estimated_time": "1-2 semanas",
                        "tools": ["OSINT Framework", "Maltego", "Shodan", "theHarvester"],
                        "deliverables": [
                            "Perfil de la organización",
                            "Empleados clave identificados",
                            "Infraestructura externa",
                            "Vectores de ataque identificados"
                        ]
                    },
                    {
                        "phase": "weaponization",
                        "name": "Armamento",
                        "description": "Creación de payloads y herramientas de ataque",
                        "estimated_time": "3-7 días",
                        "tools": ["msfvenom", "Donut", "Veil", "Shellter"],
                        "deliverables": [
                            "Payloads personalizados",
                            "Malware ofuscado",
                            "Exploits preparados",
                            "C2 infrastructure"
                        ]
                    },
                    {
                        "phase": "delivery",
                        "name": "Entrega",
                        "description": "Entrega de payloads al objetivo",
                        "estimated_time": "1-2 semanas",
                        "tools": ["GoPhish", "SET", "King Phisher", "Evilginx2"],
                        "deliverables": [
                            "Campañas de phishing",
                            "Sitios maliciosos",
                            "Entrega física (USB)",
                            "Tracking de ejecución"
                        ]
                    },
                    {
                        "phase": "exploitation",
                        "name": "Explotación",
                        "description": "Obtención de acceso inicial",
                        "estimated_time": "1-2 semanas",
                        "tools": ["Metasploit", "Cobalt Strike", "Empire", "Covenant"],
                        "deliverables": [
                            "Beacon inicial",
                            "Persistencia establecida",
                            "Evasión de EDR",
                            "Acceso mantenido"
                        ]
                    },
                    {
                        "phase": "installation",
                        "name": "Instalación",
                        "description": "Establecimiento de presencia duradera",
                        "estimated_time": "3-5 días",
                        "tools": ["Impacket", "PowerShell Empire", "Metasploit"],
                        "deliverables": [
                            "Backdoors instalados",
                            "Persistencia múltiple",
                            "Bypass de controles",
                            "Cuentas comprometidas"
                        ]
                    },
                    {
                        "phase": "command_and_control",
                        "name": "Command & Control",
                        "description": "Mantenimiento de comunicación con sistemas comprometidos",
                        "estimated_time": "Continuo",
                        "tools": ["Cobalt Strike", "Sliver", "Mythic", "Covenant"],
                        "deliverables": [
                            "C2 infrastructure operacional",
                            "Canales de comunicación",
                            "Evasión de detección",
                            "Logs de actividad"
                        ]
                    },
                    {
                        "phase": "actions_on_objectives",
                        "name": "Acciones en Objetivos",
                        "description": "Cumplimiento de objetivos del engagement",
                        "estimated_time": "1-2 semanas",
                        "tools": ["BloodHound", "Mimikatz", "SharpHound", "Rubeus"],
                        "deliverables": [
                            "Objetivos alcanzados",
                            "Datos exfiltrados (simulados)",
                            "Domain Admin obtenido",
                            "Impacto demostrado"
                        ]
                    },
                    {
                        "phase": "reporting",
                        "name": "Reporte de Red Team",
                        "description": "Documentación de operación completa",
                        "estimated_time": "1-2 semanas",
                        "tools": ["Markdown", "LaTeX", "Jupyter Notebooks"],
                        "deliverables": [
                            "Reporte ejecutivo",
                            "Timeline de ataque",
                            "TTPs utilizadas",
                            "Recomendaciones de defensa",
                            "Gaps de detección"
                        ]
                    }
                ]
            }
        }

        return workflows.get(methodology_id)

    def create_project(self, project_data: Dict[str, Any]) -> Dict[str, Any]:
        """Crear nuevo proyecto de pentest"""
        project_id = str(uuid4())
        
        project = {
            "id": project_id,
            "name": project_data.get("name", f"Project {project_id[:8]}"),
            "methodology": project_data.get("methodology", "black_box"),
            "target": project_data["target"],
            "scope": project_data.get("scope", []),
            "client": project_data.get("client", ""),
            "start_date": project_data.get("start_date", datetime.now().isoformat()),
            "end_date": project_data.get("end_date"),
            "status": "planning",
            "phases_completed": [],
            "findings": [],
            "team_members": project_data.get("team_members", []),
            "objectives": project_data.get("objectives", []),
            "created_at": datetime.now().isoformat(),
            "created_by": project_data.get("created_by", "admin"),
            "updated_at": datetime.now().isoformat()
        }

        # Agregar detalles de metodología
        methodology = self.methodologies.get(project["methodology"])
        if methodology:
            project["methodology_details"] = methodology

        self.projects[project_id] = project
        logger.info(f"Proyecto creado: {project_id} - {project['name']}")
        
        return {
            "success": True,
            "message": "Proyecto creado exitosamente",
            "project": project
        }

    def get_project(self, project_id: str) -> Optional[Dict[str, Any]]:
        """Obtener proyecto específico"""
        logger.info(f"Obteniendo proyecto: {project_id}")
        project = self.projects.get(project_id)
        
        if project and "methodology_details" not in project:
            methodology = self.methodologies.get(project["methodology"])
            if methodology:
                project["methodology_details"] = methodology
        
        return project

    def list_projects(self) -> List[Dict[str, Any]]:
        """Listar todos los proyectos"""
        logger.info(f"Listando proyectos: {len(self.projects)} encontrados")
        return list(self.projects.values())

    def update_project_status(
        self, 
        project_id: str, 
        status: str, 
        phase_completed: Optional[str] = None
    ) -> Dict[str, Any]:
        """Actualizar estado del proyecto"""
        project = self.projects.get(project_id)
        if not project:
            return {
                "success": False,
                "message": "Proyecto no encontrado"
            }

        project["status"] = status
        project["updated_at"] = datetime.now().isoformat()

        if phase_completed and phase_completed not in project["phases_completed"]:
            project["phases_completed"].append(phase_completed)

        logger.info(f"Proyecto actualizado: {project_id} - Estado: {status}")
        
        return {
            "success": True,
            "message": "Proyecto actualizado exitosamente",
            "project": project
        }

    def add_finding(
        self, 
        project_id: str, 
        finding_data: Dict[str, Any]
    ) -> Dict[str, Any]:
        """Agregar hallazgo a proyecto"""
        project = self.projects.get(project_id)
        if not project:
            return {
                "success": False,
                "message": "Proyecto no encontrado"
            }

        finding_id = str(uuid4())
        finding = {
            "id": finding_id,
            "title": finding_data["title"],
            "description": finding_data["description"],
            "severity": finding_data.get("severity", "medium"),
            "category": finding_data.get("category", ""),
            "phase": finding_data.get("phase", ""),
            "remediation": finding_data.get("remediation", ""),
            "tags": finding_data.get("tags", []),
            "created_at": datetime.now().isoformat(),
            "created_by": finding_data.get("created_by", "admin")
        }

        project["findings"].append(finding)
        project["updated_at"] = datetime.now().isoformat()

        logger.info(f"Hallazgo agregado al proyecto {project_id}: {finding['title']}")
        
        return {
            "success": True,
            "message": "Hallazgo agregado exitosamente",
            "finding": finding
        }

    def get_dashboard_stats(self) -> Dict[str, Any]:
        """Obtener estadísticas del dashboard"""
        total_projects = len(self.projects)
        active_projects = sum(1 for p in self.projects.values() if p["status"] == "active")
        completed_projects = sum(1 for p in self.projects.values() if p["status"] == "completed")
        
        # Distribución por metodología
        methodology_distribution = {}
        for project in self.projects.values():
            methodology = project["methodology"]
            methodology_distribution[methodology] = methodology_distribution.get(methodology, 0) + 1

        # Proyectos recientes
        recent_projects = sorted(
            self.projects.values(),
            key=lambda x: x["created_at"],
            reverse=True
        )[:5]

        logger.info("Obteniendo estadísticas del dashboard")
        
        return {
            "total_projects": total_projects,
            "active_projects": active_projects,
            "completed_projects": completed_projects,
            "methodology_distribution": methodology_distribution,
            "recent_projects": recent_projects
        }


# Instancia singleton
_pentest_service_instance = None


def get_pentest_methodology_service() -> PentestMethodologyService:
    """Obtener instancia del servicio"""
    global _pentest_service_instance
    if _pentest_service_instance is None:
        _pentest_service_instance = PentestMethodologyService()
    return _pentest_service_instance





