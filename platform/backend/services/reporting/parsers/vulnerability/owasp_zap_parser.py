"""
Parser para OWASP ZAP - Web vulnerability scanner.
Formato: JSON con alerts.
"""

from pathlib import Path
from typing import List
from ..base_parser import BaseParser, ParsedFinding


class OWASPZAPParser(BaseParser):
    """Parser para archivos JSON de OWASP ZAP."""
    
    def can_parse(self, file_path: Path) -> bool:
        """Verifica si el archivo puede ser parseado."""
        filename = file_path.name.lower()
        return 'zap' in filename and file_path.suffix == '.json'
    
    def parse(self, file_path: Path) -> List[ParsedFinding]:
        """
        Parsea archivo JSON de OWASP ZAP.
        """
        findings = []
        
        try:
            data = self._safe_parse_json(file_path)
            if not data:
                return findings
            
            sites = data.get('site', [])
            
            for site in sites:
                site_name = site.get('@name', 'unknown')
                alerts = site.get('alerts', [])
                
                for alert in alerts:
                    alert_name = alert.get('alert', 'Unknown')
                    risk_code = int(alert.get('riskcode', '0'))
                    confidence = int(alert.get('confidence', '0'))
                    risk_desc = alert.get('riskdesc', '')
                    description = alert.get('desc', '')
                    
                    # Mapear risk code a severidad
                    severity_map = {
                        3: 'high',
                        2: 'medium',
                        1: 'low',
                        0: 'info'
                    }
                    severity = severity_map.get(risk_code, 'info')
                    
                    finding = ParsedFinding(
                        title=f"ZAP: {alert_name}",
                        severity=severity,
                        description=description if description else alert_name,
                        category='web_vulnerability',
                        affected_target=site_name,
                        evidence=f"Risk: {risk_desc}, Confidence: {confidence}",
                        remediation=alert.get('solution', 'Review and fix the identified issue'),
                        references=[alert.get('reference')] if alert.get('reference') else None,
                        raw_data={
                            'tool': 'owasp_zap',
                            'alert': alert_name,
                            'risk_code': risk_code,
                            'confidence': confidence,
                            'plugin_id': alert.get('pluginid')
                        }
                    )
                    findings.append(finding)
            
            self.logger.info(f"OWASP ZAP: Parsed {len(findings)} vulnerabilities")
            return findings
            
        except Exception as e:
            self.logger.error(f"Error parsing OWASP ZAP file {file_path}: {e}")
            return findings

