"""
Test Vulnerability Flow (Integration)
======================================

Tests de integración para flujo completo de vulnerabilidades.
"""

import pytest
from services import VulnerabilityService


class TestVulnerabilityFlow:
    """Tests de integración para vulnerabilidades."""
    
    def test_create_and_retrieve_vulnerability(self, db, sample_workspace):
        """Test crear vulnerabilidad y recuperarla."""
        # Arrange
        vuln_service = VulnerabilityService()
        
        # Act 1: Crear vulnerabilidad
        vuln = vuln_service.create_vulnerability(
            title='SQL Injection Test',
            description='Test SQL injection vulnerability',
            severity='high',
            target='https://example.com',
            workspace_id=sample_workspace.id,
            cve_id='CVE-2024-TEST'
        )
        
        # Assert 1: Vulnerabilidad creada
        assert vuln['title'] == 'SQL Injection Test'
        assert vuln['severity'] == 'high'
        
        # Act 2: Recuperar vulnerabilidades
        vulns = vuln_service.get_vulnerabilities(sample_workspace.id)
        
        # Assert 2: Vulnerabilidad en la lista
        assert len(vulns) == 1
        assert vulns[0]['title'] == 'SQL Injection Test'
    
    def test_vulnerability_statistics(self, db, sample_workspace):
        """Test estadísticas de vulnerabilidades."""
        vuln_service = VulnerabilityService()
        
        # Crear varias vulnerabilidades
        vuln_service.create_vulnerability(
            title='Critical Vuln 1',
            description='Test',
            severity='critical',
            target='test.com',
            workspace_id=sample_workspace.id
        )
        
        vuln_service.create_vulnerability(
            title='High Vuln 1',
            description='Test',
            severity='high',
            target='test.com',
            workspace_id=sample_workspace.id
        )
        
        # Obtener estadísticas
        stats = vuln_service.get_statistics(sample_workspace.id)
        
        # Assertions
        assert stats['total'] == 2
        assert 'by_severity' in stats
        assert 'by_status' in stats



