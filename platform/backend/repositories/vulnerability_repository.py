"""
Vulnerability Repository
========================

Repository para operaciones de vulnerabilidades.
"""

from typing import Optional, List
from models import db, Vulnerability


class VulnerabilityRepository:
    """Repository para gestiÃ³n de vulnerabilidades."""
    
    @staticmethod
    def create(
        title: str,
        description: str,
        severity: str,
        target: str,
        workspace_id: int,
        cve_id: str = None,
        cvss_score: float = None,
        port: int = None,
        service: str = None
    ) -> Vulnerability:
        """Crea una nueva vulnerabilidad."""
        vuln = Vulnerability(
            title=title,
            description=description,
            severity=severity,
            target=target,
            workspace_id=workspace_id,
            cve_id=cve_id,
            cvss_score=cvss_score,
            port=port,
            service=service
        )
        
        db.session.add(vuln)
        db.session.commit()
        
        return vuln
    
    @staticmethod
    def find_by_id(vuln_id: int) -> Optional[Vulnerability]:
        """Busca vulnerabilidad por ID."""
        return Vulnerability.query.get(vuln_id)
    
    @staticmethod
    def find_by_workspace(
        workspace_id: int,
        severity: Optional[str] = None,
        status: Optional[str] = None
    ) -> List[Vulnerability]:
        """Busca vulnerabilidades por workspace."""
        query = Vulnerability.query.filter_by(workspace_id=workspace_id)
        
        if severity:
            query = query.filter_by(severity=severity)
        
        if status:
            query = query.filter_by(status=status)
        
        return query.order_by(Vulnerability.discovered_at.desc()).all()
    
    @staticmethod
    def find_by_severity(workspace_id: int, severities: List[str]) -> List[Vulnerability]:
        """Busca vulnerabilidades por severidad."""
        return Vulnerability.query\
            .filter_by(workspace_id=workspace_id)\
            .filter(Vulnerability.severity.in_(severities))\
            .order_by(Vulnerability.cvss_score.desc())\
            .all()
    
    @staticmethod
    def update_status(vuln: Vulnerability, status: str) -> Vulnerability:
        """Actualiza el estado de una vulnerabilidad."""
        vuln.status = status
        db.session.commit()
        return vuln
    
    @staticmethod
    def get_stats(workspace_id: int) -> dict:
        """Obtiene estadÃ­sticas de vulnerabilidades."""
        total = Vulnerability.query.filter_by(workspace_id=workspace_id).count()
        
        by_severity = db.session.query(
            Vulnerability.severity,
            db.func.count(Vulnerability.id)
        ).filter_by(workspace_id=workspace_id)\
         .group_by(Vulnerability.severity)\
         .all()
        
        by_status = db.session.query(
            Vulnerability.status,
            db.func.count(Vulnerability.id)
        ).filter_by(workspace_id=workspace_id)\
         .group_by(Vulnerability.status)\
         .all()
        
        return {
            'total': total,
            'by_severity': dict(by_severity),
            'by_status': dict(by_status)
        }
    
    @staticmethod
    def delete(vuln: Vulnerability) -> None:
        """Elimina una vulnerabilidad."""
        db.session.delete(vuln)
        db.session.commit()



