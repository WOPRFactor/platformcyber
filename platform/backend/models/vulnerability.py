"""
Vulnerability Model
===================

Modelo de vulnerabilidades detectadas.
"""

from datetime import datetime
from . import db


class Vulnerability(db.Model):
    """Modelo de vulnerabilidad."""
    
    __tablename__ = 'vulnerabilities'
    
    id = db.Column(db.Integer, primary_key=True)
    
    # IdentificaciÃ³n
    title = db.Column(db.String(255), nullable=False)
    description = db.Column(db.Text, nullable=False)
    cve_id = db.Column(db.String(20))  # CVE-2024-XXXX
    cwe_id = db.Column(db.String(20))  # CWE-79
    
    # Severidad
    severity = db.Column(db.String(20), nullable=False)
    # critical, high, medium, low, info
    
    cvss_score = db.Column(db.Float)  # 0.0 - 10.0
    
    # Target
    target = db.Column(db.String(255), nullable=False)
    port = db.Column(db.Integer)
    service = db.Column(db.String(100))
    
    # Detalles
    proof_of_concept = db.Column(db.Text)
    remediation = db.Column(db.Text)
    references = db.Column(db.JSON)  # Lista de URLs/referencias
    
    # Estado
    status = db.Column(db.String(20), default='open', nullable=False)
    # open, confirmed, false_positive, remediated, accepted_risk
    
    # Timestamps
    discovered_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relaciones
    workspace_id = db.Column(db.Integer, db.ForeignKey('workspaces.id'), nullable=False)
    workspace = db.relationship('Workspace', back_populates='vulnerabilities')
    
    def to_dict(self) -> dict:
        """Serializa la vulnerabilidad a diccionario."""
        return {
            'id': self.id,
            'title': self.title,
            'description': self.description,
            'cve_id': self.cve_id,
            'cwe_id': self.cwe_id,
            'severity': self.severity,
            'cvss_score': self.cvss_score,
            'target': self.target,
            'port': self.port,
            'service': self.service,
            'status': self.status,
            'discovered_at': self.discovered_at.isoformat() if self.discovered_at else None,
            'workspace_id': self.workspace_id
        }
    
    def __repr__(self):
        return f'<Vulnerability {self.title} [{self.severity}]>'



