/**
 * VulnerabilityPieChart - Distribución de vulnerabilidades por severidad
 * Diseño profesional con animaciones, tooltips personalizados y leyenda interactiva
 */

import React, { useState } from 'react'
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip } from 'recharts'
import { motion } from 'framer-motion'
import { CHART_COLORS, SEVERITY_CONFIG, calculatePercent } from '../../config/chartConfig'
import ChartContainer from './ChartContainer'

interface VulnerabilitySeverityData {
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info'
  count: number
}

interface VulnerabilityPieChartProps {
  data: VulnerabilitySeverityData[]
  title?: string
  description?: string
  isLoading?: boolean
  onRefresh?: () => void
  onSeverityClick?: (severity: string) => void
}

const VulnerabilityPieChart: React.FC<VulnerabilityPieChartProps> = ({
  data,
  title = 'Vulnerabilidades por Severidad',
  description = 'Distribución del total de vulnerabilidades encontradas',
  isLoading = false,
  onRefresh,
  onSeverityClick,
}) => {
  const [activeIndex, setActiveIndex] = useState<number | null>(null)

  // Calcular total
  const total = data.reduce((sum, item) => sum + item.count, 0)

  // Preparar datos con porcentajes y colores
  const chartData = data
    .filter(item => item.count > 0) // Solo mostrar severidades con datos
    .map(item => ({
      name: SEVERITY_CONFIG[item.severity].label,
      value: item.count,
      percentage: calculatePercent(item.count, total),
      color: SEVERITY_CONFIG[item.severity].color,
      icon: SEVERITY_CONFIG[item.severity].icon,
      severity: item.severity,
    }))
    .sort((a, b) => SEVERITY_CONFIG[a.severity].order - SEVERITY_CONFIG[b.severity].order)

  // Custom tooltip
  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null

    const data = payload[0].payload
    return (
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        className="bg-gray-900 border border-gray-700 rounded-lg p-4 shadow-xl"
      >
        <div className="flex items-center space-x-2 mb-2">
          <span className="text-2xl">{data.icon}</span>
          <span className="text-white font-semibold text-lg">{data.name}</span>
        </div>
        <div className="space-y-1 text-sm">
          <div className="flex justify-between items-center">
            <span className="text-gray-400">Cantidad:</span>
            <span className="text-white font-bold ml-4">{data.value.toLocaleString()}</span>
          </div>
          <div className="flex justify-between items-center">
            <span className="text-gray-400">Porcentaje:</span>
            <span className="text-white font-bold ml-4">{data.percentage.toFixed(1)}%</span>
          </div>
        </div>
      </motion.div>
    )
  }

  // Custom label en el centro
  const renderCenterLabel = () => (
    <g>
      <text
        x="50%"
        y="45%"
        textAnchor="middle"
        dominantBaseline="middle"
        className="fill-white text-4xl font-bold"
      >
        {total.toLocaleString()}
      </text>
      <text
        x="50%"
        y="55%"
        textAnchor="middle"
        dominantBaseline="middle"
        className="fill-gray-400 text-sm font-medium"
      >
        Vulnerabilidades
      </text>
    </g>
  )

  // Custom legend
  const CustomLegend = () => (
    <div className="flex flex-wrap justify-center gap-4 mt-6">
      {chartData.map((item, index) => (
        <motion.button
          key={item.severity}
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: index * 0.1 }}
          onClick={() => onSeverityClick?.(item.severity)}
          onMouseEnter={() => setActiveIndex(index)}
          onMouseLeave={() => setActiveIndex(null)}
          className={`
            flex items-center space-x-2 px-4 py-2 rounded-lg
            border transition-all duration-200
            ${activeIndex === index
              ? 'bg-gray-700 border-gray-600 scale-105'
              : 'bg-gray-800/50 border-gray-700 hover:bg-gray-700/50'
            }
            ${onSeverityClick ? 'cursor-pointer' : ''}
          `}
        >
          <div
            className="w-3 h-3 rounded-full"
            style={{ backgroundColor: item.color }}
          />
          <span className="text-sm text-gray-300 font-medium">{item.icon} {item.name}</span>
          <span className="text-sm text-white font-bold">{item.value}</span>
          <span className="text-xs text-gray-500">({item.percentage.toFixed(1)}%)</span>
        </motion.button>
      ))}
    </div>
  )

  // Active shape con efecto hover
  const renderActiveShape = (props: any) => {
    const {
      cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill
    } = props

    return (
      <g>
        <Sector
          cx={cx}
          cy={cy}
          innerRadius={innerRadius}
          outerRadius={outerRadius + 10}
          startAngle={startAngle}
          endAngle={endAngle}
          fill={fill}
          opacity={0.8}
        />
        <Sector
          cx={cx}
          cy={cy}
          innerRadius={outerRadius + 12}
          outerRadius={outerRadius + 16}
          startAngle={startAngle}
          endAngle={endAngle}
          fill={fill}
          opacity={0.3}
        />
      </g>
    )
  }

  const isEmpty = chartData.length === 0 || total === 0

  return (
    <ChartContainer
      title={title}
      description={description}
      isLoading={isLoading}
      isEmpty={isEmpty}
      emptyMessage="No hay vulnerabilidades para mostrar"
      onRefresh={onRefresh}
      height={500}
    >
      <ResponsiveContainer width="100%" height="100%">
        <PieChart>
          <Pie
            data={chartData}
            cx="50%"
            cy="45%"
            innerRadius={80}
            outerRadius={130}
            paddingAngle={2}
            dataKey="value"
            animationBegin={0}
            animationDuration={800}
            activeIndex={activeIndex ?? undefined}
            activeShape={renderActiveShape}
            onMouseEnter={(_, index) => setActiveIndex(index)}
            onMouseLeave={() => setActiveIndex(null)}
            onClick={(data) => onSeverityClick?.(data.severity)}
          >
            {chartData.map((entry, index) => (
              <Cell
                key={`cell-${index}`}
                fill={entry.color}
                stroke="#1F2937"
                strokeWidth={2}
                style={{ cursor: onSeverityClick ? 'pointer' : 'default' }}
              />
            ))}
          </Pie>
          <Tooltip content={<CustomTooltip />} />
          {renderCenterLabel()}
        </PieChart>
      </ResponsiveContainer>
      <CustomLegend />
    </ChartContainer>
  )
}

// Helper para Sector (renderActiveShape)
const Sector = (props: any) => {
  const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill, opacity = 1 } = props
  
  return (
    <path
      d={describeArc(cx, cy, innerRadius, outerRadius, startAngle, endAngle)}
      fill={fill}
      opacity={opacity}
    />
  )
}

// Utilidad para dibujar arcos
function describeArc(cx: number, cy: number, innerRadius: number, outerRadius: number, startAngle: number, endAngle: number) {
  const start = polarToCartesian(cx, cy, outerRadius, endAngle)
  const end = polarToCartesian(cx, cy, outerRadius, startAngle)
  const innerStart = polarToCartesian(cx, cy, innerRadius, endAngle)
  const innerEnd = polarToCartesian(cx, cy, innerRadius, startAngle)
  
  const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1'
  
  return [
    'M', start.x, start.y,
    'A', outerRadius, outerRadius, 0, largeArcFlag, 0, end.x, end.y,
    'L', innerEnd.x, innerEnd.y,
    'A', innerRadius, innerRadius, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
    'Z'
  ].join(' ')
}

function polarToCartesian(cx: number, cy: number, radius: number, angleInDegrees: number) {
  const angleInRadians = (angleInDegrees - 90) * Math.PI / 180
  return {
    x: cx + (radius * Math.cos(angleInRadians)),
    y: cy + (radius * Math.sin(angleInRadians))
  }
}

export default VulnerabilityPieChart




