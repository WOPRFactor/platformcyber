/**
 * PasswordAttacksSection Component
 * 
 * Componente para herramientas de ataques de contraseña:
 * - Hydra
 * - John the Ripper
 * - Hashcat
 * - Kerbrute
 */

import React, { useState } from 'react'
import { Key, Hash, Zap, User, Loader2, Play } from 'lucide-react'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { exploitationAPI, type HydraRequest, type JohnRequest, type HashcatRequest, type KerbruteRequest } from '../../lib/api/exploitation'
import { useWorkspace } from '../../contexts/WorkspaceContext'
import { useConsole } from '../../contexts/ConsoleContext'
import { toast } from 'sonner'
import { useExploitationPreviews } from '../../hooks/exploitation-previews'

interface PasswordAttacksSectionProps {
  activeSubTab: string
  setActiveSubTab: (tab: string) => void
}

const PasswordAttacksSection: React.FC<PasswordAttacksSectionProps> = ({ activeSubTab, setActiveSubTab }) => {
  const { currentWorkspace } = useWorkspace()
  const { startTask, addLog, updateTaskProgress, failTask } = useConsole()
  const queryClient = useQueryClient()
  const previewHooks = useExploitationPreviews()

  // Estados para formularios
  const [hydraTarget, setHydraTarget] = useState('')
  const [hydraService, setHydraService] = useState('ssh')
  const [hydraUsername, setHydraUsername] = useState('')
  const [hydraUserfile, setHydraUserfile] = useState('')
  const [hydraPassword, setHydraPassword] = useState('')
  const [hydraPassfile, setHydraPassfile] = useState('')
  const [hydraPort, setHydraPort] = useState('')
  const [hydraThreads, setHydraThreads] = useState('16')
  
  const [johnHashFile, setJohnHashFile] = useState('')
  const [johnWordlist, setJohnWordlist] = useState('')
  const [johnFormat, setJohnFormat] = useState('')
  const [johnRules, setJohnRules] = useState(false)
  
  const [hashcatHashFile, setHashcatHashFile] = useState('')
  const [hashcatMode, setHashcatMode] = useState('1000')
  const [hashcatWordlist, setHashcatWordlist] = useState('')
  const [hashcatRulesFile, setHashcatRulesFile] = useState('')
  
  const [kerbruteDomain, setKerbruteDomain] = useState('')
  const [kerbruteMode, setKerbruteMode] = useState('userenum')
  const [kerbruteUsersFile, setKerbruteUsersFile] = useState('')
  const [kerbrutePasswordsFile, setKerbrutePasswordsFile] = useState('')
  const [kerbrutePassword, setKerbrutePassword] = useState('')
  const [kerbruteDcIp, setKerbruteDcIp] = useState('')

  // Auto-completar targets desde workspace
  React.useEffect(() => {
    if (currentWorkspace?.target_domain) {
      setHydraTarget(currentWorkspace.target_domain)
      setKerbruteDomain(currentWorkspace.target_domain)
    } else if (currentWorkspace && !currentWorkspace.target_domain) {
      setHydraTarget('')
      setKerbruteDomain('')
    }
  }, [currentWorkspace?.id, currentWorkspace?.target_domain])

  // Mutaciones
  const hydraMutation = useMutation({
    mutationFn: (data: HydraRequest) => exploitationAPI.startHydraAttack(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `Hydra ${variables.service} attack en ${variables.target}`)
      addLog('info', 'exploitation', `Iniciando Hydra ${variables.service} attack`, taskId, `hydra -t ${variables.threads || 16} ${variables.target}`)
      updateTaskProgress(taskId, 10, 'Iniciando ataque Hydra...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`Ataque Hydra iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'Ataque Hydra enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en Hydra: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  const johnMutation = useMutation({
    mutationFn: (data: JohnRequest) => exploitationAPI.startJohn(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `John the Ripper cracking`)
      addLog('info', 'exploitation', `Iniciando John the Ripper`, taskId, `john ${variables.hash_file}`)
      updateTaskProgress(taskId, 10, 'Iniciando cracking...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`John the Ripper iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'Cracking enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en John: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  const hashcatMutation = useMutation({
    mutationFn: (data: HashcatRequest) => exploitationAPI.startHashcat(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `Hashcat GPU cracking`)
      addLog('info', 'exploitation', `Iniciando Hashcat (modo ${variables.mode})`, taskId, `hashcat -m ${variables.mode} ${variables.hash_file}`)
      updateTaskProgress(taskId, 10, 'Iniciando cracking GPU...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`Hashcat iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'Cracking GPU enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en Hashcat: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  const kerbruteMutation = useMutation({
    mutationFn: (data: KerbruteRequest) => exploitationAPI.startKerbrute(data),
    onMutate: (variables) => {
      const taskId = startTask('Exploitation', `Kerbrute ${variables.mode} en ${variables.domain}`)
      addLog('info', 'exploitation', `Iniciando Kerbrute ${variables.mode}`, taskId, `kerbrute ${variables.mode} -d ${variables.domain}`)
      updateTaskProgress(taskId, 10, 'Iniciando Kerbrute...')
      return { taskId }
    },
    onSuccess: (data, variables, context) => {
      toast.success(`Kerbrute iniciado: ${data.message || 'Éxito'}`)
      queryClient.invalidateQueries({ queryKey: ['exploit_sessions'] })
      if (context?.taskId) {
        updateTaskProgress(context.taskId, 25, 'Kerbrute enviado al backend')
        addLog('info', 'exploitation', `Sesión iniciada: scan_id ${data.scan_id}`, context.taskId)
      }
    },
    onError: (error: any, variables, context) => {
      toast.error(`Error en Kerbrute: ${error.message}`)
      if (context?.taskId) failTask(context.taskId, error.message)
    }
  })

  // Handlers con preview
  const handleHydraWithPreview = () => {
    previewHooks.handleHydraWithPreview({
      target: hydraTarget,
      service: hydraService,
      username: hydraUsername || undefined,
      userfile: hydraUserfile || undefined,
      password: hydraPassword || undefined,
      passfile: hydraPassfile || undefined,
      port: hydraPort ? parseInt(hydraPort) : undefined,
      threads: hydraThreads ? parseInt(hydraThreads) : 16,
      originalPassword: hydraPassword,
      onExecute: async (params: any) => {
        await hydraMutation.mutateAsync(params)
      }
    })
  }

  const handleJohnWithPreview = () => {
    previewHooks.handleJohnWithPreview({
      hashFile: johnHashFile,
      wordlist: johnWordlist || undefined,
      format: johnFormat || undefined,
      rules: johnRules,
      onExecute: async (params: any) => {
        await johnMutation.mutateAsync(params)
      }
    })
  }

  const handleHashcatWithPreview = () => {
    previewHooks.handleHashcatWithPreview({
      hashFile: hashcatHashFile,
      mode: parseInt(hashcatMode),
      wordlist: hashcatWordlist,
      rulesFile: hashcatRulesFile || undefined,
      onExecute: async (params: any) => {
        await hashcatMutation.mutateAsync(params)
      }
    })
  }

  const handleKerbruteWithPreview = () => {
    previewHooks.handleKerbruteWithPreview({
      domain: kerbruteDomain,
      mode: kerbruteMode,
      usersFile: kerbruteUsersFile || undefined,
      passwordsFile: kerbrutePasswordsFile || undefined,
      password: kerbrutePassword || undefined,
      dcIp: kerbruteDcIp || undefined,
      originalPassword: kerbrutePassword,
      onExecute: async (params: any) => {
        await kerbruteMutation.mutateAsync(params)
      }
    })
  }

  return (
    <div className="space-y-4">
      {/* Sub-tabs */}
      <div className="flex border-b border-gray-700 mb-4">
        <button
          onClick={() => setActiveSubTab('hydra')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'hydra' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          Hydra
        </button>
        <button
          onClick={() => setActiveSubTab('john')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'john' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          John
        </button>
        <button
          onClick={() => setActiveSubTab('hashcat')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'hashcat' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          Hashcat
        </button>
        <button
          onClick={() => setActiveSubTab('kerbrute')}
          className={`px-4 py-2 border-b-2 ${
            activeSubTab === 'kerbrute' ? 'border-green-400 text-green-400' : 'border-transparent text-gray-400'
          }`}
        >
          Kerbrute
        </button>
      </div>

      {/* Formulario Hydra */}
      {activeSubTab === 'hydra' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <Key className="w-5 h-5" />
            Hydra - Brute Force Multi-Protocolo
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-300 mb-1">Target</label>
              <input
                type="text"
                value={hydraTarget}
                onChange={(e) => setHydraTarget(e.target.value)}
                placeholder="192.168.1.10"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Servicio</label>
              <select
                value={hydraService}
                onChange={(e) => setHydraService(e.target.value)}
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              >
                <option value="ssh">SSH</option>
                <option value="smb">SMB</option>
                <option value="ftp">FTP</option>
                <option value="rdp">RDP</option>
                <option value="mysql">MySQL</option>
              </select>
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Usuario (opcional)</label>
              <input
                type="text"
                value={hydraUsername}
                onChange={(e) => setHydraUsername(e.target.value)}
                placeholder="admin"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Archivo usuarios (opcional)</label>
              <input
                type="text"
                value={hydraUserfile}
                onChange={(e) => setHydraUserfile(e.target.value)}
                placeholder="/path/to/users.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Password (opcional)</label>
              <input
                type="password"
                value={hydraPassword}
                onChange={(e) => setHydraPassword(e.target.value)}
                placeholder="password123"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Archivo passwords (opcional)</label>
              <input
                type="text"
                value={hydraPassfile}
                onChange={(e) => setHydraPassfile(e.target.value)}
                placeholder="/path/to/passwords.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Puerto (opcional)</label>
              <input
                type="number"
                value={hydraPort}
                onChange={(e) => setHydraPort(e.target.value)}
                placeholder="22"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Threads</label>
              <input
                type="number"
                value={hydraThreads}
                onChange={(e) => setHydraThreads(e.target.value)}
                placeholder="16"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
          </div>
          <button
            onClick={handleHydraWithPreview}
            disabled={hydraMutation.isPending}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {hydraMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {hydraMutation.isPending ? 'Iniciando...' : 'Iniciar Ataque Hydra'}
          </button>
        </div>
      )}

      {/* Formulario John */}
      {activeSubTab === 'john' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <Hash className="w-5 h-5" />
            John the Ripper - Hash Cracking
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div className="col-span-2">
              <label className="block text-sm text-gray-300 mb-1">Archivo de hashes *</label>
              <input
                type="text"
                value={johnHashFile}
                onChange={(e) => setJohnHashFile(e.target.value)}
                placeholder="/path/to/hashes.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Wordlist (opcional)</label>
              <input
                type="text"
                value={johnWordlist}
                onChange={(e) => setJohnWordlist(e.target.value)}
                placeholder="/path/to/wordlist.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Formato hash (opcional)</label>
              <input
                type="text"
                value={johnFormat}
                onChange={(e) => setJohnFormat(e.target.value)}
                placeholder="NT, Raw-MD5, sha512crypt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div className="col-span-2">
              <label className="flex items-center gap-2 text-sm text-gray-300">
                <input
                  type="checkbox"
                  checked={johnRules}
                  onChange={(e) => setJohnRules(e.target.checked)}
                  className="rounded"
                />
                Usar reglas de transformación
              </label>
            </div>
          </div>
          <button
            onClick={handleJohnWithPreview}
            disabled={johnMutation.isPending}
            className="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {johnMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {johnMutation.isPending ? 'Iniciando...' : 'Iniciar John the Ripper'}
          </button>
        </div>
      )}

      {/* Formulario Hashcat */}
      {activeSubTab === 'hashcat' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <Zap className="w-5 h-5" />
            Hashcat - GPU Accelerated Cracking
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-300 mb-1">Archivo de hashes *</label>
              <input
                type="text"
                value={hashcatHashFile}
                onChange={(e) => setHashcatHashFile(e.target.value)}
                placeholder="/path/to/hashes.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Modo hash *</label>
              <select
                value={hashcatMode}
                onChange={(e) => setHashcatMode(e.target.value)}
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              >
                <option value="0">MD5</option>
                <option value="1000">NTLM</option>
                <option value="5600">NetNTLMv2</option>
                <option value="1800">SHA-512</option>
                <option value="500">MD5 Crypt</option>
              </select>
            </div>
            <div className="col-span-2">
              <label className="block text-sm text-gray-300 mb-1">Wordlist *</label>
              <input
                type="text"
                value={hashcatWordlist}
                onChange={(e) => setHashcatWordlist(e.target.value)}
                placeholder="/path/to/wordlist.txt"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div className="col-span-2">
              <label className="block text-sm text-gray-300 mb-1">Archivo de reglas (opcional)</label>
              <input
                type="text"
                value={hashcatRulesFile}
                onChange={(e) => setHashcatRulesFile(e.target.value)}
                placeholder="/path/to/rules.rule"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
          </div>
          <button
            onClick={handleHashcatWithPreview}
            disabled={hashcatMutation.isPending}
            className="w-full bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {hashcatMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {hashcatMutation.isPending ? 'Iniciando...' : 'Iniciar Hashcat'}
          </button>
        </div>
      )}

      {/* Formulario Kerbrute */}
      {activeSubTab === 'kerbrute' && (
        <div className="bg-gray-900 border border-green-500 rounded-lg p-6 space-y-4">
          <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
            <User className="w-5 h-5" />
            Kerbrute - Kerberos Enumeration & Brute Force
          </h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-300 mb-1">Dominio *</label>
              <input
                type="text"
                value={kerbruteDomain}
                onChange={(e) => setKerbruteDomain(e.target.value)}
                placeholder="domain.local"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
            <div>
              <label className="block text-sm text-gray-300 mb-1">Modo *</label>
              <select
                value={kerbruteMode}
                onChange={(e) => setKerbruteMode(e.target.value)}
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              >
                <option value="userenum">User Enumeration</option>
                <option value="passwordspray">Password Spray</option>
                <option value="bruteuser">Brute User</option>
              </select>
            </div>
            {kerbruteMode !== 'bruteuser' && (
              <div className="col-span-2">
                <label className="block text-sm text-gray-300 mb-1">Archivo de usuarios *</label>
                <input
                  type="text"
                  value={kerbruteUsersFile}
                  onChange={(e) => setKerbruteUsersFile(e.target.value)}
                  placeholder="/path/to/users.txt"
                  className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
                />
              </div>
            )}
            {kerbruteMode === 'passwordspray' && (
              <div className="col-span-2">
                <label className="block text-sm text-gray-300 mb-1">Password *</label>
                <input
                  type="password"
                  value={kerbrutePassword}
                  onChange={(e) => setKerbrutePassword(e.target.value)}
                  placeholder="Password123"
                  className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
                />
              </div>
            )}
            {kerbruteMode === 'bruteuser' && (
              <>
                <div>
                  <label className="block text-sm text-gray-300 mb-1">Usuario *</label>
                  <input
                    type="text"
                    value={kerbruteUsersFile}
                    onChange={(e) => setKerbruteUsersFile(e.target.value)}
                    placeholder="username"
                    className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
                  />
                </div>
                <div>
                  <label className="block text-sm text-gray-300 mb-1">Archivo passwords *</label>
                  <input
                    type="text"
                    value={kerbrutePasswordsFile}
                    onChange={(e) => setKerbrutePasswordsFile(e.target.value)}
                    placeholder="/path/to/passwords.txt"
                    className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
                  />
                </div>
              </>
            )}
            <div>
              <label className="block text-sm text-gray-300 mb-1">DC IP (opcional)</label>
              <input
                type="text"
                value={kerbruteDcIp}
                onChange={(e) => setKerbruteDcIp(e.target.value)}
                placeholder="192.168.1.10"
                className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400"
              />
            </div>
          </div>
          <button
            onClick={handleKerbruteWithPreview}
            disabled={kerbruteMutation.isPending}
            className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 disabled:opacity-50"
          >
            {kerbruteMutation.isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Play className="w-4 h-4" />}
            {kerbruteMutation.isPending ? 'Iniciando...' : 'Iniciar Kerbrute'}
          </button>
        </div>
      )}
    </div>
  )
}

export default PasswordAttacksSection
