/**
 * SeatbeltSection Component
 * =========================
 *
 * Componente para ejecutar Seatbelt (enumeración de seguridad Windows).
 */

import React, { useState, useRef } from 'react'
import { Search, Loader2, Terminal } from 'lucide-react'
import { useMutation } from '@tanstack/react-query'
import { postExploitAPI } from '../../lib/api/postExploit'
import { commandPreviewAPI } from '../../lib/api/command-preview'
import { useWorkspace } from '../../contexts/WorkspaceContext'
import { useConsole } from '../../contexts/ConsoleContext'
import { toast } from 'sonner'
import { useQueryClient } from '@tanstack/react-query'
import CommandPreviewModal from '../CommandPreviewModal'
import type { CommandPreview } from '../CommandPreviewModal'

interface SeatbeltSectionProps {
  setActiveScanSession: (session: number | null) => void
}

const SeatbeltSection: React.FC<SeatbeltSectionProps> = ({
  setActiveScanSession
}) => {
  const { currentWorkspace } = useWorkspace()
  const { startTask, addLog, updateTaskProgress } = useConsole()
  const queryClient = useQueryClient()

  const [target, setTarget] = useState('')
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [group, setGroup] = useState('all')
  
  // Estado para preview
  const [showPreview, setShowPreview] = useState(false)
  const [previewData, setPreviewData] = useState<CommandPreview | null>(null)
  const previewExecuteFnRef = useRef<(() => Promise<void>) | null>(null)

  const seatbeltMutation = useMutation({
    mutationFn: (data: { target: string; username: string; password: string; group: string }) => {
      if (!data.target?.trim() || !data.username?.trim() || !data.password?.trim() || !currentWorkspace?.id) {
        throw new Error('Target, username, password y workspace son requeridos')
      }

      const taskId = startTask('Post Exploitation', `Seatbelt en ${data.target}`)
      addLog('info', 'postexploitation', `Iniciando Seatbelt para ${data.target}`, taskId, `seatbelt ${data.group}`)
      updateTaskProgress(taskId, 10, 'Iniciando Seatbelt...')

      return postExploitAPI.runSeatbelt({
        target: data.target,
        workspace_id: currentWorkspace.id,
        username: data.username,
        password: data.password,
        group: data.group
      }).then(result => {
        if (result.scan_id) {
          setActiveScanSession(result.scan_id)
        }
        return result
      })
    },
    onSuccess: (data, variables) => {
      toast.success('Seatbelt ejecutado exitosamente')
      queryClient.invalidateQueries({ queryKey: ['post-exploit-sessions'] })
    },
    onError: (error: any, variables) => {
      toast.error(`Error ejecutando Seatbelt: ${error.message}`)
    }
  })

  const handleSeatbeltWithPreview = async () => {
    if (!currentWorkspace?.id || !target.trim() || !username.trim() || !password.trim()) {
      toast.error('Workspace, target, username y password son requeridos')
      return
    }

    try {
      const preview = await commandPreviewAPI.previewSeatbelt({
        workspace_id: currentWorkspace.id,
        target: target.trim(),
        username: username.trim(),
        password: password,
        group: group
      })

      setPreviewData(preview)
      previewExecuteFnRef.current = async () => {
        await seatbeltMutation.mutateAsync({
          target: target.trim(),
          username: username.trim(),
          password: password,
          group: group
        })
      };
      setShowPreview(true)
    } catch (error: any) {
      toast.error(`Error obteniendo preview: ${error.message}`)
      // NO ejecutar el comando automáticamente - el usuario debe confirmar desde el preview
    }
  }

  const groups = [
    { value: 'all', label: 'All Checks' },
    { value: 'system', label: 'System Information' },
    { value: 'user', label: 'User Information' },
    { value: 'powershell', label: 'PowerShell Information' },
    { value: 'process', label: 'Process Information' },
    { value: 'service', label: 'Service Information' },
    { value: 'network', label: 'Network Information' },
    { value: 'security', label: 'Security Checks' }
  ]

  return (
    <div className="bg-gray-900 border border-green-500 rounded-lg p-6">
      <div className="mb-4">
        <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
          <Search className="w-5 h-5" />
          Seatbelt - Windows Security Enumeration
        </h3>
        <p className="text-green-600">
          Realiza enumeración de seguridad y configuración en sistemas Windows
        </p>
      </div>

      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-green-400 mb-2">
            Target (IP/Hostname)
          </label>
          <input
            type="text"
            value={target}
            onChange={(e) => setTarget(e.target.value)}
            placeholder="192.168.1.100"
            className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">
              Username *
            </label>
            <input
              type="text"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              placeholder="DOMAIN\\usuario"
              className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">
              Password *
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="contraseña"
              className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-green-400 mb-2">
            Grupo de Checks
          </label>
          <select
            value={group}
            onChange={(e) => setGroup(e.target.value)}
            className="w-full bg-gray-800 border border-green-500 rounded px-3 py-2 text-green-400 focus:outline-none focus:ring-2 focus:ring-green-500"
          >
            {groups.map((grp) => (
              <option key={grp.value} value={grp.value}>
                {grp.label}
              </option>
            ))}
          </select>
        </div>

        <button
          onClick={handleSeatbeltWithPreview}
          disabled={seatbeltMutation.isPending}
          className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {seatbeltMutation.isPending ? (
            <Loader2 className="w-4 h-4 animate-spin mr-2" />
          ) : (
            <Terminal className="w-4 h-4 mr-2" />
          )}
          Ejecutar Seatbelt
        </button>
      </div>

      <CommandPreviewModal
        isOpen={showPreview}
        onClose={() => setShowPreview(false)}
        onExecute={async () => {
          if (previewExecuteFnRef.current) {
            setShowPreview(false)
            await previewExecuteFnRef.current()
          }
        }}
        previewData={previewData}
        toolName="Seatbelt"
        category="post-exploitation"
      />
    </div>
  )
}

export default SeatbeltSection




