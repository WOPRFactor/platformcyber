/**
 * M√≥dulo de Evaluaci√≥n de Vulnerabilidades
 * Maneja operaciones relacionadas con escaneo de vulnerabilidades web
 */

import axios from 'axios'
import { api } from '../shared/client'
import { CommandPreview } from '../../../components/CommandPreviewModal'
import type {
  VulnSession,
  VulnResult,
  VulnScanRequest,
  VulnScanResponse,
  VulnSessionsResponse,
  VulnResultsResponse,
  NiktoResult,
  SqlMapResult,
  DirbResult,
  GobusterResult
} from './types'

/**
 * Obtiene todas las sesiones de vulnerabilidades
 * @returns Lista de sesiones de escaneo de vulnerabilidades
 */
export const getVulnSessions = async (): Promise<VulnSession[]> => {
  const response = await api.get<VulnSessionsResponse>('vulnerability/sessions')
  return response.data.sessions
}

/**
 * Obtiene los resultados de una sesi√≥n espec√≠fica
 * @param sessionId - ID de la sesi√≥n
 * @returns Resultados de la sesi√≥n de vulnerabilidades
 */
export const getVulnResults = async (sessionId: string): Promise<VulnResult[]> => {
  const response = await api.get<VulnResultsResponse>(`vulnerability/results/${sessionId}`)
  return response.data.results
}

/**
 * Obtiene el estado de una sesi√≥n espec√≠fica
 * @param sessionId - ID de la sesi√≥n
 * @returns Estado actual de la sesi√≥n
 */
export const getVulnSessionStatus = async (sessionId: string): Promise<VulnSession> => {
  const response = await api.get<{ session: VulnSession }>(`vulnerability/status/${sessionId}`)
  return response.data.session
}

/**
 * Inicia un escaneo Nikto
 * @param target - URL objetivo
 * @param workspaceId - ID del workspace
 * @param options - Opciones adicionales
 * @param options.ssl - Usar SSL/TLS
 * @param options.port - Puerto (default: 80)
 * @param options.tuning - Categor√≠as de tests (1-9,0,a-e,x) - Ej: "1,2,3" o "x1"
 * @param options.maxtime - Tiempo m√°ximo ("1h", "60m", "3600s")
 * @param options.maxtests - N√∫mero m√°ximo de tests
 * @param options.timeout - Timeout por request en segundos (default: 10)
 * @returns Respuesta del escaneo iniciado
 */
export const startNiktoScan = async (
  target: string, 
  workspaceId: number, 
  options?: {
    ssl?: boolean
    port?: number
    tuning?: string
    maxtime?: string
    maxtests?: number
    timeout?: number
  }
): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/nikto', {
    target,
    workspace_id: workspaceId,
    port: options?.port || 80,
    ssl: options?.ssl || false,
    tuning: options?.tuning,
    maxtime: options?.maxtime,
    maxtests: options?.maxtests,
    timeout: options?.timeout
  })
  return response.data
}

/**
 * Inicia un escaneo SQLMap
 * @param target - URL objetivo con par√°metro vulnerable
 * @param workspaceId - ID del workspace
 * @param options - Opciones adicionales
 * @returns Respuesta del escaneo iniciado
 */
export const startSqlMapScan = async (target: string, workspaceId: number, options?: Record<string, any>): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/sqlmap', {
    url: target,
    workspace_id: workspaceId,
    database: options?.database,
    table: options?.table,
    cookies: options?.cookies
  })
  return response.data
}

/**
 * Inicia un escaneo de vulnerabilidades con Nmap (scripts NSE)
 * @param target - Objetivo del escaneo
 * @param workspaceId - ID del workspace
 * @param options - Opciones adicionales
 * @param options.ports - Puertos a escanear (opcional, default: top 1000)
 * @returns Resultado del escaneo Nmap vuln
 */
export const startNmapVulnScan = async (
  target: string, 
  workspaceId: number,
  options?: {
    ports?: string
  }
): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/nmap', {
    target,
    workspace_id: workspaceId,
    ports: options?.ports
  })
  return response.data
}

/**
 * Inicia un escaneo con Nuclei
 * @param target - Objetivo del escaneo
 * @param workspaceId - ID del workspace
 * @param options - Opciones adicionales (severity, templates)
 * @returns Resultado del escaneo Nuclei
 */
export const startNucleiScan = async (target: string, workspaceId: number, options?: Record<string, any>): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/nuclei', {
    target,
    workspace_id: workspaceId,
    severity: options?.severity || ['critical', 'high', 'medium'],
    templates: options?.templates
  })
  return response.data
}

/**
 * Inicia un escaneo WPScan (WordPress Security Scanner)
 * @param target - URL objetivo (debe ser un sitio WordPress)
 * @param workspaceId - ID del workspace
 * @param options - Opciones adicionales
 * @param options.enumerate - Enumerar (u=usuarios, p=plugins, t=themes)
 * @param options.plugins_detection - Detecci√≥n de plugins ('passive', 'aggressive', 'mixed')
 * @param options.api_token - API token de WPScan (opcional)
 * @returns Respuesta del escaneo iniciado
 */
export const startWpscanScan = async (
  target: string,
  workspaceId: number,
  options?: {
    enumerate?: string
    plugins_detection?: string
    api_token?: string
  }
): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/wpscan', {
    target,
    workspace_id: workspaceId,
    enumerate: options?.enumerate,
    plugins_detection: options?.plugins_detection || 'passive',
    api_token: options?.api_token
  })
  return response.data
}

/**
 * Inicia evaluaci√≥n completa de vulnerabilidades
 * @param target - Objetivo de la evaluaci√≥n
 * @param options - Opciones adicionales
 * @returns Resultado de la evaluaci√≥n completa
 */
export const startComprehensiveScan = async (target: string, workspaceId: number, options?: Record<string, any>): Promise<VulnScanResponse> => {
  if (!workspaceId) {
    throw new Error('workspace_id is required')
  }
  
  const body = {
    workspace_id: workspaceId,
    options: options || {}
  }
  
  console.log('üîç [startComprehensiveScan] Enviando request:', {
    url: `vulnerability/comprehensive/${target}`,
    body,
    workspaceId,
    target
  })
  
  // Usar la instancia global de api que ya tiene los interceptores configurados
  try {
    const response = await api.post<VulnScanResponse>(`vulnerability/comprehensive/${target}`, body)
    console.log('‚úÖ [startComprehensiveScan] Response:', response.data)
    return response.data
  } catch (error: any) {
    console.error('‚ùå [startComprehensiveScan] Error:', {
      message: error.message,
      response: error.response?.data,
      status: error.response?.status,
      statusText: error.response?.statusText,
      headers: error.response?.headers,
      request: {
        url: error.config?.url,
        method: error.config?.method,
        data: error.config?.data,
        params: error.config?.params
      }
    })
    console.error('‚ùå [startComprehensiveScan] Full error response:', error.response?.data)
    throw error
  }
}

/**
 * Detiene una sesi√≥n de escaneo
 * @param sessionId - ID de la sesi√≥n a detener
 * @returns Confirmaci√≥n de detenci√≥n
 */
export const stopVulnScan = async (sessionId: string): Promise<{ message: string }> => {
  const response = await api.post<{ message: string }>(`vulnerability/stop/${sessionId}`)
  return response.data
}

/**
 * Elimina una sesi√≥n de vulnerabilidades
 * @param sessionId - ID de la sesi√≥n a eliminar
 * @returns Confirmaci√≥n de eliminaci√≥n
 */
export const deleteVulnSession = async (sessionId: string): Promise<{ message: string }> => {
  const response = await api.delete<{ message: string }>(`vulnerability/session/${sessionId}`)
  return response.data
}

/**
 * Inicia un escaneo con OWASP ZAP
 * @param target - URL objetivo
 * @param workspaceId - ID del workspace
 * @param options - Opciones (scan_type, ajax_spider)
 * @returns Respuesta del escaneo iniciado
 */
export const startZapScan = async (target: string, workspaceId: number, options?: { scan_type?: 'baseline' | 'full' | 'api'; ajax_spider?: boolean }): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/zap', {
    target,
    workspace_id: workspaceId,
    scan_type: options?.scan_type || 'baseline',
    ajax_spider: options?.ajax_spider || false
  })
  return response.data
}

/**
 * Inicia an√°lisis SSL/TLS con testssl.sh
 * @param target - Host objetivo
 * @param workspaceId - ID del workspace
 * @param port - Puerto SSL/TLS (default: 443)
 * @returns Respuesta del escaneo iniciado
 */
export const startTestSslScan = async (target: string, workspaceId: number, port: number = 443): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/testssl', {
    target,
    workspace_id: workspaceId,
    port
  })
  return response.data
}

/**
 * Detecta tecnolog√≠as con WhatWeb
 * @param target - URL objetivo
 * @param workspaceId - ID del workspace
 * @param aggression - Nivel de agresi√≥n (1-4, default: 1)
 * @returns Respuesta del escaneo iniciado
 */
export const startWhatWebScan = async (target: string, workspaceId: number, aggression: number = 1): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/whatweb', {
    target,
    workspace_id: workspaceId,
    aggression
  })
  return response.data
}

/**
 * Verifica qu√© herramientas XSS est√°n disponibles
 * @returns Disponibilidad de cada herramienta
 */
export const getXSSAvailableTools = async (): Promise<{ xsstrike: boolean; xsser: boolean; zap: boolean; nuclei: boolean }> => {
  const response = await api.get<{ xsstrike: boolean; xsser: boolean; zap: boolean; nuclei: boolean }>('vulnerability/xss/available-tools')
  return response.data
}

/**
 * Preview del comando XSS que se ejecutar√°
 * @param url - URL objetivo
 * @param workspaceId - ID del workspace
 * @param engine - Engine a usar (auto|xsstrike|xsser|zap|nuclei)
 * @param scanMode - Modo de escaneo (single|all|compare)
 * @param engines - Lista de engines para modo compare
 * @param options - Opciones de configuraci√≥n
 * @returns Preview del comando
 */
export const previewXSSCommand = async (
  url: string,
  workspaceId: number,
  engine: string = 'auto',
  scanMode: string = 'single',
  engines?: string[],
  options?: Record<string, any>
): Promise<CommandPreview> => {
  const response = await api.post<CommandPreview>('vulnerability/xss/preview', {
    url,
    workspace_id: workspaceId,
    engine,
    scan_mode: scanMode,
    engines,
    options
  })
  return response.data
}

/**
 * Escanea XSS con m√∫ltiples herramientas
 * @param url - URL objetivo
 * @param workspaceId - ID del workspace
 * @param engine - Engine a usar (auto|xsstrike|xsser|zap|nuclei)
 * @param scanMode - Modo de escaneo (single|all|compare)
 * @param engines - Lista de engines para modo compare
 * @param options - Opciones de configuraci√≥n
 * @returns Respuesta del escaneo iniciado
 */
export const startXSSScan = async (
  url: string,
  workspaceId: number,
  engine: string = 'auto',
  scanMode: string = 'single',
  engines?: string[],
  options?: Record<string, any>
): Promise<VulnScanResponse> => {
  const response = await api.post<VulnScanResponse>('vulnerability/xss', {
    url,
    workspace_id: workspaceId,
    engine,
    scan_mode: scanMode,
    engines,
    options
  })
  return response.data
}

/**
 * Obtiene resultados comparativos de un scan en modo COMPARE
 * @param scanId - ID del scan
 * @returns Resultados comparativos
 */
export const getXSSComparison = async (scanId: number): Promise<any> => {
  const response = await api.get(`vulnerability/xss/${scanId}/comparison`)
  return response.data
}

/**
 * Objeto API de vulnerabilidades - compatible hacia atr√°s
 * Agrupa todas las funciones de evaluaci√≥n de vulnerabilidades
 */
export const vulnerabilityAPI = {
  getVulnSessions,
  getVulnResults,
  getVulnSessionStatus,
  startNiktoScan,
  startSqlMapScan,
  startNmapVulnScan,
  startNucleiScan,
  startWpscanScan,
  startZapScan,
  startTestSslScan,
  startWhatWebScan,
  // XSS Multi-Tool Scanner
  getXSSAvailableTools,
  previewXSSCommand,
  startXSSScan,
  getXSSComparison,
  startComprehensiveScan,
  stopVulnScan,
  deleteVulnSession
}
