import React, { useState } from 'react'
import { Shield, Target, Search, Zap, Globe, Database, AlertTriangle, CheckCircle, XCircle, Loader } from 'lucide-react'
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query'
import { vulnerabilityAPI } from '../lib/api'
import {
  NiktoScanResult,
  VulnScanResult,
  NucleiScanResult,
  ComprehensiveVulnResult,
  VulnSession
} from '../types'
import LoadingSpinner from '../components/LoadingSpinner'
import { toast } from 'sonner'

const VulnerabilityAssessment: React.FC = () => {
  const [target, setTarget] = useState('')
  const [sqlUrl, setSqlUrl] = useState('')
  const [activeTab, setActiveTab] = useState('nikto')
  const queryClient = useQueryClient()

  // Query para obtener sesiones de vulnerabilidades
  const { data: sessions, isLoading: sessionsLoading, refetch: refetchSessions } = useQuery({
    queryKey: ['vuln-sessions'],
    queryFn: vulnerabilityAPI.getVulnSessions,
    refetchInterval: 5000,
  })

  // Mutations para diferentes tipos de escaneo
  const niktoMutation = useMutation({
    mutationFn: (target: string) => vulnerabilityAPI.niktoScan(target),
    onSuccess: (data) => {
      toast.success(`Escaneo Nikto completado: ${data.findings?.length || 0} hallazgos`)
      queryClient.invalidateQueries({ queryKey: ['vuln-sessions'] })
    },
    onError: (error: any) => {
      toast.error(`Error en escaneo Nikto: ${error.message}`)
    }
  })

  const nmapVulnMutation = useMutation({
    mutationFn: (target: string) => vulnerabilityAPI.nmapVulnScan(target),
    onSuccess: (data) => {
      toast.success(`Escaneo Nmap vuln completado: ${data.vulnerabilities?.length || 0} vulnerabilidades`)
      queryClient.invalidateQueries({ queryKey: ['vuln-sessions'] })
    },
    onError: (error: any) => {
      toast.error(`Error en escaneo Nmap vuln: ${error.message}`)
    }
  })

  const nucleiMutation = useMutation({
    mutationFn: (target: string) => vulnerabilityAPI.nucleiScan(target),
    onSuccess: (data) => {
      toast.success(`Escaneo Nuclei completado: ${data.findings?.length || 0} hallazgos`)
      queryClient.invalidateQueries({ queryKey: ['vuln-sessions'] })
    },
    onError: (error: any) => {
      toast.error(`Error en escaneo Nuclei: ${error.message}`)
    }
  })

  const sqlmapMutation = useMutation({
    mutationFn: (data: { target: string; url: string }) => vulnerabilityAPI.sqlmapScan(data),
    onSuccess: (data) => {
      toast.success(`Escaneo SQLMap completado: ${data.findings?.length || 0} hallazgos`)
      queryClient.invalidateQueries({ queryKey: ['vuln-sessions'] })
    },
    onError: (error: any) => {
      toast.error(`Error en escaneo SQLMap: ${error.message}`)
    }
  })

  const comprehensiveMutation = useMutation({
    mutationFn: (target: string) => vulnerabilityAPI.comprehensiveVulnAssessment(target),
    onSuccess: (data) => {
      toast.success(`Evaluación completa finalizada: ${data.summary?.total_vulnerabilities || 0} vulnerabilidades encontradas`)
      queryClient.invalidateQueries({ queryKey: ['vuln-sessions'] })
    },
    onError: (error: any) => {
      toast.error(`Error en evaluación completa: ${error.message}`)
    }
  })

  const handleScan = (scanType: string) => {
    if (!target.trim()) {
      toast.error('Por favor ingrese un target válido')
      return
    }

    switch (scanType) {
      case 'nikto':
        niktoMutation.mutate(target)
        break
      case 'nmap':
        nmapVulnMutation.mutate(target)
        break
      case 'nuclei':
        nucleiMutation.mutate(target)
        break
      case 'sqlmap':
        if (!sqlUrl.trim()) {
          toast.error('Por favor ingrese una URL para el escaneo SQL')
          return
        }
        sqlmapMutation.mutate({ target, url: sqlUrl })
        break
      case 'comprehensive':
        comprehensiveMutation.mutate(target)
        break
    }
  }

  const renderFindings = (findings: any[], type: string) => {
    if (!findings || findings.length === 0) {
      return <p className="text-gray-500">No se encontraron hallazgos</p>
    }

    return (
      <div className="space-y-2">
        {findings.map((finding: any, idx: number) => (
          <div key={idx} className={`border rounded-lg p-3 mb-2 ${
            finding.severity === 'high' ? 'border-red-500 bg-red-50' :
            finding.severity === 'medium' ? 'border-yellow-500 bg-yellow-50' :
            'border-blue-500 bg-blue-50'
          }`}>
            <div className="flex items-start gap-2">
              <div className="border border-yellow-500 bg-yellow-50 p-4 rounded-lg"Triangle className="h-4 w-4 mt-0.5 flex-shrink-0" />
              <div className="flex-1">
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <p className="font-medium">{finding.description || finding.template || finding.type}</p>
                    {finding.url && <p className="text-sm text-gray-600">URL: {finding.url}</p>}
                    {finding.info && <p className="text-sm text-gray-600">Info: {JSON.stringify(finding.info)}</p>}
                  </div>
                  <span className={`px-2 py-1 text-xs rounded ${
                    finding.severity === 'high' ? 'bg-red-100 text-red-800' :
                    finding.severity === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-blue-100 text-blue-800'
                  }`}>
                    {finding.severity || 'medium'}
                  </span>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    )
  }

  const getRiskColor = (level: string) => {
    switch (level?.toLowerCase()) {
      case 'critical': return 'text-red-600 bg-red-100'
      case 'high': return 'text-red-600 bg-red-100'
      case 'medium': return 'text-yellow-600 bg-yellow-100'
      case 'low': return 'text-green-600 bg-green-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">Vulnerability Assessment</h1>
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <Shield className="w-4 h-4" />
          Sistema de evaluación de vulnerabilidades avanzado
        </div>
      </div>

      {/* Input del target */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4">
          <h2 className="text-xl font-bold text-green-400">Target</h2>
          <p className="text-green-600">
            Ingrese el dominio, IP o URL objetivo para evaluación de vulnerabilidades
          </p>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">Target</label>
            <input
              type="text"
              value={target}
              onChange={(e) => setTarget(e.target.value)}
              placeholder="ej: example.com, 192.168.1.1"
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-green-400 mb-2">URL para SQL Injection (opcional)</label>
            <input
              type="text"
              value={sqlUrl}
              onChange={(e) => setSqlUrl(e.target.value)}
              placeholder="ej: http://example.com/page.php?id=1"
              className="w-full bg-gray-900 border border-green-500 rounded px-3 py-2 text-green-400 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500"
            />
          </div>
        </div>
      </div>

      {/* Tipos de evaluación */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4">
          <h2 className="text-xl font-bold text-green-400">Herramientas de Evaluación</h2>
          <p className="text-green-600">
            Seleccione la herramienta de evaluación de vulnerabilidades a utilizar
          </p>
        </div>
          <div className="w-full">
            <div className="flex border-b border-green-500 mb-4">
              <button
                onClick={() => setActiveTab('nikto')}
                className={`flex items-center gap-2 px-4 py-2 border-b-2 ${
                  activeTab === 'nikto'
                    ? 'border-green-400 text-green-400'
                    : 'border-transparent text-gray-400 hover:text-green-400'
                }`}
              >
                <Globe className="w-4 h-4" />
                Nikto
              </button>
              <button
                onClick={() => setActiveTab('nmap')}
                className={`flex items-center gap-2 px-4 py-2 border-b-2 ${
                  activeTab === 'nmap'
                    ? 'border-green-400 text-green-400'
                    : 'border-transparent text-gray-400 hover:text-green-400'
                }`}
              >
                <Target className="w-4 h-4" />
                Nmap Vuln
              </button>
              <button
                onClick={() => setActiveTab('nuclei')}
                className={`flex items-center gap-2 px-4 py-2 border-b-2 ${
                  activeTab === 'nuclei'
                    ? 'border-green-400 text-green-400'
                    : 'border-transparent text-gray-400 hover:text-green-400'
                }`}
              >
                <Zap className="w-4 h-4" />
                Nuclei
              </button>
              <button
                onClick={() => setActiveTab('sqlmap')}
                className={`flex items-center gap-2 px-4 py-2 border-b-2 ${
                  activeTab === 'sqlmap'
                    ? 'border-green-400 text-green-400'
                    : 'border-transparent text-gray-400 hover:text-green-400'
                }`}
              >
                <Database className="w-4 h-4" />
                SQLMap
              </button>
              <button
                onClick={() => setActiveTab('comprehensive')}
                className={`flex items-center gap-2 px-4 py-2 border-b-2 ${
                  activeTab === 'comprehensive'
                    ? 'border-green-400 text-green-400'
                    : 'border-transparent text-gray-400 hover:text-green-400'
                }`}
              >
                <Shield className="w-4 h-4" />
                Completo
              </button>
            </div>

            {activeTab === 'nikto' && (
              <div className="mt-4">
                <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                  <div className="mb-4">
                    <h3 className="text-lg font-bold text-green-400 flex items-center gap-2">
                      <Globe className="w-5 h-5" />
                      Nikto - Web Server Scanner
                    </h3>
                    <p className="text-green-600">
                      Escanea servidores web en busca de archivos obsoletos, configuraciones peligrosas y otros problemas
                    </p>
                  </div>
                  <button
                    onClick={() => handleScan('nikto')}
                    disabled={niktoMutation.isPending}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {niktoMutation.isPending ? (
                      <Loader className="w-4 h-4 animate-spin mr-2" />
                    ) : (
                      <Globe className="w-4 h-4 mr-2" />
                    )}
                    Iniciar Escaneo Nikto
                  </button>
                  {niktoMutation.data && (
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Resultados:</h4>
                      {renderFindings(niktoMutation.data.findings, 'nikto')}
                    </div>
                  )}
                
              </div>
            )}

            {activeTab === 'nmap' && (
              <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="flex items-center gap-2">
                    <Target className="w-5 h-5" />
                    Nmap Vulnerability Scripts
                  </h3>
                  <p className="text-green-600">
                    Utiliza los scripts NSE de Nmap para detectar vulnerabilidades conocidas
                  </p>
                </div>
                
                  <button
                    onClick={() => handleScan('nmap')}
                    disabled={nmapVulnMutation.isPending}
                    className="w-full bg-green-600 hover:bg-green-700"
                  >
                    {nmapVulnMutation.isPending ? (
                      <Loader className="w-4 h-4 animate-spin mr-2" />
                    ) : (
                      <Target className="w-4 h-4 mr-2" />
                    )}
                    Iniciar Escaneo Nmap Vuln
                  </button>
                  {nmapVulnMutation.data && (
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Vulnerabilidades encontradas:</h4>
                      {renderFindings(nmapVulnMutation.data.vulnerabilities, 'nmap')}
                    </div>
                  )}
                
              </div>
            )}

            {activeTab === 'nuclei' <TabsContent value="nuclei" className="mt-4"><TabsContent value="nuclei" className="mt-4"> (
              <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="flex items-center gap-2">
                    <Zap className="w-5 h-5" />
                    Nuclei - Template Based Scanner
                  </h3>
                  <p className="text-green-600">
                    Escanea utilizando templates de vulnerabilidades y exposiciones comunes
                  </p>
                </div>
                
                  <button
                    onClick={() => handleScan('nuclei')}
                    disabled={nucleiMutation.isPending}
                    className="w-full bg-purple-600 hover:bg-purple-700"
                  >
                    {nucleiMutation.isPending ? (
                      <Loader className="w-4 h-4 animate-spin mr-2" />
                    ) : (
                      <Zap className="w-4 h-4 mr-2" />
                    )}
                    Iniciar Escaneo Nuclei
                  </button>
                  {nucleiMutation.data && (
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Resultados:</h4>
                      {renderFindings(nucleiMutation.data.findings, 'nuclei')}
                    </div>
                  )}
                
              </div>
            )}

            {activeTab === 'sqlmap' <TabsContent value="sqlmap" className="mt-4"><TabsContent value="sqlmap" className="mt-4"> (
              <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="flex items-center gap-2">
                    <Database className="w-5 h-5" />
                    SQLMap - SQL Injection Scanner
                  </h3>
                  <p className="text-green-600">
                    Detecta y explota vulnerabilidades de inyección SQL
                  </p>
                </div>
                
                  <div className="mb-4">
                    <div className="border border-yellow-500 bg-yellow-50 p-4 rounded-lg"Description>
                      Asegúrese de tener permisos para realizar pruebas de inyección SQL.
                      Este escaneo puede ser detectado por WAF y sistemas de seguridad.
                    
                  </div>
                  <button
                    onClick={() => handleScan('sqlmap')}
                    disabled={sqlmapMutation.isPending || !sqlUrl.trim()}
                    className="w-full bg-red-600 hover:bg-red-700"
                  >
                    {sqlmapMutation.isPending ? (
                      <Loader className="w-4 h-4 animate-spin mr-2" />
                    ) : (
                      <Database className="w-4 h-4 mr-2" />
                    )}
                    Iniciar Escaneo SQLMap
                  </button>
                  {sqlmapMutation.data && (
                    <div className="mt-4">
                      <h4 className="font-semibold mb-2">Resultados de SQL Injection:</h4>
                      {renderFindings(sqlmapMutation.data.findings, 'sqlmap')}
                    </div>
                  )}
                
              </div>
            )}

            {activeTab === 'comprehensive' <TabsContent value="comprehensive" className="mt-4"><TabsContent value="comprehensive" className="mt-4"> (
              <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                <div className="mb-4">
                  <h3 className="flex items-center gap-2">
                    <Shield className="w-5 h-5" />
                    Evaluación Completa de Vulnerabilidades
                  </h3>
                  <p className="text-green-600">
                    Ejecuta múltiples herramientas para una evaluación completa de vulnerabilidades
                  </p>
                </div>
                
                  <div className="mb-4">
                    <div className="border border-yellow-500 bg-yellow-50 p-4 rounded-lg"Description>
                      Este escaneo puede tomar varios minutos y ejecutar Nikto, Nmap vuln scripts y Nuclei.
                      Se recomienda para evaluaciones exhaustivas.
                    
                  </div>
                  <button
                    onClick={() => handleScan('comprehensive')}
                    disabled={comprehensiveMutation.isPending}
                    className="w-full bg-gradient-to-r from-red-600 to-purple-600 hover:from-red-700 hover:to-purple-700"
                  >
                    {comprehensiveMutation.isPending ? (
                      <Loader className="w-4 h-4 animate-spin mr-2" />
                    ) : (
                      <Shield className="w-4 h-4 mr-2" />
                    )}
                    Iniciar Evaluación Completa
                  </button>

                  {/* Resultados de evaluación completa */}
                  {comprehensiveMutation.data && (
                    <div className="mt-6 space-y-4">
                      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                        <div className="mb-4">
                          <h3 className="text-lg font-bold text-green-400">Resumen de Evaluación Completa</h3>
                          <p className="text-green-600">
                            Ejecutado el {new Date(comprehensiveMutation.data.timestamp).toLocaleString()}
                          </p>
                        </div>
                        
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div className="text-center">
                              <div className="text-2xl font-bold text-blue-600">
                                {comprehensiveMutation.data.summary.total_phases}
                              </div>
                              <div className="text-sm text-gray-600">Fases</div>
                            </div>
                            <div className="text-center">
                              <div className="text-2xl font-bold text-green-600">
                                {comprehensiveMutation.data.summary.successful_phases}
                              </div>
                              <div className="text-sm text-gray-600">Exitosas</div>
                            </div>
                            <div className="text-center">
                              <div className="text-2xl font-bold text-red-600">
                                {comprehensiveMutation.data.summary.total_vulnerabilities}
                              </div>
                              <div className="text-sm text-gray-600">Vulnerabilidades</div>
                            </div>
                            <div className="text-center">
                              <span className={`text-lg px-3 py-1 ${getRiskColor(comprehensiveMutation.data.summary.risk_level)}`}>
                                {comprehensiveMutation.data.summary.risk_level?.toUpperCase()}
                              </span>
                              <div className="text-sm text-gray-600 mt-1">Nivel de Riesgo</div>
                            </div>
                          </div>
                        
                      </div>

                      {/* Detalles por herramienta */}
                      <div className="w-full">
                        <div className="flex border-b border-green-500 mb-4">
                          <button className="px-4 py-2 border-b-2 border-green-400 text-green-400">Nikto</button>
                          <button className="px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-green-400">Nmap Vuln</button>
                          <button className="px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-green-400">Nuclei</button>
                        </div>

                        {Object.entries(comprehensiveMutation.data.phases).map(([phase, results]) => (
                          <div key={phase} value={phase}>
                            <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
                              <div className="mb-4">
                                <h3 className="capitalize">{phase.replace('_', ' ')}</h3>
                                <span className={`px-2 py-1 text-xs rounded ${results?.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                  {results?.success ? 'Completado' : 'Error'}
                                </span>
                              </div>
                              
                                {phase === 'nikto' && results?.findings && (
                                  renderFindings(results.findings, 'nikto')
                                )}
                                {phase === 'nmap_vuln' && results?.vulnerabilities && (
                                  renderFindings(results.vulnerabilities, 'nmap')
                                )}
                                {phase === 'nuclei' && results?.findings && (
                                  renderFindings(results.findings, 'nuclei')
                                )}
                              
                            </div>
                          )}
                        ))}
                      </div>
                    </div>
                  )}
                
              </div>
            )}
          </Tabs>
        
      </div>

      {/* Historial de evaluaciones */}
      <div className="bg-gray-800 border border-green-500 rounded-lg p-6">
        <div className="mb-4">
          <h3 className="text-lg font-bold text-green-400">Historial de Evaluaciones</h3>
          <p className="text-green-600">
            Sesiones de evaluación de vulnerabilidades recientes
          </p>
        </div>
        
          {sessionsLoading ? (
            <div className="flex items-center justify-center py-8">
              <Loader className="w-8 h-8 animate-spin" />
            </div>
          ) : sessions && sessions.length > 0 ? (
            <div className="space-y-2">
              {sessions.slice(0, 10).map((session: VulnSession) => (
                <div key={session.id} className="flex items-center justify-between p-3 bg-gray-50 rounded">
                  <div>
                    <div className="font-medium">{session.target}</div>
                    <div className="text-sm text-gray-600">
                      {session.scan_type} - {new Date(session.created_at).toLocaleString()}
                    </div>
                  </div>
                  <span className={`px-2 py-1 text-xs rounded ${
                    session.status === 'completed' ? 'bg-green-100 text-green-800' :
                    session.status === 'running' ? 'bg-blue-100 text-blue-800' :
                    session.status === 'error' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                  }`}>
                    {session.status}
                  </span>
                </div>
              ))}
            </div>
          ) : (
            <p className="text-gray-500 text-center py-4">
              No hay sesiones de evaluación de vulnerabilidades registradas
            </p>
          )}
        
      </div>
    </div>
  )
}

export default VulnerabilityAssessment

